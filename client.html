<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YYZ Offices â€” My Mailbox</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /* â”€â”€ THEME CONFIG (changeable from staff panel later) â”€â”€â”€ */
  :root {
    --theme:       #8B1A1A;   /* primary brand colour */
    --logo-url:    url('https://yyzoffices.com/wp-content/uploads/2026/02/logo-transparent-png-scaled.png');

    --red:        #8B1A1A;
    --red-light:  #A52020;
    --red-dim:    rgba(139,26,26,0.08);
    --red-border: rgba(139,26,26,0.18);
    --ink:        #1A1A1F;
    --ink-2:      #3D3D45;
    --ink-3:      #72727D;
    --ink-4:      #A8A8B0;
    --bg:         #F7F6F4;
    --bg-2:       #EFEDE9;
    --white:      #FFFFFF;
    --border:     #E2E0DB;
    --shadow:     0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md:  0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
    --radius:     10px;
    --radius-sm:  6px;
    --green:      #1A6B3C;
    --green-bg:   #E8F5EE;
    --amber:      #92520A;
    --amber-bg:   #FEF3E2;
    --blue:       #1A4A7A;
    --blue-bg:    #E8F0FA;
  }

  /* â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--ink);
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }
  button { font-family: inherit; cursor: pointer; border: none; outline: none; }
  input, select, textarea { font-family: inherit; outline: none; }
  a { text-decoration: none; color: inherit; }

  /* â”€â”€ Loading Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #loading-screen {
    position: fixed; inset: 0;
    background: var(--white);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
    z-index: 9999;
    transition: opacity 0.4s ease;
  }
  #loading-screen.fade-out { opacity: 0; pointer-events: none; }
  .loading-logo {
    font-family: 'DM Serif Display', serif;
    font-size: 22px; color: var(--ink);
    letter-spacing: -0.3px;
  }
  .loading-logo span { color: var(--red); }
  .loading-bar {
    width: 120px; height: 2px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .loading-bar-fill {
    height: 100%; width: 0;
    background: var(--red);
    border-radius: 2px;
    animation: loadBar 1.2s ease forwards;
  }
  @keyframes loadBar { to { width: 100%; } }

  /* â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app { display: none; flex-direction: column; min-height: 100vh; }
  #app.visible { display: flex; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .header {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 56px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .header-logo {
    font-family: 'DM Serif Display', serif;
    font-size: 18px; color: var(--ink);
    letter-spacing: -0.3px;
    display: flex; align-items: center; gap: 8px;
  }
  .header-logo .dot { color: var(--red); }
  .header-right {
    display: flex; align-items: center; gap: 12px;
  }
  .client-name {
    font-size: 12px; color: var(--ink-3); font-weight: 400;
    display: flex; align-items: center; gap: 8px;
  }
  .client-name strong { color: var(--ink); font-weight: 500; }
  .client-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    background: var(--red-dim); color: var(--red);
    font-size: 11px; font-weight: 700;
    display: inline-flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  /* â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .banner {
    padding: 12px 24px;
    display: flex; align-items: center; gap: 12px;
    font-size: 13px;
    border-bottom: 1px solid transparent;
  }
  .banner.setup    { background: var(--blue-bg); border-color: rgba(26,74,122,0.15); color: var(--blue); }
  .banner.warning  { background: var(--amber-bg); border-color: rgba(146,82,10,0.15); color: var(--amber); }
  .banner.error    { background: #FEE8E8; border-color: rgba(139,26,26,0.15); color: var(--red); }
  .banner-icon { font-size: 16px; flex-shrink: 0; }
  .banner-text { flex: 1; }
  .banner-text strong { font-weight: 600; display: block; margin-bottom: 1px; }
  .banner-btn {
    background: var(--ink);
    color: var(--white);
    border-radius: var(--radius-sm);
    padding: 6px 14px;
    font-size: 12px; font-weight: 500;
    white-space: nowrap;
    transition: opacity 0.15s;
  }
  .banner-btn:hover { opacity: 0.85; }
  .banner-btn.outline {
    background: transparent;
    border: 1px solid currentColor;
    color: inherit;
  }

  /* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main {
    flex: 1;
    padding: 24px;
    max-width: 900px;
    width: 100%;
    margin: 0 auto;
    display: flex; flex-direction: column; gap: 20px;
  }

  /* â”€â”€ Section Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px;
  }
  .section-title {
    font-size: 13px; font-weight: 600;
    color: var(--ink-2);
    text-transform: uppercase; letter-spacing: 0.06em;
  }
  .section-action {
    font-size: 12px; color: var(--red); font-weight: 500;
    cursor: pointer; transition: opacity 0.15s;
  }
  .section-action:hover { opacity: 0.7; }

  /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  /* â”€â”€ Stats Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
  }
  .stat-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--border);
    border-radius: 3px 3px 0 0;
  }
  .stat-card.accent::before { background: var(--red); }
  .stat-card.green::before  { background: var(--green); }
  .stat-card.amber::before  { background: #D97706; }
  .stat-card.blue::before   { background: var(--blue); }
  .stat-label {
    font-size: 11px; font-weight: 500;
    color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.06em;
    margin-bottom: 8px;
  }
  .stat-value {
    font-family: 'DM Serif Display', serif;
    font-size: 28px; color: var(--ink);
    line-height: 1; margin-bottom: 4px;
  }
  .stat-sub {
    font-size: 11px; color: var(--ink-4);
  }
  .stat-sub strong { color: var(--ink-3); font-weight: 500; }

  /* â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .usage-bar {
    height: 4px; background: var(--bg-2);
    border-radius: 4px; margin-top: 8px;
    overflow: hidden;
  }
  .usage-bar-fill {
    height: 100%; border-radius: 4px;
    background: var(--red);
    transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
  }
  .usage-bar-fill.safe   { background: var(--green); }
  .usage-bar-fill.warn   { background: #D97706; }
  .usage-bar-fill.danger { background: var(--red); }

  /* â”€â”€ Mail Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .mail-list { border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); }
  .mail-item {
    background: var(--white);
    display: grid;
    grid-template-columns: 36px 1fr auto;
    align-items: center; gap: 12px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    transition: background 0.12s;
    cursor: default;
  }
  .mail-item:last-child { border-bottom: none; }
  .mail-item:hover { background: var(--bg); }
  .mail-item.blurred .mail-info,
  .mail-item.blurred .mail-meta { filter: blur(4px); user-select: none; }
  .mail-icon {
    width: 36px; height: 36px;
    border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
  }
  .mail-icon.letter { background: var(--blue-bg); }
  .mail-icon.parcel { background: var(--amber-bg); }
  .mail-info { min-width: 0; }
  .mail-recipient {
    font-size: 13px; font-weight: 500; color: var(--ink);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .mail-date { font-size: 11px; color: var(--ink-4); margin-top: 1px; }
  .mail-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
  .pill {
    display: inline-flex; align-items: center;
    padding: 2px 8px; border-radius: 20px;
    font-size: 11px; font-weight: 500; white-space: nowrap;
  }
  .pill.arrived     { background: var(--blue-bg); color: var(--blue); }
  .pill.scanned     { background: #E8F5EE; color: var(--green); }
  .pill.stored      { background: var(--amber-bg); color: var(--amber); }
  .pill.forwarded   { background: #E8F5EE; color: var(--green); }
  .pill.picked_up   { background: #F0F0F5; color: var(--ink-3); }
  .pill.shredded    { background: #F0F0F5; color: var(--ink-4); }
  .pill.ready_to_ship { background: var(--amber-bg); color: var(--amber); }
  .pill.confidential { background: var(--red-dim); color: var(--red); }
  .mail-item-done { opacity: 0.65; }
  .storage-warn {
    font-size: 10px; color: var(--amber); font-weight: 500;
  }
  .storage-warn.urgent { color: var(--red); }

  /* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .empty-state {
    padding: 48px 24px;
    text-align: center;
    color: var(--ink-3);
  }
  .empty-icon { font-size: 32px; margin-bottom: 12px; opacity: 0.5; }
  .empty-title { font-size: 14px; font-weight: 500; color: var(--ink-2); margin-bottom: 4px; }
  .empty-sub   { font-size: 13px; color: var(--ink-4); }

  /* â”€â”€ Onboarding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .onboarding {
    max-width: 560px; margin: 40px auto;
    padding: 0 24px;
  }
  .onboard-header { margin-bottom: 28px; }
  .onboard-step {
    font-size: 11px; font-weight: 600; color: var(--red);
    text-transform: uppercase; letter-spacing: 0.08em;
    margin-bottom: 8px;
  }
  .onboard-title {
    font-family: 'DM Serif Display', serif;
    font-size: 26px; color: var(--ink); margin-bottom: 6px;
  }
  .onboard-sub { font-size: 14px; color: var(--ink-3); }

  .onboard-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow-md);
  }

  /* â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .form-group { margin-bottom: 16px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .form-row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; }
  label {
    display: block; font-size: 12px; font-weight: 500;
    color: var(--ink-2); margin-bottom: 5px;
  }
  input[type=text], input[type=email], select, textarea {
    width: 100%; padding: 9px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--white);
    color: var(--ink); font-size: 13px;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--red);
    box-shadow: 0 0 0 3px var(--red-dim);
  }
  input::placeholder, textarea::placeholder { color: var(--ink-4); }
  textarea { resize: vertical; min-height: 72px; }
  .form-divider {
    font-size: 11px; font-weight: 600; color: var(--ink-4);
    text-transform: uppercase; letter-spacing: 0.08em;
    margin: 20px 0 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    gap: 6px; padding: 10px 20px;
    border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 500;
    transition: all 0.15s;
    cursor: pointer;
  }
  .btn-primary {
    background: var(--red); color: var(--white);
    border: 1px solid var(--red);
  }
  .btn-primary:hover { background: var(--red-light); }
  .btn-secondary {
    background: var(--white); color: var(--ink);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { background: var(--bg); }
  .btn-full { width: 100%; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin  { to { transform: rotate(360deg); } }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.45; } }
  .spin-active { animation: spin 0.7s linear infinite; display:inline-block; }
  @keyframes shimmer { 0%{background-position:-600px 0} 100%{background-position:600px 0} }
  .shimmer-line {
    height: 13px; border-radius: 6px; margin-bottom: 10px;
    background: linear-gradient(90deg, var(--bg-2) 25%, rgba(255,255,255,0.06) 50%, var(--bg-2) 75%);
    background-size: 1200px 100%;
    animation: shimmer 1.5s infinite;
  }
  .shimmer-line.short { width: 55%; }
  .shimmer-line.med   { width: 78%; }

  /* â”€â”€ Steps indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .steps {
    display: flex; gap: 8px; align-items: center;
    margin-bottom: 24px;
  }
  .step-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--border);
    transition: all 0.2s;
  }
  .step-dot.active { background: var(--red); transform: scale(1.3); }
  .step-dot.done   { background: var(--green); }
  .step-line { flex: 1; height: 1px; background: var(--border); }

  /* â”€â”€ Recipient Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .recipient-list { display: flex; flex-direction: column; gap: 8px; }
  .recipient-item {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: var(--shadow);
  }
  .recipient-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: var(--red-dim);
    color: var(--red);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 600; flex-shrink: 0;
  }
  .recipient-info { flex: 1; }
  .recipient-name { font-size: 13px; font-weight: 500; color: var(--ink); }
  .recipient-company { font-size: 11px; color: var(--ink-4); margin-top: 1px; }
  .recipient-status { }

  /* â”€â”€ Blocked Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .blocked-screen {
    display: flex; align-items: center; justify-content: center;
    min-height: calc(100vh - 56px);
    padding: 24px;
  }
  .blocked-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 40px 32px;
    max-width: 420px; width: 100%;
    text-align: center;
    box-shadow: var(--shadow-md);
  }
  .blocked-icon {
    width: 56px; height: 56px;
    border-radius: 50%;
    background: #FEE8E8;
    color: var(--red);
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
    margin: 0 auto 20px;
  }
  .blocked-title {
    font-family: 'DM Serif Display', serif;
    font-size: 20px; color: var(--ink); margin-bottom: 8px;
  }
  .blocked-msg { font-size: 13px; color: var(--ink-3); margin-bottom: 8px; line-height: 1.6; }
  .blocked-reason {
    font-size: 12px; color: var(--ink-4);
    background: var(--bg); border-radius: var(--radius-sm);
    padding: 8px 12px; margin-bottom: 24px;
  }

  /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tabs-bar-wrap {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    padding: 7px 20px;
    position: sticky; top: 56px; z-index: 90;
    display: flex; align-items: center; justify-content: space-between;
  }
  .tabs {
    display: flex; gap: 3px;
    background: var(--bg-2);
    border-radius: 8px;
    padding: 3px;
  }
  .tab {
    padding: 6px 18px;
    font-size: 12px; font-weight: 500;
    color: var(--ink-3);
    cursor: pointer;
    border-radius: 6px;
    border: none;
    background: transparent;
    transition: all 0.15s;
    white-space: nowrap;
    font-family: inherit;
  }
  .tab.active {
    background: var(--white);
    color: var(--ink);
    font-weight: 600;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
  }
  .tab:hover:not(.active) { color: var(--ink-2); background: rgba(255,255,255,0.5); }

  /* Refresh button */
  .refresh-btn {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 5px 11px;
    font-size: 11px; font-weight: 500; color: var(--ink-3);
    background: transparent; border: 1px solid var(--border);
    border-radius: 6px; cursor: pointer;
    font-family: inherit; transition: all 0.15s;
    white-space: nowrap;
  }
  .refresh-btn:hover { background: var(--bg); color: var(--ink); border-color: var(--ink-3); }
  .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .refresh-btn svg { transition: transform 0.15s; flex-shrink: 0; }
  .refresh-btn.spinning svg { animation: refreshSpin 0.7s linear infinite; }
  @keyframes refreshSpin { to { transform: rotate(360deg); } }
  .refresh-ts { font-size: 11px; color: var(--ink-4); }

  /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast-container {
    position: fixed; bottom: 20px; right: 20px;
    display: flex; flex-direction: column; gap: 8px;
    z-index: 9999;
  }
  .toast {
    background: var(--ink); color: var(--white);
    padding: 10px 16px; border-radius: var(--radius-sm);
    font-size: 13px; box-shadow: var(--shadow-md);
    animation: toastIn 0.25s ease;
  }
  .toast.success { background: var(--green); }
  .toast.error   { background: var(--red); }
  @keyframes toastIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

  /* â”€â”€ Subscription switcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sub-switcher {
    display: flex; gap: 6px;
    padding: 10px 20px;
    background: var(--white);
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    align-items: center;
  }
  .sub-switcher::-webkit-scrollbar { display: none; }
  .sub-pill {
    padding: 6px 14px;
    font-size: 12px; font-weight: 500;
    cursor: pointer; border: 1.5px solid var(--border);
    border-radius: 20px;
    background: transparent; color: var(--ink-3);
    white-space: nowrap; transition: all 0.15s;
    display: inline-flex; align-items: center; gap: 5px;
    font-family: inherit;
  }
  .sub-pill:hover { color: var(--ink); border-color: var(--ink-3); background: var(--bg); }
  .sub-pill.active {
    background: var(--red); color: var(--white);
    border-color: var(--red); font-weight: 600;
  }
  .sub-pill.active:hover { background: var(--red-light); border-color: var(--red-light); }
  .sub-pill.blocked { color: var(--red); border-color: var(--red-border); }
  .sub-pill.active.blocked { background: var(--red); border-color: var(--red); color: var(--white); }
  /* â”€â”€ Plan card grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .plan-card-grid { display:flex; flex-direction:column; gap:12px; }

  /* Plan selection screen */
  .setup-selection-grid { display:flex; flex-direction:column; gap:14px; margin-top:8px; }
  .setup-select-card {
    background: var(--white);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    cursor: pointer;
    transition: border-color 0.15s, box-shadow 0.15s;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }
  .setup-select-card:hover {
    border-color: var(--ink-3);
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .setup-select-card .plan-icon { font-size: 28px; flex-shrink: 0; }
  .setup-select-card .plan-info { flex: 1; min-width: 0; }
  .setup-select-card .plan-title { font-size: 15px; font-weight: 600; color: var(--ink); margin-bottom: 3px; }
  .setup-select-card .plan-meta  { font-size: 12px; color: var(--ink-4); }
  .setup-select-card .setup-btn  {
    font-size: 12px; font-weight: 600; padding: 8px 16px;
    background: var(--ink); color: var(--white);
    border: none; border-radius: var(--radius-sm);
    cursor: pointer; white-space: nowrap; flex-shrink: 0;
    font-family: inherit;
  }
  .setup-select-card:hover .setup-btn { background: #111; }
  .plan-card-item { background:var(--white); border:1px solid var(--border); border-radius:var(--radius); padding:18px 20px; }
  .plan-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
  .plan-card-name { font-size:14px; font-weight:600; color:var(--ink); }
  .plan-card-sub { font-size:12px; color:var(--ink-3); margin-top:2px; }
  .recipient-row { display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid var(--border); }
  .recipient-row:last-child { border-bottom:none; }
  .add-recipient-row { display:flex; align-items:center; gap:10px; padding:12px 0 4px; }

  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 600px) {
    .main { padding: 16px; gap: 16px; }
    .form-row, .form-row-3 { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: 1fr 1fr; }
    .header { padding: 0 16px; }
    .tabs { padding: 0 16px; overflow-x: auto; }
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="yyz-supabase-adapter.js"></script>
</head>
<body>

<!-- Loading -->
<div id="loading-screen">
  <div class="loading-logo">
    <img src="https://yyzoffices.com/wp-content/uploads/2026/02/logo-transparent-png-1-scaled.png"
      alt="YYZ Offices" style="height:52px;width:auto;display:block;margin:0 auto"
      onerror="this.style.display='none';this.nextElementSibling.style.display='inline'">
    <span style="display:none">YYZ<span class="dot">.</span>Offices</span>
  </div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<!-- App -->
<div id="app">

  <!-- Header -->
  <header class="header">
    <div class="header-logo">
        <img src="https://yyzoffices.com/wp-content/uploads/2026/02/logo-transparent-png-scaled.png"
          alt="YYZ Offices" style="height:30px;width:auto;display:block"
          onerror="this.style.display='none';this.nextElementSibling.style.display='inline'">
        <span style="display:none">YYZ<span class="dot">.</span>Offices</span>
      </div>
    <div class="header-right">
      <span class="client-name" id="header-name"></span>
    </div>
  </header>

  <!-- Subscription switcher (hidden until needed) -->
  <div id="sub-switcher-area"></div>

  <!-- Banner area -->
  <div id="banner-area"></div>

  <!-- Content area -->
  <div id="content-area"></div>

</div>

<!-- Toast container -->
<div class="toast-container" id="toasts"></div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let STATE = {
  uuid:         null,
  access:       null,
  activeSub:    null,
  allSubs:      [],
  mailLog:      [],
  planCard:     null,
  recipients:   [],
  agents:       [],
  activeTab:    'mail',
  loading:      false
};

function safePcId(id) {
  return String(id || 'unknown').replace(/[^a-zA-Z0-9_-]/g, '_');
}


// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function qs(id) { return document.getElementById(id); }
function getUUID() {
  const params = new URLSearchParams(window.location.search);
  return params.get('uuid') || params.get('id') || null;
}
function fmtDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-CA', { month: 'short', day: 'numeric', year: 'numeric' });
}
function fmtDateTime(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-CA', { month: 'short', day: 'numeric' }) + ' ' +
         new Date(d).toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' });
}
function daysUntil(d) {
  if (!d) return null;
  return Math.ceil((new Date(d) - new Date()) / (1000 * 60 * 60 * 24));
}
function initials(name) {
  return (name || '').split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase();
}
function toast(msg, type = '') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  qs('toasts').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

function getCachedAuth(uuid) {
  try {
    const raw = sessionStorage.getItem('auth_' + uuid);
    if (!raw) return null;
    const { data, ts } = JSON.parse(raw);
    if (Date.now() - ts > CACHE_TTL) { sessionStorage.removeItem('auth_' + uuid); return null; }
    return data;
  } catch(e) { return null; }
}

function setCachedAuth(uuid, data) {
  try { sessionStorage.setItem('auth_' + uuid, JSON.stringify({ data, ts: Date.now() })); } catch(e) {}
}

function clearCachedAuth(uuid) {
  try { sessionStorage.removeItem('auth_' + uuid); } catch(e) {}
}

async function boot() {
  STATE.uuid = getUUID();

  if (!STATE.uuid) {
    hideLoading();
    showBlocked('No Access', 'No access credential found in URL.', null, null);
    return;
  }

  // Check session cache first â€” instant load on refresh
  const cached = getCachedAuth(STATE.uuid);
  if (cached && cached.status === 'client') {
    STATE.access = cached;
    hideLoading();
    renderClient(cached);
    // Silently refresh cache in background
    api('uuid=' + encodeURIComponent(STATE.uuid)).then(fresh => {
      if (fresh && fresh.status === 'client') setCachedAuth(STATE.uuid, fresh);
    }).catch(() => {});
    return;
  }

  // No cache â€” show loading bar then fetch
  await new Promise(r => setTimeout(r, 600));

  try {
    const data = await api('uuid=' + encodeURIComponent(STATE.uuid));
    STATE.access = data;
    hideLoading();

    if (data.status === 'blocked' || data.status === 'error') {
      showBlocked(
        data.status === 'error' ? 'Error' : 'Access Unavailable',
        data.message, null, null
      );
      return;
    }
    if (data.status === 'staff') {
      showBlocked('Wrong Portal', 'Please use the staff portal to access your dashboard.', null, null);
      return;
    }
    if (data.status === 'client') {
      setCachedAuth(STATE.uuid, data);
      renderClient(data);
    }

  } catch (err) {
    hideLoading();
    showBlocked('Connection Error', 'Could not connect to the server. Please try again.', null, null);
  }
}

function hideLoading() {
  const ls = qs('loading-screen');
  ls.classList.add('fade-out');
  setTimeout(() => { ls.style.display = 'none'; }, 400);
  qs('app').classList.add('visible');
}

// â”€â”€ Client Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderClient(access) {
  const _hn = access.name || access.email || 'Client';
  const _initials = _hn.split(' ').filter(Boolean).slice(0,2).map(w=>w[0]).join('').toUpperCase();
  qs('header-name').innerHTML = `<span class="client-avatar">${_initials}</span><strong>${_hn}</strong>`;

  const subs = (access.subscriptions || []).filter(s => s.subscriptionId);
  if (!subs.length) {
    showBlocked('No Subscription', 'No subscription found for your account.', null, null);
    return;
  }

  // Pick best sub: prefer fully set-up ACTIVE, then any ACTIVE, then CANCELED_WITH_ACCESS, then first
  const best = subs.find(s => s.accessStatus === 'ACTIVE' && !s.setupRequired)
    || subs.find(s => s.accessStatus === 'CANCELED_WITH_ACCESS' && !s.setupRequired)
    || subs.find(s => s.accessStatus === 'ACTIVE')
    || subs.find(s => s.accessStatus === 'CANCELED_WITH_ACCESS')
    || subs[0];

  STATE.allSubs  = subs;
  STATE.activeSub = best;

  renderSubscriptionSwitcher(access);

  // If best sub is fully live, go straight to dashboard â€” never hijack into another plan's setup
  if (!best.setupRequired) {
    loadAndRenderSub(best, access);
    return;
  }

  // All accessible subs still need setup â€” figure out where to send them
  const pendingSetup   = subs.filter(s => s.canAccess && s.setupRequired);
  const needsSelection = pendingSetup.filter(s => s.setupStep === 'plan_setup');

  if (needsSelection.length > 1) {
    renderPlanSelection(access);
  } else {
    // One plan to set up or resume mid-flow
    const priority   = ['add_recipients', 'plan_setup'];
    const resumeSub  = pendingSetup.slice().sort((a, b) =>
      priority.indexOf(a.setupStep) - priority.indexOf(b.setupStep)
    )[0] || best;
    loadAndRenderSub(resumeSub, access);
  }
}

function renderSubscriptionSwitcher(access) {
  const area = qs('sub-switcher-area');
  const subs = STATE.allSubs || [];

  // Only show switcher if more than 1 subscription
  if (subs.length <= 1) { area.innerHTML = ''; return; }

  area.innerHTML = `
    <div class="sub-switcher">
      ${subs.map(s => {
        const isActive  = s.subscriptionId === (STATE.activeSub || {}).subscriptionId;
        const isBlocked = !s.canAccess;
        const needsSetup = s.canAccess && s.setupRequired;
        const label = getPlanFriendlyName(s);
        const badge = needsSetup
          ? `<span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:8px;background:var(--blue-bg);color:var(--blue);letter-spacing:0.03em;text-transform:uppercase">Setup</span>`
          : '';
        return `<div class="sub-pill ${isActive ? 'active' : ''} ${isBlocked && !isActive ? 'blocked' : ''}"
          onclick="switchSubscription('${s.subscriptionId}')">${label}${badge}</div>`;
      }).join('')}
    </div>`;
}

async function switchSubscription(subscriptionId) {
  const sub = (STATE.allSubs || []).find(s => s.subscriptionId === subscriptionId);
  if (!sub) return;
  STATE.activeSub = sub;
  // Clear per-sub data but preserve allPlanCards so friendlyNames stay visible in switcher
  STATE.mailLog      = [];
  STATE.planCard     = null;
  STATE.recipients   = [];
  STATE.agents       = [];
  // Keep allPlanCards intact â€” it holds friendlyNames for the switcher labels
  _plansTabActiveSub = subscriptionId; // reset plan tab to new sub
  renderSubscriptionSwitcher(STATE.access);
  // Show shimmer in content area while loading
  const dc = qs('dashboard-content');
  if (dc) dc.innerHTML = `<div style="padding:20px"><div class="shimmer-line"></div><div class="shimmer-line med"></div><div class="shimmer-line short"></div><div style="margin-top:20px"><div class="shimmer-line"></div><div class="shimmer-line med"></div></div></div>`;
  loadAndRenderSub(sub, STATE.access);
}

async function loadAndRenderSub(sub, access) {
  // Don't show banner during onboarding â€” it's redundant noise
  if (!sub.setupRequired) renderBanner(sub);
  else { const b = qs('banner-area'); if (b) b.innerHTML = ''; }

  if (!sub.canAccess) {
    renderBlockedSub(sub);
    return;
  }
  if (sub.setupRequired) {
    await renderSetup(sub, access);
    return;
  }
  await renderDashboard(sub, access);
}

// â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBanner(sub) {
  const area = qs('banner-area');
  if (!sub.banner) { area.innerHTML = ''; return; }
  const b = sub.banner;
  const typeClass = {
    setup_required:      'setup',
    canceled_with_access:'warning',
    pending_payment:     'warning',
    payment_required:    'error',
    canceled:            'error'
  }[b.type] || 'setup';

  const icon = {
    setup_required:      'ğŸ“‹',
    canceled_with_access:'â°',
    pending_payment:     'ğŸ“¬',
    payment_required:    'ğŸ’³',
    canceled:            'ğŸ”’'
  }[b.type] || 'â„¹ï¸';

  const btnHtml = b.actionLabel && b.actionUrl
    ? `<button class="banner-btn" onclick="window.open('${b.actionUrl}','_blank')">${b.actionLabel}</button>`
    : b.actionLabel
    ? `<button class="banner-btn" onclick="handleBannerAction('${b.setupStep}')">${b.actionLabel}</button>`
    : '';

  // For setup banners on multi-plan dashboards, show which plan needs setup
  const pendingSetupSubs = (STATE.allSubs || []).filter(s =>
    s.canAccess && s.setupRequired && s.subscriptionId !== (STATE.activeSub || {}).subscriptionId
  );
  const pendingBanners = pendingSetupSubs.length > 0 && b.type !== 'setup_required'
    ? pendingSetupSubs.map(s => {
        const label = getPlanFriendlyName(s);
        return `<button class="banner-btn outline" style="margin-left:6px" onclick="switchSubscription('${s.subscriptionId}')">${label} â€” Finish Setup â†’</button>`;
      }).join('')
    : '';

  area.innerHTML = `
    <div class="banner ${typeClass}">
      <span class="banner-icon">${icon}</span>
      <div class="banner-text">
        <strong>${b.title || ''}</strong>
        ${b.message || ''}
      </div>
      ${btnHtml}${pendingBanners}
    </div>`;
}

function handleBannerAction(step) {
  // Scroll to setup section or trigger it
  const setupEl = qs('setup-section');
  if (setupEl) setupEl.scrollIntoView({ behavior: 'smooth' });
}

// â”€â”€ Blocked Sub Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBlockedSub(sub) {
  const b = sub.banner || {};
  const icon = sub.accessStatus === 'PENDING_PAYMENT'  ? 'ğŸ“¬'
             : sub.accessStatus === 'PAYMENT_REQUIRED' ? 'ğŸ’³' : 'ğŸ”’';
  const btnHtml = b.actionLabel
    ? `<button class="btn btn-primary btn-full" onclick="window.open('${b.actionUrl||'#'}','_blank')">${b.actionLabel}</button>`
    : '';

  qs('content-area').innerHTML = `
    <div class="blocked-screen">
      <div class="blocked-card">
        <div class="blocked-icon">${icon}</div>
        <div class="blocked-title">${b.title || 'Access Unavailable'}</div>
        <p class="blocked-msg">${b.message || ''}</p>
        ${b.reason ? `<div class="blocked-reason">Reason: ${b.reason}</div>` : ''}
        ${btnHtml}
      </div>
    </div>`;
}

// â”€â”€ Blocked (no account) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showBlocked(title, msg, btnLabel, btnUrl) {
  qs('app').classList.add('visible');
  const btn = btnLabel ? `<button class="btn btn-primary btn-full" onclick="window.open('${btnUrl}','_blank')">${btnLabel}</button>` : '';
  qs('content-area').innerHTML = `
    <div class="blocked-screen">
      <div class="blocked-card">
        <div class="blocked-icon">ğŸ”’</div>
        <div class="blocked-title">${title}</div>
        <p class="blocked-msg">${msg}</p>
        ${btn}
      </div>
    </div>`;
}

// â”€â”€ Plan Selection Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Shows when client has 2+ pending plans. They pick which to set up.
function renderPlanSelection(access) {
  const subs = STATE.allSubs || [];

  // Only show pending subs (no planCard yet or status = pending_setup)
  // Only show subs still on step 1 (plan_setup) â€” mid-flow subs are handled by renderClient
  const pending = subs.filter(s => s.canAccess && s.setupRequired && s.setupStep === 'plan_setup');

  // Should not land here with 0 or 1 pending â€” but guard anyway
  if (pending.length === 0) { renderDashboard(subs[0], access); return; }
  if (pending.length === 1) { loadAndRenderSub(pending[0], access); return; }

  const switcher = qs('sub-switcher-area');

  const planIcons = { ship: 'ğŸ“¬', scan: 'ğŸ”', none: 'ğŸ“¦' };

  qs('content-area').innerHTML = `
    <div class="onboarding" style="max-width:520px">
      <div class="onboard-header">
        <div class="onboard-step">Mailbox Setup</div>
        <div class="onboard-title">Set up your plans</div>
        <div class="onboard-sub">You have ${pending.length} plans ready to configure. Set them up one at a time.</div>
      </div>
      <div class="setup-selection-grid">
        ${pending.map(sub => {
          const planLabel  = (sub.planName || '').split('â€“')[0].trim();
          const billing    = sub.interval === 'year' ? 'Yearly' : 'Monthly';
          const amount     = sub.planAmount ? '$' + (sub.planAmount / 100).toFixed(2) + ' CAD / ' + (sub.interval === 'year' ? 'yr' : 'mo') : '';
          const planLower  = (sub.planName || '').toLowerCase();
          const icon       = planLower.includes('scan') ? 'ğŸ”'
                           : planLower.includes('forward') ? 'ğŸ“¬'
                           : planLower.includes('core') ? 'ğŸ“ª'
                           : 'âœ‰ï¸';
          return `
          <div class="setup-select-card" onclick="startPlanSetup('${sub.subscriptionId}')">
            <div class="plan-icon">${icon}</div>
            <div class="plan-info">
              <div class="plan-title">${planLabel}</div>
              <div class="plan-meta">${billing}${amount ? ' Â· ' + amount : ''}</div>
            </div>
            <button class="setup-btn" onclick="event.stopPropagation();startPlanSetup('${sub.subscriptionId}')">
              Set Up â†’
            </button>
          </div>`;
        }).join('')}
      </div>
    </div>`;
}

function startPlanSetup(subscriptionId) {
  const sub = (STATE.allSubs || []).find(s => s.subscriptionId === subscriptionId);
  if (!sub) return;
  STATE.activeSub = sub;
  const switcher = qs('sub-switcher-area');
  renderSetup(sub, STATE.access);
}

// â”€â”€ Setup Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderSetup(sub, access) {
  const step = sub.setupStep;

  const switcher = qs('sub-switcher-area');

  const stepIndex = { plan_setup: 0, add_recipients: 1, pending_activation: 2 };
  const currentStep = stepIndex[step] ?? 0;


  // Back-to-plans only when 2+ plans are BOTH pending setup (plan_setup step)
  const pendingSetupCount = (STATE.allSubs || []).filter(s =>
    s.canAccess && s.setupRequired && s.setupStep === 'plan_setup'
  ).length;
  const backBtn = pendingSetupCount >= 2 ? `
    <button onclick="goBackToPlanSelection()"
      style="display:inline-flex;align-items:center;gap:5px;background:none;border:none;
             cursor:pointer;font-size:12px;color:var(--ink-4);font-family:inherit;
             padding:0;margin-bottom:12px;transition:color 0.15s"
      onmouseover="this.style.color='var(--ink)'" onmouseout="this.style.color='var(--ink-4)'">
      â† Back to plans
    </button>` : '';
  const returnBtn = '';

  const stepsHtml = [0,1,2].map((i, idx) => `
    <div class="step-dot ${i < currentStep ? 'done' : i === currentStep ? 'active' : ''}"></div>
    ${idx < 2 ? '<div class="step-line"></div>' : ''}
  `).join('');

  if (step === 'plan_setup') {
    await renderOnboardingForm(sub, access, stepsHtml, backBtn);
  } else if (step === 'add_recipients') {
    await renderAddRecipient(sub, access, stepsHtml, backBtn);
  } else if (step === 'pending_activation') {
    // Legacy step â€” recipients already active, show success
    renderOnboardingSuccess(sub.planCardId);
  }
}

function goBackToPlanSelection() {

  renderPlanSelection(STATE.access);
}

async function renderOnboardingForm(sub, access, stepsHtml, backBtn = '') {
  // Show loading state while fetching plan template
  qs('content-area').innerHTML = `
    <div class="onboarding" id="setup-section">
      <div class="onboard-header">
        ${backBtn}
        <div class="onboard-step">Step 1 of 3 â€” Plan Setup</div>
        <div class="onboard-title">Set up your mailbox</div>
      </div>
      <div class="onboard-card" style="padding:40px;text-align:center">
        <div class="shimmer-line" style="width:60%;margin:0 auto 12px"></div>
        <div class="shimmer-line med" style="width:40%;margin:0 auto"></div>
      </div>
    </div>`;

  // Fetch plan template + resolved locations
  let tmpl = null, locations = [];
  try {
    const productId = sub.productId || '';
    const res = await apiPost({ action: 'getPlanTemplate', uuid: STATE.uuid, productId });
    if (res.status === 'ok') {
      tmpl      = res.template   || null;
      locations = res.locations  || [];
      // Stash maxRecipients so step 2 can use it even before planCard is created
      if (tmpl && tmpl.maxRecipients) {
        STATE._pendingMaxRecipients = parseInt(tmpl.maxRecipients) || 1;
      }
    }
  } catch(e) { /* fallback to blank form */ }

  // â”€â”€ Plan feature flags from Plans sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const feature     = tmpl ? (tmpl.autoFeature || 'none').toLowerCase() : 'none';
  const isShip      = feature === 'ship';   // auto-forward letters 1st week of month
  const isScan      = feature === 'scan';   // scan + email on arrival (non-confidential)
  const isNone      = !isShip && !isScan;

  // â”€â”€ Plan identity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // planName from Plans sheet col A; limitType from col D ('monthly'|'yearly')
  const planLabel   = tmpl && tmpl.planName
    ? tmpl.planName.split('â€“')[0].trim()
    : (sub.planName || '').split('â€“')[0].trim() || 'Your Plan';

  const limitType   = tmpl ? (tmpl.limitType || '').toLowerCase() : '';
  const isYearly    = limitType === 'yearly' || sub.interval === 'year';
  const cycleLabel  = isYearly ? 'Yearly Plan' : 'Monthly Plan';
  // quota label shown in detail rows e.g. "60 letters / year"
  const quotaLabel  = isYearly ? 'year' : 'month';

  // â”€â”€ Limits & fees from Plans sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // mailLimit      col F â€” total letters for the plan term
  // mailStorageDays col M â€” days before shred/action
  // mailOverageFee  col G â€” fee per letter over limit
  // parcelsIncluded col H â€” total parcels for the plan term
  // parcelStorageDays col N â€” days before discard / fee
  // parcelOverageFee  col I â€” fee per parcel over limit
  // maxRecipients   col E â€” max names allowed on this plan
  const mailLimit     = parseInt(tmpl && tmpl.mailLimit        || 0);
  const parcelLimit   = parseInt(tmpl && tmpl.parcelsIncluded  || 0);
  const hasParcel     = parcelLimit > 0;
  const mailFee       = tmpl && parseFloat(tmpl.mailOverageFee)   > 0 ? '$' + parseFloat(tmpl.mailOverageFee).toFixed(2)   : null;
  const parcelFee     = tmpl && parseFloat(tmpl.parcelOverageFee) > 0 ? '$' + parseFloat(tmpl.parcelOverageFee).toFixed(2) : null;
  const mailStorage   = parseInt(tmpl && tmpl.mailStorageDays   || 30);
  const parcelStorage = parseInt(tmpl && tmpl.parcelStorageDays || 7);
  const maxRecipients = parseInt(tmpl && tmpl.maxRecipients     || 1);

  // â”€â”€ planMemo from Plans sheet col P â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Shown as a blurb above the plan detail table
  const planMemo    = tmpl && tmpl.planMemo ? String(tmpl.planMemo).trim() : '';

  // â”€â”€ Mail section rows â”€â”€
  const mailRows = [
    { label: 'Mail included',  value: mailLimit ? mailLimit + ' letters / ' + quotaLabel : 'Unlimited' },
    { label: 'Mail storage',   value: mailStorage + ' days' },
    { label: 'Mail overage',   value: mailFee ? mailFee + ' / letter' : 'N/A' },
  ];

  // â”€â”€ Parcel section rows â”€â”€
  const parcelRows = hasParcel ? [
    { label: 'Parcels included', value: parcelLimit + ' parcels / ' + quotaLabel },
    { label: 'Parcel storage',   value: parcelStorage + ' days' },
    { label: 'Parcel overage',   value: parcelFee ? parcelFee + ' / parcel' : 'N/A' },
  ] : [
    { label: 'Parcels', value: 'Not supported on this plan' },
  ];

  const renderRow = (r, last) => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;
      ${last ? '' : 'border-bottom:1px solid var(--border);'}font-size:12px">
      <span style="color:var(--ink-3)">${r.label}</span>
      <span style="font-weight:500;color:var(--ink)">${r.value}</span>
    </div>`;

  // planMemo blurb â€” shown right below plan title
  const memoHtml = planMemo ? `
    <div style="font-size:12px;color:var(--ink-3);line-height:1.6;padding:10px 14px;
      background:var(--bg);border-left:3px solid var(--border);border-radius:0 var(--radius-sm) var(--radius-sm) 0;
      margin-bottom:16px">${planMemo}</div>` : '';

  const summaryHtml = `
    <div style="margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <span style="font-size:12px;font-weight:600;color:var(--ink)">${planLabel}</span>
        <span style="font-size:11px;background:var(--bg-2);color:var(--ink-4);padding:2px 8px;
          border-radius:20px;font-weight:500">${cycleLabel}</span>
      </div>
      <div style="background:var(--bg);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:8px">
        <div style="font-size:10px;font-weight:600;color:var(--ink-4);text-transform:uppercase;
          letter-spacing:.05em;margin-bottom:8px">âœ‰ï¸ Mail</div>
        ${mailRows.map((r, i) => renderRow(r, i === mailRows.length - 1)).join('')}
      </div>
      <div style="background:var(--bg);border-radius:var(--radius-sm);padding:14px 16px">
        <div style="font-size:10px;font-weight:600;color:var(--ink-4);text-transform:uppercase;
          letter-spacing:.05em;margin-bottom:8px">ğŸ“¦ Parcels</div>
        ${parcelRows.map((r, i) => renderRow(r, i === parcelRows.length - 1)).join('')}
      </div>
    </div>`;

  // Location picker
  let locationHtml = '';
  if (locations.length === 0) {
    locationHtml = `<input type="hidden" id="ob-location" value="">`;
  } else if (locations.length === 1) {
    const loc = locations[0];
    const addr = [loc.address, loc.city, loc.province, loc.postalCode].filter(Boolean).join(', ');
    locationHtml = `
      <input type="hidden" id="ob-location" value="${loc.locationId}">
      <div class="form-group">
        <label>Your Virtual Office Address</label>
        <div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;font-size:13px">
          <div style="font-weight:600;color:var(--ink);margin-bottom:2px">${loc.name}</div>
          <div style="color:var(--ink-3)">${addr}</div>
          ${loc.hours ? `<div style="font-size:11px;color:var(--ink-4);margin-top:4px">ğŸ• ${loc.hours}</div>` : ''}
        </div>
        <div style="font-size:11px;color:var(--ink-4);margin-top:4px">This is the address registered mailbox address for this plan.</div>
      </div>`;
  } else {
    locationHtml = `
      <div class="form-group">
        <label>Select Your Location</label>
        <div style="display:flex;flex-direction:column;gap:10px" id="ob-location-list">
          ${locations.map((loc, i) => {
            const addr = [loc.address, loc.city, loc.province, loc.postalCode].filter(Boolean).join(', ');
            return `
            <label style="display:flex;align-items:flex-start;gap:10px;padding:12px 14px;border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:border-color .15s"
              onclick="document.querySelectorAll('#ob-location-list label').forEach(l=>l.style.borderColor='var(--border)');this.style.borderColor='var(--ink)';document.getElementById('ob-location').value='${loc.locationId}'">
              <input type="radio" name="ob-loc-radio" value="${loc.locationId}" ${i===0?'checked':''} style="margin-top:2px;accent-color:var(--ink)">
              <div>
                <div style="font-weight:600;font-size:13px;color:var(--ink)">${loc.name}</div>
                <div style="font-size:12px;color:var(--ink-3)">${addr}</div>
                ${loc.hours ? `<div style="font-size:11px;color:var(--ink-4);margin-top:2px">ğŸ• ${loc.hours}</div>` : ''}
              </div>
            </label>`;
          }).join('')}
        </div>
        <input type="hidden" id="ob-location" value="${locations[0].locationId}">
      </div>`;
  }

  // Forwarding address section â€” only for ship plans
  const fwdHtml = isShip ? `
    <div class="form-divider">Forwarding Address</div>
    <div style="font-size:12px;color:var(--ink-3);margin-bottom:14px;line-height:1.6">
      Your letters will be bundled and shipped to your forwarding address during the <strong>first week of every following month</strong>.
      <strong>All standard shipping fees are included in your plan.</strong>
      Confidential mail will never be forwarded, and parcels are not included.
      <br>
      <button type="button"
        onclick="var b=document.getElementById('conf-accordion');var a=document.getElementById('conf-arrow');if(b.style.display==='none'){b.style.display='block';a.style.transform='rotate(180deg)'}else{b.style.display='none';a.style.transform='rotate(0deg)'}"
        style="display:inline-flex;align-items:center;gap:5px;margin-top:8px;padding:5px 10px;
               background:none;border:1px solid var(--border);border-radius:20px;
               font-size:11px;color:var(--ink-3);cursor:pointer;font-family:inherit;
               transition:all .15s;line-height:1"
        onmouseover="this.style.borderColor='var(--ink-3)';this.style.color='var(--ink)'"
        onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--ink-3)'">
        <span style="font-size:11px">ğŸ“‹</span>
        What counts as confidential mail?
        <svg id="conf-arrow" width="10" height="10" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2.5"
          style="transition:transform .2s;flex-shrink:0"><polyline points="6 9 12 15 18 9"/></svg>
      </button>
      <div id="conf-accordion" style="display:none;margin-top:8px;padding:10px 12px;
           background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);
           font-size:11px;color:var(--ink-3);line-height:1.7">
        <strong style="display:block;margin-bottom:6px;color:var(--ink)">Confidential mail includes:</strong>
        <ul style="margin:0 0 8px;padding-left:16px">
          <li>Government-issued ID (passports, driver's licences, SIN cards)</li>
          <li>Credit, debit &amp; bank cards</li>
          <li>Any envelope that, when gently flexed, feels like it contains a rigid item â€” such as a credit card or government-issued ID like a driver's licence or passport</li>
        </ul>
        <p style="margin:0 0 8px;color:var(--ink-4)">
          These items are stored securely for in-person pickup and will <strong>never be forwarded</strong>.
          Forwarding may be arranged after you verify your identity with us in person at least once.
        </p>
        <p style="margin:0;color:var(--ink-4)">
          These provisions are in place to protect our clients and uphold the integrity of our service â€” ensuring our platform is never used as a vehicle for fraud, identity theft, or unauthorized handling of sensitive documents.
        </p>
      </div>
      <br><br>
      Most destinations (including <strong>Germany, United Kingdom, United States, France, Australia, the Netherlands</strong> and more)
      fall within standard international zones. No additional fees apply unless your shipment exceeds
      <strong>standard weight limits</strong> or incurs <strong>remote-area surcharges, customs duties, or carrier premiums</strong>,
      in which case we will contact you in advance for approval before dispatch.
      <br><br>
      <span style="color:var(--ink-4)">You may update your forwarding address anytime in your profile.</span>
    </div>
    <div class="form-group">
      <label>Street Address <span style="color:var(--red)">*</span></label>
      <input type="text" id="ob-addr" placeholder="123 Main Street" required>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>City <span style="color:var(--red)">*</span></label>
        <input type="text" id="ob-city" placeholder="Toronto" required>
      </div>
      <div class="form-group">
        <label>Province / State <span style="color:var(--red)">*</span></label>
        <input type="text" id="ob-province" placeholder="ON" required>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Postal / ZIP Code <span style="color:var(--red)">*</span></label>
        <input type="text" id="ob-postal" placeholder="M5H 2S3" required>
      </div>
      <div class="form-group">
        <label>Country <span style="color:var(--red)">*</span></label>
        <input type="text" id="ob-country" value="Canada" required>
      </div>
    </div>
    <div class="form-group">
      <label>Forwarding Instructions <span style="color:var(--ink-4)">(optional)</span></label>
      <textarea id="ob-instructions" placeholder="e.g. Leave in mailroom, buzz unit 4B on arrival..."></textarea>
    </div>` : `
    <input type="hidden" id="ob-addr" value="">
    <input type="hidden" id="ob-city" value="">
    <input type="hidden" id="ob-province" value="">
    <input type="hidden" id="ob-postal" value="">
    <input type="hidden" id="ob-country" value="">
    <input type="hidden" id="ob-instructions" value="">`;

  // Scan notice â€” only for scan plans
  const scanHtml = isScan ? `
    <div style="background:#E8F5EE;border:1px solid rgba(34,139,34,0.2);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:20px;display:flex;gap:10px;align-items:flex-start">
      <div style="font-size:18px;flex-shrink:0">ğŸ”</div>
      <div>
        <div style="font-size:13px;font-weight:600;color:#1a5c2a;margin-bottom:4px">Scan Plan â€” Digital Delivery</div>
        <div style="font-size:12px;color:#2d7a3a;line-height:1.5">
          Non-confidential letters will be scanned and emailed to <strong>${access.email || 'your registered email'}</strong> when they arrive.
          Confidential mail (e.g. credit cards, government ID) will <strong>not</strong> be scanned.
          Physical mail stays available for pickup for <strong>${mailStorage} days</strong>, then is discarded.
        </div>
      </div>
    </div>` : '';

  qs('content-area').innerHTML = `
    <div class="onboarding" id="setup-section">
      <div class="onboard-header">
        ${backBtn}
        <div class="onboard-step">Step 1 of 3 â€” Plan Setup</div>
        <div class="onboard-title">Set up your mailbox</div>
        <div class="onboard-sub">Configure your ${planLabel} plan.</div>
      </div>
      <div class="steps">${stepsHtml}</div>
      <div class="onboard-card">
        <form id="onboard-form">

          ${memoHtml}
          ${summaryHtml}
          ${scanHtml}

          <div class="form-divider">Mailbox Location</div>
          ${locationHtml}

          <div class="form-divider">Business Information</div>
          <div class="form-group">
            <label>Plan Nickname <span style="color:var(--red)">*</span></label>
            <input type="text" id="ob-friendly-name" placeholder="e.g. John's Company, Landscaping LTD" required>
            <div style="font-size:11px;color:var(--ink-4);margin-top:4px">A personal name for this mailbox. Shown instead of the plan name.</div>
          </div>
          <div class="form-group">
            <label>Business Description <span style="color:var(--ink-4)">(one sentence)</span> <span style="color:var(--red)">*</span></label>
            <input type="text" id="ob-biz" placeholder="e.g. Digital marketing agency serving SMBs" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>How did you hear about us? <span style="color:var(--red)">*</span></label>
              <select id="ob-referral" required>
                <option value="">Select...</option>
                <option>Google Search</option>
                <option>Referral</option>
                <option>Walk-in</option>
                <option>Social Media</option>
                <option>Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Which best describes you? <span style="color:var(--red)">*</span></label>
              <select id="ob-customer-type" required>
                <option value="">Select...</option>
                <option value="canadian">ğŸ‡¨ğŸ‡¦ Canadian Customer</option>
                <option value="us">ğŸ‡ºğŸ‡¸ U.S. Customer</option>
                <option value="international">ğŸŒ International Customer</option>
              </select>
            </div>
          </div>

          ${fwdHtml}

          <button type="submit" class="btn btn-primary btn-full" id="ob-submit">
            Save & Continue
          </button>
        </form>
      </div>
    </div>`;

  qs('onboard-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = qs('ob-submit');
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-spinner"></span> Saving...';

    const locationId = (qs('ob-location') && qs('ob-location').value) || '';
    if (!locationId && locations.length > 0) {
      toast('Please select a location.', 'error');
      btn.disabled = false; btn.innerHTML = 'Save & Continue'; return;
    }
    if (!qs('ob-friendly-name') || !qs('ob-friendly-name').value.trim()) {
      toast('Please enter a plan nickname.', 'error');
      btn.disabled = false; btn.innerHTML = 'Save & Continue'; return;
    }
    if (!qs('ob-biz') || !qs('ob-biz').value.trim()) {
      toast('Please enter a business description.', 'error');
      btn.disabled = false; btn.innerHTML = 'Save & Continue'; return;
    }
    if (!qs('ob-referral') || !qs('ob-referral').value) {
      toast('Please tell us how you heard about us.', 'error');
      btn.disabled = false; btn.innerHTML = 'Save & Continue'; return;
    }
    if (!qs('ob-customer-type') || !qs('ob-customer-type').value) {
      toast('Please select which best describes you.', 'error');
      btn.disabled = false; btn.innerHTML = 'Save & Continue'; return;
    }

    try {
      const result = await apiPost({
        action:              'submitOnboarding',
        uuid:                STATE.uuid,
        subscriptionId:      sub.subscriptionId,
        productId:           sub.productId || extractProductId(sub),
        locationId:          locationId,
        forwardingAddress:   qs('ob-addr') ? qs('ob-addr').value : '',
        forwardingCity:      qs('ob-city') ? qs('ob-city').value : '',
        forwardingProvince:  qs('ob-province') ? qs('ob-province').value : '',
        forwardingPostalCode:qs('ob-postal') ? qs('ob-postal').value : '',
        forwardingCountry:   qs('ob-country') ? qs('ob-country').value : '',
        forwardingInstructions: qs('ob-instructions') ? qs('ob-instructions').value : '',
        clientTimezone:      Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Toronto',
        businessDescription: qs('ob-biz') ? qs('ob-biz').value : '',
        referralSource:      qs('ob-referral') ? qs('ob-referral').value : '',
        customerType:        qs('ob-customer-type') ? qs('ob-customer-type').value : '',
        friendlyName:        qs('ob-friendly-name') ? qs('ob-friendly-name').value.trim() : ''
      });

      if (result.status === 'ok') {
        toast('Plan set up successfully!', 'success');
        // Update sub state to move to recipients step (no reload needed)
        sub.setupStep = 'add_recipients';
        sub.planCardId = result.planCardId;
        clearCachedAuth(STATE.uuid);
        // Go directly to recipient setup
        await renderSetup(sub, access);
      } else {
        throw new Error(result.message || 'Setup failed');
      }
    } catch (err) {
      toast(err.message, 'error');
      btn.disabled = false;
      btn.innerHTML = 'Save & Continue';
    }
  });
}

function extractProductId(sub) {
  // productId may not be in auth response â€” we get it from sub object
  // For now pass subscriptionId and let server look it up from billingDB
  return sub.productId || '';
}

async function renderAddRecipient(sub, access, stepsHtml, backBtn = '') {
  // Show loading skeleton while we resolve maxRecipients
  qs('content-area').innerHTML = `
    <div class="onboarding" id="setup-section">
      <div class="onboard-header">
        ${backBtn}
        <div class="onboard-step">Step 2 of 3 â€” Recipients</div>
        <div class="onboard-title">Who will receive mail at your virtual office?</div>
      </div>
      <div class="steps">${stepsHtml}</div>
      <div class="onboard-card">
        <div class="shimmer-line" style="width:80%;margin-bottom:10px"></div>
        <div class="shimmer-line med" style="width:60%"></div>
      </div>
    </div>`;

  // Resolve maxRecipients â€” try planCard first, then fetch template from Plans sheet
  let maxR = 1;
  let planCardId = sub.planCardId || '';

  // Try cached planCard
  const pc = STATE.planCard || (STATE.allPlanCards && STATE.allPlanCards[sub.subscriptionId]) || null;
  if (pc && pc.maxRecipients) {
    maxR = parseInt(pc.maxRecipients) || 1;
    if (pc.planCardId) planCardId = pc.planCardId;
  } else if (sub.productId) {
    // Fetch plan template to get maxRecipients from Plans sheet
    try {
      const res = await apiPost({ action: 'getPlanTemplate', uuid: STATE.uuid, productId: sub.productId });
      if (res.status === 'ok' && res.template && res.template.maxRecipients) {
        maxR = parseInt(res.template.maxRecipients) || 1;
      }
    } catch(e) { /* use default 1 */ }
  } else if (STATE._pendingMaxRecipients) {
    maxR = STATE._pendingMaxRecipients;
  }

  qs('content-area').innerHTML = `
    <div class="onboarding" id="setup-section">
      <div class="onboard-header">
        ${backBtn}
        <div class="onboard-step">Step 2 of 3 â€” Recipients</div>
        <div class="onboard-title">Who will receive mail at your virtual office?</div>
      </div>
      <div class="steps">${stepsHtml}</div>
      <div class="onboard-card">

        <!-- Intro copy -->
        <div style="margin-bottom:24px">
          <p style="font-size:13px;font-weight:600;color:var(--ink);margin:0 0 8px;line-height:1.5">
            Please list the individuals or businesses authorized to receive mail at your virtual office address.
          </p>
          <p style="font-size:12px;color:var(--ink-3);margin:0 0 10px;line-height:1.6">
            The names you provide will be used to:
          </p>
          <ul style="margin:0;padding-left:18px;font-size:12px;color:var(--ink-3);line-height:1.9">
            <li>Appear on all mail and package deliveries to your address</li>
            <li>Verify and authorize mail recipients on your account</li>
            <li>Ensure accurate, secure, and timely mail handling</li>
            <li>Prevent delays, returns, or rejected deliveries</li>
          </ul>
        </div>

        <!-- Plan capacity badge -->
        <div style="padding:12px 14px;background:var(--bg);border:1px solid var(--border);
                    border-radius:var(--radius-sm);margin-bottom:24px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
            <span style="font-size:16px">ğŸ‘¥</span>
            <span style="font-size:13px;font-weight:600;color:var(--ink)">
              Your plan supports up to ${maxR} recipient${maxR === 1 ? '' : 's'}
            </span>
          </div>
          <div style="font-size:12px;color:var(--ink-3);padding-left:24px">
            At least one recipient is required to activate your mailbox.
            ${maxR > 1 ? 'You can add the rest now or anytime later from your dashboard.' : ''}
          </div>
        </div>

        <!-- Recipient slots container -->
        <div id="rc-slots"></div>

        <!-- Add another button -->
        <div id="rc-add-wrap" style="margin-top:14px;display:${maxR > 1 ? 'block' : 'none'}">
          <button type="button" id="rc-add-btn"
            onclick="rcAddSlot()"
            style="display:flex;align-items:center;gap:6px;padding:10px 14px;background:none;
                   border:1px dashed var(--border);border-radius:var(--radius-sm);
                   font-size:12px;color:var(--ink-3);cursor:pointer;font-family:inherit;
                   transition:all .15s;width:100%;justify-content:center;box-sizing:border-box"
            onmouseover="this.style.borderColor='var(--ink-3)';this.style.color='var(--ink)'"
            onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--ink-3)'">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add another recipient
          </button>
        </div>

        <!-- Submit -->
        <button type="button" id="rc-submit"
          onclick="rcSubmit('${planCardId}')"
          class="btn btn-primary btn-full" style="margin-top:20px">
          Save Recipients &amp; Continue
        </button>

      </div>
    </div>`;

  window._rcMaxR  = maxR;
  window._rcCount = 0;
  rcAddSlot(); // render first required slot
}


function rcSlotHtml(i) {
  const isFirst = i === 0;
  const label   = isFirst
    ? `Recipient 1 <span style="color:var(--red)">*</span>`
    : `Recipient ${i + 1} <span style="font-weight:400;color:var(--ink-4)">(optional)</span>`;
  return `
    <div id="rc-slot-${i}" style="${i > 0 ? 'margin-top:14px;padding-top:14px;border-top:1px solid var(--border)' : ''}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-4)">${label}</div>
        ${i > 0 ? `<button type="button" onclick="rcRemoveSlot(${i})"
          style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--ink-4);
                 font-family:inherit;padding:2px 6px;border-radius:3px;transition:color .15s"
          onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--ink-4)'">
          âœ• Remove
        </button>` : ''}
      </div>
      <div class="form-row">
        <div class="form-group">
          <label id="rc-name-label-${i}">Full Name ${isFirst ? '<span style="color:var(--red)">*</span>' : '<span style="color:var(--ink-4)">(optional)</span>'}</label>
          <input type="text" id="rc-name-${i}" placeholder="${isFirst ? 'e.g. Jane Smith' : 'e.g. John Doe'}" ${isFirst ? 'required' : ''}
            oninput="rcCheckFullName(${i})">
          <div id="rc-name-hint-${i}" style="font-size:11px;color:var(--ink-4);margin-top:4px;display:none">
            Please enter both first and last name.
          </div>
        </div>
        <div class="form-group">
          <label>Type</label>
          <select id="rc-type-${i}" onchange="rcUpdateNameLabel(${i});rcCheckFullName(${i})">
            <option value="individual">Individual</option>
            <option value="company">Company / Business</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Language</label>
          <select id="rc-lang-${i}">
            <option value="en">English</option>
            <option value="fr">French</option>
          </select>
        </div>
      </div>
    </div>`;
}

function rcUpdateNameLabel(i) {
  const typeEl  = document.getElementById('rc-type-' + i);
  const labelEl = document.getElementById('rc-name-label-' + i);
  const nameEl  = document.getElementById('rc-name-' + i);
  if (!typeEl || !labelEl || !nameEl) return;
  const isFirst   = i === 0;
  const isCompany = typeEl.value === 'company';
  const reqSpan   = isFirst ? '<span style="color:var(--red)">*</span>' : '<span style="color:var(--ink-4)">(optional)</span>';
  if (isCompany) {
    labelEl.innerHTML = 'Company Name / DBA ' + reqSpan;
    nameEl.placeholder = 'e.g. Acme Corp';
  } else {
    labelEl.innerHTML = 'Full Name ' + reqSpan;
    nameEl.placeholder = i === 0 ? 'e.g. Jane Smith' : 'e.g. John Doe';
  }
}

function rcCheckFullName(i) {
  const nameEl  = document.getElementById('rc-name-' + i);
  const typeEl  = document.getElementById('rc-type-' + i);
  const hintEl  = document.getElementById('rc-name-hint-' + i);
  if (!nameEl || !hintEl) return;
  const isIndividual = !typeEl || typeEl.value === 'individual';
  const val = nameEl.value.trim();
  const twoWords = val.split(/\s+/).filter(Boolean).length >= 2;
  // Show hint only if individual, has typed something, but only one word
  hintEl.style.display = (isIndividual && val.length > 0 && !twoWords) ? 'block' : 'none';
}

function rcAddSlot() {
  const i       = window._rcCount;
  const maxR    = window._rcMaxR;
  const container = document.getElementById('rc-slots');
  if (!container || i >= maxR) return;

  // Don't allow adding a new slot if the previous one is empty (skip check for first slot)
  if (i > 0) {
    const prevName = document.getElementById('rc-name-' + (i - 1));
    if (prevName && !prevName.value.trim()) {
      toast('Please fill in the previous recipient first.', 'error');
      prevName.focus();
      return;
    }
  }

  container.insertAdjacentHTML('beforeend', rcSlotHtml(i));
  window._rcCount++;
  // Hide add button if at limit
  const addWrap = document.getElementById('rc-add-wrap');
  if (addWrap) addWrap.style.display = window._rcCount >= maxR ? 'none' : 'block';
  // Focus the new name field
  const nameEl = document.getElementById('rc-name-' + i);
  if (nameEl && i > 0) nameEl.focus();
}

function rcRemoveSlot(i) {
  const slot = document.getElementById('rc-slot-' + i);
  if (slot) slot.remove();
  window._rcCount--;
  // Show add button again
  const addWrap = document.getElementById('rc-add-wrap');
  if (addWrap) addWrap.style.display = 'block';
}

async function rcSubmit(planCardId) {
  const btn = document.getElementById('rc-submit');
  if (btn) { btn.disabled = true; btn.innerHTML = '<span class="btn-spinner"></span> Saving...'; }

  // Collect filled slots (only slots still in DOM) â€” no gaps allowed
  const recipients = [];
  let foundGap = false;
  let gapIndex = -1;
  for (let i = 0; i < window._rcMaxR; i++) {
    const nameEl = document.getElementById('rc-name-' + i);
    if (!nameEl) continue;
    const name = nameEl.value.trim();
    const typeEl = document.getElementById('rc-type-' + i);
    const isIndividual = !typeEl || typeEl.value === 'individual';

    if (!name) {
      foundGap = true;
      if (gapIndex === -1) gapIndex = i;
      continue;
    }

    // If there's a filled slot after a gap, block submission
    if (foundGap) {
      toast('Please fill in Recipient ' + (gapIndex + 1) + ' before adding more.', 'error');
      if (btn) { btn.disabled = false; btn.innerHTML = 'Save Recipients & Continue'; }
      const gapEl = document.getElementById('rc-name-' + gapIndex);
      if (gapEl) gapEl.focus();
      return;
    }

    // For individuals, require at least two words (first + last name)
    if (isIndividual && name.split(/\s+/).filter(Boolean).length < 2) {
      toast('Please enter a full name (first and last) for recipient ' + (i + 1) + '.', 'error');
      if (btn) { btn.disabled = false; btn.innerHTML = 'Save Recipients & Continue'; }
      nameEl.focus();
      return;
    }
    recipients.push({
      name,
      companyName:     '',
      type:            (document.getElementById('rc-type-' + i) || {}).value    || 'individual',
      language:        (document.getElementById('rc-lang-' + i) || {}).value    || 'en',
      notifyOnArrival: true
    });
  }

  if (recipients.length === 0) {
    toast('Please enter at least one recipient name.', 'error');
    if (btn) { btn.disabled = false; btn.innerHTML = 'Save Recipients & Continue'; }
    // Focus the first visible name field
    for (let i = 0; i < window._rcMaxR; i++) {
      const el = document.getElementById('rc-name-' + i);
      if (el) { el.focus(); break; }
    }
    return;
  }

  try {
    for (const rec of recipients) {
      const result = await apiPost({
        action:          'addRecipient',
        uuid:            STATE.uuid,
        planCardId:      planCardId,
        name:            rec.name,

        type:            rec.type,
        language:        rec.language,
        notifyOnArrival: rec.notifyOnArrival
      });
      if (result.status !== 'ok') throw new Error(result.message || 'Failed to add: ' + rec.name);
    }
    // Plan is now active â€” update state so switcher doesn't show setup again
    const activeSub = STATE.activeSub;
    if (activeSub) {
      activeSub.setupRequired = false;
      activeSub.setupStep = null;
      activeSub.banner = null;
      activeSub.planCardId = planCardId;
    }
    // Also update in allSubs array
    const subInAll = (STATE.allSubs || []).find(s => s.subscriptionId === activeSub?.subscriptionId);
    if (subInAll) {
      subInAll.setupRequired = false;
      subInAll.setupStep = null;
      subInAll.banner = null;
      subInAll.planCardId = planCardId;
    }
    clearCachedAuth(STATE.uuid);
    renderOnboardingSuccess(planCardId);
  } catch (err) {
    toast(err.message, 'error');
    if (btn) { btn.disabled = false; btn.innerHTML = 'Save Recipients & Continue'; }
  }
}


function renderOnboardingSuccess(planCardId) {
  // Check if there are other plans still needing setup (plan_setup step only)
  const allSubs   = STATE.allSubs || [];
  const nextPlans = allSubs.filter(s =>
    s.canAccess && s.setupRequired && s.setupStep === 'plan_setup'
  );

  const nextBtn = nextPlans.length > 0 ? `
    <div style="margin-top:12px;padding-top:16px;border-top:1px solid var(--border)">
      <p style="font-size:12px;color:var(--ink-3);margin:0 0 12px;line-height:1.6">
        You have <strong>${nextPlans.length} other plan${nextPlans.length > 1 ? 's' : ''}</strong>
        that ${nextPlans.length > 1 ? 'are' : 'is'} ready to be set up whenever you're ready.
      </p>
      <button onclick="renderPlanSelection(STATE.access)"
        class="btn btn-full"
        style="background:none;border:1px solid var(--border);color:var(--ink-3);
               font-size:13px;padding:10px;border-radius:var(--radius-sm);
               cursor:pointer;font-family:inherit;transition:all .15s"
        onmouseover="this.style.borderColor='var(--ink-3)';this.style.color='var(--ink)'"
        onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--ink-3)'">
        Set up another plan â†’
      </button>
    </div>` : '';

  qs('content-area').innerHTML = `
    <div class="onboarding" id="setup-section">
      <div class="onboard-card" style="text-align:center;padding:40px 28px">

        <div style="width:56px;height:56px;border-radius:50%;background:#e8f5e9;
                    display:flex;align-items:center;justify-content:center;
                    margin:0 auto 20px;font-size:26px">âœ…</div>

        <div style="font-size:22px;font-weight:700;color:var(--ink);margin-bottom:8px">
          You're all set!
        </div>
        <div style="font-size:13px;color:var(--ink-3);line-height:1.7;margin-bottom:24px;max-width:340px;margin-left:auto;margin-right:auto">
          Your mailbox is active and ready to receive mail.
          Our team will notify you as soon as your first piece of mail arrives.
        </div>

        <button onclick="clearCachedAuth(STATE.uuid); location.reload();"
          class="btn btn-primary btn-full" style="font-size:14px;padding:13px">
          Go to My Dashboard
        </button>

        ${nextBtn}

      </div>
    </div>`;


}


function extractProductId(sub) {
  return sub.productId || '';
}

// â”€â”€ Skeleton HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skeletonCard(lines = 2) {
  const bars = Array(lines).fill(0).map((_, i) =>
    `<div style="height:${i===0?'28px':'12px'};width:${i===0?'40%':Math.floor(50+Math.random()*40)+'%'};background:var(--bg-2);border-radius:4px;margin-bottom:8px;animation:pulse 1.4s ease infinite ${i*0.15}s"></div>`
  ).join('');
  return `<div style="padding:16px">${bars}</div>`;
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderDashboard(sub, access) {
  // Guard: prevent concurrent double-calls (e.g. from switcher re-render race)
  if (renderDashboard._running) return;
  renderDashboard._running = true;
  try { await _renderDashboardInner(sub, access); } finally { renderDashboard._running = false; }
}
async function _renderDashboardInner(sub, access) {
  // Render shell + skeleton instantly
  qs('content-area').innerHTML = `
    <div id="tabs-bar" class="tabs-bar-wrap">
      <div class="tabs">
        <button class="tab active" id="tab-mail"  onclick="switchTab('mail')">Mail</button>
        <button class="tab"        id="tab-plans" onclick="switchTab('plans')">My Plan</button>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <span class="refresh-ts" id="mail-refresh-ts"  style="display:none"></span>
        <span class="refresh-ts" id="plans-refresh-ts" style="display:none"></span>
        <button class="refresh-btn" id="refresh-mail-btn"
          onclick="clientRefresh('mail')" style="display:none">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
          </svg>
          Refresh
        </button>
        <button class="refresh-btn" id="refresh-plans-btn"
          onclick="clientRefresh('plans')" style="display:none">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
          </svg>
          Refresh
        </button>
      </div>
    </div>
    <div id="tab-mail-content" class="main">
      <div id="mail-log-area">${skeletonCard(3)}</div>
    </div>
    <div id="tab-plans-content" class="main" style="display:none">
      <div id="plans-area">${skeletonCard(2)}</div>
    </div>`;

  _restoreRefreshTs(); // restore timestamps after shell rebuild

  // Load data in parallel
  const [mailRes, planRes, agentsRes, recsRes] = await Promise.allSettled([
    apiPost({ action:'getMailLog',   uuid:STATE.uuid, subscriptionId:sub.subscriptionId }),
    apiPost({ action:'getPlanCard',  uuid:STATE.uuid, subscriptionId:sub.subscriptionId }),
    apiPost({ action:'getAgents',    uuid:STATE.uuid, subscriptionId:sub.subscriptionId }),
    apiPost({ action:'getRecipients',uuid:STATE.uuid, subscriptionId:sub.subscriptionId })
  ]);

  const mailLog    = mailRes.status    === 'fulfilled' && mailRes.value.status    === 'ok' ? mailRes.value.mailLog    || [] : [];
  const planCard   = planRes.status    === 'fulfilled' && planRes.value.status    === 'ok' ? planRes.value.planCard   || null : null;
  const agents     = agentsRes.status  === 'fulfilled' && agentsRes.value.status  === 'ok' ? agentsRes.value.agents   || [] : [];
  const recipients = recsRes.status    === 'fulfilled' && recsRes.value.status    === 'ok' ? recsRes.value.recipients || [] : [];

  STATE.mailLog    = mailLog;
  STATE.planCard   = planCard;
  STATE.agents     = agents;
  STATE.recipients = recipients;
  if (!STATE.allPlanCards) STATE.allPlanCards = {};
  if (planCard) {
    STATE.allPlanCards[sub.subscriptionId] = planCard;
    renderSubscriptionSwitcher(STATE.access); // re-render now that friendlyName is loaded
  }

  const now = new Date().toLocaleTimeString('en-CA', { hour:'2-digit', minute:'2-digit' });
  _setRefreshTs('mail-refresh-ts', now);
  _setRefreshTs('plans-refresh-ts', now);
  // Show correct refresh button for active tab
  const _rbMail  = qs('refresh-mail-btn');
  const _rbPlan  = qs('refresh-plans-btn');
  if (_rbMail)  _rbMail.style.display  = _activeTab === 'mail'  ? '' : 'none';
  if (_rbPlan)  _rbPlan.style.display  = _activeTab === 'plans' ? '' : 'none';

  buildMailLog(sub, access, mailLog, planCard, agents, recipients);
  buildPlanCard(sub, access, planCard, recipients);
}

let _activeTab = 'mail';
const _tsStore = { mail: '', plans: '' };
function switchTab(tab) {
  _activeTab = tab;
  const mailC  = qs('tab-mail-content');
  const plansC = qs('tab-plans-content');
  const tabM   = qs('tab-mail');
  const tabP   = qs('tab-plans');
  const mailTs  = qs('mail-refresh-ts');
  const planTs  = qs('plans-refresh-ts');
  const mailBtn  = qs('refresh-mail-btn');
  const plansBtn = qs('refresh-plans-btn');
  if (mailC)  mailC.style.display  = tab === 'mail'  ? '' : 'none';
  if (plansC) plansC.style.display = tab === 'plans' ? '' : 'none';
  if (tabM)  tabM.classList.toggle('active',  tab === 'mail');
  if (tabP)  tabP.classList.toggle('active',  tab === 'plans');
  if (mailTs)  mailTs.style.display  = (tab === 'mail'  && _tsStore.mail)  ? '' : 'none';
  if (planTs)  planTs.style.display  = (tab === 'plans' && _tsStore.plans) ? '' : 'none';
  if (mailBtn)  mailBtn.style.display  = tab === 'mail'  ? '' : 'none';
  if (plansBtn) plansBtn.style.display = tab === 'plans' ? '' : 'none';
}

// â”€â”€ Refresh helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _setRefreshBtn(btnId, spinning) {
  const btn = qs(btnId);
  if (!btn) return;
  btn.disabled = spinning;
  btn.classList.toggle('spinning', spinning);
  btn.querySelector('svg') && null; // trigger reflow handled by CSS
}

function _setRefreshTs(tsId, text) {
  const key = tsId === 'mail-refresh-ts' ? 'mail' : 'plans';
  _tsStore[key] = text || '';
  const el = qs(tsId);
  if (!el) return;
  el.textContent = text ? 'Updated ' + text : '';
  // Only show if this tab is currently active
  const activeKey = _activeTab === 'mail' ? 'mail-refresh-ts' : 'plans-refresh-ts';
  el.style.display = (text && tsId === activeKey) ? '' : 'none';
}

function _restoreRefreshTs() {
  const mailEl  = qs('mail-refresh-ts');
  const plansEl = qs('plans-refresh-ts');
  if (mailEl)  { mailEl.textContent  = _tsStore.mail  ? 'Updated ' + _tsStore.mail  : ''; mailEl.style.display  = (_tsStore.mail  && _activeTab === 'mail')  ? '' : 'none'; }
  if (plansEl) { plansEl.textContent = _tsStore.plans ? 'Updated ' + _tsStore.plans : ''; plansEl.style.display = (_tsStore.plans && _activeTab === 'plans') ? '' : 'none'; }
}

async function clientRefresh(tab) {
  const sub = STATE.activeSub;
  if (!sub) return;
  if (tab === 'mail') {
    _setRefreshBtn('refresh-mail-btn', true);
    await _doRefreshMailLog(sub);
    _setRefreshBtn('refresh-mail-btn', false);
  } else {
    _setRefreshBtn('refresh-plans-btn', true);
    // Re-fetch planCard + recipients
    try {
      const [pcRes, recRes] = await Promise.all([
        apiPost({ action:'getPlanCard', uuid:STATE.uuid, subscriptionId:sub.subscriptionId }),
        apiPost({ action:'getRecipients', uuid:STATE.uuid, subscriptionId:sub.subscriptionId })
      ]);
      if (pcRes.planCard) {
        STATE.planCard = pcRes.planCard;
        STATE.allPlanCards[sub.subscriptionId] = pcRes.planCard;
        renderSubscriptionSwitcher(STATE.access);
      }
      if (recRes.recipients) STATE.recipients = recRes.recipients;
      buildPlanCard(sub, STATE.access, STATE.planCard, STATE.recipients);
      _setRefreshTs('plans-refresh-ts', new Date().toLocaleTimeString('en-CA',{hour:'2-digit',minute:'2-digit'}));
    } catch(e) { toast('Failed to refresh plan', 'error'); }
    _setRefreshBtn('refresh-plans-btn', false);
  }
}

async function _doRefreshMailLog(sub) {
  const area = qs('mail-log-area');
  if (area) area.innerHTML = skeletonCard(3);
  try {
    const r = await apiPost({ action:'getMailLog', uuid:STATE.uuid, subscriptionId:sub.subscriptionId });
    if (r.status === 'ok') {
      STATE.mailLog = r.mailLog || [];
      buildMailLog(sub, STATE.access, STATE.mailLog, STATE.planCard, STATE.agents, STATE.recipients);
      _setRefreshTs('mail-refresh-ts', new Date().toLocaleTimeString('en-CA',{hour:'2-digit',minute:'2-digit'}));
    }
  } catch(e) { toast('Failed to refresh mail log', 'error'); }
}

// â”€â”€ getPlanFriendlyName â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPlanFriendlyName(s) {
  const pc = STATE.allPlanCards && STATE.allPlanCards[s.subscriptionId];
  const friendly = pc && pc.friendlyName ? pc.friendlyName.trim() : '';
  if (friendly && !friendly.startsWith('TEMP:')) return friendly;
  return (s.planName || '').split('â€“')[0].trim() || s.subscriptionId.slice(-8);
}

// â”€â”€ buildPlanCard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPlanCard(sub, access, pc, recipients) {
  const billing  = pc ? (pc.billingCycle === 'yearly' || pc.billingCycle === 'year' || sub.interval === 'year' ? 'Annual' : 'Monthly') : (sub.interval === 'year' ? 'Annual' : 'Monthly');
  const safeId   = (sub.subscriptionId || sub.planCardId || 'plan').replace(/[^a-zA-Z0-9_-]/g, '_');

  const officialPlanName = ((pc && pc.planName) || sub.planName || 'â€”').split('â€“')[0].trim();
  const friendlyPlanName = (pc && pc.friendlyName && !pc.friendlyName.startsWith('TEMP:'))
    ? pc.friendlyName.trim() : null;
  const planName = friendlyPlanName || officialPlanName;

  // Address
  const officeAddr = pc && pc.locationAddress
    ? [pc.locationAddress, pc.locationCity, pc.locationProvince, pc.locationPostal].filter(Boolean).join(', ')
    : '448 Gibraltar Dr, Unit 100, Mississauga, ON L5T 2N8';

  // Usage
  const mailLimit   = pc ? (parseInt(pc.mailLimit)   || 0) : 0;
  const parcelLimit = pc ? (parseInt(pc.parcelLimit)  || 0) : 0;
  const mailsUsed   = pc ? (parseInt(pc.mailsUsed)    || 0) : 0;
  const parcelsUsed = pc ? (parseInt(pc.parcelsUsed)  || 0) : 0;
  const mailPct     = mailLimit   ? Math.min(100, Math.round(mailsUsed   / mailLimit   * 100)) : 0;
  const parcelPct   = parcelLimit ? Math.min(100, Math.round(parcelsUsed / parcelLimit * 100)) : 0;
  const barClass    = pct => pct < 60 ? 'safe' : pct < 85 ? 'warn' : 'danger';

  // Forwarding
  const hasFwd  = pc && pc.autoFeature === 'ship';
  const fwdAddr = pc ? [pc.forwardingAddress, pc.forwardingCity, pc.forwardingProvince, pc.forwardingPostalCode, pc.forwardingCountry].filter(Boolean).join(', ') : '';

  // Recipients â€” temps don't count toward slot allotment
  const maxR     = pc ? (parseInt(pc.maxRecipients) || 1) : 1;
  const activeR  = recipients.filter(r => r.status === 'active' && !(r.notes && r.notes.startsWith('TEMP:'))).length;
  const pendingR = recipients.filter(r => r.status !== 'active' && !(r.notes && r.notes.startsWith('TEMP:'))).length;
  const canAddR  = activeR < maxR;

  const _regRecs  = recipients.filter(r => !(r.notes && r.notes.startsWith('TEMP:')));
  const _tempRecs = recipients.filter(r =>   r.notes && r.notes.startsWith('TEMP:'));
  const allRecs   = [..._regRecs, ..._tempRecs];

  // â”€â”€ Plan header â”€â”€
  const planHeaderHtml = `
    <div class="card" style="padding:0;margin-bottom:16px;overflow:hidden">
      <div style="background:linear-gradient(135deg,#6B1414 0%,#8B1A1A 100%);padding:24px 24px 20px">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
          <div style="min-width:0">
            <div id="fname-display-wrap-${safeId}" style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
              <div id="fname-display-${safeId}" style="font-family:'DM Serif Display',serif;font-size:22px;color:#fff;letter-spacing:-0.3px;line-height:1.2">${planName}</div>
              <button onclick="openFriendlyNameEdit('${pc ? pc.planCardId : ''}','${safeId}')"
                title="Edit nickname"
                style="background:rgba(255,255,255,0.1);border:none;cursor:pointer;padding:4px 6px;border-radius:5px;color:rgba(255,255,255,0.5);transition:all .15s;flex-shrink:0"
                onmouseover="this.style.background='rgba(255,255,255,0.2)';this.style.color='#fff'" onmouseout="this.style.background='rgba(255,255,255,0.1)';this.style.color='rgba(255,255,255,0.5)'">
                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </button>
            </div>
            <div id="fname-edit-${safeId}" style="display:none;align-items:center;gap:6px;margin-bottom:6px">
              <input id="fname-input-${safeId}" type="text" placeholder="e.g. Main Corp"
                style="font-size:13px;padding:5px 10px;border:1px solid rgba(255,255,255,0.25);border-radius:var(--radius-sm);font-family:inherit;width:180px;background:rgba(0,0,0,0.15);color:#fff"
                onkeydown="if(event.key==='Enter')saveFriendlyName('${pc ? pc.planCardId : ''}','${safeId}');if(event.key==='Escape')closeFriendlyNameEdit('${safeId}')">
              <button id="fname-save-${safeId}" onclick="saveFriendlyName('${pc ? pc.planCardId : ''}','${safeId}')"
                style="font-size:11px;padding:5px 12px;background:#fff;color:var(--ink);border:none;border-radius:var(--radius-sm);cursor:pointer;font-family:inherit;font-weight:600">Save</button>
              <button onclick="closeFriendlyNameEdit('${safeId}')"
                style="font-size:11px;padding:5px 8px;background:rgba(255,255,255,0.1);border:none;border-radius:var(--radius-sm);cursor:pointer;font-family:inherit;color:rgba(255,255,255,0.6)">âœ•</button>
            </div>
            ${friendlyPlanName ? `<div style="font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:4px">${officialPlanName}</div>` : ''}
            <div style="font-size:12px;color:rgba(255,255,255,0.5)">${billing}${sub.planAmountFormatted ? ' Â· ' + sub.planAmountFormatted : ''}${pc && pc.currentPeriodEnd ? ' Â· Renews ' + (() => { const d = new Date(pc.currentPeriodEnd + 'T00:00:00'); d.setDate(d.getDate() + 1); return d.toLocaleDateString('en-CA',{month:'short',day:'numeric',year:'numeric'}); })() : ''}</div>
          </div>
          <span style="font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;background:rgba(26,107,60,0.35);color:#6ee08a;border:1px solid rgba(110,224,138,0.25);white-space:nowrap;flex-shrink:0;margin-top:2px">${pc && pc.status === 'active' ? 'â— Active' : pc ? pc.status : 'Active'}</span>
        </div>
      </div>
      <!-- Address bar -->
      <div id="copy-addr-box-${safeId}" onclick="copyAddress('${safeId}')"
        style="padding:12px 20px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:background .12s;background:var(--white)"
        onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background='var(--white)'">
        <div style="min-width:0">
          <div style="font-size:10px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:2px">Your Mailbox Address</div>
          <div id="copy-addr-text-${safeId}" style="font-size:13px;color:var(--ink);font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${officeAddr}</div>
        </div>
        <div id="copy-addr-icon-${safeId}" style="margin-left:16px;flex-shrink:0;color:var(--ink-4);display:flex;align-items:center;gap:4px;font-size:11px">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
          Copy
        </div>
      </div>
    </div>`;

  // â”€â”€ Usage stats â”€â”€
  const statsHtml = (mailLimit > 0 || parcelLimit > 0) ? `
    <div class="stats-row" style="margin-bottom:16px">
      ${mailLimit > 0 ? `
      <div class="stat-card ${barClass(mailPct) === 'safe' ? 'green' : barClass(mailPct) === 'warn' ? 'amber' : 'accent'}">
        <div class="stat-label">Mail Used</div>
        <div class="stat-value">${mailsUsed}</div>
        <div class="stat-sub">of <strong>${mailLimit}</strong> included</div>
        <div class="usage-bar"><div class="usage-bar-fill ${barClass(mailPct)}" style="width:${mailPct}%"></div></div>
      </div>` : ''}
      ${parcelLimit > 0 ? `
      <div class="stat-card ${barClass(parcelPct) === 'safe' ? 'green' : barClass(parcelPct) === 'warn' ? 'amber' : 'accent'}">
        <div class="stat-label">Parcels Used</div>
        <div class="stat-value">${parcelsUsed}</div>
        <div class="stat-sub">of <strong>${parcelLimit}</strong> included</div>
        <div class="usage-bar"><div class="usage-bar-fill ${barClass(parcelPct)}" style="width:${parcelPct}%"></div></div>
      </div>` : ''}
      <div class="stat-card blue">
        <div class="stat-label">Recipients</div>
        <div class="stat-value">${activeR}</div>
        <div class="stat-sub">of <strong>${maxR}</strong> slots${pendingR > 0 ? ' Â· ' + pendingR + ' pending' : ''}</div>
      </div>
    </div>` : `
    <div class="stats-row" style="margin-bottom:16px">
      <div class="stat-card blue">
        <div class="stat-label">Recipients</div>
        <div class="stat-value">${activeR}</div>
        <div class="stat-sub">of <strong>${maxR}</strong> slots${pendingR > 0 ? ' Â· ' + pendingR + ' pending' : ''}</div>
      </div>
    </div>`;

  // â”€â”€ Forwarding â”€â”€
  const fwdHtml = hasFwd && fwdAddr ? `
    <div class="card" style="padding:14px 16px;margin-bottom:16px">
      <div style="font-size:10px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px">ğŸ“¬ Forwarding Address</div>
      <div style="font-size:13px;color:var(--ink-2)">${fwdAddr}</div>
    </div>` : '';

  // â”€â”€ Recipient rows â”€â”€
  const recItemsHtml = allRecs.length > 0 ? allRecs.map(r => {
    const isTemp   = r.notes && r.notes.startsWith('TEMP:');
    const initials = (r.name || '?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
    const typeLabel = r.type === 'company' ? 'Company' : 'Individual';
    const langLabel = r.language === 'fr' ? 'FR' : 'EN';
    return `
      <div class="recipient-item">
        <div class="recipient-avatar">${initials}</div>
        <div class="recipient-info">
          <div class="recipient-name">${r.name || 'â€”'}</div>
          <div class="recipient-company">${typeLabel} Â· ${langLabel}</div>
        </div>
        <div class="recipient-status">
          ${r.status === 'active'
            ? '<span class="pill scanned">Active</span>'
            : isTemp
              ? '<span class="pill stored">Pending</span>'
              : '<span class="pill stored">Inactive</span>'}
        </div>
      </div>`;
  }).join('') : `
    <div style="padding:24px 0;text-align:center;color:var(--ink-4)">
      <div style="font-size:22px;margin-bottom:6px">ğŸ‘¤</div>
      <div style="font-size:13px">No recipients yet</div>
    </div>`;

  // â”€â”€ Add recipient form â€” matches onboarding style â”€â”€
  const addRecipientForm = canAddR ? `
    <div style="border-top:1px solid var(--border);margin-top:4px;padding-top:16px">
      <div style="font-size:11px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.06em;margin-bottom:14px">Add Recipient</div>
      <div class="form-row" style="margin-bottom:12px">
        <div class="form-group" style="margin-bottom:0">
          <label>Full Name <span style="color:var(--red)">*</span></label>
          <input type="text" id="ar-name-${safeId}" placeholder="e.g. Jane Smith" required
            oninput="arCheckName('${safeId}')">
          <div id="ar-name-hint-${safeId}" style="font-size:11px;color:var(--ink-4);margin-top:3px;display:none">Please enter both first and last name.</div>
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label>Type</label>
          <select id="ar-type-${safeId}" onchange="arUpdateLabel('${safeId}')">
            <option value="individual">Individual</option>
            <option value="company">Company / Business</option>
          </select>
        </div>
      </div>
      <div class="form-group" style="margin-bottom:14px">
        <label>Language</label>
        <select id="ar-lang-${safeId}" style="width:50%">
          <option value="en">English</option>
          <option value="fr">French</option>
        </select>
      </div>
      <button type="button" id="ar-btn-${safeId}"
        onclick="submitAddRecipient(event,'${sub.subscriptionId}','${safeId}')"
        class="btn btn-primary" style="width:100%">
        + Add Recipient
      </button>
    </div>` : `
    <div style="border-top:1px solid var(--border);margin-top:4px;padding-top:14px;text-align:center;font-size:12px;color:var(--ink-4)">
      Recipient limit reached (${maxR} / ${maxR})
    </div>`;

  const recsHtml = `
    <div style="margin-bottom:16px">
      <div class="section-header">
        <span class="section-title">Recipients <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:12px;color:var(--ink-4)">${activeR} / ${maxR}</span></span>
      </div>
      <div class="card" style="padding:8px 16px 4px">
        <div class="recipient-list">${recItemsHtml}</div>
        ${addRecipientForm}
        <div style="padding-bottom:12px"></div>
      </div>
    </div>`;

  const planHtml = planHeaderHtml + statsHtml + fwdHtml + recsHtml + buildAgentsSection(sub, pc);

  const plansArea = qs('plans-area');
  if (plansArea) {
    plansArea.innerHTML = planHtml;
    attachPlanCardListeners(sub, pc);
  }

  return planHtml;
}


function attachPlanCardListeners(sub, pc) {
  // Add recipient form submission
  const safeId = (sub.subscriptionId || '').replace(/[^a-zA-Z0-9_-]/g, '_');
  const form = document.getElementById('add-rec-form-' + safeId);
  if (form) {
    form.addEventListener('submit', (e) => submitAddRecipient(e, sub.subscriptionId, safeId));
  }
}

async function submitAddRecipient(e, subscriptionId, safeId) {
  e.preventDefault ? e.preventDefault() : null;
  const nameEl = document.getElementById('ar-name-' + safeId);
  const typeEl = document.getElementById('ar-type-' + safeId);
  const langEl = document.getElementById('ar-lang-' + safeId);
  const btnEl  = document.getElementById('ar-btn-' + safeId);
  const name   = nameEl ? nameEl.value.trim() : '';
  const type   = typeEl ? typeEl.value : 'individual';
  const lang   = langEl ? langEl.value : 'en';

  if (!name) { toast('Please enter a name.', 'error'); return; }

  // Validate full name for individuals
  if (type === 'individual' && name.split(/\s+/).filter(Boolean).length < 2) {
    toast('Please enter both first and last name.', 'error');
    if (nameEl) nameEl.focus();
    return;
  }

  const pc = STATE.allPlanCards && STATE.allPlanCards[subscriptionId];
  const planCardId = pc ? pc.planCardId : (STATE.planCard ? STATE.planCard.planCardId : '');

  if (btnEl) { btnEl.disabled = true; btnEl.innerHTML = '<span class="btn-spinner"></span> Adding...'; }

  try {
    const result = await apiPost({
      action:          'addRecipient',
      uuid:            STATE.uuid,
      planCardId:      planCardId,
      name:            name,
      type:            type,
      language:        lang,
      notifyOnArrival: true
    });
    if (result.status !== 'ok') throw new Error(result.message || 'Failed');
    toast('Recipient added!', 'success');
    if (nameEl) nameEl.value = '';
    // Refresh recipients
    const rRes = await apiPost({ action:'getRecipients', uuid:STATE.uuid, subscriptionId });
    if (rRes.status === 'ok') {
      STATE.recipients = rRes.recipients || [];
      const sub = (STATE.allSubs||[]).find(s=>s.subscriptionId===subscriptionId) || STATE.activeSub;
      buildPlanCard(sub, STATE.access, pc, STATE.recipients);
    }
  } catch(err) {
    toast(err.message, 'error');
    if (btnEl) { btnEl.disabled = false; btnEl.innerHTML = '+ Add Recipient'; }
  }
}

function arCheckName(safeId) {
  const nameEl = document.getElementById('ar-name-' + safeId);
  const typeEl = document.getElementById('ar-type-' + safeId);
  const hintEl = document.getElementById('ar-name-hint-' + safeId);
  if (!nameEl || !hintEl) return;
  const isInd = !typeEl || typeEl.value === 'individual';
  const val   = nameEl.value.trim();
  hintEl.style.display = (isInd && val.length > 0 && val.split(/\s+/).filter(Boolean).length < 2) ? 'block' : 'none';
}

function arUpdateLabel(safeId) {
  arCheckName(safeId);
}

function copyAddress(safeId) {
  const el = document.getElementById('copy-addr-text-' + safeId);
  const icon = document.getElementById('copy-addr-icon-' + safeId);
  const box = document.getElementById('copy-addr-box-' + safeId);
  if (!el) return;
  navigator.clipboard.writeText(el.textContent).then(() => {
    if (box)  { box.style.borderColor = 'var(--green)'; box.style.background = '#E8F5EE'; }
    if (icon) icon.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Copied âœ“';
    setTimeout(() => {
      if (box)  { box.style.borderColor = 'var(--border)'; box.style.background = 'var(--bg)'; }
      if (icon) icon.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy';
    }, 2000);
  }).catch(() => toast('Copy failed', 'error'));
}

// â”€â”€ buildAgentsSection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildAgentsSection(sub, pc) {
  const agents = STATE.agents || [];
  const safeId = 'agents_global';
  const maxAgents = 5;
  const canAdd = agents.length < maxAgents;
  const planCardId = pc ? pc.planCardId : '';
  const locationId = pc ? pc.locationId : '';

  // Banner for first-time setup
  const noBanner = agents.length === 0 ? `
    <div style="background:#FFF8E1;border:1px solid #FFE082;border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:14px;display:flex;align-items:flex-start;gap:10px">
      <div style="font-size:18px;flex-shrink:0;margin-top:1px">ğŸªª</div>
      <div>
        <div style="font-size:13px;font-weight:600;color:#5D4037;margin-bottom:3px">No pickup agents registered</div>
        <div style="font-size:12px;color:#795548;line-height:1.5">Register anyone authorized to pick up mail on your behalf. You (the account holder) can always pick up your own mail â€” this is for additional people like assistants, employees, or family members.</div>
      </div>
    </div>` : '';

  // Agent list
  const idTypeLabels = { drivers_license: "Driver's License", passport: 'Passport', health_card: 'Health Card', other: 'Other ID' };
  const agentItems = agents.map(a => {
    const initials = (a.name || '?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
    const idLabel = a.idType ? (idTypeLabels[a.idType] || a.idType) : '';
    const id4 = a.idLast4 ? ` Â·Â·Â·Â·${a.idLast4}` : '';
    const details = [idLabel ? idLabel + id4 : '', a.phone, a.notes].filter(Boolean).join(' Â· ');
    return `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;${agents.indexOf(a) > 0 ? 'border-top:1px solid var(--border);' : ''}">
        <div style="display:flex;align-items:center;gap:10px;min-width:0">
          <div style="width:32px;height:32px;border-radius:50%;background:#E3F2FD;color:#1565C0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0">${initials}</div>
          <div style="min-width:0">
            <div style="font-size:13px;font-weight:600;color:var(--ink)">${a.name}</div>
            <div style="font-size:11px;color:var(--ink-4)">${details || 'No details provided'}</div>
          </div>
        </div>
        <button onclick="removeAgent('${a.agentId}')"
          style="background:none;border:none;cursor:pointer;font-size:11px;color:var(--ink-4);padding:4px 8px;border-radius:4px;transition:all .15s;flex-shrink:0"
          onmouseover="this.style.color='var(--red)';this.style.background='#FFF0F0'" onmouseout="this.style.color='var(--ink-4)';this.style.background='none'">
          âœ• Remove
        </button>
      </div>`;
  }).join('');

  // Add agent form (hidden when at max) â€” compact inline design
  const addForm = canAdd ? `
    <div id="agt-form-wrap-${safeId}" style="border-top:1px solid var(--border);margin-top:4px;padding-top:12px">
      <button id="agt-toggle-${safeId}" onclick="document.getElementById('agt-form-${safeId}').style.display='block';this.style.display='none'"
        style="display:flex;align-items:center;gap:6px;width:100%;padding:10px;background:none;border:1px dashed var(--border);border-radius:var(--radius-sm);
               font-size:12px;color:var(--ink-3);cursor:pointer;font-family:inherit;justify-content:center;transition:all .15s;box-sizing:border-box"
        onmouseover="this.style.borderColor='var(--ink-3)';this.style.color='var(--ink)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--ink-3)'">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Register pickup agent
      </button>
      <div id="agt-form-${safeId}" style="display:none">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
          <div>
            <label style="font-size:11px;font-weight:600;color:var(--ink-3);display:block;margin-bottom:4px">Full Name <span style="color:var(--red)">*</span></label>
            <input type="text" id="agt-name-${safeId}" placeholder="First Last" style="width:100%;box-sizing:border-box"
              oninput="agtCheckName('${safeId}')">
            <div id="agt-name-hint-${safeId}" style="font-size:10px;color:var(--red);margin-top:2px;display:none">Enter first and last name</div>
          </div>
          <div>
            <label style="font-size:11px;font-weight:600;color:var(--ink-3);display:block;margin-bottom:4px">Phone</label>
            <input type="text" id="agt-phone-${safeId}" placeholder="416-555-1234" style="width:100%;box-sizing:border-box">
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
          <div>
            <label style="font-size:11px;font-weight:600;color:var(--ink-3);display:block;margin-bottom:4px">ID Type</label>
            <select id="agt-id-${safeId}" style="width:100%;box-sizing:border-box">
              <option value="">Select...</option>
              <option value="drivers_license">Driver's License</option>
              <option value="passport">Passport</option>
              <option value="health_card">Health Card</option>
              <option value="other">Other Photo ID</option>
            </select>
          </div>
          <div>
            <label style="font-size:11px;font-weight:600;color:var(--ink-3);display:block;margin-bottom:4px">ID Last 4</label>
            <input type="text" id="agt-id4-${safeId}" placeholder="1234" maxlength="4" style="width:100%;box-sizing:border-box">
          </div>
        </div>
        <div style="margin-bottom:12px">
          <label style="font-size:11px;font-weight:600;color:var(--ink-3);display:block;margin-bottom:4px">Notes</label>
          <input type="text" id="agt-notes-${safeId}" placeholder="e.g. Assistant, picks up Mondays" style="width:100%;box-sizing:border-box">
        </div>
        <div style="display:flex;gap:8px">
          <button id="agt-btn-${safeId}" onclick="addAgent('${safeId}','${planCardId}','${locationId}')"
            style="flex:1;padding:9px;background:var(--ink);color:#fff;border:none;border-radius:var(--radius-sm);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:opacity .15s"
            onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
            Register Agent
          </button>
          <button onclick="document.getElementById('agt-form-${safeId}').style.display='none';document.getElementById('agt-toggle-${safeId}').style.display='flex'"
            style="padding:9px 14px;background:none;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;color:var(--ink-4);cursor:pointer;font-family:inherit;transition:all .15s"
            onmouseover="this.style.borderColor='var(--ink-3)'" onmouseout="this.style.borderColor='var(--border)'">
            Cancel
          </button>
        </div>
      </div>
    </div>` : `
    <div style="border-top:1px solid var(--border);margin-top:4px;padding:12px 0 4px;text-align:center">
      <div style="font-size:11px;color:var(--ink-4)">Maximum ${maxAgents} agents registered</div>
    </div>`;

  return `
    <div style="margin-bottom:16px">
      <div class="section-header">
        <span class="section-title">Authorized Pickup Agents <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:12px;color:var(--ink-4)">${agents.length}</span></span>
      </div>
      ${noBanner}
      <div class="card" style="padding:8px 16px 4px">
        ${agentItems ? `<div class="recipient-list">${agentItems}</div>` : ''}
        ${addForm}
        <div style="padding-bottom:12px"></div>
      </div>
    </div>`;
}

function agtCheckName(safeId) {
  const nameEl = document.getElementById('agt-name-' + safeId);
  const hintEl = document.getElementById('agt-name-hint-' + safeId);
  if (!nameEl || !hintEl) return;
  const val = nameEl.value.trim();
  hintEl.style.display = (val.length > 0 && val.split(/\s+/).filter(Boolean).length < 2) ? 'block' : 'none';
}

async function addAgent(safeId, planCardId, locationId) {
  const nameEl  = document.getElementById('agt-name-' + safeId);
  const phoneEl = document.getElementById('agt-phone-' + safeId);
  const notesEl = document.getElementById('agt-notes-' + safeId);
  const idEl    = document.getElementById('agt-id-' + safeId);
  const id4El   = document.getElementById('agt-id4-' + safeId);
  const btnEl   = document.getElementById('agt-btn-' + safeId);

  const name = nameEl ? nameEl.value.trim() : '';
  if (!name) { toast('Please enter the agent\'s full name.', 'error'); if (nameEl) nameEl.focus(); return; }
  if (name.split(/\s+/).filter(Boolean).length < 2) { toast('Please enter both first and last name.', 'error'); if (nameEl) nameEl.focus(); return; }

  if (btnEl) { btnEl.disabled = true; btnEl.innerHTML = '<span class="btn-spinner"></span> Registering...'; }

  try {
    const result = await apiPost({
      action:       'addAgent',
      uuid:         STATE.uuid,
      planCardId:   planCardId,
      locationId:   locationId,
      name:         name,
      phone:        phoneEl ? phoneEl.value.trim() : '',
      notes:        notesEl ? notesEl.value.trim() : '',
      idType:       idEl ? idEl.value : '',
      idLast4:      id4El ? id4El.value.trim() : ''
    });
    if (result.status !== 'ok') throw new Error(result.message || 'Failed');
    toast('Agent registered!', 'success');
    await refreshAgents();
  } catch(err) {
    toast(err.message, 'error');
    if (btnEl) { btnEl.disabled = false; btnEl.innerHTML = '+ Register Agent'; }
  }
}

async function removeAgent(agentId) {
  if (!confirm('Remove this pickup agent?')) return;
  try {
    const result = await apiPost({ action:'removeAgent', uuid:STATE.uuid, agentId });
    if (result.status !== 'ok') throw new Error(result.message || 'Failed');
    toast('Agent removed.', 'success');
    await refreshAgents();
  } catch(err) { toast(err.message, 'error'); }
}

async function refreshAgents() {
  const sub = STATE.activeSub;
  const aRes = await apiPost({ action:'getAgents', uuid:STATE.uuid, subscriptionId: sub.subscriptionId });
  if (aRes.status === 'ok') STATE.agents = aRes.agents || [];
  const pc = STATE.allPlanCards ? STATE.allPlanCards[sub.subscriptionId] : STATE.planCard;
  buildPlanCard(sub, STATE.access, pc, STATE.recipients);
}

// â”€â”€ buildMailLog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMailLog(sub, access, mailLog, pc, agents, recipients) {
  const area = qs('mail-log-area');
  if (!area) return;

  const autoFeature  = pc ? (pc.autoFeature || 'none').toLowerCase() : 'none';
  const isScanPlan   = autoFeature === 'scan';
  const canRelease   = sub.accessStatus === 'ACTIVE';
  const blurred      = !canRelease;

  if (!mailLog || mailLog.length === 0) {
    area.innerHTML = `
      <div class="card">
        <div class="empty-state">
          <div class="empty-icon">ğŸ“­</div>
          <div class="empty-title">No mail yet</div>
          <div class="empty-sub">Your mail will appear here once it arrives.</div>
        </div>
      </div>`;
    return;
  }

  const sorted = [...mailLog].sort((a, b) => {
    const da = a.storageDueDate ? new Date(a.storageDueDate) : new Date('9999');
    const db = b.storageDueDate ? new Date(b.storageDueDate) : new Date('9999');
    return da - db;
  });

  const statusLabel = {
    arrived: 'Arrived', scanned: 'Scanned', stored: 'Stored',
    forwarded: 'Forwarded', picked_up: 'Picked Up',
    shredded: 'Shredded', ready_to_ship: 'Ready to Ship',
  };

  const rows = sorted.map(m => {
    const isParcel = m.type === 'parcel';
    const isDone   = ['picked_up','shredded','forwarded'].includes(m.status);
    const dueDate  = m.storageDueDate ? new Date(m.storageDueDate) : null;
    const daysLeft = dueDate ? Math.ceil((dueDate - Date.now()) / 86400000) : null;
    const urgent   = daysLeft !== null && daysLeft <= 3 && !isDone;
    const isBlurred = blurred && !isDone;

    const dueBadge = dueDate && !isDone ? `
      <div class="storage-warn ${urgent ? 'urgent' : ''}">
        ${urgent ? 'âš  ' : ''}Due ${dueDate.toLocaleDateString('en-CA',{month:'short',day:'numeric'})}${daysLeft !== null ? ' Â· ' + (daysLeft < 0 ? 'Overdue' : daysLeft + 'd') : ''}
      </div>` : '';

    const scanLink = isScanPlan && m.scanImageUrl
      ? `<a href="${m.scanImageUrl}" target="_blank" style="font-size:11px;color:var(--blue)">ğŸ“„ View scan</a>` : '';

    return `
      <div class="mail-item ${isDone ? 'mail-item-done' : ''} ${isBlurred ? 'blurred' : ''}">
        <div class="mail-icon ${isParcel ? 'parcel' : 'letter'}">${isParcel ? 'ğŸ“¦' : 'âœ‰ï¸'}</div>
        <div class="mail-info">
          <div class="mail-recipient">${m.recipientName || 'â€”'}</div>
          <div class="mail-date">${m.mailId || ''}${m.arrivedAt ? ' Â· ' + new Date(m.arrivedAt).toLocaleDateString('en-CA',{month:'short',day:'numeric',year:'numeric'}) : ''}</div>
          ${dueBadge}${scanLink}
        </div>
        <div class="mail-meta">
          <span class="pill ${m.status || 'arrived'}">${statusLabel[m.status] || m.status || 'Arrived'}</span>
          ${m.isConfidential ? '<span class="pill confidential">Confidential</span>' : ''}
        </div>
      </div>`;
  }).join('');

  const refreshBtn = `
    <div style="display:flex;align-items:center;justify-content:flex-end;padding:8px 16px;border-bottom:1px solid var(--border)">
      <button onclick="_doRefreshMailLog(STATE.activeSub)"
        style="font-size:11px;color:var(--ink-4);background:none;border:none;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:5px;transition:color .15s"
        onmouseover="this.style.color='var(--ink-3)'" onmouseout="this.style.color='var(--ink-4)'">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        Refresh
      </button>
    </div>`;

  area.innerHTML = `<div class="mail-list">${refreshBtn}${rows}</div>`;
}

// â”€â”€ Friendly name edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openFriendlyNameEdit(planCardId, safeId) {
  const display  = document.getElementById('fname-display-' + safeId);
  const editWrap = document.getElementById('fname-edit-' + safeId);
  const input    = document.getElementById('fname-input-' + safeId);
  if (display)  display.closest('[id^="fname-display-wrap"]') ? 
    document.getElementById('fname-display-wrap-' + safeId).style.display = 'none' :
    display.style.display = 'none';
  if (editWrap) editWrap.style.display = 'flex';
  if (input)    { input.value = display ? display.textContent : ''; input.focus(); input.select(); }
}

function closeFriendlyNameEdit(safeId) {
  const display  = document.getElementById('fname-display-' + safeId);
  const editWrap = document.getElementById('fname-edit-' + safeId);
  const wrap     = document.getElementById('fname-display-wrap-' + safeId);
  if (wrap)     wrap.style.display = 'flex';
  if (display)  display.style.display = '';
  if (editWrap) editWrap.style.display = 'none';
}

async function saveFriendlyName(planCardId, safeId) {
  const input   = document.getElementById('fname-input-' + safeId);
  const name    = input ? input.value.trim() : '';
  const saveBtn = document.getElementById('fname-save-' + safeId);
  if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; }
  try {
    const r = await apiPost({ action:'updateFriendlyName', uuid:STATE.uuid, planCardId, friendlyName: name });
    if (r.status === 'ok') {
      const display = document.getElementById('fname-display-' + safeId);
      if (display) display.textContent = name || 'Add a nickname';
      if (STATE.planCard && STATE.planCard.planCardId === planCardId) STATE.planCard.friendlyName = name;
      if (STATE.allPlanCards) {
        Object.values(STATE.allPlanCards).forEach(pc => {
          if (pc && pc.planCardId === planCardId) pc.friendlyName = name;
        });
      }
      _plansTabActiveSub = null;
      closeFriendlyNameEdit(safeId);
      toast('Nickname saved', 'success');
    } else throw new Error(r.message || 'Save failed');
  } catch(e) {
    toast(e.message, 'error');
    if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save'; }
  }
}

// â”€â”€ handleBannerAction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleBannerAction(setupStep) {
  const sub = STATE.activeSub;
  if (!sub) return;
  if (setupStep === 'plan_setup' || setupStep === 'add_recipients') {
    renderSetup(sub, STATE.access);
  }
}



  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.addEventListener('DOMContentLoaded', boot);

  </script>
</body>
</html>
