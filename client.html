<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YYZ Offices â€” My Mailbox</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  :root {
    --red:        #8B1A1A;
    --red-light:  #A52020;
    --red-dim:    rgba(139,26,26,0.08);
    --red-border: rgba(139,26,26,0.18);
    --ink:        #1A1A1F;
    --ink-2:      #3D3D45;
    --ink-3:      #72727D;
    --ink-4:      #A8A8B0;
    --bg:         #F7F6F4;
    --bg-2:       #EFEDE9;
    --white:      #FFFFFF;
    --border:     #E2E0DB;
    --shadow:     0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md:  0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
    --radius:     10px;
    --radius-sm:  6px;
    --green:      #1A6B3C;
    --green-bg:   #E8F5EE;
    --amber:      #92520A;
    --amber-bg:   #FEF3E2;
    --blue:       #1A4A7A;
    --blue-bg:    #E8F0FA;
  }

  /* â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--ink);
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }
  button { font-family: inherit; cursor: pointer; border: none; outline: none; }
  input, select, textarea { font-family: inherit; outline: none; }
  a { text-decoration: none; color: inherit; }

  /* â”€â”€ Loading Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #loading-screen {
    position: fixed; inset: 0;
    background: var(--white);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
    z-index: 9999;
    transition: opacity 0.4s ease;
  }
  #loading-screen.fade-out { opacity: 0; pointer-events: none; }
  .loading-logo {
    font-family: 'DM Serif Display', serif;
    font-size: 22px; color: var(--ink);
    letter-spacing: -0.3px;
  }
  .loading-logo span { color: var(--red); }
  .loading-bar {
    width: 120px; height: 2px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .loading-bar-fill {
    height: 100%; width: 0;
    background: var(--red);
    border-radius: 2px;
    animation: loadBar 1.2s ease forwards;
  }
  @keyframes loadBar { to { width: 100%; } }

  /* â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app { display: none; flex-direction: column; min-height: 100vh; }
  #app.visible { display: flex; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .header {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 56px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .header-logo {
    font-family: 'DM Serif Display', serif;
    font-size: 18px; color: var(--ink);
    letter-spacing: -0.3px;
    display: flex; align-items: center; gap: 8px;
  }
  .header-logo .dot { color: var(--red); }
  .header-right {
    display: flex; align-items: center; gap: 12px;
  }
  .client-name {
    font-size: 13px; color: var(--ink-3); font-weight: 400;
  }
  .client-name strong { color: var(--ink); font-weight: 500; }

  /* â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .banner {
    padding: 12px 24px;
    display: flex; align-items: center; gap: 12px;
    font-size: 13px;
    border-bottom: 1px solid transparent;
  }
  .banner.setup    { background: var(--blue-bg); border-color: rgba(26,74,122,0.15); color: var(--blue); }
  .banner.warning  { background: var(--amber-bg); border-color: rgba(146,82,10,0.15); color: var(--amber); }
  .banner.error    { background: #FEE8E8; border-color: rgba(139,26,26,0.15); color: var(--red); }
  .banner-icon { font-size: 16px; flex-shrink: 0; }
  .banner-text { flex: 1; }
  .banner-text strong { font-weight: 600; display: block; margin-bottom: 1px; }
  .banner-btn {
    background: var(--ink);
    color: var(--white);
    border-radius: var(--radius-sm);
    padding: 6px 14px;
    font-size: 12px; font-weight: 500;
    white-space: nowrap;
    transition: opacity 0.15s;
  }
  .banner-btn:hover { opacity: 0.85; }
  .banner-btn.outline {
    background: transparent;
    border: 1px solid currentColor;
    color: inherit;
  }

  /* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main {
    flex: 1;
    padding: 24px;
    max-width: 900px;
    width: 100%;
    margin: 0 auto;
    display: flex; flex-direction: column; gap: 20px;
  }

  /* â”€â”€ Section Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px;
  }
  .section-title {
    font-size: 13px; font-weight: 600;
    color: var(--ink-2);
    text-transform: uppercase; letter-spacing: 0.06em;
  }
  .section-action {
    font-size: 12px; color: var(--red); font-weight: 500;
    cursor: pointer; transition: opacity 0.15s;
  }
  .section-action:hover { opacity: 0.7; }

  /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  /* â”€â”€ Stats Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
  }
  .stat-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--border);
    border-radius: 3px 3px 0 0;
  }
  .stat-card.accent::before { background: var(--red); }
  .stat-card.green::before  { background: var(--green); }
  .stat-card.amber::before  { background: #D97706; }
  .stat-card.blue::before   { background: var(--blue); }
  .stat-label {
    font-size: 11px; font-weight: 500;
    color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.06em;
    margin-bottom: 8px;
  }
  .stat-value {
    font-family: 'DM Serif Display', serif;
    font-size: 28px; color: var(--ink);
    line-height: 1; margin-bottom: 4px;
  }
  .stat-sub {
    font-size: 11px; color: var(--ink-4);
  }
  .stat-sub strong { color: var(--ink-3); font-weight: 500; }

  /* â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .usage-bar {
    height: 4px; background: var(--bg-2);
    border-radius: 4px; margin-top: 8px;
    overflow: hidden;
  }
  .usage-bar-fill {
    height: 100%; border-radius: 4px;
    background: var(--red);
    transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
  }
  .usage-bar-fill.safe   { background: var(--green); }
  .usage-bar-fill.warn   { background: #D97706; }
  .usage-bar-fill.danger { background: var(--red); }

  /* â”€â”€ Mail Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .mail-list { border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); }
  .mail-item {
    background: var(--white);
    display: grid;
    grid-template-columns: 36px 1fr auto;
    align-items: center; gap: 12px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    transition: background 0.12s;
    cursor: default;
  }
  .mail-item:last-child { border-bottom: none; }
  .mail-item:hover { background: var(--bg); }
  .mail-item.blurred .mail-info,
  .mail-item.blurred .mail-meta { filter: blur(4px); user-select: none; }
  .mail-icon {
    width: 36px; height: 36px;
    border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
  }
  .mail-icon.letter { background: var(--blue-bg); }
  .mail-icon.parcel { background: var(--amber-bg); }
  .mail-info { min-width: 0; }
  .mail-recipient {
    font-size: 13px; font-weight: 500; color: var(--ink);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .mail-date { font-size: 11px; color: var(--ink-4); margin-top: 1px; }
  .mail-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
  .pill {
    display: inline-flex; align-items: center;
    padding: 2px 8px; border-radius: 20px;
    font-size: 11px; font-weight: 500; white-space: nowrap;
  }
  .pill.arrived     { background: var(--blue-bg); color: var(--blue); }
  .pill.scanned     { background: #E8F5EE; color: var(--green); }
  .pill.stored      { background: var(--amber-bg); color: var(--amber); }
  .pill.forwarded   { background: #E8F5EE; color: var(--green); }
  .pill.picked_up   { background: #F0F0F5; color: var(--ink-3); }
  .pill.shredded    { background: #F0F0F5; color: var(--ink-4); }
  .pill.ready_to_ship { background: var(--amber-bg); color: var(--amber); }
  .pill.confidential { background: var(--red-dim); color: var(--red); }
  .mail-item-done { opacity: 0.65; }
  .storage-warn {
    font-size: 10px; color: var(--amber); font-weight: 500;
  }
  .storage-warn.urgent { color: var(--red); }

  /* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .empty-state {
    padding: 48px 24px;
    text-align: center;
    color: var(--ink-3);
  }
  .empty-icon { font-size: 32px; margin-bottom: 12px; opacity: 0.5; }
  .empty-title { font-size: 14px; font-weight: 500; color: var(--ink-2); margin-bottom: 4px; }
  .empty-sub   { font-size: 13px; color: var(--ink-4); }

  /* â”€â”€ Onboarding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .onboarding {
    max-width: 560px; margin: 40px auto;
    padding: 0 24px;
  }
  .onboard-header { margin-bottom: 28px; }
  .onboard-step {
    font-size: 11px; font-weight: 600; color: var(--red);
    text-transform: uppercase; letter-spacing: 0.08em;
    margin-bottom: 8px;
  }
  .onboard-title {
    font-family: 'DM Serif Display', serif;
    font-size: 26px; color: var(--ink); margin-bottom: 6px;
  }
  .onboard-sub { font-size: 14px; color: var(--ink-3); }

  .onboard-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow-md);
  }

  /* â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .form-group { margin-bottom: 16px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .form-row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; }
  label {
    display: block; font-size: 12px; font-weight: 500;
    color: var(--ink-2); margin-bottom: 5px;
  }
  input[type=text], input[type=email], select, textarea {
    width: 100%; padding: 9px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--white);
    color: var(--ink); font-size: 13px;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--red);
    box-shadow: 0 0 0 3px var(--red-dim);
  }
  input::placeholder, textarea::placeholder { color: var(--ink-4); }
  textarea { resize: vertical; min-height: 72px; }
  .form-divider {
    font-size: 11px; font-weight: 600; color: var(--ink-4);
    text-transform: uppercase; letter-spacing: 0.08em;
    margin: 20px 0 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    gap: 6px; padding: 10px 20px;
    border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 500;
    transition: all 0.15s;
    cursor: pointer;
  }
  .btn-primary {
    background: var(--red); color: var(--white);
    border: 1px solid var(--red);
  }
  .btn-primary:hover { background: var(--red-light); }
  .btn-secondary {
    background: var(--white); color: var(--ink);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { background: var(--bg); }
  .btn-full { width: 100%; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin  { to { transform: rotate(360deg); } }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.45; } }
  .spin-active { animation: spin 0.7s linear infinite; display:inline-block; }
  @keyframes shimmer { 0%{background-position:-600px 0} 100%{background-position:600px 0} }
  .shimmer-line {
    height: 13px; border-radius: 6px; margin-bottom: 10px;
    background: linear-gradient(90deg, var(--bg-2) 25%, rgba(255,255,255,0.06) 50%, var(--bg-2) 75%);
    background-size: 1200px 100%;
    animation: shimmer 1.5s infinite;
  }
  .shimmer-line.short { width: 55%; }
  .shimmer-line.med   { width: 78%; }

  /* â”€â”€ Steps indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .steps {
    display: flex; gap: 8px; align-items: center;
    margin-bottom: 24px;
  }
  .step-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--border);
    transition: all 0.2s;
  }
  .step-dot.active { background: var(--red); transform: scale(1.3); }
  .step-dot.done   { background: var(--green); }
  .step-line { flex: 1; height: 1px; background: var(--border); }

  /* â”€â”€ Recipient Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .recipient-list { display: flex; flex-direction: column; gap: 8px; }
  .recipient-item {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: var(--shadow);
  }
  .recipient-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: var(--red-dim);
    color: var(--red);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 600; flex-shrink: 0;
  }
  .recipient-info { flex: 1; }
  .recipient-name { font-size: 13px; font-weight: 500; color: var(--ink); }
  .recipient-company { font-size: 11px; color: var(--ink-4); margin-top: 1px; }
  .recipient-status { }

  /* â”€â”€ Blocked Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .blocked-screen {
    display: flex; align-items: center; justify-content: center;
    min-height: calc(100vh - 56px);
    padding: 24px;
  }
  .blocked-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 40px 32px;
    max-width: 420px; width: 100%;
    text-align: center;
    box-shadow: var(--shadow-md);
  }
  .blocked-icon {
    width: 56px; height: 56px;
    border-radius: 50%;
    background: #FEE8E8;
    color: var(--red);
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
    margin: 0 auto 20px;
  }
  .blocked-title {
    font-family: 'DM Serif Display', serif;
    font-size: 20px; color: var(--ink); margin-bottom: 8px;
  }
  .blocked-msg { font-size: 13px; color: var(--ink-3); margin-bottom: 8px; line-height: 1.6; }
  .blocked-reason {
    font-size: 12px; color: var(--ink-4);
    background: var(--bg); border-radius: var(--radius-sm);
    padding: 8px 12px; margin-bottom: 24px;
  }

  /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tabs {
    display: flex; gap: 0;
    border-bottom: 1px solid var(--border);
    background: var(--white);
    padding: 0 24px;
    position: sticky; top: 56px; z-index: 90;
  }
  .tab {
    padding: 12px 16px;
    font-size: 13px; font-weight: 500;
    color: var(--ink-3);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tab.active { color: var(--red); border-color: var(--red); }
  .tab:hover:not(.active) { color: var(--ink-2); }

  /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast-container {
    position: fixed; bottom: 20px; right: 20px;
    display: flex; flex-direction: column; gap: 8px;
    z-index: 9999;
  }
  .toast {
    background: var(--ink); color: var(--white);
    padding: 10px 16px; border-radius: var(--radius-sm);
    font-size: 13px; box-shadow: var(--shadow-md);
    animation: toastIn 0.25s ease;
  }
  .toast.success { background: var(--green); }
  .toast.error   { background: var(--red); }
  @keyframes toastIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

  /* â”€â”€ Subscription switcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sub-switcher { display:flex; gap:0; padding:0 24px; background:var(--bg-2); border-bottom:1px solid var(--border); overflow-x:auto; }
  .sub-pill { padding:10px 18px; font-size:13px; font-weight:500; cursor:pointer; border:none; border-bottom:2px solid transparent; background:transparent; color:var(--ink-3); white-space:nowrap; transition:all 0.15s; margin-bottom:-1px; }
  .sub-pill:hover { color:var(--ink); background:var(--bg); }
  .sub-pill.active { color:var(--ink); border-bottom-color:var(--ink); font-weight:600; }
  .sub-pill.blocked { color:var(--red); }
  .sub-pill.active.blocked { border-bottom-color:var(--red); }
  /* â”€â”€ Plan card grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .plan-card-grid { display:flex; flex-direction:column; gap:12px; }

  /* Plan selection screen */
  .setup-selection-grid { display:flex; flex-direction:column; gap:14px; margin-top:8px; }
  .setup-select-card {
    background: var(--white);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    cursor: pointer;
    transition: border-color 0.15s, box-shadow 0.15s;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }
  .setup-select-card:hover {
    border-color: var(--ink-3);
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .setup-select-card .plan-icon { font-size: 28px; flex-shrink: 0; }
  .setup-select-card .plan-info { flex: 1; min-width: 0; }
  .setup-select-card .plan-title { font-size: 15px; font-weight: 600; color: var(--ink); margin-bottom: 3px; }
  .setup-select-card .plan-meta  { font-size: 12px; color: var(--ink-4); }
  .setup-select-card .setup-btn  {
    font-size: 12px; font-weight: 600; padding: 8px 16px;
    background: var(--ink); color: var(--white);
    border: none; border-radius: var(--radius-sm);
    cursor: pointer; white-space: nowrap; flex-shrink: 0;
    font-family: inherit;
  }
  .setup-select-card:hover .setup-btn { background: #111; }
  .plan-card-item { background:var(--white); border:1px solid var(--border); border-radius:var(--radius); padding:18px 20px; }
  .plan-card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
  .plan-card-name { font-size:14px; font-weight:600; color:var(--ink); }
  .plan-card-sub { font-size:12px; color:var(--ink-3); margin-top:2px; }
  .recipient-row { display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid var(--border); }
  .recipient-row:last-child { border-bottom:none; }
  .add-recipient-row { display:flex; align-items:center; gap:10px; padding:12px 0 4px; }

  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 600px) {
    .main { padding: 16px; gap: 16px; }
    .form-row, .form-row-3 { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: 1fr 1fr; }
    .header { padding: 0 16px; }
    .tabs { padding: 0 16px; overflow-x: auto; }
  }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading-screen">
  <div class="loading-logo">YYZ<span class="dot">.</span>Offices</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<!-- App -->
<div id="app">

  <!-- Header -->
  <header class="header">
    <div class="header-logo">YYZ<span class="dot">.</span>Offices</div>
    <div class="header-right">
      <span class="client-name" id="header-name"></span>
    </div>
  </header>

  <!-- Subscription switcher (hidden until needed) -->
  <div id="sub-switcher-area"></div>

  <!-- Banner area -->
  <div id="banner-area"></div>

  <!-- Content area -->
  <div id="content-area"></div>

</div>

<!-- Toast container -->
<div class="toast-container" id="toasts"></div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_URL = 'https://script.google.com/macros/s/AKfycbyBryhTn4ajucQTDfwlLwMPz2EPirt0WjO5BD9EcnTiT2plXl4DdCiHyJOoQs1xK20Njg/exec?';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let STATE = {
  uuid:         null,
  access:       null,
  activeSub:    null,
  allSubs:      [],
  mailLog:      [],
  planCard:     null,
  recipients:   [],
  agents:       [],
  activeTab:    'mail',
  loading:      false
};

function safePcId(id) {
  return String(id || 'unknown').replace(/[^a-zA-Z0-9_-]/g, '_');
}


// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function qs(id) { return document.getElementById(id); }
function getUUID() {
  const params = new URLSearchParams(window.location.search);
  return params.get('uuid') || params.get('id') || null;
}
function fmtDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-CA', { month: 'short', day: 'numeric', year: 'numeric' });
}
function fmtDateTime(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-CA', { month: 'short', day: 'numeric' }) + ' ' +
         new Date(d).toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' });
}
function daysUntil(d) {
  if (!d) return null;
  return Math.ceil((new Date(d) - new Date()) / (1000 * 60 * 60 * 24));
}
function initials(name) {
  return (name || '').split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase();
}
function toast(msg, type = '') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  qs('toasts').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}
async function api(path, opts = {}) {
  const url = API_URL + (path || '');
  const res = await fetch(url, opts);
  return res.json();
}
async function apiPost(body) {
  // Use GET instead of POST to avoid CORS preflight issues with Apps Script
  const { uuid, action, ...rest } = body;
  const data  = encodeURIComponent(JSON.stringify(rest));
  const url   = API_URL + '&uuid=' + encodeURIComponent(uuid) + '&action=' + encodeURIComponent(action) + '&data=' + data;
  const res   = await fetch(url);
  return res.json();
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

function getCachedAuth(uuid) {
  try {
    const raw = sessionStorage.getItem('auth_' + uuid);
    if (!raw) return null;
    const { data, ts } = JSON.parse(raw);
    if (Date.now() - ts > CACHE_TTL) { sessionStorage.removeItem('auth_' + uuid); return null; }
    return data;
  } catch(e) { return null; }
}

function setCachedAuth(uuid, data) {
  try { sessionStorage.setItem('auth_' + uuid, JSON.stringify({ data, ts: Date.now() })); } catch(e) {}
}

async function boot() {
  STATE.uuid = getUUID();

  if (!STATE.uuid) {
    hideLoading();
    showBlocked('No Access', 'No access credential found in URL.', null, null);
    return;
  }

  // Check session cache first â€” instant load on refresh
  const cached = getCachedAuth(STATE.uuid);
  if (cached && cached.status === 'client') {
    STATE.access = cached;
    hideLoading();
    renderClient(cached);
    // Silently refresh cache in background
    api('uuid=' + encodeURIComponent(STATE.uuid)).then(fresh => {
      if (fresh && fresh.status === 'client') setCachedAuth(STATE.uuid, fresh);
    }).catch(() => {});
    return;
  }

  // No cache â€” show loading bar then fetch
  await new Promise(r => setTimeout(r, 600));

  try {
    const data = await api('uuid=' + encodeURIComponent(STATE.uuid));
    STATE.access = data;
    hideLoading();

    if (data.status === 'blocked' || data.status === 'error') {
      showBlocked(
        data.status === 'error' ? 'Error' : 'Access Unavailable',
        data.message, null, null
      );
      return;
    }
    if (data.status === 'staff') {
      showBlocked('Wrong Portal', 'Please use the staff portal to access your dashboard.', null, null);
      return;
    }
    if (data.status === 'client') {
      setCachedAuth(STATE.uuid, data);
      renderClient(data);
    }

  } catch (err) {
    hideLoading();
    showBlocked('Connection Error', 'Could not connect to the server. Please try again.', null, null);
  }
}

function hideLoading() {
  const ls = qs('loading-screen');
  ls.classList.add('fade-out');
  setTimeout(() => { ls.style.display = 'none'; }, 400);
  qs('app').classList.add('visible');
}

// â”€â”€ Client Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderClient(access) {
  qs('header-name').innerHTML = `<strong>${access.name}</strong>`;

  const subs = (access.subscriptions || []).filter(s => s.subscriptionId);
  if (!subs.length) {
    showBlocked('No Subscription', 'No subscription found for your account.', null, null);
    return;
  }

  // Pick best sub: prefer ACTIVE, then CANCELED_WITH_ACCESS, then first
  const best = subs.find(s => s.accessStatus === 'ACTIVE')
    || subs.find(s => s.accessStatus === 'CANCELED_WITH_ACCESS')
    || subs[0];

  STATE.allSubs  = subs;
  STATE.activeSub = best;

  renderSubscriptionSwitcher(access);

  // Check how many subs need setup
  const pendingSetup = subs.filter(s => s.canAccess && s.setupRequired);
  if (pendingSetup.length > 1) {
    // Multiple plans need setup â€” show selection screen
    renderPlanSelection(access);
  } else {
    loadAndRenderSub(best, access);
  }
}

function renderSubscriptionSwitcher(access) {
  const area = qs('sub-switcher-area');
  const subs = STATE.allSubs || [];

  // Only show switcher if more than 1 subscription
  if (subs.length <= 1) { area.innerHTML = ''; return; }

  area.innerHTML = `
    <div class="sub-switcher">
      ${subs.map(s => {
        const isActive  = s.subscriptionId === (STATE.activeSub || {}).subscriptionId;
        const isBlocked = !s.canAccess;
        const label = getPlanFriendlyName(s);
        return `<div class="sub-pill ${isActive ? 'active' : ''} ${isBlocked && !isActive ? 'blocked' : ''}"
          onclick="switchSubscription('${s.subscriptionId}')">${label}</div>`;
      }).join('')}
    </div>`;
}

async function switchSubscription(subscriptionId) {
  const sub = (STATE.allSubs || []).find(s => s.subscriptionId === subscriptionId);
  if (!sub) return;
  STATE.activeSub = sub;
  // Clear ALL cached data â€” each subscription is completely independent
  STATE.mailLog      = [];
  STATE.planCard     = null;
  STATE.recipients   = [];
  STATE.agents       = [];
  STATE.allPlanCards = {};
  _plansTabActiveSub = subscriptionId; // reset plan tab to new sub
  renderSubscriptionSwitcher(STATE.access);
  // Show shimmer in content area while loading
  const dc = qs('dashboard-content');
  if (dc) dc.innerHTML = `<div style="padding:20px"><div class="shimmer-line"></div><div class="shimmer-line med"></div><div class="shimmer-line short"></div><div style="margin-top:20px"><div class="shimmer-line"></div><div class="shimmer-line med"></div></div></div>`;
  loadAndRenderSub(sub, STATE.access);
}

async function loadAndRenderSub(sub, access) {
  // Don't show banner during onboarding â€” it's redundant noise
  if (!sub.setupRequired) renderBanner(sub);
  else { const b = qs('banner-area'); if (b) b.innerHTML = ''; }

  if (!sub.canAccess) {
    renderBlockedSub(sub);
    return;
  }
  if (sub.setupRequired) {
    renderSetup(sub, access);
    return;
  }
  await renderDashboard(sub, access);
}

// â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBanner(sub) {
  const area = qs('banner-area');
  if (!sub.banner) { area.innerHTML = ''; return; }
  const b = sub.banner;
  const typeClass = {
    setup_required:      'setup',
    canceled_with_access:'warning',
    pending_payment:     'warning',
    payment_required:    'error',
    canceled:            'error'
  }[b.type] || 'setup';

  const icon = {
    setup_required:      'ğŸ“‹',
    canceled_with_access:'â°',
    pending_payment:     'ğŸ“¬',
    payment_required:    'ğŸ’³',
    canceled:            'ğŸ”’'
  }[b.type] || 'â„¹ï¸';

  const btnHtml = b.actionLabel && b.actionUrl
    ? `<button class="banner-btn" onclick="window.open('${b.actionUrl}','_blank')">${b.actionLabel}</button>`
    : b.actionLabel
    ? `<button class="banner-btn" onclick="handleBannerAction('${b.setupStep}')">${b.actionLabel}</button>`
    : '';

  area.innerHTML = `
    <div class="banner ${typeClass}">
      <span class="banner-icon">${icon}</span>
      <div class="banner-text">
        <strong>${b.title || ''}</strong>
        ${b.message || ''}
      </div>
      ${btnHtml}
    </div>`;
}

function handleBannerAction(step) {
  // Scroll to setup section or trigger it
  const setupEl = qs('setup-section');
  if (setupEl) setupEl.scrollIntoView({ behavior: 'smooth' });
}

// â”€â”€ Blocked Sub Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBlockedSub(sub) {
  const b = sub.banner || {};
  const icon = sub.accessStatus === 'PENDING_PAYMENT'  ? 'ğŸ“¬'
             : sub.accessStatus === 'PAYMENT_REQUIRED' ? 'ğŸ’³' : 'ğŸ”’';
  const btnHtml = b.actionLabel
    ? `<button class="btn btn-primary btn-full" onclick="window.open('${b.actionUrl||'#'}','_blank')">${b.actionLabel}</button>`
    : '';

  qs('content-area').innerHTML = `
    <div class="blocked-screen">
      <div class="blocked-card">
        <div class="blocked-icon">${icon}</div>
        <div class="blocked-title">${b.title || 'Access Unavailable'}</div>
        <p class="blocked-msg">${b.message || ''}</p>
        ${b.reason ? `<div class="blocked-reason">Reason: ${b.reason}</div>` : ''}
        ${btnHtml}
      </div>
    </div>`;
}

// â”€â”€ Blocked (no account) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showBlocked(title, msg, btnLabel, btnUrl) {
  qs('app').classList.add('visible');
  const btn = btnLabel ? `<button class="btn btn-primary btn-full" onclick="window.open('${btnUrl}','_blank')">${btnLabel}</button>` : '';
  qs('content-area').innerHTML = `
    <div class="blocked-screen">
      <div class="blocked-card">
        <div class="blocked-icon">ğŸ”’</div>
        <div class="blocked-title">${title}</div>
        <p class="blocked-msg">${msg}</p>
        ${btn}
      </div>
    </div>`;
}

// â”€â”€ Plan Selection Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Shows when client has 2+ pending plans. They pick which to set up.
function renderPlanSelection(access) {
  const subs = STATE.allSubs || [];

  // Only show pending subs (no planCard yet or status = pending_setup)
  const pending = subs.filter(s => s.canAccess && s.setupRequired);

  // Should not land here with 0 or 1 pending â€” but guard anyway
  if (pending.length === 0) { renderDashboard(subs[0], access); return; }
  if (pending.length === 1) { loadAndRenderSub(pending[0], access); return; }

  // Hide subscription switcher tabs â€” irrelevant during plan selection
  const switcher = qs('sub-switcher-area');
  if (switcher) switcher.style.display = 'none';

  const planIcons = { ship: 'ğŸ“¬', scan: 'ğŸ”', none: 'ğŸ“¦' };

  qs('content-area').innerHTML = `
    <div class="onboarding" style="max-width:520px">
      <div class="onboard-header">
        <div class="onboard-step">Mailbox Setup</div>
        <div class="onboard-title">Set up your plans</div>
        <div class="onboard-sub">You have ${pending.length} plans ready to configure. Set them up one at a time.</div>
      </div>
      <div class="setup-selection-grid">
        ${pending.map(sub => {
          const planLabel  = (sub.planName || '').split('â€“')[0].trim();
          const billing    = sub.interval === 'year' ? 'Yearly' : 'Monthly';
          const amount     = sub.planAmount ? '$' + (sub.planAmount / 100).toFixed(2) + ' CAD / ' + (sub.interval === 'year' ? 'yr' : 'mo') : '';
          const planLower  = (sub.planName || '').toLowerCase();
          const icon       = planLower.includes('scan') ? 'ğŸ”'
                           : planLower.includes('forward') ? 'ğŸ“¬'
                           : planLower.includes('core') ? 'ğŸ“ª'
                           : 'âœ‰ï¸';
          return `
          <div class="setup-select-card" onclick="startPlanSetup('${sub.subscriptionId}')">
            <div class="plan-icon">${icon}</div>
            <div class="plan-info">
              <div class="plan-title">${planLabel}</div>
              <div class="plan-meta">${billing}${amount ? ' Â· ' + amount : ''}</div>
            </div>
            <button class="setup-btn" onclick="event.stopPropagation();startPlanSetup('${sub.subscriptionId}')">
              Set Up â†’
            </button>
          </div>`;
        }).join('')}
      </div>
    </div>`;
}

function startPlanSetup(subscriptionId) {
  const sub = (STATE.allSubs || []).find(s => s.subscriptionId === subscriptionId);
  if (!sub) return;
  STATE.activeSub = sub;
  // Restore switcher now that a plan is selected
  const switcher = qs('sub-switcher-area');
  if (switcher) switcher.style.display = '';
  renderSetup(sub, STATE.access);
}

// â”€â”€ Setup Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSetup(sub, access) {
  const step = sub.setupStep;

  // Hide subscription switcher tabs during entire onboarding flow
  const switcher = qs('sub-switcher-area');
  if (switcher) switcher.style.display = 'none';

  const stepIndex = { plan_setup: 0, add_recipients: 1, pending_activation: 2 };
  const currentStep = stepIndex[step] ?? 0;

  // Show back button only when client has multiple plans (so they can switch)
  const hasMultiplePlans = (STATE.allSubs || []).filter(s => s.canAccess).length > 1;
  const backBtn = hasMultiplePlans ? `
    <button onclick="goBackToPlanSelection()"
      style="display:inline-flex;align-items:center;gap:5px;background:none;border:none;
             cursor:pointer;font-size:12px;color:var(--ink-4);font-family:inherit;
             padding:0;margin-bottom:20px;transition:color 0.15s"
      onmouseover="this.style.color='var(--ink)'" onmouseout="this.style.color='var(--ink-4)'">
      â† Back to plans
    </button>` : '';

  const stepsHtml = [0,1,2].map((i, idx) => `
    <div class="step-dot ${i < currentStep ? 'done' : i === currentStep ? 'active' : ''}"></div>
    ${idx < 2 ? '<div class="step-line"></div>' : ''}
  `).join('');

  if (step === 'plan_setup') {
    renderOnboardingForm(sub, access, stepsHtml, backBtn);
  } else if (step === 'add_recipients') {
    renderAddRecipient(sub, access, stepsHtml, backBtn);
  } else if (step === 'pending_activation') {
    renderPendingActivation(sub, stepsHtml, backBtn);
  }
}

function goBackToPlanSelection() {
  // Restore switcher and go back to selection screen
  const switcher = qs('sub-switcher-area');
  if (switcher) switcher.style.display = 'none'; // stays hidden on selection screen
  renderPlanSelection(STATE.access);
}

async function renderOnboardingForm(sub, access, stepsHtml, backBtn = '') {
  // Show loading state while fetching plan template
  qs('content-area').innerHTML = `
    <div class="onboarding" id="setup-section">
      <div class="onboard-header">
        ${backBtn}
        <div class="onboard-step">Step 1 of 3 â€” Plan Setup</div>
        <div class="onboard-title">Set up your mailbox</div>
      </div>
      <div class="onboard-card" style="padding:40px;text-align:center">
        <div class="shimmer-line" style="width:60%;margin:0 auto 12px"></div>
        <div class="shimmer-line med" style="width:40%;margin:0 auto"></div>
      </div>
    </div>`;

  // Fetch plan template + resolved locations
  let tmpl = null, locations = [];
  try {
    const productId = sub.productId || '';
    const res = await apiPost({ action: 'getPlanTemplate', uuid: STATE.uuid, productId });
    if (res.status === 'ok') {
      tmpl      = res.template   || null;
      locations = res.locations  || [];
    }
  } catch(e) { /* fallback to blank form */ }

  const feature     = tmpl ? (tmpl.autoFeature || 'none').toLowerCase() : 'none';
  const isShip      = feature === 'ship';
  const isScan      = feature === 'scan';
  const isNone      = !isShip && !isScan;
  const planLabel   = (sub.planName || '').split('â€“')[0].trim() || 'Your Plan';
  const billingCycle = (sub.interval === 'year') ? 'year' : 'month';
  const isYearly    = billingCycle === 'year';

  // Plan stats
  const mailLimit    = parseInt(tmpl && tmpl.mailLimit       || 0);
  const parcelLimit  = parseInt(tmpl && tmpl.parcelsIncluded || 0);
  const mailFee      = tmpl && tmpl.mailOverageFee   ? '$' + parseFloat(tmpl.mailOverageFee).toFixed(2)   : null;
  const parcelFee    = tmpl && tmpl.parcelOverageFee ? '$' + parseFloat(tmpl.parcelOverageFee).toFixed(2) : null;
  const mailStorage  = parseInt(tmpl && tmpl.mailStorageDays   || 30);
  const parcelStorage= parseInt(tmpl && tmpl.parcelStorageDays || 7);

  // Plan summary rows
  const summaryRows = [
    { label: 'Mail included',    value: mailLimit   ? mailLimit + ' pieces / ' + billingCycle : 'Unlimited' },
    parcelLimit > 0
      ? { label: 'Parcels included', value: parcelLimit + ' / ' + billingCycle }
      : { label: 'Parcel handling',  value: 'Not included' },
    mailFee
      ? { label: 'Mail overage',     value: mailFee + ' per piece' }
      : { label: 'Mail overage',     value: 'N/A â€” not supported' },
    parcelFee && parcelLimit > 0
      ? { label: 'Parcel overage',   value: parcelFee + ' per parcel' }
      : null,
    { label: 'Mail storage',     value: mailStorage + ' days' },
    parcelLimit > 0 ? { label: 'Parcel storage', value: parcelStorage + ' days' } : null,
  ].filter(Boolean);

  const summaryHtml = `
    <div style="background:var(--bg);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:20px">
      <div style="font-size:11px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px">${planLabel} Plan Details</div>
      ${summaryRows.map(r => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px">
          <span style="color:var(--ink-3)">${r.label}</span>
          <span style="font-weight:500;color:var(--ink)">${r.value}</span>
        </div>`).join('')}
    </div>`;

  // Location picker
  let locationHtml = '';
  if (locations.length === 0) {
    locationHtml = `<input type="hidden" id="ob-location" value="">`;
  } else if (locations.length === 1) {
    const loc = locations[0];
    const addr = [loc.address, loc.city, loc.province, loc.postalCode].filter(Boolean).join(', ');
    locationHtml = `
      <input type="hidden" id="ob-location" value="${loc.locationId}">
      <div class="form-group">
        <label>Your Virtual Office Address</label>
        <div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;font-size:13px">
          <div style="font-weight:600;color:var(--ink);margin-bottom:2px">${loc.name}</div>
          <div style="color:var(--ink-3)">${addr}</div>
          ${loc.hours ? `<div style="font-size:11px;color:var(--ink-4);margin-top:4px">ğŸ• ${loc.hours}</div>` : ''}
        </div>
        <div style="font-size:11px;color:var(--ink-4);margin-top:4px">This is the address registered mailbox address for this plan.</div>
      </div>`;
  } else {
    locationHtml = `
      <div class="form-group">
        <label>Select Your Location</label>
        <div style="display:flex;flex-direction:column;gap:10px" id="ob-location-list">
          ${locations.map((loc, i) => {
            const addr = [loc.address, loc.city, loc.province, loc.postalCode].filter(Boolean).join(', ');
            return `
            <label style="display:flex;align-items:flex-start;gap:10px;padding:12px 14px;border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:border-color .15s"
              onclick="document.querySelectorAll('#ob-location-list label').forEach(l=>l.style.borderColor='var(--border)');this.style.borderColor='var(--ink)';document.getElementById('ob-location').value='${loc.locationId}'">
              <input type="radio" name="ob-loc-radio" value="${loc.locationId}" ${i===0?'checked':''} style="margin-top:2px;accent-color:var(--ink)">
              <div>
                <div style="font-weight:600;font-size:13px;color:var(--ink)">${loc.name}</div>
                <div style="font-size:12px;color:var(--ink-3)">${addr}</div>
                ${loc.hours ? `<div style="font-size:11px;color:var(--ink-4);margin-top:2px">ğŸ• ${loc.hours}</div>` : ''}
              </div>
            </label>`;
          }).join('')}
        </div>
        <input type="hidden" id="ob-location" value="${locations[0].locationId}">
      </div>`;
  }

  // Forwarding address section â€” only for ship plans
  const fwdHtml = isShip ? `
    <div class="form-divider">Forwarding Address</div>
    <div style="font-size:12px;color:var(--ink-3);margin-bottom:14px;line-height:1.5">
      Your mail will be forwarded to this address during the first week of each month.
    </div>
    <div class="form-group">
      <label>Street Address</label>
      <input type="text" id="ob-addr" placeholder="123 Main Street" required>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>City</label>
        <input type="text" id="ob-city" placeholder="Toronto" required>
      </div>
      <div class="form-group">
        <label>Province / State</label>
        <input type="text" id="ob-province" placeholder="ON" required>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Postal / ZIP Code</label>
        <input type="text" id="ob-postal" placeholder="M5H 2S3" required>
      </div>
      <div class="form-group">
        <label>Country</label>
        <input type="text" id="ob-country" value="Canada" required>
      </div>
    </div>
    <div class="form-group">
      <label>Forwarding Instructions <span style="color:var(--ink-4)">(optional)</span></label>
      <textarea id="ob-instructions" placeholder="e.g. Signature required, leave at front desk..."></textarea>
    </div>` : `
    <input type="hidden" id="ob-addr" value="">
    <input type="hidden" id="ob-city" value="">
    <input type="hidden" id="ob-province" value="">
    <input type="hidden" id="ob-postal" value="">
    <input type="hidden" id="ob-country" value="">
    <input type="hidden" id="ob-instructions" value="">`;

  // Scan notice â€” only for scan plans
  const scanHtml = isScan ? `
    <div style="background:#E8F5EE;border:1px solid rgba(34,139,34,0.2);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:20px;display:flex;gap:10px;align-items:flex-start">
      <div style="font-size:18px;flex-shrink:0">ğŸ”</div>
      <div>
        <div style="font-size:13px;font-weight:600;color:#1a5c2a;margin-bottom:4px">Scan Plan â€” Digital Delivery</div>
        <div style="font-size:12px;color:#2d7a3a;line-height:1.5">
          Your mail will be scanned and sent digitally to <strong>${access.email || 'your email address'}</strong>.
          You can update your email address anytime in your account settings.
        </div>
      </div>
    </div>` : '';

  qs('content-area').innerHTML = `
    <div class="onboarding" id="setup-section">
      <div class="onboard-header">
        ${backBtn}
        <div class="onboard-step">Step 1 of 3 â€” Plan Setup</div>
        <div class="onboard-title">Set up your mailbox</div>
        <div class="onboard-sub">Configure your ${planLabel} plan.</div>
      </div>
      <div class="steps">${stepsHtml}</div>
      <div class="onboard-card">
        <form id="onboard-form">

          ${summaryHtml}
          ${scanHtml}

          <div class="form-divider">Mailbox Location</div>
          ${locationHtml}

          <div class="form-divider">Business Information</div>
          <div class="form-group">
            <label>Plan Nickname <span style="color:var(--ink-4)">(optional)</span></label>
            <input type="text" id="ob-friendly-name" placeholder="e.g. John's Company, Landscaping LTD">
            <div style="font-size:11px;color:var(--ink-4);margin-top:4px">A personal name for this mailbox. Shown instead of the plan name.</div>
          </div>
          <div class="form-group">
            <label>Business Description <span style="color:var(--ink-4)">(one sentence)</span></label>
            <input type="text" id="ob-biz" placeholder="e.g. Digital marketing agency serving SMBs">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>How did you hear about us?</label>
              <select id="ob-referral">
                <option value="">Select...</option>
                <option>Google Search</option>
                <option>Referral</option>
                <option>Walk-in</option>
                <option>Social Media</option>
                <option>Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Preferred Pickup Time</label>
              <select id="ob-pickup">
                <option value="">No preference</option>
                <option>Mornings (9amâ€“12pm)</option>
                <option>Afternoons (12pmâ€“5pm)</option>
              </select>
            </div>
          </div>

          ${fwdHtml}

          <div class="form-divider">Special Instructions</div>
          <div class="form-group">
            <label>Any special instructions for our team? <span style="color:var(--ink-4)">(optional)</span></label>
            <textarea id="ob-special" placeholder="e.g. Always notify immediately upon arrival..."></textarea>
          </div>

          <button type="submit" class="btn btn-primary btn-full" id="ob-submit">
            Save & Continue
          </button>
        </form>
      </div>
    </div>`;

  qs('onboard-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = qs('ob-submit');
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-spinner"></span> Saving...';

    const locationId = (qs('ob-location') && qs('ob-location').value) || '';
    if (!locationId && locations.length > 0) {
      toast('Please select a location.', 'error');
      btn.disabled = false; btn.innerHTML = 'Save & Continue'; return;
    }

    try {
      const result = await apiPost({
        action:              'submitOnboarding',
        uuid:                STATE.uuid,
        subscriptionId:      sub.subscriptionId,
        productId:           sub.productId || extractProductId(sub),
        locationId:          locationId,
        forwardingAddress:   qs('ob-addr') ? qs('ob-addr').value : '',
        forwardingCity:      qs('ob-city') ? qs('ob-city').value : '',
        forwardingProvince:  qs('ob-province') ? qs('ob-province').value : '',
        forwardingPostalCode:qs('ob-postal') ? qs('ob-postal').value : '',
        forwardingCountry:   qs('ob-country') ? qs('ob-country').value : '',
        forwardingInstructions: qs('ob-instructions') ? qs('ob-instructions').value : '',
        clientCountry:       qs('ob-country') ? qs('ob-country').value : '',
        clientProvince:      qs('ob-province') ? qs('ob-province').value : '',
        clientCity:          qs('ob-city') ? qs('ob-city').value : '',
        clientTimezone:      Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Toronto',
        businessDescription: qs('ob-biz') ? qs('ob-biz').value : '',
        referralSource:      qs('ob-referral') ? qs('ob-referral').value : '',
        friendlyName:        qs('ob-friendly-name') ? qs('ob-friendly-name').value.trim() : '',
        preferredPickupTime: qs('ob-pickup') ? qs('ob-pickup').value : '',
        specialInstructions: qs('ob-special') ? qs('ob-special').value : ''
      });

      if (result.status === 'ok') {
        toast('Plan set up successfully!', 'success');
        setTimeout(() => location.reload(), 800);
      } else {
        throw new Error(result.message || 'Setup failed');
      }
    } catch (err) {
      toast(err.message, 'error');
      btn.disabled = false;
      btn.innerHTML = 'Save & Continue';
    }
  });
}

function extractProductId(sub) {
  // productId may not be in auth response â€” we get it from sub object
  // For now pass subscriptionId and let server look it up from billingDB
  return sub.productId || '';
}

function renderAddRecipient(sub, access, stepsHtml, backBtn = '') {
  // planCard may already be cached â€” grab maxRecipients from it
  const pc        = STATE.planCard || STATE.allPlanCards && STATE.allPlanCards[sub.subscriptionId] || null;
  const maxR      = pc ? (parseInt(pc.maxRecipients) || 1) : 1;
  const planLabel = (sub.planName || '').split('â€“')[0].trim() || 'Your Plan';

  // Build N recipient slot forms
  const slots = Array.from({ length: maxR }, (_, i) => {
    const isFirst = i === 0;
    const label   = maxR === 1 ? 'Recipient' : `Recipient ${i + 1}${isFirst ? ' (required)' : ' (optional)'}`;
    return `
      <div class="recipient-slot" id="rec-slot-${i}" style="${i > 0 ? 'margin-top:16px;padding-top:16px;border-top:1px solid var(--border)' : ''}">
        ${maxR > 1 ? `<div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-4);margin-bottom:10px">${label}</div>` : ''}
        <div class="form-row">
          <div class="form-group">
            <label>Full Name${isFirst ? '' : ' <span style="color:var(--ink-4)">(optional)</span>'}</label>
            <input type="text" id="rc-name-${i}" placeholder="Jane Smith" ${isFirst ? 'required' : ''}>
          </div>
          <div class="form-group">
            <label>Company <span style="color:var(--ink-4)">(optional)</span></label>
            <input type="text" id="rc-company-${i}" placeholder="Acme Corp">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Type</label>
            <select id="rc-type-${i}">
              <option value="individual">Individual</option>
              <option value="company">Company</option>
            </select>
          </div>
          <div class="form-group">
            <label>Language</label>
            <select id="rc-lang-${i}">
              <option value="en">English</option>
            </select>
          </div>
        </div>
      </div>`;
  }).join('');

  // Info banner
  const limitNote = maxR === 1
    ? 'Your plan supports 1 recipient.'
    : `Your ${planLabel} plan supports up to <strong>${maxR} recipients</strong>. Add as many as you need now â€” you can always add more later.`;

  qs('content-area').innerHTML = `
    <div class="onboarding" id="setup-section">
      <div class="onboard-header">
        ${backBtn}
        <div class="onboard-step">Step 2 of 3 â€” Add Recipients</div>
        <div class="onboard-title">Who will receive mail?</div>
        <div class="onboard-sub">These names will appear on mail delivered to your address.</div>
      </div>
      <div class="steps">${stepsHtml}</div>
      <div class="onboard-card">
        <div style="font-size:12px;color:var(--ink-3);background:var(--bg);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:20px">
          ${limitNote}
        </div>
        <form id="recipient-form">
          ${slots}
          <button type="submit" class="btn btn-primary btn-full" id="rc-submit" style="margin-top:20px">
            ${maxR > 1 ? 'Add Recipients & Continue' : 'Add Recipient & Continue'}
          </button>
        </form>
      </div>
    </div>`;

  qs('recipient-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = qs('rc-submit');
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-spinner"></span> Saving...';

    // Collect all filled slots
    const recipients = [];
    for (let i = 0; i < maxR; i++) {
      const name = qs('rc-name-' + i) && qs('rc-name-' + i).value.trim();
      if (!name) continue; // skip empty optional slots
      recipients.push({
        name,
        companyName:     qs('rc-company-' + i) ? qs('rc-company-' + i).value.trim() : '',
        type:            qs('rc-type-' + i) ? qs('rc-type-' + i).value : 'individual',
        language:        qs('rc-lang-' + i) ? qs('rc-lang-' + i).value : 'en',
        notifyOnArrival: true
      });
    }

    if (recipients.length === 0) {
      toast('Please add at least one recipient name.', 'error');
      btn.disabled = false;
      btn.innerHTML = maxR > 1 ? 'Add Recipients & Continue' : 'Add Recipient & Continue';
      return;
    }

    try {
      // Submit recipients one by one â€” server handles each
      for (const rec of recipients) {
        const result = await apiPost({
          action:          'addRecipient',
          uuid:            STATE.uuid,
          planCardId:      sub.planCardId,
          name:            rec.name,
          companyName:     rec.companyName,
          type:            rec.type,
          language:        rec.language,
          notifyOnArrival: rec.notifyOnArrival
        });
        if (result.status !== 'ok') throw new Error(result.message || 'Failed to add recipient: ' + rec.name);
      }

      toast('Recipient' + (recipients.length > 1 ? 's' : '') + ' added!', 'success');
      setTimeout(() => location.reload(), 800);
    } catch (err) {
      toast(err.message, 'error');
      btn.disabled = false;
      btn.innerHTML = maxR > 1 ? 'Add Recipients & Continue' : 'Add Recipient & Continue';
    }
  });
}
