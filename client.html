<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YYZ Offices â€” My Mailbox</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  :root {
    --red:        #8B1A1A;
    --red-light:  #A52020;
    --red-dim:    rgba(139,26,26,0.08);
    --red-border: rgba(139,26,26,0.18);
    --ink:        #1A1A1F;
    --ink-2:      #3D3D45;
    --ink-3:      #72727D;
    --ink-4:      #A8A8B0;
    --bg:         #F7F6F4;
    --bg-2:       #EFEDE9;
    --white:      #FFFFFF;
    --border:     #E2E0DB;
    --shadow:     0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md:  0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
    --radius:     10px;
    --radius-sm:  6px;
    --green:      #1A6B3C;
    --green-bg:   #E8F5EE;
    --amber:      #92520A;
    --amber-bg:   #FEF3E2;
    --blue:       #1A4A7A;
    --blue-bg:    #E8F0FA;
  }

  /* â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--ink);
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }
  button { font-family: inherit; cursor: pointer; border: none; outline: none; }
  input, select, textarea { font-family: inherit; outline: none; }
  a { text-decoration: none; color: inherit; }

  /* â”€â”€ Loading Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #loading-screen {
    position: fixed; inset: 0;
    background: var(--white);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
    z-index: 9999;
    transition: opacity 0.4s ease;
  }
  #loading-screen.fade-out { opacity: 0; pointer-events: none; }
  .loading-logo {
    font-family: 'DM Serif Display', serif;
    font-size: 22px; color: var(--ink);
    letter-spacing: -0.3px;
  }
  .loading-logo span { color: var(--red); }
  .loading-bar {
    width: 120px; height: 2px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .loading-bar-fill {
    height: 100%; width: 0;
    background: var(--red);
    border-radius: 2px;
    animation: loadBar 1.2s ease forwards;
  }
  @keyframes loadBar { to { width: 100%; } }

  /* â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app { display: none; flex-direction: column; min-height: 100vh; }
  #app.visible { display: flex; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .header {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 56px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .header-logo {
    font-family: 'DM Serif Display', serif;
    font-size: 18px; color: var(--ink);
    letter-spacing: -0.3px;
    display: flex; align-items: center; gap: 8px;
  }
  .header-logo .dot { color: var(--red); }
  .header-right {
    display: flex; align-items: center; gap: 12px;
  }
  .client-name {
    font-size: 13px; color: var(--ink-3); font-weight: 400;
  }
  .client-name strong { color: var(--ink); font-weight: 500; }

  /* â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .banner {
    padding: 12px 24px;
    display: flex; align-items: center; gap: 12px;
    font-size: 13px;
    border-bottom: 1px solid transparent;
  }
  .banner.setup    { background: var(--blue-bg); border-color: rgba(26,74,122,0.15); color: var(--blue); }
  .banner.warning  { background: var(--amber-bg); border-color: rgba(146,82,10,0.15); color: var(--amber); }
  .banner.error    { background: #FEE8E8; border-color: rgba(139,26,26,0.15); color: var(--red); }
  .banner-icon { font-size: 16px; flex-shrink: 0; }
  .banner-text { flex: 1; }
  .banner-text strong { font-weight: 600; display: block; margin-bottom: 1px; }
  .banner-btn {
    background: var(--ink);
    color: var(--white);
    border-radius: var(--radius-sm);
    padding: 6px 14px;
    font-size: 12px; font-weight: 500;
    white-space: nowrap;
    transition: opacity 0.15s;
  }
  .banner-btn:hover { opacity: 0.85; }
  .banner-btn.outline {
    background: transparent;
    border: 1px solid currentColor;
    color: inherit;
  }

  /* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main {
    flex: 1;
    padding: 24px;
    max-width: 900px;
    width: 100%;
    margin: 0 auto;
    display: flex; flex-direction: column; gap: 20px;
  }

  /* â”€â”€ Section Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px;
  }
  .section-title {
    font-size: 13px; font-weight: 600;
    color: var(--ink-2);
    text-transform: uppercase; letter-spacing: 0.06em;
  }
  .section-action {
    font-size: 12px; color: var(--red); font-weight: 500;
    cursor: pointer; transition: opacity 0.15s;
  }
  .section-action:hover { opacity: 0.7; }

  /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  /* â”€â”€ Stats Row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
  }
  .stat-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0;
    height: 3px;
    background: var(--border);
    border-radius: 3px 3px 0 0;
  }
  .stat-card.accent::before { background: var(--red); }
  .stat-card.green::before  { background: var(--green); }
  .stat-card.amber::before  { background: #D97706; }
  .stat-card.blue::before   { background: var(--blue); }
  .stat-label {
    font-size: 11px; font-weight: 500;
    color: var(--ink-3); text-transform: uppercase; letter-spacing: 0.06em;
    margin-bottom: 8px;
  }
  .stat-value {
    font-family: 'DM Serif Display', serif;
    font-size: 28px; color: var(--ink);
    line-height: 1; margin-bottom: 4px;
  }
  .stat-sub {
    font-size: 11px; color: var(--ink-4);
  }
  .stat-sub strong { color: var(--ink-3); font-weight: 500; }

  /* â”€â”€ Progress Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .usage-bar {
    height: 4px; background: var(--bg-2);
    border-radius: 4px; margin-top: 8px;
    overflow: hidden;
  }
  .usage-bar-fill {
    height: 100%; border-radius: 4px;
    background: var(--red);
    transition: width 0.6s cubic-bezier(0.4,0,0.2,1);
  }
  .usage-bar-fill.safe   { background: var(--green); }
  .usage-bar-fill.warn   { background: #D97706; }
  .usage-bar-fill.danger { background: var(--red); }

  /* â”€â”€ Mail Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .mail-list { border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); }
  .mail-item {
    background: var(--white);
    display: grid;
    grid-template-columns: 36px 1fr auto;
    align-items: center; gap: 12px;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    transition: background 0.12s;
    cursor: default;
  }
  .mail-item:last-child { border-bottom: none; }
  .mail-item:hover { background: var(--bg); }
  .mail-item.blurred .mail-info,
  .mail-item.blurred .mail-meta { filter: blur(4px); user-select: none; }
  .mail-icon {
    width: 36px; height: 36px;
    border-radius: var(--radius-sm);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
  }
  .mail-icon.letter { background: var(--blue-bg); }
  .mail-icon.parcel { background: var(--amber-bg); }
  .mail-info { min-width: 0; }
  .mail-recipient {
    font-size: 13px; font-weight: 500; color: var(--ink);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .mail-date { font-size: 11px; color: var(--ink-4); margin-top: 1px; }
  .mail-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
  .pill {
    display: inline-flex; align-items: center;
    padding: 2px 8px; border-radius: 20px;
    font-size: 11px; font-weight: 500; white-space: nowrap;
  }
  .pill.arrived     { background: var(--blue-bg); color: var(--blue); }
  .pill.scanned     { background: #E8F5EE; color: var(--green); }
  .pill.stored      { background: var(--amber-bg); color: var(--amber); }
  .pill.forwarded   { background: #E8F5EE; color: var(--green); }
  .pill.picked_up   { background: #F0F0F5; color: var(--ink-3); }
  .pill.shredded    { background: #F0F0F5; color: var(--ink-4); }
  .pill.ready_to_ship { background: var(--amber-bg); color: var(--amber); }
  .pill.confidential { background: var(--red-dim); color: var(--red); }
  .storage-warn {
    font-size: 10px; color: var(--amber); font-weight: 500;
  }
  .storage-warn.urgent { color: var(--red); }

  /* â”€â”€ Empty State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .empty-state {
    padding: 48px 24px;
    text-align: center;
    color: var(--ink-3);
  }
  .empty-icon { font-size: 32px; margin-bottom: 12px; opacity: 0.5; }
  .empty-title { font-size: 14px; font-weight: 500; color: var(--ink-2); margin-bottom: 4px; }
  .empty-sub   { font-size: 13px; color: var(--ink-4); }

  /* â”€â”€ Onboarding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .onboarding {
    max-width: 560px; margin: 40px auto;
    padding: 0 24px;
  }
  .onboard-header { margin-bottom: 28px; }
  .onboard-step {
    font-size: 11px; font-weight: 600; color: var(--red);
    text-transform: uppercase; letter-spacing: 0.08em;
    margin-bottom: 8px;
  }
  .onboard-title {
    font-family: 'DM Serif Display', serif;
    font-size: 26px; color: var(--ink); margin-bottom: 6px;
  }
  .onboard-sub { font-size: 14px; color: var(--ink-3); }

  .onboard-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    box-shadow: var(--shadow-md);
  }

  /* â”€â”€ Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .form-group { margin-bottom: 16px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .form-row-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 12px; }
  label {
    display: block; font-size: 12px; font-weight: 500;
    color: var(--ink-2); margin-bottom: 5px;
  }
  input[type=text], input[type=email], select, textarea {
    width: 100%; padding: 9px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--white);
    color: var(--ink); font-size: 13px;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--red);
    box-shadow: 0 0 0 3px var(--red-dim);
  }
  input::placeholder, textarea::placeholder { color: var(--ink-4); }
  textarea { resize: vertical; min-height: 72px; }
  .form-divider {
    font-size: 11px; font-weight: 600; color: var(--ink-4);
    text-transform: uppercase; letter-spacing: 0.08em;
    margin: 20px 0 14px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    gap: 6px; padding: 10px 20px;
    border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 500;
    transition: all 0.15s;
    cursor: pointer;
  }
  .btn-primary {
    background: var(--red); color: var(--white);
    border: 1px solid var(--red);
  }
  .btn-primary:hover { background: var(--red-light); }
  .btn-secondary {
    background: var(--white); color: var(--ink);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { background: var(--bg); }
  .btn-full { width: 100%; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-spinner {
    width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin  { to { transform: rotate(360deg); } }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.45; } }

  /* â”€â”€ Steps indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .steps {
    display: flex; gap: 8px; align-items: center;
    margin-bottom: 24px;
  }
  .step-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--border);
    transition: all 0.2s;
  }
  .step-dot.active { background: var(--red); transform: scale(1.3); }
  .step-dot.done   { background: var(--green); }
  .step-line { flex: 1; height: 1px; background: var(--border); }

  /* â”€â”€ Recipient Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .recipient-list { display: flex; flex-direction: column; gap: 8px; }
  .recipient-item {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: var(--shadow);
  }
  .recipient-avatar {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: var(--red-dim);
    color: var(--red);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 600; flex-shrink: 0;
  }
  .recipient-info { flex: 1; }
  .recipient-name { font-size: 13px; font-weight: 500; color: var(--ink); }
  .recipient-company { font-size: 11px; color: var(--ink-4); margin-top: 1px; }
  .recipient-status { }

  /* â”€â”€ Blocked Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .blocked-screen {
    display: flex; align-items: center; justify-content: center;
    min-height: calc(100vh - 56px);
    padding: 24px;
  }
  .blocked-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 40px 32px;
    max-width: 420px; width: 100%;
    text-align: center;
    box-shadow: var(--shadow-md);
  }
  .blocked-icon {
    width: 56px; height: 56px;
    border-radius: 50%;
    background: #FEE8E8;
    color: var(--red);
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
    margin: 0 auto 20px;
  }
  .blocked-title {
    font-family: 'DM Serif Display', serif;
    font-size: 20px; color: var(--ink); margin-bottom: 8px;
  }
  .blocked-msg { font-size: 13px; color: var(--ink-3); margin-bottom: 8px; line-height: 1.6; }
  .blocked-reason {
    font-size: 12px; color: var(--ink-4);
    background: var(--bg); border-radius: var(--radius-sm);
    padding: 8px 12px; margin-bottom: 24px;
  }

  /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tabs {
    display: flex; gap: 0;
    border-bottom: 1px solid var(--border);
    background: var(--white);
    padding: 0 24px;
    position: sticky; top: 56px; z-index: 90;
  }
  .tab {
    padding: 12px 16px;
    font-size: 13px; font-weight: 500;
    color: var(--ink-3);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tab.active { color: var(--red); border-color: var(--red); }
  .tab:hover:not(.active) { color: var(--ink-2); }

  /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast-container {
    position: fixed; bottom: 20px; right: 20px;
    display: flex; flex-direction: column; gap: 8px;
    z-index: 9999;
  }
  .toast {
    background: var(--ink); color: var(--white);
    padding: 10px 16px; border-radius: var(--radius-sm);
    font-size: 13px; box-shadow: var(--shadow-md);
    animation: toastIn 0.25s ease;
  }
  .toast.success { background: var(--green); }
  .toast.error   { background: var(--red); }
  @keyframes toastIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 600px) {
    .main { padding: 16px; gap: 16px; }
    .form-row, .form-row-3 { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: 1fr 1fr; }
    .header { padding: 0 16px; }
    .tabs { padding: 0 16px; overflow-x: auto; }
  }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading-screen">
  <div class="loading-logo">YYZ<span class="dot">.</span>Offices</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<!-- App -->
<div id="app">

  <!-- Header -->
  <header class="header">
    <div class="header-logo">YYZ<span class="dot">.</span>Offices</div>
    <div class="header-right">
      <span class="client-name" id="header-name"></span>
    </div>
  </header>

  <!-- Banner area -->
  <div id="banner-area"></div>

  <!-- Content area -->
  <div id="content-area"></div>

</div>

<!-- Toast container -->
<div class="toast-container" id="toasts"></div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API_URL = 'https://script.google.com/macros/s/AKfycbyBryhTn4ajucQTDfwlLwMPz2EPirt0WjO5BD9EcnTiT2plXl4DdCiHyJOoQs1xK20Njg/exec?';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let STATE = {
  uuid:         null,
  access:       null,
  activeSub:    null,
  mailLog:      [],
  planCard:     null,
  recipients:   [],
  activeTab:    'mail',
  loading:      false
};

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function qs(id) { return document.getElementById(id); }
function getUUID() {
  const params = new URLSearchParams(window.location.search);
  return params.get('uuid') || params.get('id') || null;
}
function fmtDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-CA', { month: 'short', day: 'numeric', year: 'numeric' });
}
function fmtDateTime(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-CA', { month: 'short', day: 'numeric' }) + ' ' +
         new Date(d).toLocaleTimeString('en-CA', { hour: 'numeric', minute: '2-digit' });
}
function daysUntil(d) {
  if (!d) return null;
  return Math.ceil((new Date(d) - new Date()) / (1000 * 60 * 60 * 24));
}
function initials(name) {
  return (name || '').split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase();
}
function toast(msg, type = '') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  qs('toasts').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}
async function api(path, opts = {}) {
  const url = API_URL + (path ? '&' + path : '');
  const res = await fetch(url, opts);
  return res.json();
}
async function apiPost(body) {
  return fetch(API_URL.replace('/exec', '/exec'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  }).then(r => r.json());
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

function getCachedAuth(uuid) {
  try {
    const raw = sessionStorage.getItem('auth_' + uuid);
    if (!raw) return null;
    const { data, ts } = JSON.parse(raw);
    if (Date.now() - ts > CACHE_TTL) { sessionStorage.removeItem('auth_' + uuid); return null; }
    return data;
  } catch(e) { return null; }
}

function setCachedAuth(uuid, data) {
  try { sessionStorage.setItem('auth_' + uuid, JSON.stringify({ data, ts: Date.now() })); } catch(e) {}
}

async function boot() {
  STATE.uuid = getUUID();

  if (!STATE.uuid) {
    hideLoading();
    showBlocked('No Access', 'No access credential found in URL.', null, null);
    return;
  }

  // Check session cache first â€” instant load on refresh
  const cached = getCachedAuth(STATE.uuid);
  if (cached && cached.status === 'client') {
    STATE.access = cached;
    hideLoading();
    renderClient(cached);
    // Silently refresh cache in background
    api('uuid=' + encodeURIComponent(STATE.uuid)).then(fresh => {
      if (fresh && fresh.status === 'client') setCachedAuth(STATE.uuid, fresh);
    }).catch(() => {});
    return;
  }

  // No cache â€” show loading bar then fetch
  await new Promise(r => setTimeout(r, 600));

  try {
    const data = await api('uuid=' + encodeURIComponent(STATE.uuid));
    STATE.access = data;
    hideLoading();

    if (data.status === 'blocked' || data.status === 'error') {
      showBlocked(
        data.status === 'error' ? 'Error' : 'Access Unavailable',
        data.message, null, null
      );
      return;
    }
    if (data.status === 'staff') {
      showBlocked('Wrong Portal', 'Please use the staff portal to access your dashboard.', null, null);
      return;
    }
    if (data.status === 'client') {
      setCachedAuth(STATE.uuid, data);
      renderClient(data);
    }

  } catch (err) {
    hideLoading();
    showBlocked('Connection Error', 'Could not connect to the server. Please try again.', null, null);
  }
}

function hideLoading() {
  const ls = qs('loading-screen');
  ls.classList.add('fade-out');
  setTimeout(() => { ls.style.display = 'none'; }, 400);
  qs('app').classList.add('visible');
}

// â”€â”€ Client Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderClient(access) {
  // Set name
  qs('header-name').innerHTML = `<strong>${access.name}</strong>`;

  // Pick first ACTIVE subscription, fallback to first
  const subs = access.subscriptions || [];
  STATE.activeSub = subs.find(s => s.accessStatus === 'ACTIVE') || subs[0];

  if (!STATE.activeSub) {
    showBlocked('No Subscription', 'No subscription found for your account.', null, null);
    return;
  }

  const sub = STATE.activeSub;

  // Show banner
  renderBanner(sub);

  // Route to correct screen
  if (!sub.canAccess) {
    renderBlockedSub(sub);
    return;
  }

  if (sub.setupRequired) {
    renderSetup(sub, access);
    return;
  }

  // Full dashboard
  renderDashboard(sub, access);
}

// â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBanner(sub) {
  const area = qs('banner-area');
  if (!sub.banner) { area.innerHTML = ''; return; }
  const b = sub.banner;
  const typeClass = {
    setup_required:      'setup',
    canceled_with_access:'warning',
    payment_required:    'error',
    canceled:            'error'
  }[b.type] || 'setup';

  const icon = {
    setup_required:      'ğŸ“‹',
    canceled_with_access:'â°',
    payment_required:    'ğŸ’³',
    canceled:            'ğŸ”’'
  }[b.type] || 'â„¹ï¸';

  const btnHtml = b.actionLabel && b.actionUrl
    ? `<button class="banner-btn" onclick="window.open('${b.actionUrl}','_blank')">${b.actionLabel}</button>`
    : b.actionLabel
    ? `<button class="banner-btn" onclick="handleBannerAction('${b.setupStep}')">${b.actionLabel}</button>`
    : '';

  area.innerHTML = `
    <div class="banner ${typeClass}">
      <span class="banner-icon">${icon}</span>
      <div class="banner-text">
        <strong>${b.title || ''}</strong>
        ${b.message || ''}
      </div>
      ${btnHtml}
    </div>`;
}

function handleBannerAction(step) {
  // Scroll to setup section or trigger it
  const setupEl = qs('setup-section');
  if (setupEl) setupEl.scrollIntoView({ behavior: 'smooth' });
}

// â”€â”€ Blocked Sub Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBlockedSub(sub) {
  const b = sub.banner || {};
  const icon = sub.accessStatus === 'PAYMENT_REQUIRED' ? 'ğŸ’³' : 'ğŸ”’';
  const btnHtml = b.actionLabel
    ? `<button class="btn btn-primary btn-full" onclick="window.open('${b.actionUrl||'#'}','_blank')">${b.actionLabel}</button>`
    : '';

  qs('content-area').innerHTML = `
    <div class="blocked-screen">
      <div class="blocked-card">
        <div class="blocked-icon">${icon}</div>
        <div class="blocked-title">${b.title || 'Access Unavailable'}</div>
        <p class="blocked-msg">${b.message || ''}</p>
        ${b.reason ? `<div class="blocked-reason">Reason: ${b.reason}</div>` : ''}
        ${btnHtml}
      </div>
    </div>`;
}

// â”€â”€ Blocked (no account) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showBlocked(title, msg, btnLabel, btnUrl) {
  qs('app').classList.add('visible');
  const btn = btnLabel ? `<button class="btn btn-primary btn-full" onclick="window.open('${btnUrl}','_blank')">${btnLabel}</button>` : '';
  qs('content-area').innerHTML = `
    <div class="blocked-screen">
      <div class="blocked-card">
        <div class="blocked-icon">ğŸ”’</div>
        <div class="blocked-title">${title}</div>
        <p class="blocked-msg">${msg}</p>
        ${btn}
      </div>
    </div>`;
}

// â”€â”€ Setup Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSetup(sub, access) {
  const step = sub.setupStep;

  const stepIndex = { plan_setup: 0, add_recipients: 1, pending_activation: 2 };
  const currentStep = stepIndex[step] ?? 0;

  const stepsHtml = [0,1,2].map((i, idx) => `
    <div class="step-dot ${i < currentStep ? 'done' : i === currentStep ? 'active' : ''}"></div>
    ${idx < 2 ? '<div class="step-line"></div>' : ''}
  `).join('');

  if (step === 'plan_setup') {
    renderOnboardingForm(sub, access, stepsHtml);
  } else if (step === 'add_recipients') {
    renderAddRecipient(sub, access, stepsHtml);
  } else if (step === 'pending_activation') {
    renderPendingActivation(sub, stepsHtml);
  }
}

function renderOnboardingForm(sub, access, stepsHtml) {
  qs('content-area').innerHTML = `
    <div class="onboarding" id="setup-section">
      <div class="onboard-header">
        <div class="onboard-step">Step 1 of 3 â€” Plan Setup</div>
        <div class="onboard-title">Set up your mailbox</div>
        <div class="onboard-sub">Tell us a bit about yourself and where to forward your mail.</div>
      </div>
      <div class="steps">${stepsHtml}</div>
      <div class="onboard-card">
        <form id="onboard-form">

          <div class="form-divider">Business Information</div>
          <div class="form-group">
            <label>Business Description <span style="color:var(--ink-4)">(one sentence)</span></label>
            <input type="text" id="ob-biz" placeholder="e.g. Digital marketing agency serving SMBs" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>How did you hear about us?</label>
              <select id="ob-referral">
                <option value="">Select...</option>
                <option>Google Search</option>
                <option>Referral</option>
                <option>Walk-in</option>
                <option>Social Media</option>
                <option>Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Preferred Pickup Time</label>
              <select id="ob-pickup">
                <option value="">No preference</option>
                <option>Mornings (9amâ€“12pm)</option>
                <option>Afternoons (12pmâ€“5pm)</option>
              </select>
            </div>
          </div>

          <div class="form-divider">Forwarding Address</div>
          <div class="form-group">
            <label>Street Address</label>
            <input type="text" id="ob-addr" placeholder="123 Main Street" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>City</label>
              <input type="text" id="ob-city" placeholder="Toronto" required>
            </div>
            <div class="form-group">
              <label>Province / State</label>
              <input type="text" id="ob-province" placeholder="ON" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Postal / ZIP Code</label>
              <input type="text" id="ob-postal" placeholder="M5H 2S3" required>
            </div>
            <div class="form-group">
              <label>Country</label>
              <input type="text" id="ob-country" value="Canada" required>
            </div>
          </div>
          <div class="form-group">
            <label>Forwarding Instructions <span style="color:var(--ink-4)">(optional)</span></label>
            <textarea id="ob-instructions" placeholder="e.g. Signature required, leave at front desk..."></textarea>
          </div>

          <div class="form-divider">Special Instructions</div>
          <div class="form-group">
            <label>Any special instructions for our team? <span style="color:var(--ink-4)">(optional)</span></label>
            <textarea id="ob-special" placeholder="e.g. Always notify immediately, scan all mail..."></textarea>
          </div>

          <button type="submit" class="btn btn-primary btn-full" id="ob-submit">
            Save & Continue
          </button>
        </form>
      </div>
    </div>`;

  qs('onboard-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = qs('ob-submit');
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-spinner"></span> Saving...';

    try {
      const result = await apiPost({
        action:              'submitOnboarding',
        uuid:                STATE.uuid,
        subscriptionId:      sub.subscriptionId,
        productId:           sub.productId || extractProductId(sub),
        locationId:          'LOC001',
        forwardingAddress:   qs('ob-addr').value,
        forwardingCity:      qs('ob-city').value,
        forwardingProvince:  qs('ob-province').value,
        forwardingPostalCode:qs('ob-postal').value,
        forwardingCountry:   qs('ob-country').value,
        forwardingInstructions: qs('ob-instructions').value,
        clientCountry:       qs('ob-country').value,
        clientProvince:      qs('ob-province').value,
        clientCity:          qs('ob-city').value,
        clientTimezone:      'America/Toronto',
        businessDescription: qs('ob-biz').value,
        referralSource:      qs('ob-referral').value,
        preferredPickupTime: qs('ob-pickup').value,
        specialInstructions: qs('ob-special').value
      });

      if (result.status === 'ok') {
        toast('Plan set up successfully!', 'success');
        // Refresh access
        setTimeout(() => location.reload(), 800);
      } else {
        throw new Error(result.message || 'Setup failed');
      }
    } catch (err) {
      toast(err.message, 'error');
      btn.disabled = false;
      btn.innerHTML = 'Save & Continue';
    }
  });
}

function extractProductId(sub) {
  // productId may not be in auth response â€” we get it from sub object
  // For now pass subscriptionId and let server look it up from billingDB
  return sub.productId || '';
}

function renderAddRecipient(sub, access, stepsHtml) {
  qs('content-area').innerHTML = `
    <div class="onboarding" id="setup-section">
      <div class="onboard-header">
        <div class="onboard-step">Step 2 of 3 â€” Add Recipient</div>
        <div class="onboard-title">Who will receive mail?</div>
        <div class="onboard-sub">Add at least one recipient name. This is the name that will appear on your mail.</div>
      </div>
      <div class="steps">${stepsHtml}</div>
      <div class="onboard-card">
        <form id="recipient-form">
          <div class="form-row">
            <div class="form-group">
              <label>Full Name</label>
              <input type="text" id="rc-name" placeholder="Jane Smith" required>
            </div>
            <div class="form-group">
              <label>Company Name <span style="color:var(--ink-4)">(optional)</span></label>
              <input type="text" id="rc-company" placeholder="Acme Corp">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Type</label>
              <select id="rc-type">
                <option value="individual">Individual</option>
                <option value="company">Company</option>
              </select>
            </div>
            <div class="form-group">
              <label>Notification Language</label>
              <select id="rc-lang">
                <option value="en">English</option>
              </select>
            </div>
          </div>
          <button type="submit" class="btn btn-primary btn-full" id="rc-submit">
            Add Recipient & Activate
          </button>
        </form>
      </div>
    </div>`;

  qs('recipient-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = qs('rc-submit');
    btn.disabled = true;
    btn.innerHTML = '<span class="btn-spinner"></span> Saving...';

    try {
      const result = await apiPost({
        action:      'addRecipient',
        uuid:        STATE.uuid,
        planCardId:  sub.planCardId,
        name:        qs('rc-name').value,
        companyName: qs('rc-company').value,
        type:        qs('rc-type').value,
        language:    qs('rc-lang').value,
        notifyOnArrival: true
      });

      if (result.status === 'ok') {
        toast('Recipient added! Awaiting staff activation.', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        throw new Error(result.message || 'Failed to add recipient');
      }
    } catch (err) {
      toast(err.message, 'error');
      btn.disabled = false;
      btn.innerHTML = 'Add Recipient & Activate';
    }
  });
}

function renderPendingActivation(sub, stepsHtml) {
  qs('content-area').innerHTML = `
    <div class="onboarding">
      <div class="onboard-header">
        <div class="onboard-step">Step 3 of 3 â€” Activation</div>
        <div class="onboard-title">Almost there!</div>
        <div class="onboard-sub">Our team is reviewing your mailbox setup. You'll receive a confirmation once activated.</div>
      </div>
      <div class="steps">${stepsHtml}</div>
      <div class="onboard-card" style="text-align:center; padding: 40px 24px;">
        <div style="font-size:40px; margin-bottom:16px;">â³</div>
        <div style="font-size:15px; font-weight:600; color:var(--ink); margin-bottom:8px;">Pending Activation</div>
        <p style="font-size:13px; color:var(--ink-3); line-height:1.6;">
          Your recipient has been submitted and is pending review by our team.
          This usually takes less than one business day.
        </p>
        <p style="font-size:12px; color:var(--ink-4); margin-top:16px;">
          Plan: <strong>${sub.planName}</strong>
        </p>
      </div>
    </div>`;
}

// â”€â”€ Skeleton HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function skeletonCard(lines = 2) {
  const bars = Array(lines).fill(0).map((_, i) =>
    `<div style="height:${i===0?'28px':'12px'};width:${i===0?'40%':Math.floor(50+Math.random()*40)+'%'};background:var(--bg-2);border-radius:4px;margin-bottom:8px;animation:pulse 1.4s ease infinite ${i*0.15}s"></div>`
  ).join('');
  return `<div style="padding:16px">${bars}</div>`;
}

// â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderDashboard(sub, access) {
  // Render shell + skeleton instantly â€” zero wait
  qs('content-area').innerHTML = `
    <div id="tabs-bar">
      <div class="tabs">
        <div class="tab active" onclick="switchTab('mail')"  id="tab-mail">Mail Log</div>
        <div class="tab"        onclick="switchTab('plan')"  id="tab-plan">My Plan</div>
        <div class="tab"        onclick="switchTab('recipients')" id="tab-recipients">Recipients</div>
      </div>
    </div>
    <div class="main" id="dashboard-content">
      <div class="stats-row" style="margin-bottom:20px">
        ${[0,1,2,3].map(() => `<div class="stat-card">${skeletonCard(2)}</div>`).join('')}
      </div>
      <div class="card">${skeletonCard(4)}</div>
    </div>`;

  // All 3 fetches fire simultaneously
  const [mailData, planData, recipientData] = await Promise.allSettled([
    api(`uuid=${STATE.uuid}&action=getMailLog&subscriptionId=${sub.subscriptionId}`),
    sub.planCardId ? api(`uuid=${STATE.uuid}&action=getPlanCard&planCardId=${sub.planCardId}`) : Promise.resolve(null),
    sub.planCardId ? api(`uuid=${STATE.uuid}&action=getRecipients&planCardId=${sub.planCardId}`) : Promise.resolve(null)
  ]);

  STATE.mailLog    = mailData.status === 'fulfilled' ? ((mailData.value.mailLog || []).filter(m => m.mailId)) : [];
  STATE.planCard   = planData.status === 'fulfilled' && planData.value ? planData.value.planCard : null;
  STATE.recipients = recipientData.status === 'fulfilled' && recipientData.value ? (recipientData.value.recipients || []) : [];

  renderMailTab(sub, access);
}

function switchTab(tab) {
  STATE.activeTab = tab;
  ['mail','plan','recipients'].forEach(t => {
    const el = qs('tab-' + t);
    if (el) el.classList.toggle('active', t === tab);
  });
  const sub = STATE.activeSub;
  const access = STATE.access;
  if (tab === 'mail')       renderMailTab(sub, access);
  if (tab === 'plan')       renderPlanTab(sub, access);
  if (tab === 'recipients') renderRecipientsTab(sub, access);
}

function renderMailTab(sub, access) {
  const dc = qs('dashboard-content');

  try {
    const mailLog = STATE.mailLog;

    // Stats â€” use real planCard limits from cache
    const pc         = STATE.planCard;
    const mailLimit  = pc ? (parseInt(pc.mailLimit) || 0) : 0;
    const mailsUsed  = pc ? (parseInt(pc.mailsUsed) || 0) : 0;
    const dueSoon = mailLog.filter(m => {
      if (['shredded','discarded','picked_up','forwarded'].includes(m.status)) return false;
      const days = daysUntil(m.storageDueDate);
      return days !== null && days >= 0 && days <= 5;
    }).length;
    const readyPickup = mailLog.filter(m => m.status === 'arrived' || m.status === 'scanned').length;
    const forwarded   = mailLog.filter(m => m.status === 'forwarded').length;
    const usePct      = mailLimit ? Math.min(100, Math.round(mailsUsed / mailLimit * 100)) : 0;
    const barClass    = usePct < 60 ? 'safe' : usePct < 85 ? 'warn' : 'danger';

    dc.innerHTML = `
      <div>
        <!-- Stats row -->
        <div class="stats-row" style="margin-bottom:20px">
          <div class="stat-card accent">
            <div class="stat-label">Mail This Period</div>
            <div class="stat-value">${mailsUsed}</div>
            <div class="stat-sub">of <strong>${mailLimit || 'â€”'}</strong> included</div>
            <div class="usage-bar"><div class="usage-bar-fill ${barClass}" style="width:${usePct}%"></div></div>
          </div>
          <div class="stat-card ${readyPickup > 0 ? 'blue' : ''}">
            <div class="stat-label">Ready for Pickup</div>
            <div class="stat-value">${readyPickup}</div>
            <div class="stat-sub">${readyPickup > 0 ? 'items waiting' : 'all clear'}</div>
          </div>
          <div class="stat-card ${dueSoon > 0 ? 'amber' : ''}">
            <div class="stat-label">Expiring Soon</div>
            <div class="stat-value">${dueSoon}</div>
            <div class="stat-sub">${dueSoon > 0 ? 'within 5 days' : 'nothing urgent'}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Forwarded</div>
            <div class="stat-value">${forwarded}</div>
            <div class="stat-sub">this period</div>
          </div>
        </div>

        <!-- Mail list -->
        <div class="section-header">
          <div class="section-title">Mail Log</div>
          <div class="section-action">Most recent first</div>
        </div>
        ${renderMailList(mailLog, sub)}
      </div>`;

  } catch (err) {
    dc.innerHTML = `<div class="empty-state">
      <div class="empty-icon">âš ï¸</div>
      <div class="empty-title">Could not load mail log</div>
      <div class="empty-sub">${err.message}</div>
    </div>`;
  }
}

function renderMailList(mailLog, sub) {
  const blurred = !sub.canAccess;
  if (!mailLog.length) return `
    <div class="card">
      <div class="empty-state">
        <div class="empty-icon">ğŸ“¬</div>
        <div class="empty-title">No mail yet</div>
        <div class="empty-sub">Your mail log will appear here once items are received.</div>
      </div>
    </div>`;

  const sorted = [...mailLog].sort((a,b) => new Date(b.loggedAt) - new Date(a.loggedAt));
  const items  = sorted.map(m => {
    const isParcel = m.type === 'parcel';
    const icon     = isParcel ? 'ğŸ“¦' : 'âœ‰ï¸';
    const days     = daysUntil(m.storageDueDate);
    const warnHtml = days !== null && days >= 0 && days <= 5 && !['picked_up','forwarded','shredded','discarded'].includes(m.status)
      ? `<div class="storage-warn ${days <= 2 ? 'urgent' : ''}">â° Expires in ${days}d</div>`
      : '';
    const confHtml = m.confidential === 'TRUE' || m.confidential === true
      ? `<span class="pill confidential">Confidential</span>` : '';

    return `
      <div class="mail-item ${blurred ? 'blurred' : ''}">
        <div class="mail-icon ${isParcel ? 'parcel' : 'letter'}">${icon}</div>
        <div class="mail-info">
          <div class="mail-recipient">${m.recipientName || 'Unknown'}</div>
          <div class="mail-date">${fmtDateTime(m.loggedAt)}${m.senderName ? ' Â· From: <strong>' + m.senderName + '</strong>' : ''}</div>
          ${m.noteToClient ? `<div style="font-size:11px;color:var(--ink-3);margin-top:2px">${m.noteToClient}</div>` : ''}
        </div>
        <div class="mail-meta">
          <span class="pill ${m.status}">${m.status.replace(/_/g,' ')}</span>
          ${confHtml}
          ${warnHtml}
        </div>
      </div>`;
  }).join('');

  return `<div class="mail-list">${items}</div>`;
}

function renderPlanTab(sub, access) {
  const dc = qs('dashboard-content');
  const pc = STATE.planCard;

  const mailLimit    = pc ? (parseInt(pc.mailLimit)    || 0) : 0;
  const parcelLimit  = pc ? (parseInt(pc.parcelLimit)  || 0) : 0;
  const mailsUsed    = pc ? (parseInt(pc.mailsUsed)    || 0) : 0;
  const parcelsUsed  = pc ? (parseInt(pc.parcelsUsed)  || 0) : 0;
  const mailPct      = mailLimit  ? Math.min(100, Math.round(mailsUsed  / mailLimit  * 100)) : 0;
  const parcelPct    = parcelLimit? Math.min(100, Math.round(parcelsUsed/ parcelLimit* 100)) : 0;
  const mailBar      = mailPct   < 60 ? 'safe' : mailPct   < 85 ? 'warn' : 'danger';
  const parcelBar    = parcelPct < 60 ? 'safe' : parcelPct < 85 ? 'warn' : 'danger';

  const fwdAddr = pc ? [pc.forwardingAddress, pc.forwardingCity, pc.forwardingProvince, pc.forwardingPostalCode].filter(Boolean).join(', ') : 'â€”';

  dc.innerHTML = `
    <div style="display:flex; flex-direction:column; gap:16px">

      <div class="card" style="padding:20px">
        <div class="section-header" style="margin-bottom:16px">
          <div class="section-title">Plan Details</div>
          <span class="pill scanned">${sub.accessStatus}</span>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:13px;">
          <div>
            <div style="color:var(--ink-4); font-size:11px; margin-bottom:3px; text-transform:uppercase; letter-spacing:.05em">Plan</div>
            <div style="font-weight:500">${sub.planName}</div>
          </div>
          <div>
            <div style="color:var(--ink-4); font-size:11px; margin-bottom:3px; text-transform:uppercase; letter-spacing:.05em">Billing</div>
            <div style="font-weight:500">${pc ? pc.billingCycle : 'â€”'}</div>
          </div>
          <div>
            <div style="color:var(--ink-4); font-size:11px; margin-bottom:3px; text-transform:uppercase; letter-spacing:.05em">Period</div>
            <div style="font-weight:500">${pc ? fmtDate(pc.currentPeriodStart) + ' â€“ ' + fmtDate(pc.currentPeriodEnd) : 'â€”'}</div>
          </div>
          <div>
            <div style="color:var(--ink-4); font-size:11px; margin-bottom:3px; text-transform:uppercase; letter-spacing:.05em">Location</div>
            <div style="font-weight:500">YYZ Main Office</div>
          </div>
        </div>
      </div>

      <div class="card" style="padding:20px">
        <div class="section-title" style="margin-bottom:16px">Usage This Period</div>
        <div style="display:flex; flex-direction:column; gap:14px">
          <div>
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:6px">
              <span style="font-weight:500">Mail</span>
              <span style="color:var(--ink-3)">${mailsUsed} / ${mailLimit}</span>
            </div>
            <div class="usage-bar" style="height:6px"><div class="usage-bar-fill ${mailBar}" style="width:${mailPct}%"></div></div>
          </div>
          ${parcelLimit > 0 ? `
          <div>
            <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:6px">
              <span style="font-weight:500">Parcels</span>
              <span style="color:var(--ink-3)">${parcelsUsed} / ${parcelLimit}</span>
            </div>
            <div class="usage-bar" style="height:6px"><div class="usage-bar-fill ${parcelBar}" style="width:${parcelPct}%"></div></div>
          </div>` : ''}
        </div>
      </div>

      ${pc && pc.forwardingEnabled === 'TRUE' || pc && pc.forwardingEnabled === true ? `
      <div class="card" style="padding:20px">
        <div class="section-title" style="margin-bottom:12px">Forwarding Address</div>
        <div style="font-size:13px; color:var(--ink-2)">${fwdAddr}</div>
        ${pc.forwardingInstructions ? `<div style="font-size:12px; color:var(--ink-4); margin-top:6px">${pc.forwardingInstructions}</div>` : ''}
      </div>` : ''}

    </div>`;
}

function renderRecipientsTab(sub, access) {
  const dc = qs('dashboard-content');
  try {
    const recipients = STATE.recipients;

    const listHtml = recipients.length === 0
      ? `<div class="empty-state" style="background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:40px">
          <div class="empty-icon">ğŸ‘¤</div>
          <div class="empty-title">No recipients yet</div>
          <div class="empty-sub">Add a recipient to start receiving mail.</div>
        </div>`
      : `<div class="recipient-list">
          ${recipients.map(r => `
            <div class="recipient-item">
              <div class="recipient-avatar">${initials(r.name)}</div>
              <div class="recipient-info">
                <div class="recipient-name">${r.name || 'â€”'}</div>
                <div class="recipient-company">${r.companyName || r.type || ''}</div>
              </div>
              <div class="recipient-status">
                <span class="pill ${r.status === 'active' ? 'scanned' : 'stored'}">${r.status}</span>
              </div>
            </div>`).join('')}
        </div>`;

    dc.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="section-header">
          <div class="section-title">Recipients</div>
        </div>
        ${listHtml}
      </div>`;

  } catch(err) {
    dc.innerHTML = `<div class="empty-state">
      <div class="empty-icon">âš ï¸</div>
      <div class="empty-title">Could not load recipients</div>
      <div class="empty-sub">${err.message}</div>
    </div>`;
  }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
boot();
</script>
</body>
</html>
