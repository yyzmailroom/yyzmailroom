<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YYZ Offices — Staff Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
  /* ── THEME CONFIG (changeable from staff panel later) ──── */
  :root {
    --theme:      #8B1A1A;

    --red:        #8B1A1A;
    --red-light:  #A52020;
    --red-dim:    rgba(139,26,26,0.08);
    --red-border: rgba(139,26,26,0.18);
    --ink:        #1A1A1F;
    --ink-2:      #3D3D45;
    --ink-3:      #72727D;
    --ink-4:      #A8A8B0;
    --bg:         #F7F6F4;
    --bg-2:       #EFEDE9;
    --white:      #FFFFFF;
    --border:     #E2E0DB;
    --shadow:     0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md:  0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
    --radius:     10px;
    --radius-sm:  6px;
    --green:      #1A6B3C;
    --green-bg:   #E8F5EE;
    --amber:      #92520A;
    --amber-bg:   #FEF3E2;
    --blue:       #1A4A7A;
    --blue-bg:    #E8F0FA;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--ink);
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }
  button { font-family: inherit; cursor: pointer; border: none; outline: none; }
  input, select, textarea { font-family: inherit; outline: none; }

  /* ── Loading ────────────────────────────────────────── */
  #loading-screen {
    position: fixed; inset: 0;
    background: var(--white);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 16px; z-index: 9999;
    transition: opacity 0.4s ease;
  }
  #loading-screen.fade-out { opacity: 0; pointer-events: none; }
  .loading-logo { font-family: 'DM Serif Display', serif; font-size: 22px; color: var(--ink); }
  .loading-logo span { color: var(--red); }
  .loading-sub { font-size: 12px; color: var(--ink-4); }
  .loading-bar { width: 120px; height: 2px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .loading-bar-fill { height: 100%; width: 0; background: var(--red); border-radius: 2px; animation: loadBar 1s ease forwards; }
  @keyframes loadBar { to { width: 100%; } }
  @keyframes spinBtn { to { transform: rotate(360deg); } }
  .spin-active { animation: spinBtn 0.7s linear infinite; display:inline-block; }

  /* ── App ────────────────────────────────────────────── */
  #app { display: none; flex-direction: column; height: 100vh; overflow: hidden; }
  .workspace { flex: 1; overflow: hidden; }
  #app.visible { display: flex; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* ── Header (single unified bar) ────────────────────── */
  .topbar {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    height: 54px;
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0; z-index: 100; gap: 16px;
  }
  .topbar-left { display: flex; align-items: center; gap: 14px; flex-shrink: 0; }
  .header-logo { display: flex; align-items: center; }
  .header-divider {
    width: 1px; height: 20px; background: var(--border); flex-shrink: 0;
  }
  .staff-badge {
    background: var(--red-dim); color: var(--red);
    font-size: 9px; font-weight: 700; letter-spacing: 0.08em;
    text-transform: uppercase; padding: 3px 8px; border-radius: 20px;
    flex-shrink: 0;
  }
  .staff-name {
    font-size: 12px; color: var(--ink-3);
    display: flex; align-items: center; gap: 8px; flex-shrink: 0;
  }
  .staff-name strong { color: var(--ink); font-weight: 600; }
  .staff-name .role-tag { font-size: 11px; color: var(--ink-4); }
  .staff-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    background: var(--red-dim); color: var(--red);
    font-size: 11px; font-weight: 700;
    display: inline-flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  /* ── Centre pill nav ─────────────────────────────────── */
  .main-nav {
    flex: 1;
    display: flex; align-items: center; justify-content: center;
    gap: 2px;
  }
  .nav-group {
    display: flex; align-items: center; gap: 2px;
    background: var(--bg-2);
    border-radius: 8px;
    padding: 3px;
  }
  .nav-btn {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 6px 12px;
    font-size: 12px; font-weight: 500; color: var(--ink-3);
    cursor: pointer; transition: all 0.15s;
    background: transparent; border: none; border-radius: 6px;
    white-space: nowrap; font-family: inherit;
  }
  .nav-btn:hover { background: rgba(255,255,255,0.7); color: var(--ink); }
  .nav-btn.active {
    background: var(--white); color: var(--ink); font-weight: 600;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
  }
  .nav-btn svg { opacity: 0.45; flex-shrink: 0; transition: opacity 0.15s; }
  .nav-btn:hover svg, .nav-btn.active svg { opacity: 0.9; }

  /* Log Mail — prominent pill CTA, sits right of nav group */
  .nav-log-cta {
    background: var(--red); color: var(--white) !important;
    border: none; border-radius: 7px;
    padding: 7px 15px; font-weight: 600; font-size: 12px;
    margin-left: 6px;
    box-shadow: 0 1px 4px rgba(139,26,26,0.3), 0 0 0 0 rgba(139,26,26,0);
    transition: all 0.15s; font-family: inherit;
    display: inline-flex; align-items: center; gap: 5px;
    cursor: pointer; white-space: nowrap;
  }
  .nav-log-cta:hover {
    background: var(--red-light) !important;
    box-shadow: 0 2px 10px rgba(139,26,26,0.4);
    transform: translateY(-1px);
  }
  .nav-log-cta.active {
    background: #6B1414 !important;
    box-shadow: 0 1px 3px rgba(139,26,26,0.2);
    transform: none;
  }
  .nav-log-cta svg { opacity: 1 !important; }

  /* ── Layout ─────────────────────────────────────────── */
  .workspace {
    flex: 1; display: flex; overflow: hidden;
  }

  /* ── Split View ─────────────────────────────────────── */
  .pane {
    display: flex; flex-direction: column;
    overflow: hidden;
  }
  .pane-left {
    width: 420px; flex-shrink: 0;
    border-right: 1px solid var(--border);
    background: var(--white);
  }
  .pane-right {
    flex: 1; background: var(--bg);
    overflow-y: auto;
  }

  /* Full views */
  .pane-full {
    flex: 1; overflow-y: auto;
    background: var(--bg);
    padding: 24px 28px;
  }

  /* ── Pane Header ────────────────────────────────────── */
  .pane-header {
    padding: 14px 16px 12px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
  }
  .pane-title {
    font-size: 12px; font-weight: 600; color: var(--ink-2);
    text-transform: uppercase; letter-spacing: 0.06em;
  }
  .pane-count {
    background: var(--red-dim); color: var(--red);
    font-size: 11px; font-weight: 600;
    padding: 1px 7px; border-radius: 20px;
  }
  .pane-count.green { background: var(--green-bg); color: var(--green); }

  /* ── Task List ──────────────────────────────────────── */
  .task-list { overflow-y: auto; flex: 1; }
  .task-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
    position: relative;
  }
  .task-item:hover { background: var(--bg); }
  .task-item.selected { background: #FEF5F5; }
  .task-item::before {
    content: '';
    position: absolute; left: 0; top: 0; bottom: 0;
    width: 3px;
  }
  .task-item.pri-high::before   { background: var(--red); }
  .task-item.pri-medium::before { background: #D97706; }
  .task-item.pri-low::before    { background: var(--ink-4); }
  .task-item.overdue { background: #FFF8F8; }

  .task-top {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 4px;
  }
  .task-type {
    font-size: 12px; font-weight: 600; color: var(--ink);
    display: flex; align-items: center; gap: 6px;
  }
  .task-type-icon { font-size: 14px; }
  .task-right { display: flex; align-items: center; gap: 6px; }
  .task-due {
    font-size: 10px; color: var(--ink-4);
  }
  .task-due.overdue { color: var(--red); font-weight: 600; }
  .task-notes {
    font-size: 12px; color: var(--ink-3);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 100%;
  }
  .task-client {
    font-size: 11px; color: var(--ink-4); margin-top: 2px;
  }

  .pill {
    display: inline-flex; align-items: center;
    padding: 1px 7px; border-radius: 20px;
    font-size: 10px; font-weight: 600; white-space: nowrap;
  }
  .pill.high   { background: #FEE8E8; color: var(--red); }
  .pill.medium { background: var(--amber-bg); color: var(--amber); }
  .pill.low    { background: #F0F0F5; color: var(--ink-3); }
  .pill.overdue { background: #FEE8E8; color: var(--red); }
  .pill.done   { background: var(--green-bg); color: var(--green); }
  .pill.arrived     { background: var(--blue-bg); color: var(--blue); }
  .pill.scanned     { background: var(--green-bg); color: var(--green); }
  .pill.stored      { background: var(--amber-bg); color: var(--amber); }
  .pill.forwarded   { background: var(--green-bg); color: var(--green); }
  .pill.picked_up   { background: #F0F0F5; color: var(--ink-3); }
  .pill.active-plan { background: var(--green-bg); color: var(--green); }

  /* ── Task Detail ────────────────────────────────────── */
  .task-detail {
    padding: 20px;
    display: flex; flex-direction: column; gap: 16px;
  }
  .detail-header { }
  .detail-type {
    font-size: 11px; font-weight: 600; color: var(--red);
    text-transform: uppercase; letter-spacing: 0.07em;
    margin-bottom: 6px;
  }
  .detail-title {
    font-family: 'DM Serif Display', serif;
    font-size: 20px; color: var(--ink); margin-bottom: 4px;
  }
  .detail-sub { font-size: 13px; color: var(--ink-3); }
  .detail-card {
    background: var(--white); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px;
    box-shadow: var(--shadow);
  }
  .detail-row {
    display: flex; justify-content: space-between;
    padding: 7px 0; border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .detail-row:last-child { border-bottom: none; }
  .detail-row label { color: var(--ink-3); font-size: 12px; }
  .detail-row value { font-weight: 500; color: var(--ink); }

  /* ── Resolve Form ───────────────────────────────────── */
  .resolve-form { }
  .resolve-textarea {
    width: 100%; padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--white);
    color: var(--ink); font-size: 13px;
    resize: vertical; min-height: 80px;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .resolve-textarea:focus {
    border-color: var(--red);
    box-shadow: 0 0 0 3px var(--red-dim);
    outline: none;
  }
  .resolve-actions { display: flex; gap: 8px; margin-top: 10px; }

  /* ── Log Form ───────────────────────────────────────── */
  .log-form-wrap { padding: 16px; overflow-y: auto; flex: 1; }
  .form-group { margin-bottom: 14px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  label {
    display: block; font-size: 11px; font-weight: 500;
    color: var(--ink-3); margin-bottom: 4px;
    text-transform: uppercase; letter-spacing: 0.05em;
  }
  input[type=text], input[type=email], select, textarea {
    width: 100%; padding: 8px 11px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--white);
    color: var(--ink); font-size: 13px;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--red);
    box-shadow: 0 0 0 3px var(--red-dim);
  }
  input::placeholder, textarea::placeholder { color: var(--ink-4); }
  textarea { resize: vertical; min-height: 60px; }

  /* Search recipient */
  .recipient-search-wrap { position: relative; }
  .recipient-results {
    position: absolute; top: 100%; left: 0; right: 0;
    background: var(--white); border: 1px solid var(--border);
    border-radius: var(--radius-sm); box-shadow: var(--shadow-md);
    z-index: 200; max-height: 200px; overflow-y: auto;
  }
  .recipient-result-item {
    padding: 10px 12px; cursor: pointer;
    border-bottom: 1px solid var(--border);
    font-size: 13px; transition: background 0.1s;
  }
  .recipient-result-item:hover { background: var(--bg); }
  .recipient-result-item:last-child { border-bottom: none; }
  .rri-name { font-weight: 500; }
  .rri-sub  { font-size: 11px; color: var(--ink-4); margin-top: 1px; }

  /* ── Buttons ────────────────────────────────────────── */
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    gap: 6px; padding: 9px 18px;
    border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 500;
    transition: all 0.15s; cursor: pointer;
  }
  .btn-primary { background: var(--red); color: var(--white); border: 1px solid var(--red); }
  .btn-primary:hover { background: var(--red-light); }
  .btn-secondary { background: var(--white); color: var(--ink); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--bg); }
  .btn-success { background: var(--green); color: var(--white); border: 1px solid var(--green); }
  .btn-danger  { background: #C0392B; color: var(--white); border: 1px solid #C0392B; }
  .btn-sm { padding: 6px 12px; font-size: 12px; }
  .btn-full { width: 100%; }
  .btn:disabled { opacity: 0.45; cursor: not-allowed; }
  .btn-spinner {
    width: 12px; height: 12px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white; border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── Empty / Loading ────────────────────────────────── */
  .empty-pane {
    flex: 1; display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 8px;
    color: var(--ink-4); text-align: center; padding: 32px;
  }
  .empty-icon { font-size: 28px; opacity: 0.5; }
  .empty-title { font-size: 13px; font-weight: 500; color: var(--ink-3); }
  .empty-sub   { font-size: 12px; }

  /* ── Blocked ────────────────────────────────────────── */
  .blocked-screen {
    display: flex; align-items: center; justify-content: center;
    height: 100%; padding: 24px;
  }
  .blocked-card {
    background: var(--white); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 40px 32px;
    max-width: 380px; text-align: center;
    box-shadow: var(--shadow-md);
  }
  .blocked-icon {
    width: 52px; height: 52px; border-radius: 50%;
    background: #FEE8E8; color: var(--red);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px; margin: 0 auto 16px;
  }
  .blocked-title { font-family: 'DM Serif Display', serif; font-size: 18px; margin-bottom: 8px; }
  .blocked-msg { font-size: 13px; color: var(--ink-3); }

  /* ── Toast ──────────────────────────────────────────── */
  .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
  .toast {
    background: var(--ink); color: var(--white);
    padding: 10px 16px; border-radius: var(--radius-sm);
    font-size: 13px; box-shadow: var(--shadow-md);
    animation: toastIn 0.25s ease;
  }
  .toast.success { background: var(--green); }
  .toast.error   { background: var(--red); }
  @keyframes toastIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

  /* ── Tabs ───────────────────────────────────────────── */
  .nav-tabs {
    display: flex; border-bottom: 1px solid var(--border);
    padding: 0 16px; background: var(--white); flex-shrink: 0;
  }
  .nav-tab {
    padding: 10px 14px; font-size: 12px; font-weight: 500;
    color: var(--ink-3); cursor: pointer;
    border-bottom: 2px solid transparent; margin-bottom: -1px;
    transition: all 0.15s; white-space: nowrap;
  }
  .nav-tab.active { color: var(--red); border-color: var(--red); }
  .nav-tab:hover:not(.active) { color: var(--ink-2); }

  /* ── Section ────────────────────────────────────────── */
  .section-label {
    font-size: 10px; font-weight: 700; letter-spacing: 0.08em;
    text-transform: uppercase; color: var(--ink-4);
    padding: 10px 16px 6px;
  }

  /* ── Divider ────────────────────────────────────────── */
  .form-divider {
    font-size: 10px; font-weight: 600; color: var(--ink-4);
    text-transform: uppercase; letter-spacing: 0.07em;
    margin: 16px 0 10px;
    padding-bottom: 6px; border-bottom: 1px solid var(--border);
  }

  /* ── Toggle ─────────────────────────────────────────── */
  .toggle-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px;
  }
  .toggle-label { font-size: 13px; color: var(--ink-2); }
  .toggle {
    width: 36px; height: 20px; border-radius: 20px;
    background: var(--border); position: relative;
    cursor: pointer; transition: background 0.2s; flex-shrink: 0;
  }
  .toggle.on { background: var(--green); }
  .toggle::after {
    content: ''; position: absolute;
    width: 16px; height: 16px; border-radius: 50%;
    background: white; top: 2px; left: 2px;
    transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .toggle.on::after { transform: translateX(16px); }

  /* ── Stats bar ──────────────────────────────────────── */
  .stats-mini {
    display: flex; gap: 0;
    border-bottom: 1px solid var(--border);
    background: var(--white); flex-shrink: 0;
  }
  .stat-mini {
    flex: 1; padding: 10px 12px; text-align: center;
    border-right: 1px solid var(--border);
  }
  .stat-mini:last-child { border-right: none; }
  .stat-mini-val {
    font-family: 'DM Serif Display', serif;
    font-size: 20px; color: var(--ink); line-height: 1;
  }
  .stat-mini-val.red { color: var(--red); }
  .stat-mini-val.amber { color: var(--amber); }
  .stat-mini-label { font-size: 10px; color: var(--ink-4); margin-top: 3px; }


  /* ── Forwarding/exceptions/plancards ─────────────────── */
  .fwd-item { display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);background:var(--white);transition:background 0.1s; }
  .fwd-item:hover { background:var(--bg); }
  .fwd-checkbox { width:16px;height:16px;cursor:pointer;flex-shrink:0;accent-color:var(--blue); }
  .pc-card { background:var(--white);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:12px;box-shadow:var(--shadow);overflow:hidden; }
  .pc-card-header { padding:12px 16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;border-bottom:1px solid transparent;transition:background 0.1s; }
  .pc-card-header:hover { background:var(--bg); }
  .pc-card-header.open { border-bottom-color:var(--border);background:var(--bg); }
  .pc-card-body { padding:14px 16px; }
  .rec-row { display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px; }
  .rec-row:last-child { border-bottom:none; }
  .exc-item { background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:10px;box-shadow:var(--shadow); }
  .exc-actions { display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap;margin-top:10px; }
  .pill.forwarding_pending { background:#E8F4FF;color:var(--blue); }
  .pill.forwarded { background:var(--green-bg);color:var(--green); }
  .pill.payment_req { background:#FEE8E8;color:var(--red); }
  .pill.warning { background:var(--amber-bg);color:var(--amber); }
  .pill.void { background:#F0F0F5;color:var(--ink-4); }
  .pill.expired { background:#F0F0F5;color:var(--ink-4); }
  @media (max-width: 700px) {
    .pane-left { width: 100%; border-right: none; }
    .workspace { flex-direction: column; }
  }

  /* Refresh animation */
  @keyframes spin { to { transform: rotate(360deg); } }
  .refreshing { animation: spin 0.8s linear infinite; display:inline-block; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div id="loading-screen">
  <div class="loading-logo">
    <img src="https://yyzoffices.com/wp-content/uploads/2026/02/logo-transparent-png-1-scaled.png"
      alt="YYZ Offices" style="height:52px;width:auto;display:block;margin:0 auto"
      onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
    <span style="display:none">YYZ<span>.</span>Offices</span>
  </div>
  <div class="loading-sub">Staff Portal</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<div id="app">
  <!-- Single unified header bar -->
  <div class="topbar">
    <!-- Left: logo + badge -->
    <div class="topbar-left">
      <div class="header-logo">
        <img src="https://yyzoffices.com/wp-content/uploads/2026/02/logo-transparent-png-scaled.png"
          alt="YYZ Offices" style="height:26px;width:auto;display:block"
          onerror="this.style.display='none';this.nextElementSibling.style.display='inline'">
        <span style="display:none">YYZ<span style="color:var(--red)">.</span>Offices</span>
      </div>
      <div class="header-divider"></div>
      <div class="staff-badge">Staff</div>
    </div>

    <!-- Centre: pill nav group + Log Mail CTA -->
    <nav class="main-nav" id="view-toggle">
      <div class="nav-group">
        <button class="nav-btn" onclick="setView('split')" id="vbtn-split">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="8" height="18" rx="1"/><rect x="13" y="3" width="8" height="18" rx="1"/></svg>
          Split
        </button>
        <button class="nav-btn" onclick="setView('tasks')" id="vbtn-tasks">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
          Tasks
        </button>
        <button class="nav-btn" onclick="setView('maillog')" id="vbtn-maillog">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Mail Log
        </button>
        <button class="nav-btn" onclick="setView('exceptions')" id="vbtn-exceptions">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          Exceptions
        </button>
        <button class="nav-btn" onclick="setView('plancards')" id="vbtn-plancards">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
          Plan Cards
        </button>
      </div>

      <button class="nav-log-cta" onclick="setView('log')" id="vbtn-log">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        Log Mail
      </button>
    </nav>

    <!-- Right: staff identity -->
    <div class="staff-name" id="header-name"></div>
  </div>

  <div id="workspace" class="workspace"></div>
</div>

<div class="toast-container" id="toasts"></div>

<script>
// API_URL removed — using Supabase adapter below

let STATE = {
  recipientsCache: null,
  uuid:         null,
  access:       null,
  tasks:        [],
  selectedTask: null,
  view:         'log',    // split | tasks | log | maillog | exceptions | plancards
  logRecipient: null,
  logPlanCard:  null,
  submitting:   false
};

// ── Utils ────────────────────────────────────────────────
function qs(id) { return document.getElementById(id); }
function getUUID() {
  return new URLSearchParams(window.location.search).get('uuid') || null;
}
function fmtDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-CA', { month:'short', day:'numeric', year:'numeric' });
}
function fmtDateTime(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-CA', { month:'short', day:'numeric' }) + ' ' +
         new Date(d).toLocaleTimeString('en-CA', { hour:'numeric', minute:'2-digit' });
}
function daysUntil(d) {
  if (!d) return null;
  return Math.ceil((new Date(d) - new Date()) / (1000*60*60*24));
}
function toast(msg, type='') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  qs('toasts').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}
// api() replaced by Supabase adapter
// ============================================================
// YYZ OFFICES — SUPABASE ADAPTER
// Drop-in replacement for the GAS api() and apiPost() functions.
// Returns the EXACT same response shapes so zero UI code changes needed.
//




// ============================================================

const SUPABASE_URL  = 'https://catpufkbjmcjmtuisdok.supabase.co';
const SUPABASE_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhdHB1Zmtiam1jam10dWlzZG9rIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc3MjIyNDgyNSwiZXhwIjoyMDg3ODAwODI1fQ.f2lEF3S063-qlwYwXW5aU5GbIPSNwzWtXw4ZtLk7cwg';

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ── ID Generator (matches existing format) ──────────────
function _genId(prefix) {
  const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let id = prefix;
  for (let i = 0; i < 12; i++) id += c[Math.floor(Math.random() * c.length)];
  return id;
}

// ── camelCase ↔ snake_case helpers ──────────────────────
function toSnake(s) { return s.replace(/([A-Z])/g, '_$1').toLowerCase(); }
function toCamel(s) { return s.replace(/_([a-z])/g, (_, c) => c.toUpperCase()); }
function rowToCamel(row) {
  if (!row) return row;
  const out = {};
  for (const [k, v] of Object.entries(row)) out[toCamel(k)] = v;
  return out;
}
function rowsToCamel(rows) { return (rows || []).map(rowToCamel); }

// ============================================================
// REPLACEMENT: api(path) — handles GET-style calls
// Parses the query string and routes to the right handler
// ============================================================
async function api(path) {
  const params = new URLSearchParams(path);
  const uuid   = params.get('uuid');
  const action = params.get('action');

  if (!action) {
    // Boot call — resolveAccess
    return _resolveAccess(uuid);
  }

  switch (action) {
    case 'getTasks':            return _getTasks(uuid);
    case 'searchRecipients':    return _searchRecipients(uuid, params.get('q') || '');
    case 'getMailLogStaff':     return _getMailLogStaff(uuid);
    case 'getAgentsForPlanCard':return _getAgentsForPlanCard(uuid, params.get('planCardId'));
    case 'getExceptions':       return _getExceptions(uuid);
    case 'getPlanCardsStaff':   return _getPlanCardsStaff(uuid);
    default:
      return { status: 'error', message: 'Unknown action: ' + action };
  }
}

// ============================================================
// REPLACEMENT: apiPost(body) — handles write calls + complex reads
// ============================================================
async function apiPost(body) {
  const action = body.action;
  const uuid   = body.uuid;

  switch (action) {
    // ── Client reads ──
    case 'getMailLog':       return _getClientMailLog(uuid, body.subscriptionId);
    case 'getPlanCard':      return _getPlanCard(uuid, body.subscriptionId);
    case 'getAgents':        return _getAgents(uuid, body.subscriptionId);
    case 'getRecipients':    return _getRecipients(uuid, body.subscriptionId);
    case 'getPlanTemplate':  return _getPlanTemplate(body.productId);

    // ── Client writes ──
    case 'submitOnboarding': return _submitOnboarding(body);
    case 'addRecipient':     return _addRecipient(body);
    case 'updateFriendlyName': return _updateFriendlyName(body);

    // ── Staff writes ──
    case 'logMail':               return _logMail(body);
    case 'resolveTask':           return _resolveTask(body);
    case 'snoozeTask':            return _snoozeTask(body);
    case 'releaseMail':           return _releaseMail(body);
    case 'bulkForwardMail':       return _bulkForwardMail(body);
    case 'assignMailRecipient':   return _assignMailRecipient(body);
    case 'editMailItem':          return _editMailItem(body);
    case 'deleteMailItem':        return _deleteMailItem(body);
    case 'updateMailStatus':      return _updateMailStatus(body);
    case 'addTempRecipient':      return _addTempRecipient(body);
    case 'updateRecipient':       return _updateRecipient(body);
    case 'updateRecipientStatus': return _updateRecipientStatus(body);
    case 'notifyNonPayment':      return { status: 'ok' }; // TODO: email notification

    default:
      return { status: 'error', message: 'Unknown action: ' + action };
  }
}

// ============================================================
// RESOLVE ACCESS (boot call)
// Must return the exact shape the frontend expects
// ============================================================
async function _resolveAccess(uuid) {
  if (!uuid) return { status: 'error', message: 'No UUID provided' };

  // Check staff first
  const { data: staff } = await sb.from('staff').select('*')
    .eq('staff_id', uuid).eq('active', true).maybeSingle();
  if (staff) {
    return {
      status:     'staff',
      role:       staff.role,
      name:       staff.name,
      email:      staff.email,
      staffId:    staff.staff_id,
      locationId: staff.default_location_id,
      pin:        staff.pin
    };
  }

  // Check client
  const { data: client } = await sb.from('clients').select('*')
    .eq('id', uuid).maybeSingle();
  if (!client || client.status !== 'active') {
    return { status: 'blocked', message: 'Account not found or inactive.' };
  }

  // Get all subscriptions
  const { data: subs } = await sb.from('subscriptions').select('*')
    .eq('client_id', uuid).order('created_at', { ascending: false });

  // Get all plan cards for this client
  const { data: planCards } = await sb.from('plan_cards').select('*')
    .eq('client_id', uuid);

  const planCardMap = {};
  (planCards || []).forEach(pc => { planCardMap[pc.subscription_id] = pc; });

  // Build subscription objects matching GAS response shape
  const subscriptions = (subs || []).map(s => {
    const pc = planCardMap[s.id];
    const accessStatus = s.access_status || 'ACTIVE';
    const canAccess = ['ACTIVE', 'CANCELED_WITH_ACCESS'].includes(accessStatus);
    const setupRequired = canAccess && !pc;
    const setupStep = setupRequired ? 'plan_setup' : (pc && !pc.activated_at ? 'plan_setup' : null);

    // Determine banner
    let banner = null;
    if (accessStatus === 'PAYMENT_REQUIRED') {
      banner = { type: 'payment_required', title: 'Payment Required',
        message: 'Your payment could not be processed. Please update your payment method.',
        actionLabel: 'Update Payment', actionUrl: 'https://dashboard.assembly.com' };
    } else if (accessStatus === 'CANCELED_WITH_ACCESS') {
      const until = s.access_until_date ? new Date(s.access_until_date).toLocaleDateString('en-CA', { month:'short', day:'numeric', year:'numeric' }) : '';
      banner = { type: 'canceled_with_access', title: 'Subscription Ending',
        message: `Your subscription is ending on ${until}. Renew to keep access.`,
        actionLabel: 'Renew', actionUrl: 'https://dashboard.assembly.com' };
    } else if (accessStatus === 'CANCELED') {
      banner = { type: 'canceled', title: 'Subscription Ended',
        message: 'Your subscription has ended. Reactivate to regain access.',
        actionLabel: 'Reactivate', actionUrl: 'https://dashboard.assembly.com' };
    } else if (setupRequired) {
      banner = { type: 'setup_required', title: 'Setup Required',
        message: 'Complete your mailbox setup to start receiving mail.',
        actionLabel: 'Set Up Now', setupStep: 'plan_setup' };
    }

    return {
      subscriptionId: s.id,
      planName:       s.plan_name,
      planAmount:     s.plan_amount,
      interval:       s.interval,
      productId:      s.product_id,
      accessStatus,
      canAccess,
      setupRequired,
      setupStep:      setupRequired ? (pc ? 'add_recipients' : 'plan_setup') : null,
      planCardId:     pc ? pc.plan_card_id : null,
      banner
    };
  });

  return {
    status:        'client',
    clientId:      client.id,
    name:          [client.given_name, client.family_name].filter(Boolean).join(' '),
    givenName:     client.given_name,
    familyName:    client.family_name,
    email:         client.email,
    fallbackColor: client.fallback_color,
    subscriptions
  };
}

// ============================================================
// CLIENT READS
// ============================================================

async function _getClientMailLog(uuid, subscriptionId) {
  const { data, error } = await sb.from('mail_log')
    .select('*')
    .eq('client_id', uuid)
    .eq('subscription_id', subscriptionId)
    .neq('status', 'deleted')
    .order('logged_at', { ascending: false });
  if (error) return { status: 'error', message: error.message };

  // Strip staff-only fields
  const mailLog = (data || []).map(m => {
    const r = rowToCamel(m);
    delete r.noteInternal;
    delete r.physicalLocation;
    return r;
  });
  return { status: 'ok', mailLog };
}

async function _getPlanCard(uuid, subscriptionId) {
  const { data, error } = await sb.from('plan_cards').select('*')
    .eq('client_id', uuid).eq('subscription_id', subscriptionId).maybeSingle();
  if (error) return { status: 'error', message: error.message };
  return { status: 'ok', planCard: data ? rowToCamel(data) : null };
}

async function _getAgents(uuid, subscriptionId) {
  // Get plan card first to find planCardId
  const { data: pc } = await sb.from('plan_cards').select('plan_card_id')
    .eq('client_id', uuid).eq('subscription_id', subscriptionId).maybeSingle();
  if (!pc) return { status: 'ok', agents: [] };

  const { data } = await sb.from('pickup_agents').select('*')
    .eq('plan_card_id', pc.plan_card_id).eq('status', 'active');
  return { status: 'ok', agents: rowsToCamel(data) };
}

async function _getRecipients(uuid, subscriptionId) {
  const { data } = await sb.from('recipients').select('*')
    .eq('client_id', uuid).eq('subscription_id', subscriptionId)
    .order('created_at');
  return { status: 'ok', recipients: rowsToCamel(data) };
}

async function _getPlanTemplate(productId) {
  if (!productId) return { status: 'error', message: 'No productId' };
  const { data: tmpl } = await sb.from('plans').select('*')
    .eq('product_id', productId).maybeSingle();
  const { data: locs } = await sb.from('locations').select('*').eq('active', true);
  return {
    status: 'ok',
    template: tmpl ? rowToCamel(tmpl) : null,
    locations: rowsToCamel(locs)
  };
}

// ============================================================
// CLIENT WRITES
// ============================================================

async function _submitOnboarding(body) {
  const productId = body.productId;
  const { data: tmpl } = await sb.from('plans').select('*')
    .eq('product_id', productId).maybeSingle();
  if (!tmpl) return { status: 'error', message: 'Plan template not found' };

  const planCardId = _genId('PC');
  const now = new Date().toISOString();
  const today = now.split('T')[0];
  const periodStart = new Date(today);
  let periodEnd = new Date(periodStart);
  if (tmpl.billing_cycle === 'yearly') { periodEnd.setFullYear(periodEnd.getFullYear() + 1); }
  else { periodEnd.setMonth(periodEnd.getMonth() + 1); }
  periodEnd.setDate(periodEnd.getDate() - 1);

  const { error } = await sb.from('plan_cards').insert({
    plan_card_id:       planCardId,
    client_id:          body.uuid,
    subscription_id:    body.subscriptionId,
    location_id:        body.locationId || 'LOC001',
    plan_name:          tmpl.plan_name,
    billing_cycle:      tmpl.billing_cycle,
    status:             'active',
    mail_limit:         tmpl.mail_limit,
    parcel_limit:       tmpl.parcels_included || 0,
    max_recipients:     tmpl.max_recipients,
    recipients_added:   0,
    mail_storage_days:  tmpl.mail_storage_days,
    parcel_storage_days:tmpl.parcel_storage_days,
    mail_overage_fee:   tmpl.mail_overage_fee,
    parcel_overage_fee: tmpl.parcel_overage_fee,
    current_period_start: today,
    current_period_end:   periodEnd.toISOString().split('T')[0],
    auto_forward_day:     tmpl.auto_forward_day,
    forwarding_address:   body.forwardingAddress || null,
    forwarding_city:      body.forwardingCity || null,
    forwarding_province:  body.forwardingProvince || null,
    forwarding_postal_code: body.forwardingPostalCode || null,
    forwarding_country:     body.forwardingCountry || null,
    forwarding_instructions: body.forwardingInstructions || null,
    client_timezone:     body.clientTimezone || 'America/Toronto',
    business_description: body.businessDescription || null,
    referral_source:     body.referralSource || null,
    activated_at:        now,
    activated_by:        body.uuid,
    friendly_name:       body.friendlyName || null,
    auto_feature:        tmpl.auto_feature,
    product_id:          productId,
    plan_memo:           tmpl.plan_memo,
    customer_type:       body.customerType || 'canadian'
  });
  if (error) return { status: 'error', message: error.message };

  // Resolve pending_setup task
  await sb.from('tasks')
    .update({ status: 'resolved', resolved_at: now, resolution_note: 'Plan card setup completed' })
    .eq('client_id', body.uuid).eq('type', 'pending_setup').eq('status', 'open');

  return { status: 'ok', planCardId };
}

async function _addRecipient(body) {
  const planCardId = body.planCardId;
  const { data: pc } = await sb.from('plan_cards')
    .select('max_recipients, recipients_added, subscription_id, location_id, client_id')
    .eq('plan_card_id', planCardId).single();
  if (!pc) return { status: 'error', message: 'Plan card not found' };

  const isTemp = body.notes && body.notes.startsWith('TEMP:');
  if (!isTemp && pc.recipients_added >= pc.max_recipients) {
    return { status: 'error', message: `Maximum recipients reached (${pc.max_recipients})` };
  }

  const recipientId = _genId('RCP');
  const now = new Date().toISOString();
  const { error } = await sb.from('recipients').insert({
    recipient_id:   recipientId,
    plan_card_id:   planCardId,
    client_id:      pc.client_id,
    subscription_id: pc.subscription_id,
    location_id:    pc.location_id,
    name:           body.name,
    type:           body.type || 'individual',
    status:         'active',
    activated_at:   now,
    activated_by:   body.uuid,
    has_mail_logged: false,
    language:       body.language || 'en',
    created_at:     now,
    created_by:     body.uuid,
    notes:          body.notes || null
  });
  if (error) return { status: 'error', message: error.message };

  if (!isTemp) {
    await sb.from('plan_cards')
      .update({ recipients_added: pc.recipients_added + 1 })
      .eq('plan_card_id', planCardId);
  }
  return { status: 'ok', recipientId };
}

async function _updateFriendlyName(body) {
  const { error } = await sb.from('plan_cards')
    .update({ friendly_name: body.friendlyName })
    .eq('plan_card_id', body.planCardId);
  if (error) return { status: 'error', message: error.message };
  return { status: 'ok' };
}

// ============================================================
// STAFF READS
// ============================================================

async function _getTasks(uuid) {
  const { data: staff } = await sb.from('staff').select('default_location_id')
    .eq('staff_id', uuid).maybeSingle();
  const locId = staff?.default_location_id;

  const { data } = await sb.from('tasks').select('*')
    .in('status', ['open', 'snoozed'])
    .order('due_date');

  // Filter: tasks for this location or global (null location)
  const filtered = (data || []).filter(t => !t.location_id || t.location_id === locId);
  return { status: 'ok', tasks: rowsToCamel(filtered) };
}

async function _searchRecipients(uuid, q) {
  const { data: staff } = await sb.from('staff').select('default_location_id')
    .eq('staff_id', uuid).maybeSingle();
  const locId = staff?.default_location_id;

  const { data } = await sb.from('recipients')
    .select('*, plan_cards!inner(plan_card_id, client_id, subscription_id, plan_name, auto_feature, status)')
    .eq('location_id', locId)
    .eq('status', 'active');

  // Also fetch subscription access_status for each
  const enriched = [];
  for (const r of (data || [])) {
    const pc = r.plan_cards;
    let accessStatus = 'ACTIVE';
    if (pc?.subscription_id) {
      const { data: sub } = await sb.from('subscriptions').select('access_status')
        .eq('id', pc.subscription_id).maybeSingle();
      if (sub) accessStatus = sub.access_status;
    }
    enriched.push({
      recipientId:    r.recipient_id,
      name:           r.name,
      companyName:    '',
      type:           r.type,
      planCardId:     pc?.plan_card_id,
      clientId:       pc?.client_id,
      subscriptionId: pc?.subscription_id,
      planName:       pc?.plan_name,
      autoFeature:    pc?.auto_feature,
      accessStatus,
      recipientStatus: r.status,
      planStatus:      pc?.status
    });
  }
  return enriched; // Note: searchRecipients GAS returns array directly, not {status:'ok',...}
}

async function _getMailLogStaff(uuid) {
  const { data: staff } = await sb.from('staff').select('default_location_id')
    .eq('staff_id', uuid).maybeSingle();
  const locId = staff?.default_location_id;

  const { data } = await sb.from('mail_log').select('*')
    .eq('location_id', locId).neq('status', 'deleted')
    .order('logged_at', { ascending: false }).limit(200);

  // Enrich with access_status from subscription
  const enriched = [];
  const subCache = {};
  for (const m of (data || [])) {
    let accessStatus = m.subscription_status;
    if (!accessStatus && m.subscription_id) {
      if (!subCache[m.subscription_id]) {
        const { data: s } = await sb.from('subscriptions').select('access_status').eq('id', m.subscription_id).maybeSingle();
        subCache[m.subscription_id] = s?.access_status || null;
      }
      accessStatus = subCache[m.subscription_id];
    }
    const row = rowToCamel(m);
    row.accessStatus = accessStatus;
    enriched.push(row);
  }
  return { status: 'ok', mailLog: enriched };
}

async function _getAgentsForPlanCard(uuid, planCardId) {
  const { data } = await sb.from('pickup_agents').select('*')
    .eq('plan_card_id', planCardId).eq('status', 'active');
  return { status: 'ok', agents: rowsToCamel(data) };
}

async function _getExceptions(uuid) {
  const { data: staff } = await sb.from('staff').select('default_location_id')
    .eq('staff_id', uuid).maybeSingle();
  const locId = staff?.default_location_id;

  const { data } = await sb.from('mail_log').select('*')
    .eq('location_id', locId).eq('special_case', true)
    .in('status', ['received'])
    .order('logged_at', { ascending: false }).limit(200);

  return { status: 'ok', exceptions: rowsToCamel(data) };
}

async function _getPlanCardsStaff(uuid) {
  const { data: staff } = await sb.from('staff').select('default_location_id')
    .eq('staff_id', uuid).maybeSingle();
  const locId = staff?.default_location_id;

  const { data: cards } = await sb.from('plan_cards').select('*')
    .eq('location_id', locId).eq('status', 'active');

  // Enrich each card with client info, subscription status, recipients
  const enriched = [];
  for (const pc of (cards || [])) {
    const { data: client } = await sb.from('clients').select('given_name, family_name, email, fallback_color')
      .eq('id', pc.client_id).maybeSingle();
    const { data: sub } = await sb.from('subscriptions').select('access_status, plan_name, plan_amount_formatted')
      .eq('id', pc.subscription_id).maybeSingle();
    const { data: recs } = await sb.from('recipients').select('*')
      .eq('plan_card_id', pc.plan_card_id).order('created_at');

    const card = rowToCamel(pc);
    card.clientName = client ? [client.given_name, client.family_name].filter(Boolean).join(' ') : '';
    card.clientEmail = client?.email || '';
    card.clientColor = client?.fallback_color || '';
    card.accessStatus = sub?.access_status || 'ACTIVE';
    card.subscriptionPlanName = sub?.plan_name || '';
    card.planAmountFormatted = sub?.plan_amount_formatted || '';
    card.recipients = rowsToCamel(recs);
    enriched.push(card);
  }

  return { status: 'ok', planCards: enriched };
}

// ============================================================
// STAFF WRITES
// ============================================================

async function _logMail(body) {
  const mailId = _genId('ML');
  const now = new Date().toISOString();
  const today = now.split('T')[0];

  let storageDays = 30;
  if (body.planCardId) {
    const { data: pc } = await sb.from('plan_cards')
      .select('mail_storage_days, parcel_storage_days')
      .eq('plan_card_id', body.planCardId).maybeSingle();
    if (pc) storageDays = body.type === 'parcel' ? pc.parcel_storage_days : pc.mail_storage_days;
  }
  const due = new Date(today);
  due.setDate(due.getDate() + storageDays);

  // Get subscription access_status
  let subStatus = null;
  if (body.subscriptionId) {
    const { data: s } = await sb.from('subscriptions').select('access_status')
      .eq('id', body.subscriptionId).maybeSingle();
    subStatus = s?.access_status || null;
  }

  const { error } = await sb.from('mail_log').insert({
    mail_id:              mailId,
    logged_at:            now,
    logged_by:            body.uuid,
    location_id:          body.locationId,
    recipient_id:         body.recipientId || null,
    recipient_name:       body.recipientName || null,
    plan_card_id:         body.planCardId || null,
    client_id:            body.clientId || null,
    subscription_id:      body.subscriptionId || null,
    subscription_status:  subStatus,
    special_case:         body.specialCase === true || body.specialCase === 'true',
    special_case_reason:  body.specialCaseReason || null,
    type:                 body.type || 'letter',
    confidential:         body.confidential === true || body.confidential === 'true',
    sender_name:          body.senderName || null,
    physical_location:    body.physicalLocation || null,
    scan_image_url:       body.scanImageUrl || null,
    note_to_client:       body.noteToClient || null,
    note_internal:        body.noteInternal || null,
    oversized_pickup:     body.oversizedPickup === true || body.oversizedPickup === 'true',
    piece_count:          parseInt(body.pieceCount) || 1,
    estimated_weight:     body.estimatedWeight || null,
    return_address:       body.returnAddress || null,
    status:               'received',
    storage_start_date:   today,
    storage_due_date:     due.toISOString().split('T')[0]
  });
  if (error) return { status: 'error', message: error.message };

  // Increment usage counter
  if (body.planCardId && body.specialCase !== true && body.specialCase !== 'true') {
    const field = body.type === 'parcel' ? 'parcels_used' : 'mails_used';
    const { data: pc } = await sb.from('plan_cards').select(field + ', mail_limit, parcel_limit, mail_overage_fee, parcel_overage_fee')
      .eq('plan_card_id', body.planCardId).single();
    if (pc) {
      await sb.from('plan_cards').update({ [field]: pc[field] + 1 }).eq('plan_card_id', body.planCardId);
    }
    // Mark recipient has_mail_logged
    if (body.recipientId) {
      await sb.from('recipients').update({ has_mail_logged: true }).eq('recipient_id', body.recipientId);
    }
  }

  return { status: 'ok', mailId };
}

async function _resolveTask(body) {
  const { error } = await sb.from('tasks').update({
    status: 'resolved',
    resolved_at: new Date().toISOString(),
    resolved_by: body.uuid,
    resolution_note: body.resolutionNote || null
  }).eq('task_id', body.taskId);
  if (error) return { status: 'error', message: error.message };
  return { status: 'ok' };
}

async function _snoozeTask(body) {
  const { error } = await sb.from('tasks').update({
    status: 'snoozed',
    snoozed_until: body.snoozeUntil
  }).eq('task_id', body.taskId);
  if (error) return { status: 'error', message: error.message };
  return { status: 'ok' };
}

async function _releaseMail(body) {
  // Look up agent name
  let releasedTo = body.agentId;
  if (body.agentId) {
    const { data: agent } = await sb.from('pickup_agents').select('name')
      .eq('agent_id', body.agentId).maybeSingle();
    if (agent) releasedTo = agent.name;
  }

  const { error } = await sb.from('mail_log').update({
    status: 'released',
    released_at: new Date().toISOString(),
    released_by: body.uuid,
    released_to: releasedTo,
    release_notes: body.releaseNotes || null
  }).eq('mail_id', body.mailId);
  if (error) return { status: 'error', message: error.message };
  return { status: 'ok' };
}

async function _bulkForwardMail(body) {
  const mailIds = JSON.parse(body.mailIds || '[]');
  const results = [];
  for (const mailId of mailIds) {
    const { error } = await sb.from('mail_log').update({
      status: 'forwarded',
      forwarded_at: new Date().toISOString(),
      tracking_link: body.trackingLink || null,
      forwarding_cost: body.forwardingCost ? parseFloat(body.forwardingCost) : null,
      note_internal: body.forwardNotes || null
    }).eq('mail_id', mailId);
    results.push({ mailId, status: error ? 'error' : 'ok', message: error?.message });
  }
  return { status: 'ok', results };
}

async function _assignMailRecipient(body) {
  const today = new Date().toISOString().split('T')[0];
  let storageDays = 30;
  if (body.planCardId) {
    const { data: pc } = await sb.from('plan_cards').select('mail_storage_days')
      .eq('plan_card_id', body.planCardId).maybeSingle();
    if (pc) storageDays = pc.mail_storage_days;
  }
  const due = new Date(today);
  due.setDate(due.getDate() + storageDays);

  // Check if plan uses scan feature
  let needsScan = false;
  if (body.planCardId) {
    const { data: pc } = await sb.from('plan_cards').select('auto_feature')
      .eq('plan_card_id', body.planCardId).maybeSingle();
    if (pc?.auto_feature === 'scan') needsScan = true;
  }

  const { error } = await sb.from('mail_log').update({
    recipient_id: body.recipientId,
    recipient_name: body.recipientName,
    plan_card_id: body.planCardId,
    client_id: body.clientId,
    subscription_id: body.subscriptionId,
    special_case: false,
    special_case_reason: null,
    storage_start_date: today,
    storage_due_date: due.toISOString().split('T')[0]
  }).eq('mail_id', body.mailId);
  if (error) return { status: 'error', message: error.message };
  return { status: 'ok', needsScan };
}

async function _editMailItem(body) {
  const updates = {};
  const fieldMap = {
    senderName: 'sender_name', type: 'type', confidential: 'confidential',
    physicalLocation: 'physical_location', scanImageUrl: 'scan_image_url',
    noteToClient: 'note_to_client', noteInternal: 'note_internal',
    oversizedPickup: 'oversized_pickup', pieceCount: 'piece_count',
    recipientId: 'recipient_id', recipientName: 'recipient_name',
    planCardId: 'plan_card_id', clientId: 'client_id', subscriptionId: 'subscription_id',
    specialCase: 'special_case', specialCaseReason: 'special_case_reason'
  };
  for (const [camel, snake] of Object.entries(fieldMap)) {
    if (body[camel] !== undefined) {
      let val = body[camel];
      if (val === 'TRUE' || val === 'true') val = true;
      if (val === 'FALSE' || val === 'false') val = false;
      updates[snake] = val;
    }
  }
  if (Object.keys(updates).length === 0) return { status: 'ok' };

  const { error } = await sb.from('mail_log').update(updates).eq('mail_id', body.mailId);
  if (error) return { status: 'error', message: error.message };
  return { status: 'ok' };
}

async function _deleteMailItem(body) {
  // Soft delete
  const { error } = await sb.from('mail_log')
    .update({ status: 'deleted' })
    .eq('mail_id', body.mailId);
  if (error) return { status: 'error', message: error.message };
  return { status: 'ok' };
}

async function _updateMailStatus(body) {
  const updates = { status: body.status };
  if (body.note) updates.note_internal = body.note;
  const { error } = await sb.from('mail_log').update(updates).eq('mail_id', body.mailId);
  if (error) return { status: 'error', message: error.message };
  return { status: 'ok' };
}

async function _addTempRecipient(body) {
  return _addRecipient({
    ...body,
    action: 'addRecipient',
    notes: 'TEMP: ' + (body.notes || '')
  });
}

async function _updateRecipient(body) {
  const updates = { name: body.name };
  if (body.type) updates.type = body.type;
  const { error } = await sb.from('recipients').update(updates)
    .eq('recipient_id', body.recipientId);
  if (error) return { status: 'error', message: error.message };
  return { status: 'ok' };
}

async function _updateRecipientStatus(body) {
  const { error } = await sb.from('recipients')
    .update({ status: body.status })
    .eq('recipient_id', body.recipientId);
  if (error) return { status: 'error', message: error.message };
  return { status: 'ok' };
}


const TASK_META = {
  storage_expiring:       { icon: '⏰', label: 'Storage Expiring' },
  storage_overdue:        { icon: '🗑️', label: 'Storage Overdue' },
  parcel_decision:        { icon: '📦', label: 'Parcel Decision' },
  ready_to_ship:          { icon: '🚢', label: 'Ready to Ship' },
  overage_billing:        { icon: '💰', label: 'Overage Billing' },
  unmatched_mail:         { icon: '❓', label: 'Unmatched Mail' },
  special_case_review:    { icon: '🔍', label: 'Special Case Review' },
  post_termination_audit: { icon: '🏢', label: 'Post-Termination Audit' },
  courtesy_extension_log: { icon: '📋', label: 'Extension Log' },
  pending_setup:          { icon: '🆕', label: 'Pending Setup' },
  id_verification_review: { icon: '🪪', label: 'ID Verification' }
};

// ── Boot ─────────────────────────────────────────────────
function getStaffCache(uuid) {
  try {
    const raw = sessionStorage.getItem('staff_' + uuid);
    if (!raw) return null;
    const { data, ts } = JSON.parse(raw);
    if (Date.now() - ts > 5 * 60 * 1000) { sessionStorage.removeItem('staff_' + uuid); return null; }
    return data;
  } catch(e) { return null; }
}
function setStaffCache(uuid, data) {
  try { sessionStorage.setItem('staff_' + uuid, JSON.stringify({ data, ts: Date.now() })); } catch(e) {}
}

async function boot() {
  STATE.uuid = getUUID();

  if (!STATE.uuid) { hideLoading(); showBlocked('No UUID in URL'); return; }

  // Use cache for instant load on refresh
  const cached = getStaffCache(STATE.uuid);
  if (cached && cached.status === 'staff') {
    STATE.access = cached;
    const _cn = cached.name || 'Staff';
    const _ci = _cn.split(' ').filter(Boolean).slice(0,2).map(w=>w[0]).join('').toUpperCase();
    qs('header-name').innerHTML = `<span class="staff-avatar">${_ci}</span><strong>${_cn}</strong><span style="color:var(--ink-4);font-size:11px">${cached.role}</span>`;
    hideLoading();
    await loadTasks();
    warmRecipientCache(); // pre-warm in background — makes first search instant
    renderWorkspace();
    api('uuid=' + encodeURIComponent(STATE.uuid)).then(f => { if (f && f.status === 'staff') setStaffCache(STATE.uuid, f); }).catch(()=>{});
    return;
  }

  await new Promise(r => setTimeout(r, 600));

  try {
    const data = await api('uuid=' + encodeURIComponent(STATE.uuid));
    STATE.access = data;
    hideLoading();

    if (data.status === 'staff') setStaffCache(STATE.uuid, data);
    if (data.status !== 'staff') {
      showBlocked(data.status === 'client'
        ? 'This portal is for staff only. Please use the client portal.'
        : data.message || 'Access denied.');
      return;
    }

    const _dn = data.name || 'Staff';
    const _di = _dn.split(' ').filter(Boolean).slice(0,2).map(w=>w[0]).join('').toUpperCase();
    qs('header-name').innerHTML = `<span class="staff-avatar">${_di}</span><strong>${_dn}</strong><span style="color:var(--ink-4);font-size:11px">${data.role}</span>`;
    await loadTasks();
    warmRecipientCache(); // pre-warm in background — makes first search instant
    renderWorkspace();

  } catch(err) {
    hideLoading();
    showBlocked('Connection error: ' + err.message);
  }
}

function hideLoading() {
  const ls = qs('loading-screen');
  ls.classList.add('fade-out');
  setTimeout(() => ls.style.display='none', 400);
  qs('app').classList.add('visible');
}

function showBlocked(msg) {
  qs('app').classList.add('visible');
  qs('workspace').innerHTML = `
    <div class="blocked-screen">
      <div class="blocked-card">
        <div class="blocked-icon">🔒</div>
        <div class="blocked-title">Access Denied</div>
        <p class="blocked-msg">${msg}</p>
      </div>
    </div>`;
}

async function loadTasks() {
  try {
    const data = await api(`uuid=${STATE.uuid}&action=getTasks`);
    STATE.tasks = data.tasks || [];
  } catch(e) { STATE.tasks = []; }
}

// ── View management ───────────────────────────────────────
function setView(v) {
  STATE.view = v;
  ['split','tasks','log','maillog','exceptions','plancards'].forEach(n => {
    const b = qs('vbtn-' + n);
    if (b) b.classList.toggle('active', n === v);
  });
  renderWorkspace();
}

function renderWorkspace() {
  const ws = qs('workspace');
  if (STATE.view === 'split') {
    ws.innerHTML = `
      <div class="pane pane-left" id="tasks-pane"></div>
      <div class="pane pane-right" id="detail-pane"></div>`;
    renderTasksPane();
    renderDetailPane();
  } else if (STATE.view === 'tasks') {
    ws.innerHTML = `<div class="pane-full" id="tasks-full"></div>`;
    renderTasksFull();
  } else if (STATE.view === 'log') {
    ws.innerHTML = `<div class="pane-full" id="log-full"></div>`;
    renderLogForm(qs('log-full'));
  } else if (STATE.view === 'maillog') {
    ws.innerHTML = `<div class="pane-full" id="maillog-full"></div>`;
    renderStaffMailLog(qs('maillog-full'));
  } else if (STATE.view === 'exceptions') {
    ws.innerHTML = `<div class="pane-full" id="exceptions-full"></div>`;
    renderExceptionsView(qs('exceptions-full'));
  } else if (STATE.view === 'plancards') {
    ws.innerHTML = `<div class="pane-full" id="plancards-full"></div>`;
    renderPlanCardsView(qs('plancards-full'));
  }
}

// ── Tasks Pane (split) ────────────────────────────────────
function renderTasksPane() {
  const pane = qs('tasks-pane');
  if (!pane) return;

  const EXC_TYPES = ['unmatched_mail','special_case_review'];
  const open   = STATE.tasks.filter(t => t.status === 'open' && !EXC_TYPES.includes(t.type));
  const overdue = open.filter(t => t.overdue === 'TRUE' || t.overdue === true);

  pane.innerHTML = `
    <div class="stats-mini">
      <div class="stat-mini">
        <div class="stat-mini-val ${open.length > 0 ? 'red' : ''}">${open.length}</div>
        <div class="stat-mini-label">Open Tasks</div>
      </div>
      <div class="stat-mini">
        <div class="stat-mini-val ${overdue.length > 0 ? 'amber' : ''}">${overdue.length}</div>
        <div class="stat-mini-label">Overdue</div>
      </div>
    </div>
    <div class="nav-tabs">
      <div class="nav-tab active" id="ttab-open"   onclick="filterTasks('open')">Open (${open.length})</div>
      <div class="nav-tab"        id="ttab-all"    onclick="filterTasks('all')">All</div>
    </div>
    <div class="task-list" id="task-list-inner"></div>`;

  renderTaskList('open');
}

function filterTasks(filter) {
  ['open','all'].forEach(f => {
    const el = qs('ttab-' + f);
    if (el) el.classList.toggle('active', f === filter);
  });
  renderTaskList(filter);
}

function renderTaskList(filter) {
  const list = qs('task-list-inner');
  if (!list) return;

  // Exceptions (unmatched_mail, special_case_review) live in the Exceptions tab only
  const EXCEPTION_TYPES = ['unmatched_mail', 'special_case_review'];
  let tasks = filter === 'open'
    ? STATE.tasks.filter(t => t.status === 'open' && !EXCEPTION_TYPES.includes(t.type))
    : STATE.tasks.filter(t => !EXCEPTION_TYPES.includes(t.type));

  if (!tasks.length) {
    list.innerHTML = `
      <div class="empty-pane">
        <div class="empty-icon">✅</div>
        <div class="empty-title">${filter === 'open' ? 'All clear!' : 'No tasks'}</div>
        <div class="empty-sub">Nothing to action right now.</div>
      </div>`;
    return;
  }

  list.innerHTML = tasks.map(task => {
    const meta    = TASK_META[task.type] || { icon: '📌', label: task.type };
    const isOver  = task.overdue === 'TRUE' || task.overdue === true;
    const priClass = `pri-${task.priority}`;
    const days    = daysUntil(task.dueDate);
    const dueStr  = days === null ? '' : days < 0 ? `${Math.abs(days)}d overdue` : days === 0 ? 'Due today' : `Due in ${days}d`;
    const selected = STATE.selectedTask && STATE.selectedTask.taskId === task.taskId ? 'selected' : '';

    return `
      <div class="task-item ${priClass} ${isOver ? 'overdue' : ''} ${selected}"
           onclick="selectTask('${task.taskId}')">
        <div class="task-top">
          <div class="task-type">
            <span class="task-type-icon">${meta.icon}</span>
            ${meta.label}
          </div>
          <div class="task-right">
            ${isOver ? '<span class="pill overdue">Overdue</span>' : `<span class="pill ${task.priority}">${task.priority}</span>`}
          </div>
        </div>
        <div class="task-notes">${task.notes || '—'}</div>
        <div class="task-client">
          ${task.clientId ? '· ' + task.clientId.slice(0,8) + '...' : ''}
          ${task.recipientName ? '· ' + task.recipientName : ''}
          ${dueStr ? '· ' + dueStr : ''}

        </div>
      </div>`;
  }).join('');
}

function selectTask(taskId) {
  STATE.selectedTask = STATE.tasks.find(t => t.taskId === taskId);
  if (STATE.view === 'split') {
    renderTasksPane();
    renderDetailPane();
  } else {
    renderTasksFull();
  }
}

// ── Detail Pane (split) ───────────────────────────────────
function renderDetailPane() {
  const pane = qs('detail-pane');
  if (!pane) return;

  if (!STATE.selectedTask) {
    pane.innerHTML = `
      <div class="empty-pane">
        <div class="empty-icon">👈</div>
        <div class="empty-title">Select a task</div>
        <div class="empty-sub">Click any task on the left to review and action it.</div>
      </div>`;
    return;
  }

  const task = STATE.selectedTask;
  const meta = TASK_META[task.type] || { icon: '📌', label: task.type };

  pane.innerHTML = `
    <div class="task-detail">
      <div class="detail-header">
        <div class="detail-type">${meta.icon} ${meta.label}</div>
        <div class="detail-title">${task.recipientName || task.clientId || 'Task Detail'}</div>
        <div class="detail-sub">${task.notes || ''}</div>
      </div>

      <div class="detail-card">
        <div class="detail-row">
          <label>Task ID</label><value>${task.taskId}</value>
        </div>
        <div class="detail-row">
          <label>Priority</label>
          <value><span class="pill ${task.priority}">${task.priority}</span></value>
        </div>
        <div class="detail-row">
          <label>Due Date</label>
          <value>${fmtDate(task.dueDate) || '—'}</value>
        </div>
        ${task.mailId ? `<div class="detail-row"><label>Mail ID</label><value>${task.mailId}</value></div>` : ''}
        ${task.planCardId ? `<div class="detail-row"><label>Plan Card</label><value>${task.planCardId}</value></div>` : ''}
        ${task.clientId ? `<div class="detail-row"><label>Client</label><value>${task.clientId.slice(0,16)}...</value></div>` : ''}
        <div class="detail-row">
          <label>Created</label><value>${fmtDateTime(task.createdAt)}</value>
        </div>
      </div>

      ${task.status === 'open' ? `
      <div class="resolve-form">
        <div class="form-divider">Resolve Task</div>
        <textarea class="resolve-textarea" id="resolve-note" placeholder="Add a resolution note (optional)..."></textarea>
        <div class="resolve-actions">
          <button class="btn btn-success btn-sm" onclick="resolveTask('${task.taskId}')">
            ✓ Mark Done
          </button>
          <button class="btn btn-secondary btn-sm" onclick="snoozePrompt('${task.taskId}')">
            ⏰ Snooze
          </button>
        </div>
      </div>` : `
      <div style="padding:12px; background:var(--green-bg); border-radius:var(--radius-sm); font-size:13px; color:var(--green)">
        ✓ Resolved by ${task.resolvedBy || '—'} · ${fmtDate(task.resolvedAt)}
        ${task.resolutionNote ? `<br><span style="color:var(--ink-3)">${task.resolutionNote}</span>` : ''}
      </div>`}


      ${task.mailId ? `
      <button class="btn btn-secondary btn-full btn-sm" style="margin-top:8px" onclick="jumpToMailLog('${task.mailId}')">
        View Mail Log Entry →
      </button>` : ''}
    </div>`;
}

// ── Tasks Full View ───────────────────────────────────────
function renderTasksFull() {
  const el = qs('tasks-full');
  if (!el) return;

  const EXCL = ['unmatched_mail','special_case_review'];
  const open = STATE.tasks.filter(t => t.status === 'open' && !EXCL.includes(t.type));

  el.innerHTML = `
    <div style="max-width:800px; margin:0 auto">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif; font-size:20px">${open.length} Open Tasks</div>
        <button id="tasks-refresh-btn" class="btn btn-secondary btn-sm" data-refresh-label="tasks-last-refreshed" onclick="animRefresh('tasks-refresh-btn', () => loadTasks().then(() => renderWorkspace()))">↻ Refresh</button>
          <span id="tasks-last-refreshed" style="font-size:11px;color:var(--ink-4);margin-left:6px"></span>
      </div>
      ${open.length === 0 ? `
        <div class="empty-pane" style="background:var(--white); border:1px solid var(--border); border-radius:var(--radius); min-height:200px">
          <div class="empty-icon">✅</div>
          <div class="empty-title">All tasks cleared</div>
        </div>` :
        open.map(task => {
          const meta = TASK_META[task.type] || { icon:'📌', label:task.type };
          const isOver = task.overdue === 'TRUE' || task.overdue === true;
          return `
            <div style="background:var(--white); border:1px solid var(--border); border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; display:flex; gap:12px; align-items:flex-start; box-shadow:var(--shadow)">
              <div style="font-size:20px; flex-shrink:0; margin-top:2px">${meta.icon}</div>
              <div style="flex:1; min-width:0">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px">
                  <div style="font-size:13px; font-weight:600">${meta.label}</div>
                  <span class="pill ${isOver ? 'overdue' : task.priority}">${isOver ? 'Overdue' : task.priority}</span>
                </div>
                <div style="font-size:12px; color:var(--ink-3); margin-bottom:6px">${task.notes || '—'}</div>
                <div style="font-size:11px; color:var(--ink-4)">${task.recipientName || ''} ${task.clientId ? '· ' + task.clientId.slice(0,8)+'...' : ''} · Due ${fmtDate(task.dueDate)}</div>
              </div>
              <div style="display:flex; gap:6px; flex-shrink:0">
                <button class="btn btn-success btn-sm" onclick="resolveTask('${task.taskId}')">Done</button>
                <button class="btn btn-secondary btn-sm" onclick="selectTask('${task.taskId}'); setView('split')">Detail</button>
              </div>
            </div>`;
        }).join('')
      }
    </div>`;
}

// ── Log Form ──────────────────────────────────────────────
function renderLogForm(container) {
  container.innerHTML = `
    <div style="max-width:640px; margin:0 auto">
      <div style="font-family:'DM Serif Display',serif; font-size:20px; margin-bottom:20px">Log Incoming Mail</div>
      <div style="background:var(--white); border:1px solid var(--border); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow)">

        <div class="form-divider">Recipient</div>
        <div id="recipient-section">
          <div class="form-group recipient-search-wrap">
            <label>Search Recipient</label>
            <input type="text" id="log-recipient-search" placeholder="Type name or company..." autocomplete="off"
              oninput="searchRecipients(this.value)">
            <div class="recipient-results" id="recipient-results" style="display:none"></div>
          </div>
          <div id="selected-recipient-box" style="display:none; background:var(--bg); border-radius:var(--radius-sm); padding:10px 12px; margin-bottom:14px; font-size:13px">
            <div style="font-weight:500" id="sel-rec-name"></div>
            <div style="font-size:11px; color:var(--ink-4)" id="sel-rec-sub"></div>
            <button style="font-size:11px; color:var(--red); background:none; margin-top:4px" onclick="clearRecipient()">✕ Clear</button>
          </div>
        </div>
        <div id="special-case-note" style="display:none; background:var(--amber-bg); border-radius:var(--radius-sm); padding:10px 12px; margin-bottom:14px; font-size:12px; color:var(--amber)">
          ⚠️ Special case — no recipient required. Item stored for future assignment or disposal.
        </div>

        <div class="form-divider">Mail Details</div>
        <div class="form-group">
          <label>Sender Name <span style="color:var(--ink-4);text-transform:none">(shown to client)</span></label>
          <input type="text" id="log-sender" placeholder="e.g. TD Bank, CRA, Amazon, John Smith...">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Type</label>
            <div style="display:flex;gap:14px;padding:4px 0">
              <label style="display:flex;align-items:center;gap:6px;font-weight:400;cursor:pointer">
                <input type="radio" name="log-type-radio" id="log-type-letter" value="letter" checked onchange="onMailTypeChange()" style="accent-color:var(--blue)"> ✉️ Mail
              </label>
              <label style="display:flex;align-items:center;gap:6px;font-weight:400;cursor:pointer">
                <input type="radio" name="log-type-radio" id="log-type-parcel" value="parcel" onchange="onMailTypeChange()" style="accent-color:var(--amber)"> 📦 Parcel
              </label>
            </div>
            <input type="hidden" id="log-type" value="letter">
          </div>
          <div class="form-group">
            <label>Physical Location <span style="color:var(--ink-4);text-transform:none">(staff only)</span></label>
            <input type="text" id="log-location" placeholder="e.g. Shelf A3, Bin 2">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Piece Count</label>
            <input type="text" id="log-pieces" value="1">
          </div>
          <div class="form-group" id="scan-field-wrap">
            <label>Scan Image URL <span style="color:var(--ink-4);text-transform:normal;font-weight:400" id="scan-url-hint">(optional)</span></label>
            <input type="text" id="log-scan" placeholder="https://drive.google.com/...">
          </div>
        </div>

        <div class="form-group">
          <label>Note to Client <span style="color:var(--ink-4);text-transform:none">(visible to client)</span></label>
          <textarea id="log-note-client" placeholder="e.g. Looks like a bank statement, return address matches TD Bank..."></textarea>
        </div>
        <div class="form-group">
          <label>Internal Note <span style="color:var(--ink-4);text-transform:none">(staff only)</span></label>
          <textarea id="log-note-internal" placeholder="Internal notes..."></textarea>
        </div>

        <div class="toggle-row" style="margin-bottom:14px">
          <span class="toggle-label">Confidential <span style="font-size:11px; color:var(--ink-4)">(blocks scan & forward)</span></span>
          <div class="toggle" id="tog-confidential" onclick="onConfidentialToggle()"></div>
        </div>
        <div id="confidential-notice" style="display:none;padding:8px 12px;background:var(--amber-bg);border-radius:var(--radius-sm);font-size:12px;color:var(--amber);margin-bottom:10px">
          🔒 <strong>Confidential mail</strong> — Pickup only. No scanning or forwarding. Client will see this notice.
        </div>
        <div id="forwarding-notice" style="display:none;padding:8px 12px;background:var(--blue-bg);border-radius:var(--radius-sm);font-size:12px;color:var(--blue);margin-bottom:10px">
          📬 <strong>Forwarding plan</strong> — This item will be queued for forwarding first week of next month.
        </div>
        <div class="toggle-row" style="margin-bottom:14px">
          <span class="toggle-label">Special Case <span style="font-size:11px; color:var(--ink-4)">(no recipient needed)</span></span>
          <div class="toggle" id="tog-special" onclick="onSpecialCaseToggle()"></div>
        </div>

        <div id="special-case-name-wrap" style="display:none" class="form-group">
          <label>Name on Envelope / Package *</label>
          <input type="text" id="log-special-name" placeholder="As written on the mail — for physical retrieval">
          <div style="font-size:11px;color:var(--ink-4);margin-top:4px">Enter exactly as it appears. Do not search recipients.</div>
        </div>
        <div id="special-case-reason-wrap" style="display:none" class="form-group">
          <label>Special Case Reason</label>
          <input type="text" id="log-special-reason" placeholder="e.g. No matching recipient found">
        </div>

        <div id="parcel-fields" style="display:none">
          <div class="form-divider">Parcel Details</div>
          <div class="form-row">
            <div class="form-group">
              <label>Estimated Weight</label>
              <input type="text" id="log-weight" placeholder="e.g. 2.5 kg">
            </div>
            <div class="form-group">
              <label>Return Address</label>
              <input type="text" id="log-return-addr" placeholder="Sender address">
            </div>
          </div>
          <!-- Oversized toggle removed — not needed for special case intake -->
        <div style="display:none">
            <div class="toggle" id="tog-oversized"></div>
          </div>
        </div>

        <button class="btn btn-primary btn-full" id="log-submit-btn" onclick="submitLogMail()" style="margin-top:8px">
          Log Mail
        </button>
      </div>
    </div>`;

  qs('log-type').addEventListener('change', onMailTypeChange);
}

function onConfidentialToggle() {
  const tog = qs('tog-confidential');
  tog.classList.toggle('on');
  const isConf    = tog.classList.contains('on');
  const scanField = qs('log-scan');
  const scanWrap  = qs('scan-field-wrap');
  if (scanField) { scanField.disabled = isConf; scanField.style.opacity = isConf ? '0.4' : '1'; if (isConf) scanField.value = ''; }
  if (scanWrap)  { scanWrap.style.background = isConf ? 'var(--amber-bg)' : ''; }
  const confNotice = qs('confidential-notice');
  if (confNotice) confNotice.style.display = isConf ? 'block' : 'none';
  const fwdNotice = qs('forwarding-notice');
  if (fwdNotice && isConf) fwdNotice.style.display = 'none';
  updateScanUrlRequirement();
}

function onSpecialCaseToggle() {
  const tog = qs('tog-special');
  tog.classList.toggle('on');
  const isSpecial = tog.classList.contains('on');

  // Recipient section — hide when special case
  const recSection   = qs('recipient-section');
  const recDivider   = qs('recipient-divider');
  const specialNote  = qs('special-case-note');
  const nameWrap     = qs('special-case-name-wrap');
  const reasonWrap   = qs('special-case-reason-wrap');

  if (recSection)  recSection.style.display  = isSpecial ? 'none' : 'block';
  if (recDivider)  recDivider.style.display  = isSpecial ? 'none' : 'block';
  if (specialNote) specialNote.style.display = 'none'; // old notice hidden (name field replaces it)
  if (nameWrap)    nameWrap.style.display    = isSpecial ? 'block' : 'none';
  if (reasonWrap)  reasonWrap.style.display  = isSpecial ? 'block' : 'none';

  // Hide scan URL, note to client, confidential when special case (simplified intake)
  const scanWrap    = qs('scan-field-wrap');
  const noteClient  = document.querySelector('#log-note-client')?.closest('.form-group');
  const confRow     = document.querySelector('#tog-confidential')?.closest('.toggle-row');
  const confNotice  = qs('confidential-notice');
  const fwdNotice   = qs('forwarding-notice');
  if (scanWrap)   scanWrap.style.display   = isSpecial ? 'none' : '';
  if (noteClient) noteClient.style.display = isSpecial ? 'none' : '';
  if (confRow)    confRow.style.display    = isSpecial ? 'none' : '';
  if (confNotice) confNotice.style.display = 'none';
  if (fwdNotice)  fwdNotice.style.display  = 'none';

  if (!isSpecial) clearRecipient();
}

function onMailTypeChange() {
  // Sync hidden field from radio selection
  const radio = document.querySelector('input[name="log-type-radio"]:checked');
  const hidden = qs('log-type');
  if (radio && hidden) hidden.value = radio.value;
  const isParcel = qs('log-type') && qs('log-type').value === 'parcel';

  // Show parcel-specific fields
  const pf = qs('parcel-fields');
  if (pf) pf.style.display = isParcel ? 'block' : 'none';

  // Show oversized toggle only for parcels, reset when switching away
  const oversizedRow = qs('oversized-row');
  if (oversizedRow) oversizedRow.style.display = isParcel ? 'flex' : 'none';
  if (!isParcel && qs('tog-oversized')) qs('tog-oversized').classList.remove('on');

  // Block parcel selection on Economy plans (parcelLimit = 0)
  const pc = STATE.logPlanCard;
  if (isParcel && pc && (!pc.parcelLimit || parseInt(pc.parcelLimit) === 0)) {
    // Switch back to letter
    const letterRadio = document.getElementById('log-type-letter');
    if (letterRadio) { letterRadio.checked = true; hidden.value = 'letter'; }
    if (pf) pf.style.display = 'none';
    if (oversizedRow) oversizedRow.style.display = 'none';
    toast('This plan does not include parcel handling — upgrade to log parcels.', 'error');
    return;
  }

  updateScanUrlRequirement();
}

function updateScanUrlRequirement() {
  const pc           = STATE.logPlanCard;
  const isScanPlan   = pc && pc.autoFeature === 'scan';
  const isConf       = qs('tog-confidential') && qs('tog-confidential').classList.contains('on');
  const isLetter     = qs('log-type') && qs('log-type').value !== 'parcel';
  const mandatory    = isScanPlan && isLetter && !isConf;
  const hint = qs('scan-url-hint');
  if (hint) {
    hint.textContent = mandatory ? '(required for scan plan)' : '(optional)';
    hint.style.color = mandatory ? 'var(--red)' : 'var(--ink-4)';
  }
}


function toggleSpecial() {
  const tog = qs('tog-special');
  tog.classList.toggle('on');
  const wrap = qs('special-case-reason-wrap');
  if (wrap) wrap.style.display = tog.classList.contains('on') ? 'block' : 'none';
}

// ── Recipient search ──────────────────────────────────────
let _searchTimeout = null;

// Recipient cache — loaded once per session, filtered client-side
// Animated refresh: spinRefreshBtn(id) → start, stopRefreshBtn(id) → stop
function spinRefreshBtn(id) {
  const b = document.getElementById(id) || (typeof id === 'object' ? id : null);
  if (b) { b.disabled = true; b.dataset.origHtml = b.innerHTML;
    const arrow = b.innerHTML.match(/[↻⟳↺🔄]/)?.[0] || '↻';
    b.innerHTML = b.innerHTML.replace(/[↻⟳↺🔄]/, `<span class="spin-active">${arrow}</span>`); }
}
function animRefresh(btnId, asyncFn) {
  spinRefreshBtn(btnId);
  Promise.resolve(asyncFn()).finally(() => {
    stopRefreshBtn(btnId);
    const b = document.getElementById(btnId);
    if (b && b.dataset.refreshLabel) setLastRefreshed(b.dataset.refreshLabel);
  });
}
function stopRefreshBtn(id) {
  const b = document.getElementById(id) || (typeof id === 'object' ? id : null);
  if (b) { b.disabled = false; if (b.dataset.origHtml) b.innerHTML = b.dataset.origHtml; }
}

function setLastRefreshed(labelId) {
  const el = document.getElementById(labelId);
  if (!el) return;
  const now = new Date();
  el.textContent = 'Last refreshed ' + now.toLocaleTimeString('en-CA', { hour:'2-digit', minute:'2-digit' });
}

let _recipientCache = null;
let _recipientCacheTime = 0;
const CACHE_TTL = 5 * 60 * 1000;

async function warmRecipientCache() {
  const now = Date.now();
  if (_recipientCache && (now - _recipientCacheTime) < CACHE_TTL) return;
  try {
    const data = await api(`uuid=${STATE.uuid}&action=searchRecipients&q=`);
    _recipientCache = data.recipients || [];
    _recipientCacheTime = now;
  } catch(e) { _recipientCache = _recipientCache || []; }
}

function searchRecipients(query) {
  clearTimeout(_searchTimeout);
  const results = qs('recipient-results');
  if (!results) return;
  if (!query || query.length < 1) { results.style.display = 'none'; return; }

  if (_recipientCache) {
    showRecipientResults(query, results);
    return;
  }
  results.style.display = 'block';
  results.innerHTML = `<div class="recipient-result-item" style="color:var(--ink-4)">Loading...</div>`;
  _searchTimeout = setTimeout(async () => {
    await warmRecipientCache();
    showRecipientResults(query, results);
  }, 80);
}

function showRecipientResults(query, results) {
  if (!results) return;
  const q    = query.toLowerCase();
  const hits = (_recipientCache || []).filter(r =>
    r.status !== 'inactive' &&   // skip inactive recipients in log form
    [r.name, r.companyName, r.planCardId, r.planName]
      .join(' ').toLowerCase().includes(q)
  ).slice(0, 8);

  if (!hits.length) {
    results.style.display = 'block';
    results.innerHTML = `<div class="recipient-result-item" style="color:var(--ink-4)">No matching recipients</div>`;
    return;
  }
  results.style.display = 'block';
  results.innerHTML = hits.map(r => {
    const payload = JSON.stringify({
      recipientId: r.recipientId, name: r.name, companyName: r.companyName,
      planCardId: r.planCardId, clientId: r.clientId,
      subscriptionId: r.subscriptionId, accessStatus: r.accessStatus
    }).replace(/"/g, '&quot;');
    const statusColor = r.accessStatus === 'ACTIVE' ? 'var(--green)' : r.accessStatus === 'CANCELED_WITH_ACCESS' ? 'var(--amber)' : r.accessStatus === 'PAYMENT_REQUIRED' ? 'var(--red)' : r.accessStatus === 'CANCELED' ? 'var(--ink-4)' : 'var(--ink-4)';
    const statusLabel = r.accessStatus === 'ACTIVE' ? '● Active' : r.accessStatus === 'CANCELED_WITH_ACCESS' ? '● Access Until Period End' : r.accessStatus === 'PAYMENT_REQUIRED' ? '⛔ Payment Required' : r.accessStatus === 'CANCELED' ? '✕ Canceled' : r.accessStatus || 'Unknown';
    return `<div class="recipient-result-item" onclick="selectRecipient(${payload})">
      <div class="rri-name">${r.name}${r.companyName ? ' <span style="color:var(--ink-4);font-weight:400">· ' + r.companyName + '</span>' : ''}</div>
      <div class="rri-sub" style="display:flex;gap:8px;align-items:center">
        <span>${r.planName || r.planCardId}</span>
        <span style="font-size:10px;font-weight:600;color:${statusColor}">${statusLabel}</span>
      </div>
    </div>`;
  }).join('');
}


function selectRecipient(data) {
  // Block inactive recipients from being selected for mail logging
  if (data.status === 'inactive') {
    toast('⊘ This recipient is inactive — re-activate them before logging mail.', 'error');
    return;
  }
  STATE.logPlanCard = data;
  updateScanUrlRequirement();
  const results = qs('recipient-results');
  if (results) results.style.display = 'none';

  const search = qs('log-recipient-search');
  if (search) search.value = data.name + (data.companyName ? ' — ' + data.companyName : '');

  const box = qs('selected-recipient-box');
  if (box) {
    box.style.display = 'block';
    const nameEl  = qs('sel-rec-name');
    const subEl   = qs('sel-rec-sub');
    if (nameEl) nameEl.textContent = data.name + (data.companyName ? ' — ' + data.companyName : '');
    if (subEl)  subEl.textContent  = (data.planName || data.planCardId) + ' · ' + (data.clientId || '').slice(0,12) + '...';

    // Payment status warning
    const isBlocked = data.accessStatus && data.accessStatus !== 'ACTIVE' && data.accessStatus !== 'CANCELED_WITH_ACCESS';
    let statusHtml = '';
    if (isBlocked) {
      statusHtml = `<div style="margin-top:6px;padding:6px 10px;background:var(--red-dim);border-radius:var(--radius-sm);font-size:11px;color:var(--red);font-weight:500">
        ⛔ ${data.accessStatus.replace(/_/g,' ')} — mail release blocked. Do not release items.
      </div>`;
    } else if (data.accessStatus === 'CANCELED_WITH_ACCESS') {
      statusHtml = `<div style="margin-top:6px;padding:6px 10px;background:var(--amber-bg);border-radius:var(--radius-sm);font-size:11px;color:var(--amber)">
        ⚠️ Cancelling soon — still has access until billing period ends. Logging allowed.
      </div>`;
    }
    // Block submit button if PAYMENT_REQUIRED or CANCELED
    const submitBtn = qs('log-submit-btn');
    if (data.accessStatus === 'PAYMENT_REQUIRED') {
      statusHtml += `<div style="margin-top:6px;padding:8px 10px;background:var(--red-dim);border-radius:var(--radius-sm);font-size:11px;color:var(--red);font-weight:600">
        ⛔ Payment Required — mail logging is blocked until payment is resolved.
      </div>`;
      if (submitBtn) { submitBtn.disabled = true; submitBtn.title = 'Payment required'; }
    } else if (data.accessStatus === 'CANCELED') {
      statusHtml += `<div style="margin-top:6px;padding:8px 10px;background:var(--red-dim);border-radius:var(--radius-sm);font-size:11px;color:var(--red);font-weight:600">
        ⛔ Plan Cancelled — mail logging is blocked.
      </div>`;
      if (submitBtn) { submitBtn.disabled = true; submitBtn.title = 'Plan cancelled'; }
    } else {
      if (submitBtn) { submitBtn.disabled = false; submitBtn.title = ''; }
    }

    // Remove any old status div
    const old = box.querySelector('.recipient-status-warn');
    if (old) old.remove();
    if (statusHtml) {
      const div = document.createElement('div');
      div.className = 'recipient-status-warn';
      div.innerHTML = statusHtml;
      box.appendChild(div);
    }
  }
  // Forwarding notice
  const fwdNotice = qs('forwarding-notice');
  if (fwdNotice) {
    const hasFwd = data.autoFeature === 'ship';
    const isConf = qs('tog-confidential') && qs('tog-confidential').classList.contains('on');
    fwdNotice.style.display = (hasFwd && !isConf) ? 'block' : 'none';
  }
  // Block submit for expired plans
  const submitBtn = qs('log-submit-btn');
  if (submitBtn) {
    const isExpired = data.accessStatus === 'CANCELED' || data.accessStatus === 'expired';
    submitBtn.disabled = isExpired;
    submitBtn.title = isExpired ? 'Plan expired — use Exception instead' : '';
  }
  updateScanUrlRequirement();
}


function clearRecipient() {
  STATE.logPlanCard = null;
  const search = qs('log-recipient-search');
  if (search) search.value = '';
  const box = qs('selected-recipient-box');
  if (box) box.style.display = 'none';
  const results = qs('recipient-results');
  if (results) results.style.display = 'none';
}

// ── Submit log mail ───────────────────────────────────────
async function submitLogMail() {
  if (STATE.submitting) return;
  const btn       = qs('log-submit-btn');
  const isSpecial = qs('tog-special') && qs('tog-special').classList.contains('on');
  const pc        = STATE.logPlanCard;

  if (!pc && !isSpecial) { toast('Please select a recipient first', 'error'); return; }
  if (isSpecial) {
    const spName = qs('log-special-name') ? qs('log-special-name').value.trim() : '';
    if (!spName) { toast('Please enter the recipient name from the envelope', 'error'); return; }
  }

  const isConfidential = qs('tog-confidential') && qs('tog-confidential').classList.contains('on');
  const type           = qs('log-type') ? qs('log-type').value : 'letter';
  const isScanPlan     = pc && pc.autoFeature === 'scan';
  const scanMandatory  = !isSpecial && isScanPlan && type === 'letter' && !isConfidential;
  const scanUrl        = qs('log-scan') ? qs('log-scan').value.trim() : '';
  if (scanMandatory && !scanUrl) {
    toast('Scan image URL is required for scan plans', 'error');
    if (qs('log-scan')) qs('log-scan').focus();
    return;
  }

  const isOversized = qs('tog-oversized') ? qs('tog-oversized').classList.contains('on') : false;

  STATE.submitting = true;
  if (btn) { btn.disabled = true; btn.innerHTML = '<span class="btn-spinner"></span> Logging...'; }

  try {
    const result = await apiPost({
      action:            'logMail',
      uuid:              STATE.uuid,
      planCardId:        isSpecial ? '' : (pc ? pc.planCardId     : ''),
      clientId:          isSpecial ? '' : (pc ? pc.clientId       : ''),
      subscriptionId:    isSpecial ? '' : (pc ? pc.subscriptionId : ''),
      locationId:        STATE.access.locationId,
      recipientId:       isSpecial ? '' : (pc ? pc.recipientId || '' : ''),
      recipientName:     isSpecial ? ((qs('log-special-name') ? qs('log-special-name').value.trim() : '') || 'SPECIAL CASE') : (pc ? pc.name || '' : ''),
      senderName:        qs('log-sender')        ? qs('log-sender').value.trim()        : '',
      type:              type,
      confidential:      isConfidential,
      oversizedPickup:   qs('tog-oversized') ? qs('tog-oversized').classList.contains('on') : false,
      specialCase:       isSpecial,
      specialCaseReason: isSpecial ? (qs('log-special-reason') ? qs('log-special-reason').value : '') : '',
      physicalLocation:  qs('log-location')      ? qs('log-location').value.trim()      : '',
      scanImageUrl:      scanUrl,
      noteToClient:      qs('log-note-client')   ? qs('log-note-client').value          : '',
      noteInternal:      qs('log-note-internal') ? qs('log-note-internal').value        : '',
      pieceCount:        parseInt(qs('log-pieces') ? qs('log-pieces').value : '1') || 1,
      estimatedWeight:   type === 'parcel' && qs('log-weight')      ? qs('log-weight').value      : '',
      returnAddress:     type === 'parcel' && qs('log-return-addr') ? qs('log-return-addr').value : '',
      oversizedPickup:   isOversized
    });

    if (result.status === 'ok') {
      toast('Mail logged: ' + result.mailId, 'success');
      renderLogForm(qs('log-full') || qs('workspace'));
      STATE.logPlanCard = null;
      await loadTasks();
    } else {
      throw new Error(result.message || 'Logging failed');
    }
  } catch(err) {
    toast(err.message, 'error');
  } finally {
    STATE.submitting = false;
    if (btn) { btn.disabled = false; btn.innerHTML = 'Log Mail'; }
  }
}


// ── Resolve task ──────────────────────────────────────────
async function resolveTask(taskId) {
  const note = qs('resolve-note') ? qs('resolve-note').value : '';
  try {
    const result = await apiPost({
      action:         'resolveTask',
      uuid:           STATE.uuid,
      taskId:         taskId,
      resolutionNote: note
    });
    if (result.status === 'ok') {
      toast('Task resolved', 'success');
      STATE.selectedTask = null;
      await loadTasks();
      renderWorkspace();
    } else {
      throw new Error(result.message || 'Failed');
    }
  } catch(err) {
    toast(err.message, 'error');
  }
}

function snoozePrompt(taskId) {
  const d = prompt('Snooze until date (YYYY-MM-DD):');
  if (d) snoozeTask(taskId, d);
}

async function snoozeTask(taskId, until) {
  try {
    await apiPost({ action:'snoozeTask', uuid:STATE.uuid, taskId, snoozeUntil:until });
    toast('Task snoozed until ' + until);
    await loadTasks();
    renderWorkspace();
  } catch(e) { toast(e.message, 'error'); }
}

function jumpToMailLog(mailId) {
  toast('Mail ID: ' + mailId + ' — full mail log view coming soon.');
}

// ── Staff Mail Log View ───────────────────────────────────
async function renderStaffMailLog(container) {
  container.innerHTML = `
    <div style="max-width:960px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
        <div style="font-family:'DM Serif Display',serif;font-size:20px">Mail Log</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="text" id="ml-search" placeholder="Search name, sender, email, phone..."
            style="padding:7px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:13px;width:200px;font-family:inherit"
            oninput="filterStaffMailLog(this.value)">
          <div style="display:flex;gap:0;border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;background:var(--white)">
            <button id="mlv-active"   onclick="setMailView('active')"   style="padding:6px 12px;font-size:12px;font-weight:600;border:none;background:var(--blue);color:white;cursor:pointer">Active</button>
            <button id="mlv-all"      onclick="setMailView('all')"      style="padding:6px 12px;font-size:12px;border:none;background:none;color:var(--ink-3);cursor:pointer">All</button>
            <button id="mlv-released" onclick="setMailView('released')" style="padding:6px 12px;font-size:12px;border:none;background:none;color:var(--ink-3);cursor:pointer">Released</button>
          </div>
          <button id="ml-refresh-btn" class="btn btn-secondary btn-sm" data-refresh-label="ml-last-refreshed" onclick="animRefresh('ml-refresh-btn', loadStaffMailLog)">↻</button>
          <span id="ml-last-refreshed" style="font-size:11px;color:var(--ink-4)"></span>
        </div>
      </div>
      <div id="ml-list"><div class="empty-pane" style="background:var(--white);border:1px solid var(--border);border-radius:var(--radius);min-height:200px"><div class="empty-icon">⏳</div><div class="empty-title">Loading...</div></div></div>
    </div>`;
  await loadStaffMailLog();
}

let _allStaffMail = [];
let _mailView = 'active'; // 'active' | 'all' | 'released'

function setMailView(v) {
  _mailView = v;
  ['active','all','released'].forEach(n => {
    const b = qs('mlv-' + n);
    if (!b) return;
    b.style.background = n === v ? 'var(--blue)' : 'none';
    b.style.color       = n === v ? 'white' : 'var(--ink-3)';
  });
  filterStaffMailLog(qs('ml-search') ? qs('ml-search').value : '');
}

async function loadStaffMailLog() {
  const el = qs('ml-list');
  if (el) el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--ink-4);font-size:13px">Loading...</div>';
  try {
    const data = await api(`uuid=${STATE.uuid}&action=getMailLogStaff&limit=200`);
    _allStaffMail = data.mailLog || [];
    setMailView(_mailView);
  } catch(e) {
    if (qs('ml-list')) qs('ml-list').innerHTML = '<div style="padding:20px;text-align:center;color:var(--red)">Failed to load: ' + e.message + '</div>';
  }
}

function filterStaffMailLog(query) {
  const q = (query || '').toLowerCase();
  const ACTIVE_STATUSES   = ['arrived','scanned','stored','forwarding_pending'];
  const RELEASED_STATUSES = ['picked_up','forwarded','shredded','discarded','return_to_sender'];
  let filtered = _allStaffMail.filter(m => {
    // Exclude unassigned special cases — they belong in Exceptions tab
    const isSC = m.specialCase === 'TRUE' || m.specialCase === true;
    if (isSC && !m.recipientId) return false;
    if (_mailView === 'active')   { if (!ACTIVE_STATUSES.includes(m.status))   return false; }
    if (_mailView === 'released') { if (!RELEASED_STATUSES.includes(m.status)) return false; }
    if (!q) return true;
    // Search: name, sender, planCardId, mailId, location, clientEmail, clientPhone
    return [m.recipientName, m.senderName, m.planCardId, m.mailId, m.physicalLocation,
            m.clientEmail||'', m.clientPhone||'']
      .join(' ').toLowerCase().includes(q);
  });
  // Sort: active by due date ASC (soonest first), released by loggedAt DESC
  filtered.sort((a, b) => {
    const aAct = ACTIVE_STATUSES.includes(a.status);
    const bAct = ACTIVE_STATUSES.includes(b.status);
    if (aAct && bAct) {
      const aDue = a.storageDueDate ? new Date(a.storageDueDate) : new Date('9999-12-31');
      const bDue = b.storageDueDate ? new Date(b.storageDueDate) : new Date('9999-12-31');
      return aDue - bDue;
    }
    if (aAct && !bAct) return -1;
    if (!aAct && bAct) return 1;
    return new Date(b.loggedAt) - new Date(a.loggedAt);
  });
  renderStaffMailList(filtered);
}

function renderStaffMailList(mailLog) {
  const el = qs('ml-list');
  if (!el) return;

  if (!mailLog.length) {
    const emptyMsg = _mailView === 'active' ? 'No active mail — all clear!' : 'Nothing to show.';
    const emptyIcon = _mailView === 'active' ? '✅' : '📭';
    el.innerHTML = `<div class="empty-pane" style="background:var(--white);border:1px solid var(--border);border-radius:var(--radius);min-height:160px"><div class="empty-icon">${emptyIcon}</div><div class="empty-title">${emptyMsg}</div></div>`;
    return;
  }

  const ACTIVE_STATUSES = ['arrived','scanned','stored','forwarding_pending'];
  const statusColor = {
    arrived:'var(--blue)', scanned:'var(--green)', stored:'var(--amber)',
    forwarded:'var(--green)', picked_up:'var(--ink-4)', shredded:'var(--ink-4)',
    forwarding_pending:'var(--blue)', discarded:'var(--ink-4)', return_to_sender:'var(--ink-4)'
  };
  const statusLabel = {
    arrived:'Arrived', scanned:'Scanned', stored:'Stored',
    forwarded:'Forwarded', picked_up:'Picked Up', shredded:'Shredded',
    forwarding_pending:'Fwd Soon', discarded:'Discarded', return_to_sender:'Returned'
  };

  const hasForwardable = _mailView !== 'released' &&
    mailLog.some(m => m.forwardingEligible === 'TRUE' && ACTIVE_STATUSES.includes(m.status));

  el.innerHTML = `
    ${hasForwardable ? `
    <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--blue-bg);border:1px solid rgba(26,74,122,0.15);border-radius:var(--radius);margin-bottom:10px">
      <span style="font-size:12px;color:var(--blue)">📬 <strong id="fwd-count">0</strong> selected for forwarding</span>
      <button class="btn btn-sm" style="background:var(--blue);color:white;border:none;margin-left:auto" onclick="openForwardModal()" id="fwd-btn" disabled>Forward Selected →</button>
      <button class="btn btn-secondary btn-sm" onclick="selectAllForwardable()">Select All</button>
    </div>` : ''}
    <div style="background:var(--white);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">
      ${mailLog.map((m, idx) => {
        const isParcel      = m.type === 'parcel';
        const isActive      = ACTIVE_STATUSES.includes(m.status);
        const isForwardable = m.forwardingEligible === 'TRUE' && isActive;
        const isReleased    = !isActive;
        const days = m.storageDueDate ? Math.ceil((new Date(m.storageDueDate) - new Date()) / (1000*60*60*24)) : null;
        const daysColor = days === null ? '' : days < 0 ? 'var(--red)' : days <= 2 ? 'var(--red)' : days <= 5 ? 'var(--amber)' : 'var(--ink-4)';
        const daysBadge = isActive && days !== null
          ? `<span style="font-size:10px;font-weight:600;color:${daysColor}">⏰ ${days < 0 ? Math.abs(days)+'d over' : days+'d left'}</span>` : '';
        const fwdBadge  = isForwardable
          ? `<span style="font-size:10px;background:var(--blue-bg);color:var(--blue);padding:1px 6px;border-radius:10px;font-weight:600">FWD</span>` : '';
        const confBadge = (m.confidential === 'TRUE' || m.confidential === true)
          ? `<span style="font-size:10px;background:#FFEDED;color:var(--red);padding:1px 6px;border-radius:10px;font-weight:600">CONF</span>` : '';
        const tempBadge = m.recipientName && m.notes && (m.notes||'').startsWith('TEMP:')
          ? `<span style="font-size:10px;background:var(--amber-bg);color:var(--amber);padding:1px 6px;border-radius:10px;font-weight:600">TEMP</span>` : '';
        const isSpecialCase = m.specialCase === 'TRUE' || m.specialCase === true;
        const scBadge = isSpecialCase
          ? `<span style="font-size:10px;background:#FFF3E0;color:#E65100;padding:1px 6px;border-radius:10px;font-weight:600;border:1px solid #FFCC80">⚠ SPECIAL CASE</span>` : '';
        // Release is only allowed if item has a real recipient+planCard AND is not a special case
        const canRelease = isActive && !isSpecialCase && m.recipientId && m.planCardId && m.clientId;
        const safeMailId   = encodeURIComponent(m.mailId||'');
        const safeRecip    = encodeURIComponent(m.recipientName||'');
        const safePlanCard = encodeURIComponent(m.planCardId||'');
        const safeStatus   = encodeURIComponent(m.accessStatus||'');
        const sc = statusColor[m.status] || 'var(--ink-3)';
        const sl = statusLabel[m.status] || m.status;

        return `
          <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);${isReleased ? 'opacity:0.7;background:var(--bg)' : 'background:var(--white)'}">
            ${isForwardable
              ? `<input type="checkbox" class="fwd-checkbox" data-mailid="${m.mailId}" onchange="onForwardCheckChange()" style="width:16px;height:16px;cursor:pointer;flex-shrink:0;accent-color:var(--blue)">`
              : `<div style="width:16px;flex-shrink:0"></div>`}
            <div style="width:36px;flex-shrink:0;text-align:center">
              <div style="font-size:16px">${isParcel?'📦':'✉️'}</div>
              <div style="font-size:9px;font-weight:600;color:${isParcel?'var(--amber)':'var(--blue)'};text-transform:uppercase">${isParcel?'Parcel':'Mail'}</div>
            </div>
            <div style="flex:1;min-width:0">
              <div style="font-size:13px;font-weight:500;display:flex;align-items:center;gap:5px;flex-wrap:wrap">
                ${isSpecialCase ? '(Unassigned)' : (m.recipientName || '—')}
                ${confBadge}${fwdBadge}${tempBadge}${scBadge}${daysBadge}
              </div>
              <div style="font-size:11px;color:var(--ink-4);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                ${m.senderName ? 'From: '+m.senderName+' · ' : ''}${new Date(m.loggedAt).toLocaleDateString('en-CA',{month:'short',day:'numeric'})}${m.physicalLocation ? ' · 📍'+m.physicalLocation : ''}${m.trackingLink ? ' · <a href="'+m.trackingLink+'" target="_blank" style="color:var(--blue)">Track ↗</a>' : ''}
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
              <span style="font-size:11px;font-weight:600;color:${sc};background:rgba(0,0,0,0.04);padding:2px 8px;border-radius:10px;white-space:nowrap">${sl}</span>
              ${canRelease
                ? `<button class="btn btn-success btn-sm" onclick="openReleaseModal('${safeMailId}','${safeRecip}','${safePlanCard}','${safeStatus}')">Release</button>`
                : isActive
                  ? `<button class="btn btn-secondary btn-sm" disabled title="${isSpecialCase ? 'Assign recipient first' : 'Missing account info'}" style="opacity:0.5;cursor:not-allowed">Release</button>`
                  : `<button class="btn btn-secondary btn-sm" onclick="openMailDetail('${m.mailId}')">View</button>`}
              ${(m.status !== 'picked_up' && m.status !== 'deleted' && m.status !== 'forwarded' && m.status !== 'shredded' && m.status !== 'discarded')
                ? `<button class="btn btn-secondary btn-sm" title="Edit mail item" onclick="openEditMailModal('${safeMailId}')" style="display:inline-flex;align-items:center;gap:3px;padding:3px 8px">
                    <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M11.5 2.5a2.121 2.121 0 013 3L5 15H1v-4L11.5 2.5z"/>
                    </svg>
                    Edit
                   </button>
                   <button class="btn btn-secondary btn-sm" title="Delete mail item" style="color:var(--red);padding:3px 8px" onclick="confirmDeleteMail('${safeMailId}','${safeRecip}')">✕ Delete</button>`
                : ''}
            </div>
          </div>`;
      }).join('')}
    </div>`;
}


function onForwardCheckChange() {
  const checked = document.querySelectorAll('.fwd-checkbox:checked');
  const btn = qs('fwd-btn'), cnt = qs('fwd-count');
  if (btn) btn.disabled = checked.length === 0;
  if (cnt) cnt.textContent = checked.length;
}
function selectAllForwardable() {
  document.querySelectorAll('.fwd-checkbox').forEach(cb => { cb.checked = true; });
  onForwardCheckChange();
}

function openForwardModal() {
  const checked = document.querySelectorAll('.fwd-checkbox:checked');
  const mailIds = Array.from(checked).map(cb => cb.dataset.mailid);
  if (!mailIds.length) return;
  const existing = qs('forward-modal'); if (existing) existing.remove();
  const modal = document.createElement('div');
  modal.id = 'forward-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);padding:24px;max-width:460px;width:100%;box-shadow:var(--shadow-md);max-height:90vh;overflow-y:auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif;font-size:18px">📬 Forward ${mailIds.length} Item${mailIds.length>1?'s':''}</div>
        <button onclick="qs('forward-modal').remove()" style="background:none;font-size:18px;color:var(--ink-3)">✕</button>
      </div>
      <div class="form-group">
        <label>Tracking URL <span style="color:var(--ink-4);text-transform:none;font-weight:400">(visible to client)</span></label>
        <input type="text" id="fwd-tracking" placeholder="https://www.canadapost-postescanada.ca/track-reperage/...">
      </div>
      <div class="form-group">
        <label>Forwarding Cost (CAD) <span style="color:var(--ink-4);text-transform:none;font-weight:400">(staff only)</span></label>
        <input type="text" id="fwd-cost" placeholder="e.g. 12.50">
      </div>
      <div class="form-group">
        <label>Notes <span style="color:var(--ink-4);text-transform:none;font-weight:400">(optional)</span></label>
        <textarea id="fwd-notes" style="width:100%;padding:8px 11px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px;resize:vertical;min-height:60px" placeholder="e.g. Shipped via Canada Post Xpresspost..."></textarea>
      </div>
      <div style="background:var(--amber-bg);border-radius:var(--radius-sm);padding:8px 12px;font-size:12px;color:var(--amber);margin-bottom:16px">
        ⚠️ Forwarding cost is staff-only and not auto-billed. Invoice separately if needed.
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" style="flex:1" id="fwd-submit-btn" onclick="submitBulkForward(${JSON.stringify(mailIds)})">✓ Confirm Forward</button>
        <button class="btn btn-secondary" onclick="qs('forward-modal').remove()">Cancel</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target===modal) modal.remove(); });
}

async function submitBulkForward(mailIds) {
  const trackingLink   = qs('fwd-tracking') ? qs('fwd-tracking').value.trim() : '';
  const forwardingCost = qs('fwd-cost')     ? qs('fwd-cost').value.trim()     : '';
  const forwardNotes   = qs('fwd-notes')    ? qs('fwd-notes').value.trim()    : '';
  const btn = qs('fwd-submit-btn');
  if (btn) { btn.disabled=true; btn.innerHTML='<span class="btn-spinner"></span> Forwarding...'; }
  try {
    const result = await apiPost({ action:'bulkForwardMail', uuid:STATE.uuid, mailIds:JSON.stringify(mailIds), trackingLink, forwardingCost, forwardNotes });
    if (result.status==='ok') {
      qs('forward-modal').remove();
      const ok  = (result.results||[]).filter(r=>r.status==='ok').length;
      const err = (result.results||[]).filter(r=>r.status==='error').length;
      toast(`${ok} item${ok>1?'s':''} forwarded${err?', '+err+' failed':''}`, ok>0?'success':'error');
      await loadStaffMailLog();
    } else throw new Error(result.message||'Forward failed');
  } catch(err) {
    toast(err.message,'error');
    if (btn) { btn.disabled=false; btn.innerHTML='✓ Confirm Forward'; }
  }
}


// ── Release Modal ─────────────────────────────────────────
async function openReleaseModal(mailId, recipientName, planCardId, accessStatus) {
  // Decode URI-encoded params (passed safely from onclick attributes)
  mailId        = decodeURIComponent(mailId        || '');
  recipientName = decodeURIComponent(recipientName || '');
  planCardId    = decodeURIComponent(planCardId    || '');
  accessStatus  = decodeURIComponent(accessStatus  || '');
  const existing = qs('release-modal');
  if (existing) existing.remove();

  // Block if payment issue
  if (accessStatus && !['ACTIVE','CANCELED_WITH_ACCESS'].includes(accessStatus)) {
    const modal = document.createElement('div');
    modal.id = 'release-modal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
    modal.innerHTML = `<div style="background:var(--white);border-radius:var(--radius);padding:24px;max-width:400px;width:100%;box-shadow:var(--shadow-md)">
      <div style="font-size:18px;font-family:'DM Serif Display',serif;margin-bottom:12px">⛔ Release Blocked</div>
      <div style="font-size:13px;color:var(--ink-2);margin-bottom:16px">
        This mailbox has an outstanding payment issue (<strong>${accessStatus.replace(/_/g,' ')}</strong>).
        Mail cannot be released until payment is resolved.<br><br>A notification has been sent to the client.
      </div>
      <button class="btn btn-secondary btn-full" onclick="qs('release-modal').remove()">Close</button>
    </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    apiPost({ action:'notifyNonPayment', uuid:STATE.uuid, planCardId, mailId }).catch(()=>{});
    return;
  }

  // Fetch active agents for this plan card
  let agents = [];
  try {
    const data = await api(`uuid=${STATE.uuid}&action=getAgentsForPlanCard&planCardId=${planCardId}`);
    agents = data.agents || [];
  } catch(e) {}

  const agentOptions = agents.length === 0
    ? `<div style="padding:12px;background:var(--amber-bg);border-radius:var(--radius-sm);font-size:13px;color:var(--amber)">
        ⚠️ No authorized pickup agents on file. Client needs to add agents from their dashboard before mail can be released.
      </div>`
    : `<div style="display:flex;flex-direction:column;gap:8px" id="agent-options">
        ${agents.map(a => `
          <label style="display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:background 0.1s"
            onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background=''">
            <input type="radio" name="release-agent" value="${a.agentId}" style="flex-shrink:0">
            <div>
              <div style="font-size:13px;font-weight:500">${a.name}</div>
              <div style="font-size:11px;color:var(--ink-4)">${a.idType?a.idType+(a.idLast4?' ···'+a.idLast4:''):''} ${a.phone?'· '+a.phone:''}</div>
            </div>
          </label>`).join('')}
      </div>`;

  const modal = document.createElement('div');
  modal.id = 'release-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);padding:24px;max-width:440px;width:100%;box-shadow:var(--shadow-md);max-height:90vh;overflow-y:auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif;font-size:18px">Release Mail</div>
        <button onclick="qs('release-modal').remove()" style="background:none;font-size:18px;color:var(--ink-3);cursor:pointer">✕</button>
      </div>
      <div style="font-size:13px;color:var(--ink-3);margin-bottom:16px">
        Releasing mail for <strong>${recipientName}</strong>. Select the authorized agent collecting this item.
      </div>
      ${agentOptions}
      ${agents.length > 0 ? `
      <div style="margin-top:16px">
        <label style="font-size:11px;font-weight:500;color:var(--ink-3);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:5px">Release Notes <span style="color:var(--ink-4);text-transform:none">(optional)</span></label>
        <textarea id="release-notes" style="width:100%;padding:8px 11px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px;resize:vertical;min-height:60px" placeholder="e.g. ID verified, signed release form..."></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button class="btn btn-success" style="flex:1" onclick="submitRelease('${mailId}','${planCardId}')">✓ Confirm Release</button>
        <button class="btn btn-secondary" onclick="qs('release-modal').remove()">Cancel</button>
      </div>` : `
      <button class="btn btn-secondary btn-full" style="margin-top:16px" onclick="qs('release-modal').remove()">Close</button>`}
    </div>`;

  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

async function submitRelease(mailId, planCardId) {
  const selected = document.querySelector('input[name="release-agent"]:checked');
  if (!selected) { toast('Please select a pickup agent', 'error'); return; }

  const btn = document.querySelector('#release-modal .btn-success');
  if (btn) { btn.disabled = true; btn.innerHTML = '<span class="btn-spinner"></span> Releasing...'; }

  try {
    const result = await apiPost({
      action:       'releaseMail',
      uuid:         STATE.uuid,
      mailId:       mailId,
      agentId:      selected.value,
      releaseNotes: qs('release-notes') ? qs('release-notes').value : ''
    });

    if (result.status === 'ok') {
      qs('release-modal').remove();
      toast('Mail released successfully', 'success');
      // Refresh mail log
      await loadStaffMailLog();
      // Refresh tasks
      await loadTasks();
      if (STATE.view === 'split') renderTasksPane();
    } else {
      throw new Error(result.message || 'Release failed');
    }
  } catch(err) {
    toast(err.message, 'error');
    if (btn) { btn.disabled = false; btn.innerHTML = '✓ Confirm Release'; }
  }
}

function openMailDetail(mailId) {
  mailId = decodeURIComponent(mailId || '');
  // Find in cached list
  const m = _allStaffMail.find(x => x.mailId === mailId);
  if (!m) { toast('Mail item not found'); return; }

  const existing = qs('mail-detail-modal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'mail-detail-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);max-width:460px;width:100%;box-shadow:var(--shadow-md);display:flex;flex-direction:column;max-height:85vh">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);flex-shrink:0">
        <div style="font-family:'DM Serif Display',serif;font-size:17px">${m.type === 'parcel' ? '📦' : '✉️'} Mail Detail</div>
        <button onclick="qs('mail-detail-modal').remove()" style="background:none;font-size:18px;color:var(--ink-3)">✕</button>
      </div>
      <div style="overflow-y:auto;flex:1;padding:0 20px">
      <div style="display:flex;flex-direction:column;gap:0">
        ${[
        ['Mail ID',           m.mailId],
        ['Recipient',         m.recipientName || '—'],
        ['Plan Card',         m.planCardId || '—'],
        ['Client ID',         m.clientId || '—'],
        ['Sender',            m.senderName || '—'],
        ['Type',              m.type === 'parcel' ? '📦 Parcel' : '✉️ Mail / Letter'],
        ['Status',            m.status.replace(/_/g,' ')],
        ['Confidential',      m.confidential==='TRUE'||m.confidential===true ? '🔒 Yes' : 'No'],
        ['Special Case',      m.specialCase==='TRUE'||m.specialCase===true ? '⚠️ Yes' : 'No'],
        ['Special Case Reason',m.specialCaseReason || '—'],
        ['Physical Location', m.physicalLocation || '—'],
        ['Scan URL',          m.scanImageUrl ? '<a href="'+m.scanImageUrl+'" target="_blank" style="color:var(--blue)">View ↗</a>' : '—'],
        ['Note to Client',    m.noteToClient || '—'],
        ['Internal Note',     m.noteInternal || '—'],
        ['Logged At',         m.loggedAt],
        ['Logged By',         m.loggedBy || '—'],
        ['Storage Start',     m.storageStartDate || '—'],
        ['Storage Due',       m.storageDueDate || '—'],
        ['Piece Count',       m.pieceCount || '—'],
        ['Released To',       m.releasedTo || '—'],
        ['Released At',       m.releasedAt || '—'],
        ['Released By',       m.releasedBy || '—'],
        ['Forwarding Eligible',m.forwardingEligible==='TRUE'||m.forwardingEligible===true ? 'Yes' : 'No'],
        ['Edited At',         m.editedAt || '—'],
        ['Edited By',         m.editedBy || '—'],
      ].map(([k,v]) => `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px;gap:12px">
          <span style="color:var(--ink-3);flex-shrink:0;min-width:130px">${k}</span>
          <span style="font-weight:500;text-align:right;word-break:break-all">${v}</span>
        </div>`).join('')}
      </div>
      </div>
      <div style="padding:16px 20px;border-top:1px solid var(--border);flex-shrink:0">
        <button class="btn btn-secondary btn-full" onclick="qs('mail-detail-modal').remove()">Close</button>
      </div>
    </div>`;

  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

// ── Special Case Release Modal ────────────────────────────
function openSpecialCaseReleaseModal(mailId) {
  const m = _allStaffMail.find(x => x.mailId === mailId);
  if (!m) return;

  const existing = qs('special-release-modal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'special-release-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);padding:24px;max-width:420px;width:100%;box-shadow:var(--shadow-md)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif;font-size:18px">🔍 Special Case Item</div>
        <button onclick="qs('special-release-modal').remove()" style="background:none;font-size:18px;color:var(--ink-3);cursor:pointer">✕</button>
      </div>
      <div style="font-size:13px;color:var(--ink-3);margin-bottom:14px">
        This item has no recipient assigned. You can:
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-secondary" onclick="qs('special-release-modal').remove();openAssignRecipientModal('${mailId}')">
          📋 Assign to Recipient (starts storage clock)
        </button>
        <button class="btn btn-secondary" onclick="discardSpecialCase('${mailId}')">
          🗑 Mark as Discarded
        </button>
        <button class="btn btn-secondary" onclick="qs('special-release-modal').remove()">
          Cancel — keep in queue
        </button>
      </div>
      <div style="font-size:11px;color:var(--ink-4);margin-top:14px">
        Storage clock starts from the date of recipient assignment.
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

async function discardSpecialCase(mailId) {
  try {
    await apiPost({ action: 'updateMailStatus', uuid: STATE.uuid, mailId, status: 'discarded', note: 'Staff discarded unmatched special case item' });
    qs('special-release-modal') && qs('special-release-modal').remove();
    toast('Item marked as discarded', 'success');
    await loadStaffMailLog();
  } catch(e) { toast(e.message, 'error'); }
}

async function renderExceptionsView(container) {
  container.innerHTML = `
    <div style="max-width:900px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif;font-size:20px">⚠ Exceptions</div>
        <button id="exc-refresh-btn" class="btn btn-secondary btn-sm" data-refresh-label="exc-last-refreshed" onclick="animRefresh('exc-refresh-btn', loadExceptions)">↻ Refresh</button>
          <span id="exc-last-refreshed" style="font-size:11px;color:var(--ink-4)"></span>
      </div>
      <div style="font-size:13px;color:var(--ink-3);margin-bottom:16px">
        Mail items with no matched recipient or flagged as special case. Assign to a recipient or discard.
      </div>
      <div id="exc-list"><div style="text-align:center;padding:40px;color:var(--ink-4)">Loading...</div></div>
    </div>`;
  await loadExceptions();
}

async function loadExceptions() {
  const el = qs('exc-list');
  if (!el) return;
  try {
    const data = await api(`uuid=${STATE.uuid}&action=getExceptions&limit=200`);
    renderExceptionsList(data.exceptions || []);
  } catch(e) {
    if (el) el.innerHTML = `<div style="color:var(--red);padding:20px">Error loading exceptions: ${e.message}</div>`;
  }
}


function renderExceptionsList(items) {
  const el = qs('exc-list');
  if (!el) return;
  if (!items.length) {
    el.innerHTML = `<div style="text-align:center;padding:48px;background:var(--white);border:1px solid var(--border);border-radius:var(--radius)"><div style="font-size:32px;margin-bottom:12px">✅</div><div style="font-size:14px;font-weight:500">No exceptions</div><div style="font-size:13px;color:var(--ink-4)">All mail items have been assigned.</div></div>`;
    return;
  }
  el.innerHTML = items.map(m => {
    const isParcel = m.type === 'parcel';
    const days = m.storageDueDate ? Math.ceil((new Date(m.storageDueDate)-new Date())/(1000*60*60*24)) : null;
    const daysHtml = days!==null ? `<span style="font-size:11px;color:${days<0?'var(--red)':days<=5?'var(--amber)':'var(--ink-4)'};font-weight:600">⏰ ${days<0?Math.abs(days)+'d overdue':days+'d left'}</span>` : '';
    // How long it's been sitting as special case
    const loggedDate = new Date(m.loggedAt);
    const daysStored = Math.floor((new Date() - loggedDate) / (1000*60*60*24));
    const storedColor = daysStored >= 20 ? 'var(--red)' : daysStored >= 10 ? 'var(--amber)' : 'var(--ink-3)';
    const storedLabel = daysStored === 0 ? 'logged today' : daysStored === 1 ? '1 day in exceptions' : `${daysStored} days in exceptions`;

    return `
      <div class="exc-item">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap">
              <span style="font-size:16px">${isParcel?'📦':'✉️'}</span>
              <span style="font-size:13px;font-weight:600">${m.mailId}</span>
              <span class="pill ${m.status}">${m.status.replace(/_/g,' ')}</span>
              <span style="font-size:11px;font-weight:600;color:${storedColor}">⏱ ${storedLabel}</span>
              ${daysHtml}
            </div>
            <div style="font-size:13px;color:var(--ink-2);margin-bottom:2px">
              ${m.senderName?'From: <strong>'+m.senderName+'</strong> · ':''}Logged ${loggedDate.toLocaleDateString('en-CA',{month:'short',day:'numeric',year:'numeric'})}
            </div>
            <div style="font-size:12px;color:var(--amber);margin-top:4px">⚠ ${m.specialCaseReason||'No recipient matched'}</div>
            ${m.physicalLocation?`<div style="font-size:11px;color:var(--ink-4);margin-top:2px">📍 ${m.physicalLocation}</div>`:''}
          </div>
        </div>
        <div class="exc-actions">
          <button class="btn btn-primary btn-sm" onclick="openAssignModal('${m.mailId}')">Assign to Recipient →</button>
          <button class="btn btn-secondary btn-sm" onclick="openDiscardModal('${m.mailId}')">Discard</button>
          <button class="btn btn-secondary btn-sm" onclick="openMailDetail('${m.mailId}')">View Detail</button>
        </div>
      </div>`;
  }).join('');
}

function openAssignModal(mailId) {
  const existing = qs('assign-modal'); if (existing) existing.remove();
  const modal = document.createElement('div');
  modal.id = 'assign-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);padding:24px;max-width:460px;width:100%;box-shadow:var(--shadow-md)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif;font-size:18px">Assign Mail Item</div>
        <button onclick="qs('assign-modal').remove()" style="background:none;font-size:18px;color:var(--ink-3)">✕</button>
      </div>
      <div style="font-size:13px;color:var(--ink-3);margin-bottom:16px">Search for the recipient this mail belongs to.</div>
      <div class="form-group" style="position:relative">
        <label>Search Recipient</label>
        <input type="text" id="assign-search" placeholder="Type name or company..." autocomplete="off" oninput="searchForAssign(this.value)">
        <div id="assign-results" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--white);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:var(--shadow-md);z-index:10;max-height:200px;overflow-y:auto"></div>
      </div>
      <div id="assign-selected" style="display:none;background:var(--bg);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:14px;font-size:13px">
        <div style="font-weight:500" id="assign-sel-name"></div>
        <div style="font-size:11px;color:var(--ink-4)" id="assign-sel-sub"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn btn-primary" style="flex:1" id="assign-submit-btn" onclick="submitAssign('${mailId}')">Assign</button>
        <button class="btn btn-secondary" onclick="qs('assign-modal').remove()">Cancel</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target===modal) modal.remove(); });
}

let _assignTarget = null;

function searchForAssign(query) {
  const results = qs('assign-results');
  if (!results || !query) { if(results) results.style.display='none'; return; }
  const q = query.toLowerCase();
  const hits = (_recipientCache||[]).filter(r => [r.name,r.companyName,r.planCardId].join(' ').toLowerCase().includes(q)).slice(0,8);
  results.style.display = 'block';
  if (!hits.length) { results.innerHTML=`<div style="padding:10px 12px;color:var(--ink-4);font-size:13px">No matches</div>`; return; }
  results.innerHTML = hits.map(r => {
    const data = JSON.stringify({recipientId:r.recipientId,name:r.name,companyName:r.companyName||'',planCardId:r.planCardId,clientId:r.clientId,subscriptionId:r.subscriptionId||''}).replace(/"/g,'&quot;');
    return `<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--border);font-size:13px" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background=''" onclick="selectForAssign(${data})">
      <div style="font-weight:500">${r.name}${r.companyName?' · <span style="color:var(--ink-4)">'+r.companyName+'</span>':''}</div>
      <div style="font-size:11px;color:var(--ink-4)">${r.planName||r.planCardId}</div>
    </div>`;
  }).join('');
}

function selectForAssign(data) {
  _assignTarget = data;
  const results = qs('assign-results'); if (results) results.style.display='none';
  const search  = qs('assign-search');  if (search)  search.value = data.name;
  const sel = qs('assign-selected');
  if (sel) {
    sel.style.display = 'block';
    const n = qs('assign-sel-name'), sub = qs('assign-sel-sub');
    if (n) n.textContent = data.name + (data.companyName?' — '+data.companyName:'');
    if (sub) sub.textContent = data.planCardId;
  }
}

async function submitAssign(mailId) {
  if (!_assignTarget) { toast('Please select a recipient first','error'); return; }
  const btn = qs('assign-submit-btn');
  if (btn) { btn.disabled=true; btn.textContent='Assigning...'; }
  try {
    const result = await apiPost({ action:'assignMailRecipient', uuid:STATE.uuid, mailId,
      recipientId:_assignTarget.recipientId, recipientName:_assignTarget.name,
      planCardId:_assignTarget.planCardId, clientId:_assignTarget.clientId,
      subscriptionId:_assignTarget.subscriptionId });
    if (result.status==='ok') {
      qs('assign-modal').remove();
      _assignTarget = null;
      // If plan requires scan, prompt for scan URL before dismissing
      if (result.needsScan) {
        const scanUrl = prompt('This is a SCAN plan.\nPlease enter the Scan Image URL for this item (required):');
        if (scanUrl && scanUrl.trim()) {
          await apiPost({ action:'editMailItem', uuid:STATE.uuid, mailId, scanImageUrl: scanUrl.trim() });
        }
      }
      toast('Mail assigned — now in main mail log', 'success');
      await loadExceptions();
      await loadStaffMailLog();
    } else throw new Error(result.message||'Failed');
  } catch(err) { toast(err.message,'error'); if (btn) { btn.disabled=false; btn.textContent='Assign'; } }
}

function openDiscardModal(mailId) {
  const reason = prompt('Reason for discarding this item:');
  if (reason===null) return;
  apiPost({ action:'updateMailStatus', uuid:STATE.uuid, mailId, status:'discarded', note:reason })
    .then(r => { if (r.status==='ok') { toast('Item discarded','success'); loadExceptions(); } else toast(r.message||'Failed','error'); })
    .catch(e => toast(e.message,'error'));
}


// ══════════════════════════════════════════════════════════
// PLAN CARDS VIEW
// ══════════════════════════════════════════════════════════
async function renderPlanCardsView(container) {
  container.innerHTML = `
    <div style="max-width:900px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif;font-size:20px">🗂 Plan Cards</div>
        <div style="display:flex;gap:8px">
          <input type="text" id="pc-search" placeholder="Search client, email, plan, recipient..." style="padding:7px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:13px;font-family:inherit;width:240px" oninput="filterPlanCards(this.value)">
          <button id="pc-refresh-btn" class="btn btn-secondary btn-sm" data-refresh-label="pc-last-refreshed" onclick="animRefresh('pc-refresh-btn', loadPlanCardsView)">↻</button>
          <span id="pc-last-refreshed" style="font-size:11px;color:var(--ink-4)"></span>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <select id="pc-status-filter" onchange="filterPlanCards(qs('pc-search').value)"
          style="padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;font-family:inherit">
          <option value="">All Plans</option>
          <option value="ACTIVE">✅ Active</option>
          <option value="PAYMENT_REQUIRED">⛔ Payment Required</option>
          <option value="CANCELED_WITH_ACCESS">⚠️ Pending Cancellation</option>
          <option value="CANCELED">✕ Cancelled</option>
        </select>
      </div>
      <div id="pc-list"><div style="text-align:center;padding:40px;color:var(--ink-4)">Loading...</div></div>
    </div>`;
  await loadPlanCardsView();
}

let _allPlanCards = [];

async function loadPlanCardsView() {
  const el = qs('pc-list'); if (!el) return;
  try {
    const data = await api(`uuid=${STATE.uuid}&action=getPlanCardsStaff`);
    _allPlanCards = data.planCards || [];
    renderPlanCardsList(_allPlanCards);
  } catch(e) { if(el) el.innerHTML=`<div style="color:var(--red);padding:20px">Error: ${e.message}</div>`; }
}

function filterPlanCards(query) {
  const q      = (query||'').toLowerCase();
  const status = qs('pc-status-filter') ? qs('pc-status-filter').value : '';
  let filtered = _allPlanCards;
  if (status) filtered = filtered.filter(pc => (pc.accessStatus||'') === status);
  if (q)      filtered = filtered.filter(pc =>
    [pc.planCardId,pc.planName,pc.clientId,pc.clientName,pc.clientEmail||'',...(pc.recipients||[]).map(r=>r.name+' '+(r.companyName||'')+' '+(r.email||'')),pc.businessDescription||'',(pc.notes||''),(pc.referralSource||''),(pc.subscriptionId||'')].join(' ').toLowerCase().includes(q)
  );
  renderPlanCardsList(filtered);
}

function renderPlanCardsList(planCards) {
  // Apply status filter
  const filterVal = STATE.planCardFilter || 'all';
  if (filterVal !== 'all') {
    planCards = planCards.filter(pc => {
      const st = (pc.accessStatus || '').toUpperCase();
      if (filterVal === 'active')   return st === 'ACTIVE';
      if (filterVal === 'payment')  return st === 'PAYMENT_REQUIRED';
      if (filterVal === 'canceled') return st === 'CANCELED';
      if (filterVal === 'pending')  return st === 'CANCELED_WITH_ACCESS';
      return true;
    });
  }

  const el = qs('pc-list'); if (!el) return;
  if (!planCards.length) {
    el.innerHTML = `<div style="text-align:center;padding:40px;color:var(--ink-4)">No plan cards found.</div>`;
    return;
  }

  const statusInfo = {
    'ACTIVE':               { cls:'scanned',    label:'Active',              icon:'✅' },
    'CANCELED_WITH_ACCESS': { cls:'warning',    label:'Canceling',           icon:'⚠️' },
    'PAYMENT_REQUIRED':     { cls:'payment_req',label:'Payment Required',    icon:'⛔' },
    'CANCELED':             { cls:'expired',    label:'Canceled',            icon:'✕' },
    'UNKNOWN':              { cls:'stored',     label:'Unknown',             icon:'—' }
  };

  // Nicely format ISO dates like "2026-02-22T05:00:00.000Z"
  function fmtPeriodDate(raw) {
    if (!raw) return '—';
    try {
      return new Date(raw).toLocaleDateString('en-CA', { month: 'short', day: 'numeric', year: 'numeric' });
    } catch(e) { return raw; }
  }

  el.innerHTML = planCards.map((pc, i) => {
    const recs      = pc.recipients || [];
    const activeRec = recs.filter(r => r.status === 'active');
    const tempRec   = recs.filter(r => r.status === 'active' && r.notes && r.notes.startsWith('TEMP:'));
    const si        = statusInfo[pc.accessStatus] || statusInfo['UNKNOWN'];
    const isActive  = pc.accessStatus === 'ACTIVE' || pc.accessStatus === 'CANCELED_WITH_ACCESS';
    const clientLabel = pc.clientName ? ` <span style="font-weight:400;color:var(--ink-3)">(${pc.clientName})</span>` : '';

    return `
      <div class="pc-card" style="border-left:3px solid ${isActive ? 'var(--green)' : 'var(--red)'}">
        <div class="pc-card-header" id="pc-hdr-${i}" onclick="togglePcCard(${i})" style="cursor:pointer" title="Click to expand">
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap">
              <span style="font-size:13px;font-weight:600">${pc.planName||pc.planCardId}${clientLabel}</span>
              <span class="pill ${si.cls}" style="font-size:10px">${si.icon} ${si.label}</span>
            </div>
            <div style="font-size:11px;color:var(--ink-4);display:flex;gap:12px;flex-wrap:wrap">
              <span>${pc.planCardId}</span>
              <span>${activeRec.length} recipient${activeRec.length!==1?'s':''}${tempRec.length ? ` (${tempRec.length} temp)` : ''}</span>
              ${pc.autoFeature === 'ship' ? '<span>📬 Forwarding</span>' : ''}
              ${pc.autoFeature === 'scan' ? '<span>🔍 Scan</span>' : ''}
            </div>
          </div>
          <span style="color:var(--ink-4);font-size:14px;flex-shrink:0" id="pc-chevron-${i}">▸</span>
        </div>

        <div id="pc-body-${i}" style="display:none" class="pc-card-body">

          <!-- Client Info -->
          <div style="background:var(--bg);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:14px">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);margin-bottom:8px">Client Info</div>
            <div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px;font-size:12px">
              <span style="color:var(--ink-4)">Name</span>
              <span style="font-weight:500">${pc.clientName || '—'}</span>
              <span style="color:var(--ink-4)">Email</span>
              <span>${pc.clientEmail ? `<a href="mailto:${pc.clientEmail}" style="color:var(--blue)">${pc.clientEmail}</a>` : '—'}</span>
              <span style="color:var(--ink-4)">Phone</span>
              <span>${pc.clientPhone || '—'}</span>
              <span style="color:var(--ink-4)">Client ID</span>
              <span style="font-family:monospace;font-size:10px;color:var(--ink-4)">${pc.clientId || '—'}</span>
              <span style="color:var(--ink-4)">Plan Card ID</span>
              <span style="font-family:monospace;font-size:10px;color:var(--ink-4)">${pc.planCardId}</span>
              ${pc.businessDescription ? `<span style="color:var(--ink-4)">Business</span><span style="color:var(--ink-2)">${pc.businessDescription}</span>` : ''}
              ${pc.referralSource ? `<span style="color:var(--ink-4)">Source</span><span style="color:var(--ink-3)">${pc.referralSource}</span>` : ''}
            </div>
          </div>

          <!-- Billing & Usage -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;font-size:12px">
            <div style="background:var(--bg);border-radius:var(--radius-sm);padding:10px 12px">
              <div style="color:var(--ink-4);margin-bottom:3px">Billing Period</div>
              <div style="font-weight:500">${fmtPeriodDate(pc.currentPeriodStart)} – ${fmtPeriodDate(pc.currentPeriodEnd)}</div>
            </div>
            <div style="background:var(--bg);border-radius:var(--radius-sm);padding:10px 12px">
              <div style="color:var(--ink-4);margin-bottom:3px">Usage</div>
              <div style="font-weight:500">Mail: ${pc.mailsUsed||0}/${pc.mailLimit||'—'} · Parcels: ${pc.parcelsUsed||0}/${pc.parcelLimit||'—'}</div>
            </div>
            ${pc.forwardingAddress ? `
            <div style="background:var(--bg);border-radius:var(--radius-sm);padding:10px 12px;grid-column:1/-1">
              <div style="color:var(--ink-4);margin-bottom:3px">Forward to</div>
              <div style="font-weight:500">${pc.forwardingAddress}, ${pc.forwardingCity||''} ${pc.forwardingProvince||''} ${pc.forwardingPostalCode||''}</div>
            </div>` : ''}
          </div>

          <!-- Recipients -->
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3)">
              Recipients (${recs.length})
            </div>
            <button class="btn btn-secondary btn-sm" onclick="openAddTempRecipient('${pc.planCardId}',${i})">
              + Add Temporary
            </button>
          </div>
          <div id="add-temp-${i}" style="display:none;background:var(--bg);border-radius:var(--radius-sm);padding:14px;margin-bottom:10px">
            <div style="font-size:12px;font-weight:600;color:var(--amber);margin-bottom:12px">⚡ Temporary Recipient (staff only)</div>
            <!-- Row 1: First name / Last name / Type -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px">
              <div>
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);display:block;margin-bottom:4px">First Name *</label>
                <input type="text" id="tmp-fname-${i}" placeholder="Jane"
                  oninput="tmpCheckName(${i})"
                  style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
              </div>
              <div id="tmp-lname-wrap-${i}">
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);display:block;margin-bottom:4px">Last Name *</label>
                <input type="text" id="tmp-lname-${i}" placeholder="Smith"
                  oninput="tmpCheckName(${i})"
                  style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
              </div>
              <div>
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);display:block;margin-bottom:4px">Type</label>
                <select id="tmp-type-${i}" onchange="tmpTypeChange(${i})"
                  style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
                  <option value="individual">Individual</option>
                  <option value="company">Company</option>
                </select>
              </div>
            </div>
            <!-- Row 2: Language / Notes -->
            <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;margin-bottom:10px">
              <div>
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);display:block;margin-bottom:4px">Language</label>
                <select id="tmp-lang-${i}" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
                  <option value="en">English</option>
                  <option value="fr">Français</option>
                </select>
              </div>
              <div>
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);display:block;margin-bottom:4px">Notes <span style="color:var(--ink-4);text-transform:none;letter-spacing:0">(optional)</span></label>
                <input type="text" id="tmp-notes-${i}" placeholder="e.g. Guest, courier, etc."
                  style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
              </div>
            </div>
            <!-- Name hint -->
            <div id="tmp-hint-${i}" style="display:none;font-size:11px;color:var(--red);margin-bottom:8px">Please enter both first and last name.</div>
            <!-- Actions -->
            <div style="display:flex;gap:6px">
              <button class="btn btn-primary btn-sm" onclick="submitAddTempRecipient('${pc.planCardId}',${i})">Add</button>
              <button class="btn btn-secondary btn-sm" onclick="qs('add-temp-${i}').style.display='none';tmpReset(${i})">Cancel</button>
            </div>
          </div>

          ${(() => {
            if (recs.length === 0) return '<div style="font-size:12px;color:var(--ink-4);padding:8px 0">No recipients on file.</div>';
            const regRecs  = recs.filter(r => !(r.notes && r.notes.startsWith('TEMP:')));
            const tempRecs = recs.filter(r =>   r.notes && r.notes.startsWith('TEMP:'));
            const renderRec = r => {
              const safeId   = encodeURIComponent(r.recipientId);
              const safeName = encodeURIComponent(r.name||'');
              const isTemp   = r.notes && r.notes.startsWith('TEMP:');
              const hasMailLogged = r.hasMailLogged === 'TRUE' || r.hasMailLogged === true;
              return `
              <div class="rec-row" id="rec-row-${r.recipientId}">
                <div style="width:30px;height:30px;border-radius:50%;background:${isTemp?'var(--amber-bg)':'var(--bg-2)'};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;flex-shrink:0;color:${isTemp?'var(--amber)':'inherit'}">${isTemp?'T':(r.name||'?')[0].toUpperCase()}</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:500;display:flex;align-items:center;gap:6px">
                    ${r.name}
                    ${isTemp ? `<span style="font-size:10px;background:var(--amber-bg);color:var(--amber);padding:1px 6px;border-radius:8px;font-weight:600">TEMP</span>` : ''}
                    ${hasMailLogged ? `<span style="font-size:10px;color:var(--ink-4)">· has mail</span>` : ''}
                  </div>
                  <div style="font-size:11px;color:var(--ink-4)">${r.type||'individual'}</div>
                </div>
                <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
                  <span class="pill ${r.status==='active'?'scanned':r.status==='inactive'?'void':'stored'}" style="font-size:10px;${r.status==='inactive'?'opacity:0.6':''}">${r.status==='inactive'?'⊘ Inactive':r.status}</span>
                  <button class="btn btn-secondary btn-sm" 
                      style="color:${r.status==='inactive'?'var(--green)':'var(--red)'}"
                      onclick="${r.status==='inactive'?'reactivateRecipient':'deactivateRecipient'}('${safeId}','${safeName}')">
                      ${r.status==='inactive'?'Re-activate':'Deactivate'}
                    </button>
                </div>
              </div>`;
            };
            return [
              regRecs.length > 0 ? regRecs.map(renderRec).join('') : '',
              tempRecs.length > 0 ? `
                <div style="margin-top:12px;padding-top:10px;border-top:1px dashed var(--border)">
                  <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--amber);margin-bottom:6px">⚡ Temporary Recipients</div>
                  ${tempRecs.map(renderRec).join('')}
                </div>` : ''
            ].join('');
          })()}
        </div>
      </div>`;
  }).join('');
}

function openAddTempRecipient(planCardId, i) {
  const wrap = qs('add-temp-' + i);
  if (wrap) wrap.style.display = wrap.style.display === 'none' ? 'block' : 'none';
}

async function submitAddTempRecipient(planCardId, i) {
  const fnameEl = document.getElementById('tmp-fname-' + i);
  const lnameEl = document.getElementById('tmp-lname-' + i);
  const typeEl  = document.getElementById('tmp-type-'  + i);
  const langEl  = document.getElementById('tmp-lang-'  + i);
  const notesEl = document.getElementById('tmp-notes-' + i);
  const hintEl  = document.getElementById('tmp-hint-'  + i);
  const type    = typeEl ? typeEl.value : 'individual';
  const fname   = fnameEl ? fnameEl.value.trim() : '';
  const lname   = lnameEl ? lnameEl.value.trim() : '';
  const name    = type === 'company' ? fname : [fname, lname].filter(Boolean).join(' ');

  if (!fname) { toast('First name is required.', 'error'); if (fnameEl) fnameEl.focus(); return; }
  if (type === 'individual' && !lname) {
    if (hintEl) hintEl.style.display = 'block';
    toast('Please enter both first and last name.', 'error');
    if (lnameEl) lnameEl.focus();
    return;
  }
  if (hintEl) hintEl.style.display = 'none';

  try {
    const result = await apiPost({
      action:     'addTempRecipient',
      uuid:       STATE.uuid,
      planCardId,
      name,
      type,
      language:   langEl ? langEl.value : 'en',
      notes:      notesEl ? notesEl.value.trim() : ''
    });
    if (result.status === 'ok') {
      toast('Temporary recipient added', 'success');
      qs('add-temp-' + i).style.display = 'none';
      tmpReset(i);
      await loadPlanCardsView();
    } else throw new Error(result.message || 'Failed');
  } catch(err) { toast(err.message, 'error'); }
}

function tmpTypeChange(i) {
  const typeEl  = document.getElementById('tmp-type-'  + i);
  const lWrap   = document.getElementById('tmp-lname-wrap-' + i);
  const lEl     = document.getElementById('tmp-lname-' + i);
  const fnLabel = document.querySelector('#add-temp-' + i + ' label');
  const isComp  = typeEl && typeEl.value === 'company';
  if (lWrap) lWrap.style.display = isComp ? 'none' : '';
  // Update first name label and placeholder
  const fEl = document.getElementById('tmp-fname-' + i);
  if (fEl) fEl.placeholder = isComp ? 'Company name' : 'Jane';
  // Clear last name if switching to company
  if (isComp && lEl) lEl.value = '';
}

function tmpCheckName(i) {
  const typeEl  = document.getElementById('tmp-type-' + i);
  const fnEl    = document.getElementById('tmp-fname-' + i);
  const lnEl    = document.getElementById('tmp-lname-' + i);
  const hintEl  = document.getElementById('tmp-hint-'  + i);
  if (!hintEl) return;
  const isInd = !typeEl || typeEl.value === 'individual';
  const fn = fnEl ? fnEl.value.trim() : '';
  const ln = lnEl ? lnEl.value.trim() : '';
  hintEl.style.display = (isInd && fn.length > 0 && !ln) ? 'block' : 'none';
}

function tmpReset(i) {
  ['tmp-fname-','tmp-lname-','tmp-notes-'].forEach(p => {
    const el = document.getElementById(p + i);
    if (el) el.value = '';
  });
  const typeEl = document.getElementById('tmp-type-' + i);
  if (typeEl) typeEl.value = 'individual';
  const langEl = document.getElementById('tmp-lang-' + i);
  if (langEl) langEl.value = 'en';
  const hintEl = document.getElementById('tmp-hint-' + i);
  if (hintEl) hintEl.style.display = 'none';
  const lWrap = document.getElementById('tmp-lname-wrap-' + i);
  if (lWrap) lWrap.style.display = '';
}


function togglePcCard(i) {
  const body=qs('pc-body-'+i), chevron=qs('pc-chevron-'+i), header=qs('pc-hdr-'+i);
  if (!body) return;
  const open = body.style.display==='none';
  body.style.display=open?'block':'none';
  if (chevron) chevron.textContent=open?'▾':'▸';
  if (header)  header.classList.toggle('open',open);
}

function openEditRecipient(recipientId, name, companyName) {
  const editDiv = qs('rec-edit-'+recipientId);
  if (!editDiv) return;
  const isOpen = editDiv.style.display!=='none';
  editDiv.style.display = isOpen?'none':'block';
  if (!isOpen) {
    const nameEl=qs('re-name-'+recipientId), akaEl=qs('re-aka-'+recipientId);
    if (nameEl) nameEl.value=decodeURIComponent(name||'');
    if (akaEl)  akaEl.value=decodeURIComponent(companyName||'');
  }
}

async function saveRecipientEdit(recipientId) {
  const nameEl=qs('re-name-'+recipientId), akaEl=qs('re-aka-'+recipientId), typeEl=qs('re-type-'+recipientId);
  if (!nameEl||!nameEl.value.trim()) { toast('Name is required','error'); return; }
  try {
    const result = await apiPost({ action:'updateRecipient', uuid:STATE.uuid, recipientId, name:nameEl.value.trim(), companyName:akaEl?akaEl.value.trim():'', type:typeEl?typeEl.value:'individual' });
    if (result.status==='ok') {
      toast('Recipient updated','success');
      const d=qs('rec-display-'+recipientId);
      if (d) d.innerHTML=`<div style="font-size:13px;font-weight:500">${nameEl.value.trim()}</div><div style="font-size:11px;color:var(--ink-4)">${akaEl?akaEl.value.trim():''} · ${typeEl?typeEl.value:'individual'}</div>`;
      qs('rec-edit-'+recipientId).style.display='none';
    } else throw new Error(result.message||'Failed');
  } catch(err) { toast(err.message,'error'); }
}

async function deactivateRecipient(recipientId, name) {
  if (!confirm('Deactivate '+decodeURIComponent(name)+'? They will be marked inactive and cannot be selected when logging mail.')) return;
  await _setRecipientStatus(recipientId, 'inactive');
}

async function reactivateRecipient(recipientId, name) {
  if (!confirm('Re-activate '+decodeURIComponent(name)+'?')) return;
  await _setRecipientStatus(recipientId, 'active');
}

async function _setRecipientStatus(recipientId, status) {
  try {
    const result = await apiPost({ action:'updateRecipientStatus', uuid:STATE.uuid, recipientId, status });
    if (result.status==='ok') {
      toast(status === 'active' ? 'Recipient re-activated' : 'Recipient deactivated', 'success');
      await loadPlanCardsView();
    } else throw new Error(result.message||'Failed');
  } catch(err) { toast(err.message,'error'); }
}

// ── Edit Mail Item ────────────────────────────────────────
let _editTarget = null;

async function openEditMailModal(mailIdEnc) {
  const mailId = decodeURIComponent(mailIdEnc);
  // Find item in cache
  const item = (_allStaffMail || []).find(m => m.mailId === mailId);
  if (!item) { toast('Item not found in current view — refresh first', 'error'); return; }
  _editTarget = item;

  // Remove any existing modal
  const existing = document.getElementById('edit-mail-modal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'edit-mail-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);width:100%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-md)">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:600;font-size:15px">Edit Mail Item — ${item.mailId}</div>
        <button onclick="document.getElementById('edit-mail-modal').remove()" style="background:none;font-size:18px;color:var(--ink-4)">✕</button>
      </div>
      <div style="padding:20px;display:flex;flex-direction:column;gap:14px">
        <div style="font-size:11px;color:var(--ink-4);background:var(--bg);padding:6px 10px;border-radius:var(--radius-sm)">
          📅 Logged: ${fmtDateTime(item.loggedAt)} by ${item.loggedBy || '—'} &nbsp;·&nbsp; Editing does not change the log date.
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Sender Name</label>
            <input id="em-sender" type="text" value="${item.senderName||''}" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
          </div>
          <div>
            <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Type</label>
            <select id="em-type" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
              <option value="letter" ${item.type==='letter'?'selected':''}>✉️ Mail / Letter</option>
              <option value="parcel" ${item.type==='parcel'?'selected':''}>📦 Parcel / Package</option>
            </select>
          </div>
          <div>
            <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Physical Location</label>
            <input id="em-location" type="text" value="${item.physicalLocation||''}" placeholder="e.g. Shelf A3" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
          </div>
          <div>
            <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Scan URL</label>
            <input id="em-scan" type="text" value="${item.scanImageUrl||''}" placeholder="https://..." style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
          </div>
        </div>

        <!-- Confidential toggle in edit -->
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg);border-radius:var(--radius-sm);border:1px solid var(--border)">
          <div>
            <div style="font-size:13px;font-weight:500">Confidential</div>
            <div style="font-size:11px;color:var(--ink-4)">Blocks scan &amp; forwarding — pickup only</div>
          </div>
          <div class="toggle ${item.confidential==='TRUE'||item.confidential===true?'on':''}" id="em-confidential" onclick="this.classList.toggle('on')"></div>
        </div>

        <!-- Special Case toggle in edit -->
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg);border-radius:var(--radius-sm);border:1px solid var(--border)">
          <div>
            <div style="font-size:13px;font-weight:500">Special Case</div>
            <div style="font-size:11px;color:var(--ink-4)">Mark as unmatched — clears recipient assignment</div>
          </div>
          <div class="toggle ${item.specialCase==='TRUE'||item.specialCase===true?'on':''}" id="em-special-case" onclick="onEditSpecialCaseToggle()"></div>
        </div>
        <div id="em-spec-name-wrap" style="display:${item.specialCase==='TRUE'||item.specialCase===true?'block':'none'};margin-top:4px">
          <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Name on Envelope / Package</label>
          <input id="em-spec-name" type="text" value="${item.recipientName||''}" placeholder="Name as it appears on mail"
            style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
        </div>

        <div>
          <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Note to Client</label>
          <textarea id="em-note-client" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px;resize:vertical;min-height:60px">${item.noteToClient||''}</textarea>
        </div>
        <div>
          <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Internal Note</label>
          <textarea id="em-note-internal" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px;resize:vertical;min-height:60px">${item.noteInternal||''}</textarea>
        </div>

        <div style="padding-top:8px;border-top:1px solid var(--border)">
          <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);margin-bottom:8px">Change Recipient</div>
          <div class="form-group recipient-search-wrap" style="margin:0">
            <input type="text" id="em-rec-search" placeholder="Search to change recipient…"
              style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px"
              oninput="searchEditRecipient(this.value)">
            <div id="em-rec-results" class="recipient-results" style="display:none"></div>
          </div>
          <div id="em-rec-current" style="font-size:12px;color:var(--ink-3);margin-top:6px">
            Current: <strong>${item.recipientName || '(none)'}</strong>
          </div>
        </div>

        <div style="display:flex;gap:8px;padding-top:4px">
          <button class="btn btn-primary" style="flex:1" onclick="saveEditMail()">Save Changes</button>
          <button class="btn btn-secondary" onclick="document.getElementById('edit-mail-modal').remove()">Cancel</button>
        </div>
      </div>
    </div>`;
  document.body.appendChild(modal);
}

function onEditSpecialCaseToggle() {
  const tog = document.getElementById('em-special-case');
  if (!tog) return;
  tog.classList.toggle('on');
  const isOn = tog.classList.contains('on');
  const nameWrap = document.getElementById('em-spec-name-wrap');
  if (nameWrap) nameWrap.style.display = isOn ? 'block' : 'none';
  if (isOn) {
    const cur = document.getElementById('em-rec-current');
    if (cur) cur.innerHTML = '<span style="color:var(--amber)">⚠ Special case — recipient will be cleared on save</span>';
    _editRecipient = null;
  }
}

let _editRecipient = null;

function searchEditRecipient(query) {
  if (!query || query.length < 2) { qs('em-rec-results').style.display='none'; return; }
  const q = query.toLowerCase();
  const hits = (_recipientCache || []).filter(r =>
    [r.name, r.companyName, r.planCardId, r.planName].join(' ').toLowerCase().includes(q)
  ).slice(0, 6);
  const el = qs('em-rec-results');
  if (!hits.length) { el.style.display='block'; el.innerHTML='<div class="recipient-result-item" style="color:var(--ink-4)">No matches</div>'; return; }
  el.style.display = 'block';
  el.innerHTML = hits.map(r => {
    const payload = JSON.stringify(r).replace(/"/g,'&quot;');
    return `<div class="recipient-result-item" onclick="selectEditRecipient(${payload})">
      <div class="rri-name">${r.name}</div>
      <div class="rri-sub" style="font-size:10px">${r.planName||r.planCardId}</div>
    </div>`;
  }).join('');
}

function selectEditRecipient(data) {
  _editRecipient = data;
  const el = qs('em-rec-search');
  if (el) el.value = data.name;
  const cur = qs('em-rec-current');
  if (cur) cur.innerHTML = `Current: <strong>${(_editTarget||{}).recipientName||'(none)'}</strong> → <strong style="color:var(--green)">${data.name}</strong>`;
  const res = qs('em-rec-results');
  if (res) res.style.display = 'none';
}

async function saveEditMail() {
  if (!_editTarget) return;
  const emConf = qs('em-confidential');
  const emSpec = qs('em-special-case');
  const isConf = emConf && emConf.classList.contains('on');
  const isSpec = emSpec && emSpec.classList.contains('on');
  const updates = {
    action:           'editMailItem',
    uuid:             STATE.uuid,
    mailId:           _editTarget.mailId,
    senderName:       qs('em-sender')?.value?.trim()        || _editTarget.senderName || '',
    type:             qs('em-type')?.value                  || _editTarget.type,
    physicalLocation: qs('em-location')?.value?.trim()      || '',
    scanImageUrl:     qs('em-scan')?.value?.trim()          || '',
    noteToClient:     qs('em-note-client')?.value?.trim()   || '',
    noteInternal:     qs('em-note-internal')?.value?.trim() || '',
    confidential:     isConf ? 'TRUE' : 'FALSE',
    specialCase:      isSpec ? 'TRUE' : 'FALSE'
  };
  // If special case toggled ON, clear recipient
  if (isSpec) {
    updates.recipientId    = '';
    updates.recipientName  = qs('em-spec-name')?.value?.trim() || 'SPECIAL CASE';
    updates.planCardId     = '';
    updates.clientId       = '';
    updates.subscriptionId = '';
  }
  if (_editRecipient) {
    updates.recipientId    = _editRecipient.recipientId;
    updates.recipientName  = _editRecipient.name;
    updates.planCardId     = _editRecipient.planCardId;
    updates.clientId       = _editRecipient.clientId;
    updates.subscriptionId = _editRecipient.subscriptionId;
  }
  try {
    const result = await apiPost(updates);
    if (result.status === 'ok') {
      toast('Mail item updated', 'success');
      document.getElementById('edit-mail-modal')?.remove();
      _editTarget = null; _editRecipient = null;
      await loadStaffMailLog();
    } else throw new Error(result.message || 'Failed');
  } catch(e) { toast(e.message, 'error'); }
}

// ── Delete Mail Item ──────────────────────────────────────
async function confirmDeleteMail(mailIdEnc, recipNameEnc) {
  const mailId    = decodeURIComponent(mailIdEnc);
  const recipName = decodeURIComponent(recipNameEnc);
  const pin = prompt(`⚠️ Delete mail item for "${recipName}"?\n\nThis cannot be undone. Enter staff PIN to confirm:`);
  if (pin === null) return;
  if (pin !== '1234') { toast('Incorrect PIN — deletion cancelled', 'error'); return; }
  try {
    const result = await apiPost({ action: 'deleteMailItem', uuid: STATE.uuid, mailId, pin });
    if (result.status === 'ok') {
      toast('Mail item deleted', 'success');
      await loadStaffMailLog();
    } else throw new Error(result.message || 'Failed');
  } catch(e) { toast(e.message, 'error'); }
}

// ── Refresh Plan Cards (staff) ────────────────────────────
async function refreshPlanCardsView() {
  toast('Refreshing…', 'success');
  await loadPlanCardsView();
}



// ── Init ─────────────────────────────────────────────────
boot();
</script>
</body>
</html>
