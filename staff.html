<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YYZ Offices â€” Staff Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Serif+Display&display=swap" rel="stylesheet">
<style>
  /* â”€â”€ THEME CONFIG (changeable from staff panel later) â”€â”€â”€â”€ */
  :root {
    --theme:      #8B1A1A;

    --red:        #8B1A1A;
    --red-light:  #A52020;
    --red-dim:    rgba(139,26,26,0.08);
    --red-border: rgba(139,26,26,0.18);
    --ink:        #1A1A1F;
    --ink-2:      #3D3D45;
    --ink-3:      #72727D;
    --ink-4:      #A8A8B0;
    --bg:         #F7F6F4;
    --bg-2:       #EFEDE9;
    --white:      #FFFFFF;
    --border:     #E2E0DB;
    --shadow:     0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md:  0 4px 12px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.04);
    --radius:     10px;
    --radius-sm:  6px;
    --green:      #1A6B3C;
    --green-bg:   #E8F5EE;
    --amber:      #92520A;
    --amber-bg:   #FEF3E2;
    --blue:       #1A4A7A;
    --blue-bg:    #E8F0FA;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--ink);
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }
  button { font-family: inherit; cursor: pointer; border: none; outline: none; }
  input, select, textarea { font-family: inherit; outline: none; }

  /* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #loading-screen {
    position: fixed; inset: 0;
    background: var(--white);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 16px; z-index: 9999;
    transition: opacity 0.4s ease;
  }
  #loading-screen.fade-out { opacity: 0; pointer-events: none; }
  .loading-logo { font-family: 'DM Serif Display', serif; font-size: 22px; color: var(--ink); }
  .loading-logo span { color: var(--red); }
  .loading-sub { font-size: 12px; color: var(--ink-4); }
  .loading-bar { width: 120px; height: 2px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .loading-bar-fill { height: 100%; width: 0; background: var(--red); border-radius: 2px; animation: loadBar 1s ease forwards; }
  @keyframes loadBar { to { width: 100%; } }
  @keyframes spinBtn { to { transform: rotate(360deg); } }
  .spin-active { animation: spinBtn 0.7s linear infinite; display:inline-block; }

  /* â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #app { display: none; flex-direction: column; height: 100vh; overflow: hidden; }
  .workspace { flex: 1; overflow: hidden; }
  #app.visible { display: flex; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* â”€â”€ Header (single unified bar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .topbar {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    padding: 0 20px;
    height: 54px;
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0; z-index: 100; gap: 16px;
  }
  .topbar-left { display: flex; align-items: center; gap: 14px; flex-shrink: 0; }
  .header-logo { display: flex; align-items: center; }
  .header-divider {
    width: 1px; height: 20px; background: var(--border); flex-shrink: 0;
  }
  .staff-badge {
    background: var(--red-dim); color: var(--red);
    font-size: 9px; font-weight: 700; letter-spacing: 0.08em;
    text-transform: uppercase; padding: 3px 8px; border-radius: 20px;
    flex-shrink: 0;
  }
  .staff-name {
    font-size: 12px; color: var(--ink-3);
    display: flex; align-items: center; gap: 8px; flex-shrink: 0;
  }
  .staff-name strong { color: var(--ink); font-weight: 600; }
  .staff-name .role-tag { font-size: 11px; color: var(--ink-4); }
  .staff-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    background: var(--red-dim); color: var(--red);
    font-size: 11px; font-weight: 700;
    display: inline-flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  /* â”€â”€ Centre pill nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main-nav {
    flex: 1;
    display: flex; align-items: center; justify-content: center;
    gap: 2px;
  }
  .nav-group {
    display: flex; align-items: center; gap: 2px;
    background: var(--bg-2);
    border-radius: 8px;
    padding: 3px;
  }
  .nav-btn {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 6px 12px;
    font-size: 12px; font-weight: 500; color: var(--ink-3);
    cursor: pointer; transition: all 0.15s;
    background: transparent; border: none; border-radius: 6px;
    white-space: nowrap; font-family: inherit;
  }
  .nav-btn:hover { background: rgba(255,255,255,0.7); color: var(--ink); }
  .nav-btn.active {
    background: var(--white); color: var(--ink); font-weight: 600;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
  }
  .nav-btn svg { opacity: 0.45; flex-shrink: 0; transition: opacity 0.15s; }
  .nav-btn:hover svg, .nav-btn.active svg { opacity: 0.9; }

  /* Mail toggle â€” sliding pill switch */
  .mail-toggle {
    display: flex; align-items: center;
    background: var(--bg-2);
    border-radius: 8px;
    padding: 3px;
    position: relative;
    margin-left: 4px;
  }
  .mail-toggle-slider {
    position: absolute;
    height: calc(100% - 6px);
    width: calc(50% - 3px);
    top: 3px;
    left: 3px;
    border-radius: 6px;
    transition: left 0.25s cubic-bezier(0.4, 0, 0.2, 1), background 0.25s;
    pointer-events: none;
    z-index: 0;
  }
  .mail-toggle-slider.pos-left {
    left: 3px;
    background: var(--white);
    box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
  }
  .mail-toggle-slider.pos-right {
    left: calc(50%);
    background: var(--red);
    box-shadow: 0 1px 4px rgba(139,26,26,0.3);
  }
  .mail-toggle-btn {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 6px 14px;
    font-size: 12px; font-weight: 500; color: var(--ink-3);
    cursor: pointer; transition: color 0.2s, font-weight 0.2s;
    background: transparent; border: none; border-radius: 6px;
    white-space: nowrap; font-family: inherit;
    position: relative; z-index: 1;
  }
  .mail-toggle-btn svg { opacity: 0.45; flex-shrink: 0; transition: opacity 0.2s; }
  .mail-toggle-btn.active { font-weight: 600; }
  .mail-toggle-btn.active svg { opacity: 0.9; }
  .mail-toggle-btn.active-maillog { color: var(--ink); }
  .mail-toggle-btn.active-log { color: #fff; }

  /* Mail type toggle (Log Mail form) */
  .mail-type-toggle {
    display: inline-flex; align-items: center;
    background: var(--bg-2); border-radius: 8px; padding: 3px;
    position: relative;
  }
  .mail-type-slider {
    position: absolute; height: calc(100% - 6px); width: calc(50% - 3px);
    top: 3px; left: 3px; border-radius: 6px;
    background: var(--white); box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    transition: left 0.25s cubic-bezier(0.4, 0, 0.2, 1), background 0.25s;
    pointer-events: none; z-index: 0;
  }
  .mail-type-slider.parcel {
    left: calc(50%);
    background: var(--amber-bg); border: 1px solid #FFE082;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  }
  .mail-type-btn {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 5px 16px; font-size: 12px; font-weight: 500;
    color: var(--ink-3); cursor: pointer;
    background: transparent; border: none; border-radius: 6px;
    font-family: inherit; position: relative; z-index: 1;
    transition: color 0.2s, font-weight 0.2s; white-space: nowrap;
  }
  .mail-type-btn.active { font-weight: 600; color: var(--ink); }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .workspace {
    flex: 1; display: flex; overflow: hidden;
  }

  /* â”€â”€ Split View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .pane {
    display: flex; flex-direction: column;
    overflow: hidden;
  }
  .pane-left {
    width: 420px; flex-shrink: 0;
    border-right: 1px solid var(--border);
    background: var(--white);
  }
  .pane-right {
    flex: 1; background: var(--bg);
    overflow-y: auto;
  }

  /* Full views */
  .pane-full {
    flex: 1; overflow-y: auto;
    background: var(--bg);
    padding: 24px 28px;
  }

  /* â”€â”€ Pane Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .pane-header {
    padding: 14px 16px 12px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    flex-shrink: 0;
  }
  .pane-title {
    font-size: 12px; font-weight: 600; color: var(--ink-2);
    text-transform: uppercase; letter-spacing: 0.06em;
  }
  .pane-count {
    background: var(--red-dim); color: var(--red);
    font-size: 11px; font-weight: 600;
    padding: 1px 7px; border-radius: 20px;
  }
  .pane-count.green { background: var(--green-bg); color: var(--green); }

  /* â”€â”€ Task List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .task-list { overflow-y: auto; flex: 1; }
  .task-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
    position: relative;
  }
  .task-item:hover { background: var(--bg); }
  .task-item.selected { background: #FEF5F5; }
  .task-item::before {
    content: '';
    position: absolute; left: 0; top: 0; bottom: 0;
    width: 3px;
  }
  .task-item.pri-high::before   { background: var(--red); }
  .task-item.pri-medium::before { background: #D97706; }
  .task-item.pri-low::before    { background: var(--ink-4); }
  .task-item.overdue { background: #FFF8F8; }

  .task-top {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 4px;
  }
  .task-type {
    font-size: 12px; font-weight: 600; color: var(--ink);
    display: flex; align-items: center; gap: 6px;
  }
  .task-type-icon { font-size: 14px; }
  .task-right { display: flex; align-items: center; gap: 6px; }
  .task-due {
    font-size: 10px; color: var(--ink-4);
  }
  .task-due.overdue { color: var(--red); font-weight: 600; }
  .task-notes {
    font-size: 12px; color: var(--ink-3);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 100%;
  }
  .task-client {
    font-size: 11px; color: var(--ink-4); margin-top: 2px;
  }

  .pill {
    display: inline-flex; align-items: center;
    padding: 1px 7px; border-radius: 20px;
    font-size: 10px; font-weight: 600; white-space: nowrap;
  }
  .pill.high   { background: #FEE8E8; color: var(--red); }
  .pill.medium { background: var(--amber-bg); color: var(--amber); }
  .pill.low    { background: #F0F0F5; color: var(--ink-3); }
  .pill.overdue { background: #FEE8E8; color: var(--red); }
  .pill.done   { background: var(--green-bg); color: var(--green); }
  .pill.arrived     { background: var(--blue-bg); color: var(--blue); }
  .pill.scanned     { background: var(--green-bg); color: var(--green); }
  .pill.stored      { background: var(--amber-bg); color: var(--amber); }
  .pill.forwarded   { background: var(--green-bg); color: var(--green); }
  .pill.picked_up   { background: #F0F0F5; color: var(--ink-3); }
  .pill.active-plan { background: var(--green-bg); color: var(--green); }

  /* â”€â”€ Task Detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .task-detail {
    padding: 20px;
    display: flex; flex-direction: column; gap: 16px;
  }
  .detail-header { }
  .detail-type {
    font-size: 11px; font-weight: 600; color: var(--red);
    text-transform: uppercase; letter-spacing: 0.07em;
    margin-bottom: 6px;
  }
  .detail-title {
    font-family: 'DM Serif Display', serif;
    font-size: 20px; color: var(--ink); margin-bottom: 4px;
  }
  .detail-sub { font-size: 13px; color: var(--ink-3); }
  .detail-card {
    background: var(--white); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px;
    box-shadow: var(--shadow);
  }
  .detail-row {
    display: flex; justify-content: space-between;
    padding: 7px 0; border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .detail-row:last-child { border-bottom: none; }
  .detail-row label { color: var(--ink-3); font-size: 12px; }
  .detail-row value { font-weight: 500; color: var(--ink); }

  /* â”€â”€ Resolve Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .resolve-form { }
  .resolve-textarea {
    width: 100%; padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--white);
    color: var(--ink); font-size: 13px;
    resize: vertical; min-height: 80px;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .resolve-textarea:focus {
    border-color: var(--red);
    box-shadow: 0 0 0 3px var(--red-dim);
    outline: none;
  }
  .resolve-actions { display: flex; gap: 8px; margin-top: 10px; }

  /* â”€â”€ Log Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .log-form-wrap { padding: 16px; overflow-y: auto; flex: 1; }
  .form-group { margin-bottom: 14px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  label {
    display: block; font-size: 11px; font-weight: 500;
    color: var(--ink-3); margin-bottom: 4px;
    text-transform: uppercase; letter-spacing: 0.05em;
  }
  input[type=text], input[type=email], select, textarea {
    width: 100%; padding: 8px 11px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: var(--white);
    color: var(--ink); font-size: 13px;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--red);
    box-shadow: 0 0 0 3px var(--red-dim);
  }
  input::placeholder, textarea::placeholder { color: var(--ink-4); }
  textarea { resize: vertical; min-height: 60px; }

  /* Search recipient */
  .recipient-search-wrap { position: relative; }
  .recipient-results {
    position: absolute; top: 100%; left: 0; right: 0;
    background: var(--white); border: 1px solid var(--border);
    border-radius: var(--radius-sm); box-shadow: var(--shadow-md);
    z-index: 200; max-height: 200px; overflow-y: auto;
  }
  .recipient-result-item {
    padding: 10px 12px; cursor: pointer;
    border-bottom: 1px solid var(--border);
    font-size: 13px; transition: background 0.1s;
  }
  .recipient-result-item:hover { background: var(--bg); }
  .recipient-result-item:last-child { border-bottom: none; }
  .rri-name { font-weight: 500; }
  .rri-sub  { font-size: 11px; color: var(--ink-4); margin-top: 1px; }

  /* â”€â”€ Suggest dropdowns & chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .suggest-dropdown {
    position: absolute; top: 100%; left: 0; right: 0;
    background: var(--white); border: 1px solid var(--border);
    border-radius: var(--radius-sm); box-shadow: var(--shadow-md);
    z-index: 150; max-height: 160px; overflow-y: auto;
  }
  .suggest-item {
    padding: 7px 12px; cursor: pointer; font-size: 12px;
    border-bottom: 1px solid var(--border); transition: background 0.1s;
  }
  .suggest-item:hover { background: var(--bg); }
  .suggest-item:last-child { border-bottom: none; }
  .suggest-chips {
    display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px;
  }
  .suggest-chips .chip, .suggest-chips .qnote-chip {
    font-size: 10px; padding: 3px 8px; border-radius: 12px;
    cursor: pointer; transition: all 0.15s; font-family: inherit;
    border: 1px solid var(--border); background: var(--white); color: var(--ink-3);
    white-space: nowrap;
  }
  .suggest-chips .chip:hover { background: var(--bg); border-color: var(--ink-3); color: var(--ink); }
  .suggest-chips .qnote-chip { background: var(--bg); }
  .suggest-chips .qnote-chip:hover { background: var(--white); border-color: var(--ink-3); color: var(--ink); }

  /* â”€â”€ Scan mode toggle & drop zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .scan-mode-toggle {
    display: inline-flex; border: 1px solid var(--border); border-radius: 6px; overflow: hidden;
  }
  .scan-mode-btn {
    padding: 4px 12px; font-size: 11px; font-weight: 500; font-family: inherit;
    border: none; background: var(--white); color: var(--ink-3); cursor: pointer;
    transition: all 0.15s;
  }
  .scan-mode-btn:not(:last-child) { border-right: 1px solid var(--border); }
  .scan-mode-btn.active { background: var(--ink); color: #fff; }
  .scan-mode-btn:hover:not(.active) { background: var(--bg); }
  .scan-drop-zone {
    border: 2px dashed var(--border); border-radius: var(--radius-sm);
    padding: 16px; text-align: center; cursor: pointer;
    transition: all 0.2s; display: flex; flex-direction: column;
    align-items: center; gap: 4px;
  }
  .scan-drop-zone:hover, .scan-drop-zone.dragover {
    border-color: var(--blue); background: var(--blue-bg);
  }
  .scan-file-info {
    display: flex; align-items: center; gap: 8px; padding: 8px 0;
    font-size: 12px;
  }
  .scan-file-info .file-name { font-weight: 500; color: var(--ink); }
  .scan-file-info .file-size { color: var(--ink-4); }
  .scan-file-info .remove-btn {
    margin-left: auto; color: var(--red); cursor: pointer;
    background: none; border: none; font-size: 13px; font-family: inherit;
  }
  .expiry-chip {
    font-size: 10px; padding: 3px 10px; border-radius: 12px;
    border: 1px solid var(--border); background: var(--white); color: var(--ink-3);
    cursor: pointer; font-family: inherit; transition: all 0.15s;
  }
  .expiry-chip:hover { border-color: var(--ink-3); color: var(--ink); }
  .expiry-chip.active { background: var(--ink); color: #fff; border-color: var(--ink); }

  /* â”€â”€ Inline toggle buttons (Confidential/Special) â”€â”€â”€â”€ */
  .inline-tog {
    font-size: 11px; padding: 6px 10px; border-radius: 6px;
    border: 1px solid var(--border); background: var(--white); color: var(--ink-3);
    cursor: pointer; font-family: inherit; transition: all 0.15s;
    white-space: nowrap; font-weight: 500;
  }
  .inline-tog:hover { border-color: var(--ink-3); color: var(--ink); }
  .inline-tog.active { background: var(--amber-bg); border-color: #FFB300; color: #E65100; font-weight: 600; }

  /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    gap: 6px; padding: 9px 18px;
    border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 500;
    transition: all 0.15s; cursor: pointer;
  }
  .btn-primary { background: var(--red); color: var(--white); border: 1px solid var(--red); }
  .btn-primary:hover { background: var(--red-light); }
  .btn-secondary { background: var(--white); color: var(--ink); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--bg); }
  .btn-success { background: var(--green); color: var(--white); border: 1px solid var(--green); }
  .btn-danger  { background: #C0392B; color: var(--white); border: 1px solid #C0392B; }
  .btn-sm { padding: 6px 12px; font-size: 12px; }
  .btn-full { width: 100%; }
  .btn:disabled { opacity: 0.45; cursor: not-allowed; }
  .btn-spinner {
    width: 12px; height: 12px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white; border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Empty / Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .empty-pane {
    flex: 1; display: flex; align-items: center; justify-content: center;
    flex-direction: column; gap: 8px;
    color: var(--ink-4); text-align: center; padding: 32px;
  }
  .empty-icon { font-size: 28px; opacity: 0.5; }
  .empty-title { font-size: 13px; font-weight: 500; color: var(--ink-3); }
  .empty-sub   { font-size: 12px; }

  /* â”€â”€ Blocked â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .blocked-screen {
    display: flex; align-items: center; justify-content: center;
    height: 100%; padding: 24px;
  }
  .blocked-card {
    background: var(--white); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 40px 32px;
    max-width: 380px; text-align: center;
    box-shadow: var(--shadow-md);
  }
  .blocked-icon {
    width: 52px; height: 52px; border-radius: 50%;
    background: #FEE8E8; color: var(--red);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px; margin: 0 auto 16px;
  }
  .blocked-title { font-family: 'DM Serif Display', serif; font-size: 18px; margin-bottom: 8px; }
  .blocked-msg { font-size: 13px; color: var(--ink-3); }

  /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
  .toast {
    background: var(--ink); color: var(--white);
    padding: 10px 16px; border-radius: var(--radius-sm);
    font-size: 13px; box-shadow: var(--shadow-md);
    animation: toastIn 0.25s ease;
  }
  .toast.success { background: var(--green); }
  .toast.error   { background: var(--red); }
  @keyframes toastIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

  /* â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .nav-tabs {
    display: flex; border-bottom: 1px solid var(--border);
    padding: 0 16px; background: var(--white); flex-shrink: 0;
  }
  .nav-tab {
    padding: 10px 14px; font-size: 12px; font-weight: 500;
    color: var(--ink-3); cursor: pointer;
    border-bottom: 2px solid transparent; margin-bottom: -1px;
    transition: all 0.15s; white-space: nowrap;
  }
  .nav-tab.active { color: var(--red); border-color: var(--red); }
  .nav-tab:hover:not(.active) { color: var(--ink-2); }

  /* â”€â”€ Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-label {
    font-size: 10px; font-weight: 700; letter-spacing: 0.08em;
    text-transform: uppercase; color: var(--ink-4);
    padding: 10px 16px 6px;
  }

  /* â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .form-divider {
    font-size: 10px; font-weight: 600; color: var(--ink-4);
    text-transform: uppercase; letter-spacing: 0.07em;
    margin: 16px 0 10px;
    padding-bottom: 6px; border-bottom: 1px solid var(--border);
  }

  /* â”€â”€ Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toggle-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px;
  }
  .toggle-label { font-size: 13px; color: var(--ink-2); }
  .toggle {
    width: 36px; height: 20px; border-radius: 20px;
    background: var(--border); position: relative;
    cursor: pointer; transition: background 0.2s; flex-shrink: 0;
  }
  .toggle.on { background: var(--green); }
  .toggle::after {
    content: ''; position: absolute;
    width: 16px; height: 16px; border-radius: 50%;
    background: white; top: 2px; left: 2px;
    transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .toggle.on::after { transform: translateX(16px); }

  /* â”€â”€ Stats bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .stats-mini {
    display: flex; gap: 0;
    border-bottom: 1px solid var(--border);
    background: var(--white); flex-shrink: 0;
  }
  .stat-mini {
    flex: 1; padding: 10px 12px; text-align: center;
    border-right: 1px solid var(--border);
  }
  .stat-mini:last-child { border-right: none; }
  .stat-mini-val {
    font-family: 'DM Serif Display', serif;
    font-size: 20px; color: var(--ink); line-height: 1;
  }
  .stat-mini-val.red { color: var(--red); }
  .stat-mini-val.amber { color: var(--amber); }
  .stat-mini-label { font-size: 10px; color: var(--ink-4); margin-top: 3px; }


  /* â”€â”€ Forwarding/exceptions/plancards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .fwd-item { display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);background:var(--white);transition:background 0.1s; }
  .fwd-item:hover { background:var(--bg); }
  .fwd-checkbox { width:16px;height:16px;cursor:pointer;flex-shrink:0;accent-color:var(--blue); }
  .pc-card { background:var(--white);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:12px;box-shadow:var(--shadow);overflow:hidden; }
  .pc-card-header { padding:12px 16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;border-bottom:1px solid transparent;transition:background 0.1s; }
  .pc-card-header:hover { background:var(--bg); }
  .pc-card-header.open { border-bottom-color:var(--border);background:var(--bg); }
  .pc-card-body { padding:14px 16px; }
  .rec-row { display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px; }
  .rec-row:last-child { border-bottom:none; }
  .exc-item { background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:10px;box-shadow:var(--shadow); }
  .exc-actions { display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap;margin-top:10px; }
  .pill.forwarding_pending { background:#E8F4FF;color:var(--blue); }
  .pill.forwarded { background:var(--green-bg);color:var(--green); }
  .pill.payment_req { background:#FEE8E8;color:var(--red); }
  .pill.warning { background:var(--amber-bg);color:var(--amber); }
  .pill.void { background:#F0F0F5;color:var(--ink-4); }
  .pill.expired { background:#F0F0F5;color:var(--ink-4); }
  @media (max-width: 700px) {
    .pane-left { width: 100%; border-right: none; }
    .workspace { flex-direction: column; }
  }

  /* Refresh animation */
  @keyframes spin { to { transform: rotate(360deg); } }
  .refreshing { animation: spin 0.8s linear infinite; display:inline-block; }
  /* â”€â”€ In-app modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .app-modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center;
    z-index: 9999; animation: fadeIn 0.15s ease;
  }
  @keyframes fadeIn { from { opacity:0 } to { opacity:1 } }
  .app-modal {
    background: var(--white); border-radius: var(--radius);
    box-shadow: 0 8px 32px rgba(0,0,0,0.18); padding: 24px;
    max-width: 420px; width: 90%; animation: slideUp 0.2s ease;
  }
  @keyframes slideUp { from { transform: translateY(12px); opacity:0 } to { transform: translateY(0); opacity:1 } }
  .app-modal-title { font-size: 15px; font-weight: 600; margin-bottom: 8px; color: var(--ink); }
  .app-modal-msg { font-size: 13px; color: var(--ink-3); line-height: 1.5; margin-bottom: 16px; }
  .app-modal input, .app-modal textarea {
    width: 100%; padding: 8px 12px; border: 1px solid var(--border);
    border-radius: var(--radius-sm); font-size: 13px; font-family: inherit;
    margin-bottom: 14px; box-sizing: border-box;
  }
  .app-modal textarea { min-height: 60px; resize: vertical; }
  .app-modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
  .app-modal-actions .btn { min-width: 80px; }
  .app-modal .btn-danger {
    background: #D32F2F; border-color: #D32F2F; color: #fff;
  }
  .app-modal .btn-danger:hover { background: #B71C1C; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="yyz-supabase-adapter.js"></script>
</head>
<body>

<div id="loading-screen">
  <div class="loading-logo">
    <img src="https://yyzoffices.com/wp-content/uploads/2026/02/logo-transparent-png-1-scaled.png"
      alt="YYZ Offices" style="height:52px;width:auto;display:block;margin:0 auto"
      onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
    <span style="display:none">YYZ<span>.</span>Offices</span>
  </div>
  <div class="loading-sub">Staff Portal</div>
  <div class="loading-bar"><div class="loading-bar-fill"></div></div>
</div>

<div id="app">
  <!-- Single unified header bar -->
  <div class="topbar">
    <!-- Left: logo + badge -->
    <div class="topbar-left">
      <div class="header-logo">
        <img src="https://yyzoffices.com/wp-content/uploads/2026/02/logo-transparent-png-scaled.png"
          alt="YYZ Offices" style="height:26px;width:auto;display:block"
          onerror="this.style.display='none';this.nextElementSibling.style.display='inline'">
        <span style="display:none">YYZ<span style="color:var(--red)">.</span>Offices</span>
      </div>
      <div class="header-divider"></div>
      <div class="staff-badge">Staff</div>
    </div>

    <!-- Centre: pill nav group + Log Mail CTA -->
    <nav class="main-nav" id="view-toggle">
      <div class="nav-group">
        <button class="nav-btn" onclick="setView('split')" id="vbtn-split">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="8" height="18" rx="1"/><rect x="13" y="3" width="8" height="18" rx="1"/></svg>
          Split
        </button>
        <button class="nav-btn" onclick="setView('tasks')" id="vbtn-tasks">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
          Tasks
        </button>
        <button class="nav-btn" onclick="setView('exceptions')" id="vbtn-exceptions">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          Exceptions
        </button>
        <button class="nav-btn" onclick="setView('plancards')" id="vbtn-plancards">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
          Plan Cards
        </button>
      </div>

      <div class="mail-toggle" id="mail-toggle">
        <div class="mail-toggle-slider pos-left" id="mail-toggle-slider"></div>
        <button class="mail-toggle-btn active active-maillog" onclick="setView('maillog')" id="vbtn-maillog">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Mail Log
        </button>
        <button class="mail-toggle-btn" onclick="setView('log')" id="vbtn-log">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
          Log Mail
        </button>
      </div>
    </nav>

    <!-- Right: staff identity -->
    <div class="staff-name" id="header-name"></div>
  </div>

  <div id="workspace" class="workspace"></div>
</div>

<div class="toast-container" id="toasts"></div>

<script>

let STATE = {
  recipientsCache: null,
  uuid:         null,
  access:       null,
  tasks:        [],
  selectedTask: null,
  view:         'split',    // split | tasks | log | maillog | exceptions | plancards
  logRecipient: null,
  logPlanCard:  null,
  submitting:   false
};

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function qs(id) { return document.getElementById(id); }

// â”€â”€ In-app modal system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appConfirm({ title, message, confirmLabel, confirmClass, cancelLabel }) {
  return new Promise(resolve => {
    const overlay = document.createElement('div');
    overlay.className = 'app-modal-overlay';
    overlay.innerHTML = `<div class="app-modal">
      <div class="app-modal-title">${title || 'Confirm'}</div>
      <div class="app-modal-msg">${message || 'Are you sure?'}</div>
      <div class="app-modal-actions">
        <button class="btn btn-secondary btn-sm" id="amc-cancel">${cancelLabel || 'Cancel'}</button>
        <button class="btn btn-sm ${confirmClass || 'btn-primary'}" id="amc-ok">${confirmLabel || 'Confirm'}</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
    overlay.querySelector('#amc-ok').focus();
    overlay.querySelector('#amc-ok').onclick = () => { overlay.remove(); resolve(true); };
    overlay.querySelector('#amc-cancel').onclick = () => { overlay.remove(); resolve(false); };
    overlay.addEventListener('click', e => { if (e.target === overlay) { overlay.remove(); resolve(false); } });
  });
}

function appPrompt({ title, message, placeholder, inputType, confirmLabel, confirmClass, cancelLabel, required }) {
  return new Promise(resolve => {
    const isTextarea = inputType === 'textarea';
    const inputHtml = isTextarea
      ? `<textarea id="amp-input" placeholder="${placeholder || ''}" class="app-modal-input"></textarea>`
      : `<input type="${inputType || 'text'}" id="amp-input" placeholder="${placeholder || ''}" class="app-modal-input">`;
    const overlay = document.createElement('div');
    overlay.className = 'app-modal-overlay';
    overlay.innerHTML = `<div class="app-modal">
      <div class="app-modal-title">${title || 'Input'}</div>
      <div class="app-modal-msg">${message || ''}</div>
      ${inputHtml}
      <div class="app-modal-actions">
        <button class="btn btn-secondary btn-sm" id="amp-cancel">${cancelLabel || 'Cancel'}</button>
        <button class="btn btn-sm ${confirmClass || 'btn-primary'}" id="amp-ok">${confirmLabel || 'Submit'}</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
    const inp = overlay.querySelector('#amp-input');
    inp.focus();
    const submit = () => {
      const val = inp.value.trim();
      if (required && !val) { inp.style.borderColor = 'var(--red)'; inp.focus(); return; }
      overlay.remove(); resolve(val);
    };
    overlay.querySelector('#amp-ok').onclick = submit;
    inp.addEventListener('keydown', e => { if (e.key === 'Enter' && !isTextarea) submit(); });
    overlay.querySelector('#amp-cancel').onclick = () => { overlay.remove(); resolve(null); };
    overlay.addEventListener('click', e => { if (e.target === overlay) { overlay.remove(); resolve(null); } });
  });
}

function getUUID() {
  return new URLSearchParams(window.location.search).get('uuid') || null;
}
function fmtDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-CA', { month:'short', day:'numeric', year:'numeric' });
}
function fmtDateTime(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-CA', { month:'short', day:'numeric' }) + ' ' +
         new Date(d).toLocaleTimeString('en-CA', { hour:'numeric', minute:'2-digit' });
}
function daysUntil(d) {
  if (!d) return null;
  return Math.ceil((new Date(d) - new Date()) / (1000*60*60*24));
}
function toast(msg, type='') {
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  el.textContent = msg;
  qs('toasts').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getStaffCache(uuid) {
  try {
    const raw = sessionStorage.getItem('staff_' + uuid);
    if (!raw) return null;
    const { data, ts } = JSON.parse(raw);
    if (Date.now() - ts > 5 * 60 * 1000) { sessionStorage.removeItem('staff_' + uuid); return null; }
    return data;
  } catch(e) { return null; }
}
function setStaffCache(uuid, data) {
  try { sessionStorage.setItem('staff_' + uuid, JSON.stringify({ data, ts: Date.now() })); } catch(e) {}
}

async function boot() {
  STATE.uuid = getUUID();

  if (!STATE.uuid) { hideLoading(); showBlocked('No UUID in URL'); return; }

  // Use cache for instant load on refresh
  const cached = getStaffCache(STATE.uuid);
  if (cached && cached.status === 'staff') {
    STATE.access = cached;
    const _cn = cached.name || 'Staff';
    const _ci = _cn.split(' ').filter(Boolean).slice(0,2).map(w=>w[0]).join('').toUpperCase();
    qs('header-name').innerHTML = `<span class="staff-avatar">${_ci}</span><strong>${_cn}</strong><span style="color:var(--ink-4);font-size:11px">${cached.role}</span>`;
    hideLoading();
    await loadTasks();
    warmRecipientCache(); // pre-warm in background â€” makes first search instant
    setView(STATE.view);
    api('uuid=' + encodeURIComponent(STATE.uuid)).then(f => { if (f && f.status === 'staff') setStaffCache(STATE.uuid, f); }).catch(()=>{});
    return;
  }

  await new Promise(r => setTimeout(r, 600));

  try {
    const data = await api('uuid=' + encodeURIComponent(STATE.uuid));
    STATE.access = data;
    hideLoading();

    if (data.status === 'staff') setStaffCache(STATE.uuid, data);
    if (data.status !== 'staff') {
      showBlocked(data.status === 'client'
        ? 'This portal is for staff only. Please use the client portal.'
        : data.message || 'Access denied.');
      return;
    }

    const _dn = data.name || 'Staff';
    const _di = _dn.split(' ').filter(Boolean).slice(0,2).map(w=>w[0]).join('').toUpperCase();
    qs('header-name').innerHTML = `<span class="staff-avatar">${_di}</span><strong>${_dn}</strong><span style="color:var(--ink-4);font-size:11px">${data.role}</span>`;
    await loadTasks();
    warmRecipientCache(); // pre-warm in background â€” makes first search instant
    setView(STATE.view);

  } catch(err) {
    hideLoading();
    showBlocked('Connection error: ' + err.message);
  }
}

function hideLoading() {
  const ls = qs('loading-screen');
  ls.classList.add('fade-out');
  setTimeout(() => ls.style.display='none', 400);
  qs('app').classList.add('visible');
}

function showBlocked(msg) {
  qs('app').classList.add('visible');
  qs('workspace').innerHTML = `
    <div class="blocked-screen">
      <div class="blocked-card">
        <div class="blocked-icon">ğŸ”’</div>
        <div class="blocked-title">Access Denied</div>
        <p class="blocked-msg">${msg}</p>
      </div>
    </div>`;
}

async function loadTasks() {
  try {
    const data = await api(`uuid=${STATE.uuid}&action=getTasks`);
    STATE.tasks = data.tasks || [];
  } catch(e) { STATE.tasks = []; }
}

// â”€â”€ View management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setView(v) {
  STATE.view = v;
  // Update main nav buttons
  ['split','tasks','exceptions','plancards'].forEach(n => {
    const b = qs('vbtn-' + n);
    if (b) b.classList.toggle('active', n === v);
  });
  // Update mail toggle slider
  const slider = qs('mail-toggle-slider');
  const btnMaillog = qs('vbtn-maillog');
  const btnLog = qs('vbtn-log');
  if (slider && btnMaillog && btnLog) {
    const isMaillog = v === 'maillog';
    const isLog = v === 'log';
    // Reset both buttons
    btnMaillog.classList.remove('active', 'active-maillog');
    btnLog.classList.remove('active', 'active-log');
    btnMaillog.style.color = '';
    btnLog.style.color = '';
    if (isMaillog) {
      slider.className = 'mail-toggle-slider pos-left';
      btnMaillog.classList.add('active', 'active-maillog');
    } else if (isLog) {
      slider.className = 'mail-toggle-slider pos-right';
      btnLog.classList.add('active', 'active-log');
    } else {
      // Neither selected â€” keep last state but dim
      slider.className = 'mail-toggle-slider pos-left';
    }
  }
  renderWorkspace();
}

function renderWorkspace() {
  const ws = qs('workspace');
  if (STATE.view === 'split') {
    ws.innerHTML = `
      <div class="pane pane-left" id="tasks-pane"></div>
      <div class="pane pane-right" id="detail-pane"></div>`;
    renderTasksPane();
    renderDetailPane();
  } else if (STATE.view === 'tasks') {
    ws.innerHTML = `<div class="pane-full" id="tasks-full"></div>`;
    renderTasksFull();
  } else if (STATE.view === 'log') {
    ws.innerHTML = `<div class="pane-full" id="log-full"></div>`;
    renderLogForm(qs('log-full'));
  } else if (STATE.view === 'maillog') {
    ws.innerHTML = `<div class="pane-full" id="maillog-full"></div>`;
    renderStaffMailLog(qs('maillog-full'));
  } else if (STATE.view === 'exceptions') {
    ws.innerHTML = `<div class="pane-full" id="exceptions-full"></div>`;
    renderExceptionsView(qs('exceptions-full'));
  } else if (STATE.view === 'plancards') {
    ws.innerHTML = `<div class="pane-full" id="plancards-full"></div>`;
    renderPlanCardsView(qs('plancards-full'));
  }
}

// â”€â”€ Tasks Pane (split) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTasksPane() {
  const pane = qs('tasks-pane');
  if (!pane) return;

  const EXC_TYPES = ['unmatched_mail','special_case_review'];
  const open   = STATE.tasks.filter(t => t.status === 'open' && !EXC_TYPES.includes(t.type));
  const overdue = open.filter(t => t.overdue === 'TRUE' || t.overdue === true);

  pane.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:0 4px">
      <div class="stats-mini" style="margin-bottom:0">
        <div class="stat-mini">
          <div class="stat-mini-val ${open.length > 0 ? 'red' : ''}">${open.length}</div>
          <div class="stat-mini-label">Open Tasks</div>
        </div>
        <div class="stat-mini">
          <div class="stat-mini-val ${overdue.length > 0 ? 'amber' : ''}">${overdue.length}</div>
          <div class="stat-mini-label">Overdue</div>
        </div>
      </div>
      <button id="split-refresh-btn" class="btn btn-secondary btn-sm" data-refresh-label="split-last-refreshed"
        onclick="animRefresh('split-refresh-btn', () => loadTasks().then(() => { renderTasksPane(); renderDetailPane(); }))">â†»</button>
    </div>
    <div class="nav-tabs">
      <div class="nav-tab active" id="ttab-open"   onclick="filterTasks('open')">Open (${open.length})</div>
      <div class="nav-tab"        id="ttab-all"    onclick="filterTasks('all')">All</div>
    </div>
    <div class="task-list" id="task-list-inner"></div>`;

  renderTaskList('open');
}

function filterTasks(filter) {
  ['open','all'].forEach(f => {
    const el = qs('ttab-' + f);
    if (el) el.classList.toggle('active', f === filter);
  });
  renderTaskList(filter);
}

function renderTaskList(filter) {
  const list = qs('task-list-inner');
  if (!list) return;

  // Exceptions (unmatched_mail, special_case_review) live in the Exceptions tab only
  const EXCEPTION_TYPES = ['unmatched_mail', 'special_case_review'];
  let tasks = filter === 'open'
    ? STATE.tasks.filter(t => t.status === 'open' && !EXCEPTION_TYPES.includes(t.type))
    : STATE.tasks.filter(t => !EXCEPTION_TYPES.includes(t.type));

  if (!tasks.length) {
    list.innerHTML = `
      <div class="empty-pane">
        <div class="empty-icon">âœ…</div>
        <div class="empty-title">${filter === 'open' ? 'All clear!' : 'No tasks'}</div>
        <div class="empty-sub">Nothing to action right now.</div>
      </div>`;
    return;
  }

  list.innerHTML = tasks.map(task => {
    const meta    = TASK_META[task.type] || { icon: 'ğŸ“Œ', label: task.type };
    const isOver  = task.overdue === 'TRUE' || task.overdue === true;
    const priClass = `pri-${task.priority}`;
    const days    = daysUntil(task.dueDate);
    const dueStr  = days === null ? '' : days < 0 ? `${Math.abs(days)}d overdue` : days === 0 ? 'Due today' : `Due in ${days}d`;
    const selected = STATE.selectedTask && STATE.selectedTask.taskId === task.taskId ? 'selected' : '';

    return `
      <div class="task-item ${priClass} ${isOver ? 'overdue' : ''} ${selected}"
           onclick="selectTask('${task.taskId}')">
        <div class="task-top">
          <div class="task-type">
            <span class="task-type-icon">${meta.icon}</span>
            ${meta.label}
          </div>
          <div class="task-right">
            ${isOver ? '<span class="pill overdue">Overdue</span>' : `<span class="pill ${task.priority}">${task.priority}</span>`}
          </div>
        </div>
        <div class="task-notes">${task.notes || 'â€”'}</div>
        <div class="task-client">
          ${task.clientId ? 'Â· ' + task.clientId.slice(0,8) + '...' : ''}
          ${task.recipientName ? 'Â· ' + task.recipientName : ''}
          ${dueStr ? 'Â· ' + dueStr : ''}

        </div>
      </div>`;
  }).join('');
}

function selectTask(taskId) {
  STATE.selectedTask = STATE.tasks.find(t => t.taskId === taskId);
  if (STATE.view === 'split') {
    renderTasksPane();
    renderDetailPane();
  } else {
    renderTasksFull();
  }
}

// â”€â”€ Detail Pane (split) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDetailPane() {
  const pane = qs('detail-pane');
  if (!pane) return;

  if (!STATE.selectedTask) {
    pane.innerHTML = `
      <div class="empty-pane">
        <div class="empty-icon">ğŸ‘ˆ</div>
        <div class="empty-title">Select a task</div>
        <div class="empty-sub">Click any task on the left to review and action it.</div>
      </div>`;
    return;
  }

  const task = STATE.selectedTask;
  const meta = TASK_META[task.type] || { icon: 'ğŸ“Œ', label: task.type };

  pane.innerHTML = `
    <div class="task-detail">
      <div class="detail-header">
        <div class="detail-type">${meta.icon} ${meta.label}</div>
        <div class="detail-title">${task.recipientName || task.clientId || 'Task Detail'}</div>
        <div class="detail-sub">${task.notes || ''}</div>
      </div>

      <div class="detail-card">
        <div class="detail-row">
          <label>Task ID</label><value>${task.taskId}</value>
        </div>
        <div class="detail-row">
          <label>Priority</label>
          <value><span class="pill ${task.priority}">${task.priority}</span></value>
        </div>
        <div class="detail-row">
          <label>Due Date</label>
          <value>${fmtDate(task.dueDate) || 'â€”'}</value>
        </div>
        ${task.mailId ? `<div class="detail-row"><label>Mail ID</label><value>${task.mailId}</value></div>` : ''}
        ${task.planCardId ? `<div class="detail-row"><label>Plan Card</label><value>${task.planCardId}</value></div>` : ''}
        ${task.clientId ? `<div class="detail-row"><label>Client</label><value>${task.clientId.slice(0,16)}...</value></div>` : ''}
        <div class="detail-row">
          <label>Created</label><value>${fmtDateTime(task.createdAt)}</value>
        </div>
      </div>

      ${task.status === 'open' ? `
      <div class="resolve-form">
        <div class="form-divider">Resolve Task</div>
        <textarea class="resolve-textarea" id="resolve-note" placeholder="Add a resolution note (optional)..."></textarea>
        <div class="resolve-actions">
          <button class="btn btn-success btn-sm" onclick="resolveTask('${task.taskId}')">
            âœ“ Mark Done
          </button>
          <button class="btn btn-secondary btn-sm" onclick="snoozePrompt('${task.taskId}')">
            â° Snooze
          </button>
        </div>
      </div>` : `
      <div style="padding:12px; background:var(--green-bg); border-radius:var(--radius-sm); font-size:13px; color:var(--green)">
        âœ“ Resolved by ${task.resolvedBy || 'â€”'} Â· ${fmtDate(task.resolvedAt)}
        ${task.resolutionNote ? `<br><span style="color:var(--ink-3)">${task.resolutionNote}</span>` : ''}
      </div>`}


      ${task.mailId ? `
      <button class="btn btn-secondary btn-full btn-sm" style="margin-top:8px" onclick="jumpToMailLog('${task.mailId}')">
        View Mail Log Entry â†’
      </button>` : ''}
    </div>`;
}

// â”€â”€ Tasks Full View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTasksFull() {
  const el = qs('tasks-full');
  if (!el) return;

  const EXCL = ['unmatched_mail','special_case_review'];
  const open = STATE.tasks.filter(t => t.status === 'open' && !EXCL.includes(t.type));

  el.innerHTML = `
    <div style="max-width:800px; margin:0 auto">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif; font-size:20px">${open.length} Open Tasks</div>
        <div style="display:flex;align-items:center;gap:6px">
          <span id="tasks-last-refreshed" style="font-size:11px;color:var(--ink-4)"></span>
          <button id="tasks-refresh-btn" class="btn btn-secondary btn-sm" data-refresh-label="tasks-last-refreshed" onclick="animRefresh('tasks-refresh-btn', () => loadTasks().then(() => renderWorkspace()))">â†» Refresh</button>
        </div>
      </div>
      ${open.length === 0 ? `
        <div class="empty-pane" style="background:var(--white); border:1px solid var(--border); border-radius:var(--radius); min-height:200px">
          <div class="empty-icon">âœ…</div>
          <div class="empty-title">All tasks cleared</div>
        </div>` :
        open.map(task => {
          const meta = TASK_META[task.type] || { icon:'ğŸ“Œ', label:task.type };
          const isOver = task.overdue === 'TRUE' || task.overdue === true;
          return `
            <div style="background:var(--white); border:1px solid var(--border); border-radius:var(--radius); padding:14px 16px; margin-bottom:10px; display:flex; gap:12px; align-items:flex-start; box-shadow:var(--shadow)">
              <div style="font-size:20px; flex-shrink:0; margin-top:2px">${meta.icon}</div>
              <div style="flex:1; min-width:0">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px">
                  <div style="font-size:13px; font-weight:600">${meta.label}</div>
                  <span class="pill ${isOver ? 'overdue' : task.priority}">${isOver ? 'Overdue' : task.priority}</span>
                </div>
                <div style="font-size:12px; color:var(--ink-3); margin-bottom:6px">${task.notes || 'â€”'}</div>
                <div style="font-size:11px; color:var(--ink-4)">${task.recipientName || ''} ${task.clientId ? 'Â· ' + task.clientId.slice(0,8)+'...' : ''} Â· Due ${fmtDate(task.dueDate)}</div>
              </div>
              <div style="display:flex; gap:6px; flex-shrink:0">
                <button class="btn btn-success btn-sm" onclick="resolveTask('${task.taskId}')">Done</button>
                <button class="btn btn-secondary btn-sm" onclick="selectTask('${task.taskId}'); setView('split')">Detail</button>
              </div>
            </div>`;
        }).join('')
      }
    </div>`;
}

// â”€â”€ Log Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLogForm(container) {
  container.innerHTML = `
    <div style="max-width:640px; margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
        <div style="font-family:'DM Serif Display',serif; font-size:20px">Log Incoming Mail</div>
        <div style="display:flex;align-items:center;gap:6px">
          <span id="log-last-refreshed" style="font-size:11px;color:var(--ink-4)"></span>
          <button id="log-refresh-btn" class="btn btn-secondary btn-sm" data-refresh-label="log-last-refreshed"
            onclick="animRefresh('log-refresh-btn', async () => { _recipientCache = null; await warmRecipientCache(); })">â†» Refresh</button>
        </div>
      </div>
      <div style="background:var(--white); border:1px solid var(--border); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow)">

        <div class="form-divider" id="recipient-divider">Recipient</div>
        <div id="recipient-section">
          <div style="display:flex;align-items:flex-end;gap:8px;margin-bottom:10px;flex-wrap:wrap">
            <div class="form-group recipient-search-wrap" style="flex:1;min-width:180px;margin-bottom:0">
              <input type="text" id="log-recipient-search" placeholder="Search recipient..." autocomplete="off"
                oninput="searchRecipients(this.value)">
              <div class="recipient-results" id="recipient-results" style="display:none"></div>
            </div>
            <div style="display:flex;gap:4px;flex-shrink:0;padding-bottom:1px">
              <button type="button" class="inline-tog" id="tog-confidential-btn" onclick="onConfidentialToggle()" title="Blocks scan & forward">ğŸ”’ Confidential</button>
              <button type="button" class="inline-tog" id="tog-special-btn" onclick="onSpecialCaseToggle()" title="No recipient needed">âš ï¸ Special</button>
            </div>
          </div>
          <!-- Hidden toggles for state tracking -->
          <div style="display:none">
            <div class="toggle" id="tog-confidential"></div>
            <div class="toggle" id="tog-special"></div>
          </div>
          <div id="selected-recipient-box" style="display:none; background:var(--bg); border-radius:var(--radius-sm); padding:10px 12px; margin-bottom:14px; font-size:13px">
            <div style="font-weight:500" id="sel-rec-name"></div>
            <div style="font-size:11px; color:var(--ink-4)" id="sel-rec-sub"></div>
            <button style="font-size:11px; color:var(--red); background:none; margin-top:4px" onclick="clearRecipient()">âœ• Clear</button>
          </div>
        </div>
        <div id="special-case-note" style="display:none; background:var(--amber-bg); border-radius:var(--radius-sm); padding:10px 12px; margin-bottom:14px; font-size:12px; color:var(--amber)">
          âš ï¸ Special case â€” no recipient required. Item stored for future assignment or disposal.
        </div>

        <div class="form-divider">Mail Details</div>
        <div class="form-group" style="position:relative">
          <label>Sender Name <span style="color:var(--ink-4);text-transform:none">(shown to client)</span></label>
          <input type="text" id="log-sender" placeholder="e.g. TD Bank, CRA, Amazon, John Smith..." autocomplete="off"
            oninput="showSuggestions('log-sender','sender-suggest',_senderCache,this.value)"
            onfocus="showSuggestions('log-sender','sender-suggest',_senderCache,this.value)">
          <div id="sender-suggest" class="suggest-dropdown" style="display:none"></div>
          <div id="sender-chips" class="suggest-chips"></div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Type</label>
            <div class="mail-type-toggle" id="mail-type-toggle" style="margin-top:4px">
              <div class="mail-type-slider" id="mail-type-slider"></div>
              <button type="button" class="mail-type-btn active" id="mt-btn-letter" onclick="setMailType('letter')">âœ‰ï¸ Mail</button>
              <button type="button" class="mail-type-btn" id="mt-btn-parcel" onclick="setMailType('parcel')">ğŸ“¦ Parcel</button>
            </div>
            <input type="hidden" id="log-type" value="letter">
          </div>
          <div class="form-group" style="position:relative">
            <label>Physical Location <span style="color:var(--ink-4);text-transform:none">(staff only)</span></label>
            <input type="text" id="log-location" placeholder="e.g. Shelf A3, Bin 2" autocomplete="off"
              oninput="showSuggestions('log-location','location-suggest',_locationCache,this.value)"
              onfocus="showSuggestions('log-location','location-suggest',_locationCache,this.value)">
            <div id="location-suggest" class="suggest-dropdown" style="display:none"></div>
            <div id="location-chips" class="suggest-chips"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Piece Count</label>
            <input type="text" id="log-pieces" value="1">
          </div>
          <div class="form-group" id="scan-field-wrap">
            <label>Scanned File <span style="color:var(--ink-4);text-transform:normal;font-weight:400" id="scan-url-hint">(optional)</span></label>
            <div class="scan-mode-toggle" style="margin-bottom:6px">
              <button type="button" class="scan-mode-btn active" id="scan-mode-url" onclick="setScanMode('url')">ğŸ”— URL</button>
              <button type="button" class="scan-mode-btn" id="scan-mode-upload" onclick="setScanMode('upload')">ğŸ“„ Upload</button>
            </div>
            <div id="scan-url-input">
              <input type="text" id="log-scan" placeholder="https://drive.google.com/...">
            </div>
            <div id="scan-upload-input" style="display:none">
              <div id="scan-drop-zone" class="scan-drop-zone" onclick="qs('scan-file-input').click()"
                ondragover="event.preventDefault();this.classList.add('dragover')"
                ondragleave="this.classList.remove('dragover')"
                ondrop="event.preventDefault();this.classList.remove('dragover');handleScanDrop(event)">
                <div id="scan-drop-label">
                  <span style="font-size:20px">ğŸ“</span>
                  <span style="font-size:12px;color:var(--ink-3)">Click or drag file here</span>
                  <span style="font-size:10px;color:var(--ink-4)">JPG, PNG, PDF â€” max 5 MB</span>
                </div>
                <div id="scan-file-preview" style="display:none"></div>
              </div>
              <input type="file" id="scan-file-input" accept="image/*,.pdf" style="display:none" onchange="handleScanFile(this.files[0])">
            </div>
            <div style="margin-top:6px">
              <label style="font-size:10px;color:var(--ink-4);text-transform:uppercase;letter-spacing:.04em">Expire after</label>
              <div class="scan-expiry-chips" style="display:flex;gap:4px;margin-top:3px">
                <button type="button" class="expiry-chip active" data-days="30" onclick="setScanExpiry(30,this)">30 days</button>
                <button type="button" class="expiry-chip" data-days="60" onclick="setScanExpiry(60,this)">60 days</button>
                <button type="button" class="expiry-chip" data-days="90" onclick="setScanExpiry(90,this)">90 days</button>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Note to Client <span style="color:var(--ink-4);text-transform:none">(visible to client)</span></label>
          <textarea id="log-note-client" placeholder="e.g. Looks like a bank statement, return address matches TD Bank..."></textarea>
          <div class="suggest-chips" style="margin-top:4px">
            <span class="qnote-chip" onclick="appendNote('log-note-client','You have new mail ready for pickup.')">ğŸ“¬ Ready for pickup</span>
            <span class="qnote-chip" onclick="appendNote('log-note-client','Government / official correspondence received.')">ğŸ›ï¸ Government mail</span>
            <span class="qnote-chip" onclick="appendNote('log-note-client','Looks like a financial statement or bank notice.')">ğŸ¦ Financial/Bank</span>
            <span class="qnote-chip" onclick="appendNote('log-note-client','Package received â€” requires signature on pickup.')">âœï¸ Signature required</span>
            <span class="qnote-chip" onclick="appendNote('log-note-client','Large or oversized item â€” please arrange pickup soon.')">ğŸ“¦ Oversized item</span>
            <span class="qnote-chip" onclick="appendNote('log-note-client','Time-sensitive â€” please pick up at your earliest convenience.')">â° Time-sensitive</span>
            <span class="qnote-chip" onclick="appendNote('log-note-client','Multiple items received today.')">ğŸ“‹ Multiple items</span>
          </div>
        </div>
        <div class="form-group">
          <label>Internal Note <span style="color:var(--ink-4);text-transform:none">(staff only)</span></label>
          <textarea id="log-note-internal" placeholder="Internal notes..."></textarea>
          <div class="suggest-chips" style="margin-top:4px">
            <span class="qnote-chip" onclick="appendNote('log-note-internal','Client notified via email.')">ğŸ“§ Client notified</span>
            <span class="qnote-chip" onclick="appendNote('log-note-internal','Left voicemail for client.')">ğŸ“ Left voicemail</span>
            <span class="qnote-chip" onclick="appendNote('log-note-internal','Return to sender if not picked up within 30 days.')">â†©ï¸ RTS 30 days</span>
            <span class="qnote-chip" onclick="appendNote('log-note-internal','Client requested hold â€” do not forward.')">ğŸš« Hold, no forward</span>
            <span class="qnote-chip" onclick="appendNote('log-note-internal','Duplicate item â€” verify with previous entry.')">âš ï¸ Possible duplicate</span>
            <span class="qnote-chip" onclick="appendNote('log-note-internal','Damaged on arrival â€” documented.')">ğŸ’” Damaged</span>
            <span class="qnote-chip" onclick="appendNote('log-note-internal','Requires manager review.')">ğŸ‘€ Manager review</span>
          </div>
        </div>

        <div id="confidential-notice" style="display:none;padding:8px 12px;background:var(--amber-bg);border-radius:var(--radius-sm);font-size:12px;color:var(--amber);margin-bottom:10px">
          ğŸ”’ <strong>Confidential mail</strong> â€” Pickup only. No scanning or forwarding. Client will see this notice.
        </div>
        <div id="forwarding-notice" style="display:none;padding:8px 12px;background:var(--blue-bg);border-radius:var(--radius-sm);font-size:12px;color:var(--blue);margin-bottom:10px">
          ğŸ“¬ <strong>Forwarding plan</strong> â€” This item will be queued for forwarding first week of next month.
        </div>

        <div id="special-case-name-wrap" style="display:none" class="form-group">
          <label>Name on Envelope / Package *</label>
          <input type="text" id="log-special-name" placeholder="As written on the mail â€” for physical retrieval">
          <div style="font-size:11px;color:var(--ink-4);margin-top:4px">Enter exactly as it appears. Do not search recipients.</div>
        </div>
        <div id="special-case-reason-wrap" style="display:none" class="form-group">
          <label>Special Case Reason</label>
          <input type="text" id="log-special-reason" placeholder="e.g. No matching recipient found">
        </div>

        <div id="parcel-fields" style="display:none">
          <div class="form-divider">Parcel Details</div>
          <div class="form-row">
            <div class="form-group">
              <label>Estimated Weight</label>
              <input type="text" id="log-weight" placeholder="e.g. 2.5 kg">
            </div>
            <div class="form-group">
              <label>Return Address</label>
              <input type="text" id="log-return-addr" placeholder="Sender address">
            </div>
          </div>
          <!-- Oversized toggle removed â€” not needed for special case intake -->
        <div style="display:none">
            <div class="toggle" id="tog-oversized"></div>
          </div>
        </div>

        <button class="btn btn-primary btn-full" id="log-submit-btn" onclick="submitLogMail()" style="margin-top:8px">
          Log Mail
        </button>
      </div>
    </div>`;

  qs('log-type').addEventListener('change', onMailTypeChange);
  loadLogSuggestions();
  _scanMode = 'url';
  _scanFile = null;
  _scanExpiryDays = 30;
}

function onConfidentialToggle() {
  const tog = qs('tog-confidential');
  tog.classList.toggle('on');
  const isConf    = tog.classList.contains('on');
  const btn = qs('tog-confidential-btn');
  if (btn) btn.classList.toggle('active', isConf);
  const scanField = qs('log-scan');
  const scanWrap  = qs('scan-field-wrap');
  if (scanField) { scanField.disabled = isConf; scanField.style.opacity = isConf ? '0.4' : '1'; if (isConf) scanField.value = ''; }
  if (scanWrap)  { scanWrap.style.background = isConf ? 'var(--amber-bg)' : ''; }
  const confNotice = qs('confidential-notice');
  if (confNotice) confNotice.style.display = isConf ? 'block' : 'none';
  const fwdNotice = qs('forwarding-notice');
  if (fwdNotice && isConf) fwdNotice.style.display = 'none';
  updateScanUrlRequirement();
}

function onSpecialCaseToggle() {
  const tog = qs('tog-special');
  tog.classList.toggle('on');
  const isSpecial = tog.classList.contains('on');
  const btn = qs('tog-special-btn');
  if (btn) btn.classList.toggle('active', isSpecial);

  // Recipient section â€” hide when special case
  const recSection   = qs('recipient-section');
  const recDivider   = qs('recipient-divider');
  const specialNote  = qs('special-case-note');
  const nameWrap     = qs('special-case-name-wrap');
  const reasonWrap   = qs('special-case-reason-wrap');

  if (recSection)  recSection.style.display  = isSpecial ? 'none' : 'block';
  if (recDivider)  recDivider.style.display  = isSpecial ? 'none' : 'block';
  if (specialNote) specialNote.style.display = 'none';
  if (nameWrap)    nameWrap.style.display    = isSpecial ? 'block' : 'none';
  if (reasonWrap)  reasonWrap.style.display  = isSpecial ? 'block' : 'none';

  // Hide scan, note to client, confidential when special case
  const scanWrap    = qs('scan-field-wrap');
  const noteClient  = document.querySelector('#log-note-client')?.closest('.form-group');
  const confNotice  = qs('confidential-notice');
  const fwdNotice   = qs('forwarding-notice');
  if (scanWrap)   scanWrap.style.display   = isSpecial ? 'none' : '';
  if (noteClient) noteClient.style.display = isSpecial ? 'none' : '';
  if (confNotice) confNotice.style.display = 'none';
  if (fwdNotice)  fwdNotice.style.display  = 'none';

  // Also hide/show the confidential button
  const confBtn = qs('tog-confidential-btn');
  if (confBtn) confBtn.style.display = isSpecial ? 'none' : '';

  if (!isSpecial) clearRecipient();
}

function setMailType(type) {
  const hidden = qs('log-type');
  if (hidden) hidden.value = type;
  const slider = qs('mail-type-slider');
  const btnLetter = qs('mt-btn-letter');
  const btnParcel = qs('mt-btn-parcel');
  if (slider) slider.className = 'mail-type-slider' + (type === 'parcel' ? ' parcel' : '');
  if (btnLetter) { btnLetter.classList.toggle('active', type === 'letter'); }
  if (btnParcel) { btnParcel.classList.toggle('active', type === 'parcel'); }
  onMailTypeChange();
}

function onMailTypeChange() {
  const isParcel = qs('log-type') && qs('log-type').value === 'parcel';

  // Show parcel-specific fields
  const pf = qs('parcel-fields');
  if (pf) pf.style.display = isParcel ? 'block' : 'none';

  // Show oversized toggle only for parcels, reset when switching away
  const oversizedRow = qs('oversized-row');
  if (oversizedRow) oversizedRow.style.display = isParcel ? 'flex' : 'none';
  if (!isParcel && qs('tog-oversized')) qs('tog-oversized').classList.remove('on');

  // Block parcel selection on Economy plans (parcelLimit = 0)
  const pc = STATE.logPlanCard;
  if (isParcel && pc && (!pc.parcelLimit || parseInt(pc.parcelLimit) === 0)) {
    // Switch back to letter using the new toggle (set hidden directly to avoid loop)
    const hidden = qs('log-type');
    if (hidden) hidden.value = 'letter';
    const slider = qs('mail-type-slider');
    if (slider) slider.className = 'mail-type-slider';
    const btnL = qs('mt-btn-letter'), btnP = qs('mt-btn-parcel');
    if (btnL) btnL.classList.add('active');
    if (btnP) btnP.classList.remove('active');
    if (pf) pf.style.display = 'none';
    if (oversizedRow) oversizedRow.style.display = 'none';
    toast('This plan does not include parcel handling â€” upgrade to log parcels.', 'error');
    return;
  }

  // Hide scan field for parcels (not needed)
  const scanWrap = qs('scan-field-wrap');
  if (scanWrap) scanWrap.style.display = isParcel ? 'none' : '';

  updateScanUrlRequirement();
}

function updateScanUrlRequirement() {
  const pc           = STATE.logPlanCard;
  const isScanPlan   = pc && pc.autoFeature === 'scan';
  const isConf       = qs('tog-confidential') && qs('tog-confidential').classList.contains('on');
  const isLetter     = qs('log-type') && qs('log-type').value !== 'parcel';
  const mandatory    = isScanPlan && isLetter && !isConf;
  const hint = qs('scan-url-hint');
  if (hint) {
    hint.textContent = mandatory ? '(required for scan plan)' : '(optional)';
    hint.style.color = mandatory ? 'var(--red)' : 'var(--ink-4)';
  }
}

// â”€â”€ Scan mode (URL vs Upload) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _scanMode = 'url';
let _scanFile = null;

function setScanMode(mode) {
  _scanMode = mode;
  const urlBtn = qs('scan-mode-url'), uploadBtn = qs('scan-mode-upload');
  const urlInput = qs('scan-url-input'), uploadInput = qs('scan-upload-input');
  if (urlBtn) urlBtn.classList.toggle('active', mode === 'url');
  if (uploadBtn) uploadBtn.classList.toggle('active', mode === 'upload');
  if (urlInput) urlInput.style.display = mode === 'url' ? 'block' : 'none';
  if (uploadInput) uploadInput.style.display = mode === 'upload' ? 'block' : 'none';
}

function handleScanDrop(e) {
  const file = e.dataTransfer.files[0];
  if (file) handleScanFile(file);
}

function handleScanFile(file) {
  if (!file) return;
  const maxSize = 5 * 1024 * 1024;
  if (file.size > maxSize) { toast('File too large â€” max 5 MB', 'error'); return; }
  const allowed = ['image/jpeg','image/png','image/webp','application/pdf'];
  if (!allowed.includes(file.type)) { toast('Unsupported file type â€” use JPG, PNG, or PDF', 'error'); return; }
  _scanFile = file;
  const sizeStr = file.size < 1024*1024
    ? (file.size/1024).toFixed(0) + ' KB'
    : (file.size/1024/1024).toFixed(1) + ' MB';
  const icon = file.type === 'application/pdf' ? 'ğŸ“„' : 'ğŸ–¼ï¸';
  const label = qs('scan-drop-label');
  const preview = qs('scan-file-preview');
  if (label) label.style.display = 'none';
  if (preview) {
    preview.style.display = 'block';
    preview.innerHTML = `
      <div class="scan-file-info">
        <span style="font-size:18px">${icon}</span>
        <span class="file-name">${file.name}</span>
        <span class="file-size">${sizeStr}</span>
        <button class="remove-btn" onclick="event.stopPropagation();clearScanFile()">âœ• Remove</button>
      </div>`;
  }
}

function clearScanFile() {
  _scanFile = null;
  const label = qs('scan-drop-label');
  const preview = qs('scan-file-preview');
  const input = qs('scan-file-input');
  if (label) label.style.display = 'flex';
  if (preview) { preview.style.display = 'none'; preview.innerHTML = ''; }
  if (input) input.value = '';
}

function getScanValue() {
  // Returns URL string or null â€” upload mode stores file in _scanFile for future Supabase storage
  if (_scanMode === 'url') {
    return qs('log-scan') ? qs('log-scan').value.trim() : '';
  }
  // For upload mode, return a placeholder that indicates file is pending
  // When Supabase storage is enabled, this will upload and return the URL
  if (_scanFile) return 'file:pending:' + _scanFile.name;
  return '';
}

function resetScanField() {
  setScanMode('url');
  if (qs('log-scan')) qs('log-scan').value = '';
  clearScanFile();
  _scanExpiryDays = 30;
}

// â”€â”€ Scan expiry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _scanExpiryDays = 30;

function setScanExpiry(days, btnEl) {
  _scanExpiryDays = days;
  document.querySelectorAll('.expiry-chip').forEach(c => c.classList.remove('active'));
  if (btnEl) btnEl.classList.add('active');
}

function getScanExpiresAt() {
  const d = new Date();
  d.setDate(d.getDate() + _scanExpiryDays);
  return d.toISOString();
}


function toggleSpecial() {
  const tog = qs('tog-special');
  tog.classList.toggle('on');
  const wrap = qs('special-case-reason-wrap');
  if (wrap) wrap.style.display = tog.classList.contains('on') ? 'block' : 'none';
}

// â”€â”€ Log suggestions (senders, locations) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _senderCache = [];
let _locationCache = [];
let _suggestionsLoaded = false;

async function loadLogSuggestions() {
  if (_suggestionsLoaded) return;
  try {
    const data = await api(`uuid=${STATE.uuid}&action=getLogSuggestions`);
    _senderCache = data.senders || [];
    _locationCache = data.locations || [];
    _suggestionsLoaded = true;
    renderChips('sender-chips', _senderCache.slice(0, 6), 'log-sender');
    renderChips('location-chips', _locationCache.slice(0, 4), 'log-location');
  } catch(e) { /* silent */ }
}

function renderChips(containerId, items, inputId) {
  const el = qs(containerId);
  if (!el || !items.length) return;
  el.innerHTML = items.map(v =>
    `<span class="chip" onclick="document.getElementById('${inputId}').value='${v.replace(/'/g,"\\'")}';hideSuggest('${inputId.replace('log-','')}-suggest')">${v}</span>`
  ).join('');
}

function showSuggestions(inputId, dropdownId, cache, query) {
  const dd = qs(dropdownId);
  if (!dd) return;
  const q = (query || '').toLowerCase();
  if (!q || !cache.length) { dd.style.display = 'none'; return; }
  const hits = cache.filter(v => v.toLowerCase().includes(q) && v.toLowerCase() !== q).slice(0, 6);
  if (!hits.length) { dd.style.display = 'none'; return; }
  dd.style.display = 'block';
  dd.innerHTML = hits.map(v =>
    `<div class="suggest-item" onmousedown="document.getElementById('${inputId}').value='${v.replace(/'/g,"\\'")}';hideSuggest('${dropdownId}')">${v}</div>`
  ).join('');
}

function hideSuggest(id) {
  const el = qs(id);
  if (el) el.style.display = 'none';
}

function appendNote(textareaId, text) {
  const el = document.getElementById(textareaId);
  if (!el) return;
  const cur = el.value.trim();
  el.value = cur ? cur + ' ' + text : text;
  el.focus();
}

// Hide dropdowns on blur
document.addEventListener('click', function(e) {
  ['sender-suggest','location-suggest'].forEach(id => {
    const dd = qs(id);
    if (dd && !dd.contains(e.target)) dd.style.display = 'none';
  });
});

// â”€â”€ Recipient search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _searchTimeout = null;

// Recipient cache â€” loaded once per session, filtered client-side
// Animated refresh: spinRefreshBtn(id) â†’ start, stopRefreshBtn(id) â†’ stop
function spinRefreshBtn(id) {
  const b = document.getElementById(id) || (typeof id === 'object' ? id : null);
  if (b) { b.disabled = true; b.dataset.origHtml = b.innerHTML;
    const arrow = b.innerHTML.match(/[â†»âŸ³â†ºğŸ”„]/)?.[0] || 'â†»';
    b.innerHTML = b.innerHTML.replace(/[â†»âŸ³â†ºğŸ”„]/, `<span class="spin-active">${arrow}</span>`); }
}
function animRefresh(btnId, asyncFn) {
  spinRefreshBtn(btnId);
  Promise.resolve(asyncFn()).finally(() => {
    stopRefreshBtn(btnId);
    const b = document.getElementById(btnId);
    if (b && b.dataset.refreshLabel) setLastRefreshed(b.dataset.refreshLabel);
  });
}
function stopRefreshBtn(id) {
  const b = document.getElementById(id) || (typeof id === 'object' ? id : null);
  if (b) { b.disabled = false; if (b.dataset.origHtml) b.innerHTML = b.dataset.origHtml; }
}

function setLastRefreshed(labelId) {
  const el = document.getElementById(labelId);
  if (!el) return;
  const now = new Date();
  el.textContent = 'Last refreshed ' + now.toLocaleTimeString('en-CA', { hour:'2-digit', minute:'2-digit' });
}

let _recipientCache = null;
let _recipientCacheTime = 0;
const CACHE_TTL = 5 * 60 * 1000;

async function warmRecipientCache() {
  const now = Date.now();
  if (_recipientCache && (now - _recipientCacheTime) < CACHE_TTL) return;
  try {
    const data = await api(`uuid=${STATE.uuid}&action=searchRecipients&q=`);
    _recipientCache = Array.isArray(data) ? data : (data.recipients || []);
    _recipientCacheTime = now;
  } catch(e) { _recipientCache = _recipientCache || []; }
}

function searchRecipients(query) {
  clearTimeout(_searchTimeout);
  const results = qs('recipient-results');
  if (!results) return;
  if (!query || query.length < 1) { results.style.display = 'none'; return; }

  if (_recipientCache) {
    showRecipientResults(query, results);
    return;
  }
  results.style.display = 'block';
  results.innerHTML = `<div class="recipient-result-item" style="color:var(--ink-4)">Loading...</div>`;
  _searchTimeout = setTimeout(async () => {
    await warmRecipientCache();
    showRecipientResults(query, results);
  }, 80);
}

function showRecipientResults(query, results) {
  if (!results) return;
  const q    = query.toLowerCase();
  const hits = (_recipientCache || []).filter(r =>
    [r.name, r.companyName, r.planCardId, r.planName, r.clientName, r.friendlyName]
      .join(' ').toLowerCase().includes(q)
  ).slice(0, 10);

  if (!hits.length) {
    results.style.display = 'block';
    results.innerHTML = `<div class="recipient-result-item" style="color:var(--ink-4)">No matching recipients</div>`;
    return;
  }

  // Sort: active first, then inactive
  hits.sort((a, b) => {
    if (a.recipientStatus === 'active' && b.recipientStatus !== 'active') return -1;
    if (a.recipientStatus !== 'active' && b.recipientStatus === 'active') return 1;
    return 0;
  });

  results.style.display = 'block';
  results.innerHTML = hits.map(r => {
    const isInactive = r.recipientStatus === 'inactive';
    const isTemp = r.notes && r.notes.startsWith('TEMP:');
    const payload = JSON.stringify({
      recipientId: r.recipientId, name: r.name, companyName: r.companyName,
      planCardId: r.planCardId, clientId: r.clientId, clientName: r.clientName,
      subscriptionId: r.subscriptionId, accessStatus: r.accessStatus,
      notes: r.notes, locationId: r.locationId, status: r.recipientStatus,
      friendlyName: r.friendlyName, planName: r.planName, autoFeature: r.autoFeature,
      parcelLimit: r.parcelLimit
    }).replace(/"/g, '&quot;');
    const statusColor = r.accessStatus === 'ACTIVE' ? 'var(--green)' : r.accessStatus === 'CANCELED_WITH_ACCESS' ? 'var(--amber)' : r.accessStatus === 'PAYMENT_REQUIRED' ? 'var(--red)' : 'var(--ink-4)';
    const statusLabel = r.accessStatus === 'ACTIVE' ? 'â— Active' : r.accessStatus === 'CANCELED_WITH_ACCESS' ? 'â— Access Until Period End' : r.accessStatus === 'PAYMENT_REQUIRED' ? 'â›” Payment Required' : r.accessStatus === 'CANCELED' ? 'âœ• Canceled' : r.accessStatus || 'Unknown';

    const tempBadge = isTemp ? '<span style="font-size:9px;font-weight:600;padding:1px 5px;border-radius:8px;background:#FFF3E0;color:#E65100;border:1px solid #FFE0B2;margin-left:4px">TEMP</span>' : '';
    const inactiveBadge = isInactive ? '<span style="font-size:9px;font-weight:600;padding:1px 5px;border-radius:8px;background:#F5F5F5;color:#9E9E9E;border:1px solid #E0E0E0;margin-left:4px">INACTIVE</span>' : '';
    const displayPlan = r.friendlyName && !r.friendlyName.startsWith('TEMP:') ? r.friendlyName : (r.planName || r.planCardId);
    const clientLabel = r.clientName ? `<span style="color:var(--ink-4)">Â· ${r.clientName}</span>` : '';

    if (isInactive) {
      return `<div class="recipient-result-item" style="opacity:0.45;cursor:not-allowed;pointer-events:none">
        <div class="rri-name">${r.name}${r.companyName ? ' <span style="color:var(--ink-4);font-weight:400">Â· ' + r.companyName + '</span>' : ''}${inactiveBadge}</div>
        <div class="rri-sub" style="font-size:10px;color:#9E9E9E">${displayPlan} ${clientLabel} Â· Inactive</div>
      </div>`;
    }

    return `<div class="recipient-result-item" onclick="selectRecipient(${payload})">
      <div class="rri-name">${r.name}${r.companyName ? ' <span style="color:var(--ink-4);font-weight:400">Â· ' + r.companyName + '</span>' : ''}${tempBadge}</div>
      <div class="rri-sub" style="display:flex;gap:8px;align-items:center">
        <span>${displayPlan} ${clientLabel}</span>
        <span style="font-size:10px;font-weight:600;color:${statusColor}">${statusLabel}</span>
      </div>
    </div>`;
  }).join('');
}


function selectRecipient(data) {
  // Block inactive recipients from being selected for mail logging
  if (data.status === 'inactive') {
    toast('âŠ˜ This recipient is inactive â€” re-activate them before logging mail.', 'error');
    return;
  }
  STATE.logPlanCard = data;
  updateScanUrlRequirement();
  const results = qs('recipient-results');
  if (results) results.style.display = 'none';

  const isTemp = data.notes && data.notes.startsWith('TEMP:');

  const search = qs('log-recipient-search');
  if (search) search.value = data.name + (data.companyName ? ' â€” ' + data.companyName : '');

  const box = qs('selected-recipient-box');
  if (box) {
    box.style.display = 'block';
    const nameEl  = qs('sel-rec-name');
    const subEl   = qs('sel-rec-sub');
    const displayPlan = data.friendlyName && !data.friendlyName.startsWith('TEMP:') ? data.friendlyName : (data.planName || data.planCardId);
    if (nameEl) nameEl.innerHTML = data.name + (data.companyName ? ' â€” ' + data.companyName : '')
      + (isTemp ? ' <span style="font-size:9px;font-weight:600;padding:1px 5px;border-radius:8px;background:#FFF3E0;color:#E65100;border:1px solid #FFE0B2">TEMP</span>' : '');
    if (subEl)  subEl.innerHTML = `${displayPlan}${data.clientName ? ' Â· <strong>' + data.clientName + '</strong>' : ''}`;

    // Build expandable other recipients on same plan card
    const oldOther = box.querySelector('.other-recs-wrap');
    if (oldOther) oldOther.remove();
    const siblings = (_recipientCache || []).filter(r =>
      r.planCardId === data.planCardId && r.recipientId !== data.recipientId
    );
    if (siblings.length > 0) {
      const otherDiv = document.createElement('div');
      otherDiv.className = 'other-recs-wrap';
      otherDiv.innerHTML = `
        <button onclick="const el=this.nextElementSibling;const ch=this.querySelector('span');if(el.style.display==='none'){el.style.display='block';ch.style.transform='rotate(90deg)'}else{el.style.display='none';ch.style.transform='rotate(0deg)'}"
          style="display:flex;align-items:center;gap:5px;background:none;border:none;cursor:pointer;font-family:inherit;font-size:11px;color:var(--ink-4);padding:6px 0 2px;font-weight:600">
          <span style="display:inline-block;transition:transform .2s;font-size:10px">â–¸</span>
          Other recipients on this plan (${siblings.length})
        </button>
        <div style="display:none;padding:4px 0 2px">
          ${siblings.map(s => {
            const sTemp = s.notes && s.notes.startsWith('TEMP:');
            const sInactive = s.recipientStatus === 'inactive';
            const badge = sTemp ? '<span style="font-size:8px;font-weight:600;padding:0 4px;border-radius:6px;background:#FFF3E0;color:#E65100;margin-left:4px">TEMP</span>'
              : sInactive ? '<span style="font-size:8px;font-weight:600;padding:0 4px;border-radius:6px;background:#F5F5F5;color:#9E9E9E;margin-left:4px">INACTIVE</span>' : '';
            return '<div style="font-size:12px;color:var(--ink-3);padding:2px 0;'+(sInactive?'opacity:0.5;':'')+'">' + s.name + badge + '</div>';
          }).join('')}
        </div>`;
      box.appendChild(otherDiv);
    }

    // Payment status warning
    const isBlocked = data.accessStatus && data.accessStatus !== 'ACTIVE' && data.accessStatus !== 'CANCELED_WITH_ACCESS';
    let statusHtml = '';
    if (isBlocked) {
      statusHtml = `<div style="margin-top:6px;padding:6px 10px;background:var(--red-dim);border-radius:var(--radius-sm);font-size:11px;color:var(--red);font-weight:500">
        â›” ${data.accessStatus.replace(/_/g,' ')} â€” mail release blocked. Do not release items.
      </div>`;
    } else if (data.accessStatus === 'CANCELED_WITH_ACCESS') {
      statusHtml = `<div style="margin-top:6px;padding:6px 10px;background:var(--amber-bg);border-radius:var(--radius-sm);font-size:11px;color:var(--amber)">
        âš ï¸ Cancelling soon â€” still has access until billing period ends. Logging allowed.
      </div>`;
    }
    // Block submit button if PAYMENT_REQUIRED or CANCELED
    const submitBtn = qs('log-submit-btn');
    if (data.accessStatus === 'PAYMENT_REQUIRED') {
      statusHtml += `<div style="margin-top:6px;padding:8px 10px;background:var(--red-dim);border-radius:var(--radius-sm);font-size:11px;color:var(--red);font-weight:600">
        â›” Payment Required â€” mail logging is blocked until payment is resolved.
      </div>`;
      if (submitBtn) { submitBtn.disabled = true; submitBtn.title = 'Payment required'; }
    } else if (data.accessStatus === 'CANCELED') {
      statusHtml += `<div style="margin-top:6px;padding:8px 10px;background:var(--red-dim);border-radius:var(--radius-sm);font-size:11px;color:var(--red);font-weight:600">
        â›” Plan Cancelled â€” mail logging is blocked.
      </div>`;
      if (submitBtn) { submitBtn.disabled = true; submitBtn.title = 'Plan cancelled'; }
    } else {
      if (submitBtn) { submitBtn.disabled = false; submitBtn.title = ''; }
    }

    // Remove any old status div
    const old = box.querySelector('.recipient-status-warn');
    if (old) old.remove();
    if (statusHtml) {
      const div = document.createElement('div');
      div.className = 'recipient-status-warn';
      div.innerHTML = statusHtml;
      box.appendChild(div);
    }
  }

  // Auto-set location from recipient's plan card
  const locInput = qs('log-location');
  if (locInput && data.locationId) {
    locInput.dataset.locationId = data.locationId;
  }

  // Forwarding notice
  const fwdNotice = qs('forwarding-notice');
  if (fwdNotice) {
    const hasFwd = data.autoFeature === 'ship';
    const isConf = qs('tog-confidential') && qs('tog-confidential').classList.contains('on');
    fwdNotice.style.display = (hasFwd && !isConf) ? 'block' : 'none';
  }
  // Block submit for expired plans
  const submitBtn = qs('log-submit-btn');
  if (submitBtn) {
    const isExpired = data.accessStatus === 'CANCELED' || data.accessStatus === 'expired';
    submitBtn.disabled = isExpired;
    submitBtn.title = isExpired ? 'Plan expired â€” use Exception instead' : '';
  }
  updateScanUrlRequirement();
}


function clearRecipient() {
  STATE.logPlanCard = null;
  const search = qs('log-recipient-search');
  if (search) search.value = '';
  const box = qs('selected-recipient-box');
  if (box) box.style.display = 'none';
  const results = qs('recipient-results');
  if (results) results.style.display = 'none';
  const locInput = qs('log-location');
  if (locInput) delete locInput.dataset.locationId;
  // Re-enable submit
  const submitBtn = qs('log-submit-btn');
  if (submitBtn) { submitBtn.disabled = false; submitBtn.title = ''; }
  // Hide forwarding notice
  const fwdNotice = qs('forwarding-notice');
  if (fwdNotice) fwdNotice.style.display = 'none';
}

// â”€â”€ Submit log mail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function submitLogMail() {
  if (STATE.submitting) return;
  const btn       = qs('log-submit-btn');
  const isSpecial = qs('tog-special') && qs('tog-special').classList.contains('on');
  const pc        = STATE.logPlanCard;

  if (!pc && !isSpecial) { toast('Please select a recipient first', 'error'); return; }
  if (isSpecial) {
    const spName = qs('log-special-name') ? qs('log-special-name').value.trim() : '';
    if (!spName) { toast('Please enter the recipient name from the envelope', 'error'); return; }
  }

  const isConfidential = qs('tog-confidential') && qs('tog-confidential').classList.contains('on');
  const type           = qs('log-type') ? qs('log-type').value : 'letter';
  const isScanPlan     = pc && pc.autoFeature === 'scan';
  const scanMandatory  = !isSpecial && isScanPlan && type === 'letter' && !isConfidential;
  const scanUrl        = getScanValue();
  if (scanMandatory && !scanUrl) {
    toast('Scanned file is required for scan plans â€” paste a URL or upload a file', 'error');
    return;
  }

  const isOversized = qs('tog-oversized') ? qs('tog-oversized').classList.contains('on') : false;

  STATE.submitting = true;
  if (btn) { btn.disabled = true; btn.innerHTML = '<span class="btn-spinner"></span> Logging...'; }

  try {
    const result = await apiPost({
      action:            'logMail',
      uuid:              STATE.uuid,
      planCardId:        isSpecial ? '' : (pc ? pc.planCardId     : ''),
      clientId:          isSpecial ? '' : (pc ? pc.clientId       : ''),
      subscriptionId:    isSpecial ? '' : (pc ? pc.subscriptionId : ''),
      locationId:        STATE.access.locationId,
      recipientId:       isSpecial ? '' : (pc ? pc.recipientId || '' : ''),
      recipientName:     isSpecial ? ((qs('log-special-name') ? qs('log-special-name').value.trim() : '') || 'SPECIAL CASE') : (pc ? pc.name || '' : ''),
      senderName:        qs('log-sender')        ? qs('log-sender').value.trim()        : '',
      type:              type,
      confidential:      isConfidential,
      oversizedPickup:   qs('tog-oversized') ? qs('tog-oversized').classList.contains('on') : false,
      specialCase:       isSpecial,
      specialCaseReason: isSpecial ? (qs('log-special-reason') ? qs('log-special-reason').value : '') : '',
      physicalLocation:  qs('log-location')      ? qs('log-location').value.trim()      : '',
      scanImageUrl:      scanUrl,
      scanExpiresAt:     scanUrl ? getScanExpiresAt() : null,
      noteToClient:      qs('log-note-client')   ? qs('log-note-client').value          : '',
      noteInternal:      qs('log-note-internal') ? qs('log-note-internal').value        : '',
      pieceCount:        parseInt(qs('log-pieces') ? qs('log-pieces').value : '1') || 1,
      estimatedWeight:   type === 'parcel' && qs('log-weight')      ? qs('log-weight').value      : '',
      returnAddress:     type === 'parcel' && qs('log-return-addr') ? qs('log-return-addr').value : '',
      oversizedPickup:   isOversized
    });

    if (result.status === 'ok') {
      toast('Mail logged: ' + result.mailId, 'success');
      renderLogForm(qs('log-full') || qs('workspace'));
      STATE.logPlanCard = null;
      await loadTasks();
    } else {
      throw new Error(result.message || 'Logging failed');
    }
  } catch(err) {
    toast(err.message, 'error');
  } finally {
    STATE.submitting = false;
    if (btn) { btn.disabled = false; btn.innerHTML = 'Log Mail'; }
  }
}


// â”€â”€ Resolve task â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function resolveTask(taskId) {
  const note = qs('resolve-note') ? qs('resolve-note').value : '';
  try {
    const result = await apiPost({
      action:         'resolveTask',
      uuid:           STATE.uuid,
      taskId:         taskId,
      resolutionNote: note
    });
    if (result.status === 'ok') {
      toast('Task resolved', 'success');
      STATE.selectedTask = null;
      await loadTasks();
      renderWorkspace();
    } else {
      throw new Error(result.message || 'Failed');
    }
  } catch(err) {
    toast(err.message, 'error');
  }
}

async function snoozePrompt(taskId) {
  const d = await appPrompt({ title: 'Snooze Task', message: 'Enter the date to snooze until:', placeholder: 'YYYY-MM-DD', required: true, confirmLabel: 'Snooze' });
  if (d) snoozeTask(taskId, d);
}

async function snoozeTask(taskId, until) {
  try {
    await apiPost({ action:'snoozeTask', uuid:STATE.uuid, taskId, snoozeUntil:until });
    toast('Task snoozed until ' + until);
    await loadTasks();
    renderWorkspace();
  } catch(e) { toast(e.message, 'error'); }
}

function jumpToMailLog(mailId) {
  toast('Mail ID: ' + mailId + ' â€” full mail log view coming soon.');
}

// â”€â”€ Staff Mail Log View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderStaffMailLog(container) {
  container.innerHTML = `
    <div style="max-width:960px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
        <div style="font-family:'DM Serif Display',serif;font-size:20px">Mail Log</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="text" id="ml-search" placeholder="Search name, sender, email, phone..."
            style="padding:7px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:13px;width:200px;font-family:inherit"
            oninput="filterStaffMailLog(this.value)">
          <div style="display:flex;gap:0;border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;background:var(--white)">
            <button id="mlv-active"   onclick="setMailView('active')"   style="padding:6px 12px;font-size:12px;font-weight:600;border:none;background:var(--blue);color:white;cursor:pointer">Active</button>
            <button id="mlv-all"      onclick="setMailView('all')"      style="padding:6px 12px;font-size:12px;border:none;background:none;color:var(--ink-3);cursor:pointer">All</button>
            <button id="mlv-released" onclick="setMailView('released')" style="padding:6px 12px;font-size:12px;border:none;background:none;color:var(--ink-3);cursor:pointer">Released</button>
          </div>
          <button id="ml-refresh-btn" class="btn btn-secondary btn-sm" data-refresh-label="ml-last-refreshed" onclick="animRefresh('ml-refresh-btn', loadStaffMailLog)">â†»</button>
          <span id="ml-last-refreshed" style="font-size:11px;color:var(--ink-4)"></span>
        </div>
      </div>
      <div id="ml-list"><div class="empty-pane" style="background:var(--white);border:1px solid var(--border);border-radius:var(--radius);min-height:200px"><div class="empty-icon">â³</div><div class="empty-title">Loading...</div></div></div>
    </div>`;
  await loadStaffMailLog();
}

let _allStaffMail = [];
let _mailView = 'active'; // 'active' | 'all' | 'released'

function setMailView(v) {
  _mailView = v;
  ['active','all','released'].forEach(n => {
    const b = qs('mlv-' + n);
    if (!b) return;
    b.style.background = n === v ? 'var(--blue)' : 'none';
    b.style.color       = n === v ? 'white' : 'var(--ink-3)';
  });
  filterStaffMailLog(qs('ml-search') ? qs('ml-search').value : '');
}

async function loadStaffMailLog() {
  const el = qs('ml-list');
  if (el) el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--ink-4);font-size:13px">Loading...</div>';
  try {
    const data = await api(`uuid=${STATE.uuid}&action=getMailLogStaff&limit=200`);
    _allStaffMail = data.mailLog || [];
    setMailView(_mailView);
  } catch(e) {
    if (qs('ml-list')) qs('ml-list').innerHTML = '<div style="padding:20px;text-align:center;color:var(--red)">Failed to load: ' + e.message + '</div>';
  }
}

function filterStaffMailLog(query) {
  const q = (query || '').toLowerCase();
  const ACTIVE_STATUSES   = ['arrived','scanned','stored','forwarding_pending'];
  const RELEASED_STATUSES = ['picked_up','forwarded','shredded','discarded','return_to_sender'];
  let filtered = _allStaffMail.filter(m => {
    // Exclude unassigned special cases â€” they belong in Exceptions tab
    const isSC = m.specialCase === 'TRUE' || m.specialCase === true;
    if (isSC && !m.recipientId) return false;
    if (_mailView === 'active')   { if (!ACTIVE_STATUSES.includes(m.status))   return false; }
    if (_mailView === 'released') { if (!RELEASED_STATUSES.includes(m.status)) return false; }
    if (!q) return true;
    // Search: name, sender, planCardId, mailId, location, clientEmail, clientPhone
    return [m.recipientName, m.senderName, m.planCardId, m.mailId, m.physicalLocation,
            m.clientEmail||'', m.clientPhone||'']
      .join(' ').toLowerCase().includes(q);
  });
  // Sort: active by due date ASC (soonest first), released by loggedAt DESC
  filtered.sort((a, b) => {
    const aAct = ACTIVE_STATUSES.includes(a.status);
    const bAct = ACTIVE_STATUSES.includes(b.status);
    if (aAct && bAct) {
      const aDue = a.storageDueDate ? new Date(a.storageDueDate) : new Date('9999-12-31');
      const bDue = b.storageDueDate ? new Date(b.storageDueDate) : new Date('9999-12-31');
      return aDue - bDue;
    }
    if (aAct && !bAct) return -1;
    if (!aAct && bAct) return 1;
    return new Date(b.loggedAt) - new Date(a.loggedAt);
  });
  renderStaffMailList(filtered);
}

function renderStaffMailList(mailLog) {
  const el = qs('ml-list');
  if (!el) return;

  if (!mailLog.length) {
    const emptyMsg = _mailView === 'active' ? 'No active mail â€” all clear!' : 'Nothing to show.';
    const emptyIcon = _mailView === 'active' ? 'âœ…' : 'ğŸ“­';
    el.innerHTML = `<div class="empty-pane" style="background:var(--white);border:1px solid var(--border);border-radius:var(--radius);min-height:160px"><div class="empty-icon">${emptyIcon}</div><div class="empty-title">${emptyMsg}</div></div>`;
    return;
  }

  const ACTIVE_STATUSES = ['arrived','scanned','stored','forwarding_pending'];
  const statusColor = {
    arrived:'var(--blue)', scanned:'var(--green)', stored:'var(--amber)',
    forwarded:'var(--green)', picked_up:'var(--ink-4)', shredded:'var(--ink-4)',
    forwarding_pending:'var(--blue)', discarded:'var(--ink-4)', return_to_sender:'var(--ink-4)'
  };
  const statusLabel = {
    arrived:'Arrived', scanned:'Scanned', stored:'Stored',
    forwarded:'Forwarded', picked_up:'Picked Up', shredded:'Shredded',
    forwarding_pending:'Fwd Soon', discarded:'Discarded', return_to_sender:'Returned'
  };

  const hasForwardable = _mailView !== 'released' &&
    mailLog.some(m => m.forwardingEligible === 'TRUE' && ACTIVE_STATUSES.includes(m.status));

  el.innerHTML = `
    ${hasForwardable ? `
    <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--blue-bg);border:1px solid rgba(26,74,122,0.15);border-radius:var(--radius);margin-bottom:10px">
      <span style="font-size:12px;color:var(--blue)">ğŸ“¬ <strong id="fwd-count">0</strong> selected for forwarding</span>
      <button class="btn btn-sm" style="background:var(--blue);color:white;border:none;margin-left:auto" onclick="openForwardModal()" id="fwd-btn" disabled>Forward Selected â†’</button>
      <button class="btn btn-secondary btn-sm" onclick="selectAllForwardable()">Select All</button>
    </div>` : ''}
    <div style="background:var(--white);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">
      ${mailLog.map((m, idx) => {
        const isParcel      = m.type === 'parcel';
        const isActive      = ACTIVE_STATUSES.includes(m.status);
        const isForwardable = m.forwardingEligible === 'TRUE' && isActive;
        const isReleased    = !isActive;
        const days = m.storageDueDate ? Math.ceil((new Date(m.storageDueDate) - new Date()) / (1000*60*60*24)) : null;
        const daysColor = days === null ? '' : days < 0 ? 'var(--red)' : days <= 2 ? 'var(--red)' : days <= 5 ? 'var(--amber)' : 'var(--ink-4)';
        const daysBadge = isActive && days !== null
          ? `<span style="font-size:10px;font-weight:600;color:${daysColor}">â° ${days < 0 ? Math.abs(days)+'d over' : days+'d left'}</span>` : '';
        const fwdBadge  = isForwardable
          ? `<span style="font-size:10px;background:var(--blue-bg);color:var(--blue);padding:1px 6px;border-radius:10px;font-weight:600">FWD</span>` : '';
        const confBadge = (m.confidential === 'TRUE' || m.confidential === true)
          ? `<span style="font-size:10px;background:#FFEDED;color:var(--red);padding:1px 6px;border-radius:10px;font-weight:600">CONF</span>` : '';
        const tempBadge = m.recipientName && m.notes && (m.notes||'').startsWith('TEMP:')
          ? `<span style="font-size:10px;background:var(--amber-bg);color:var(--amber);padding:1px 6px;border-radius:10px;font-weight:600">TEMP</span>` : '';
        const isSpecialCase = m.specialCase === 'TRUE' || m.specialCase === true;
        const scBadge = isSpecialCase
          ? `<span style="font-size:10px;background:#FFF3E0;color:#E65100;padding:1px 6px;border-radius:10px;font-weight:600;border:1px solid #FFCC80">âš  SPECIAL CASE</span>` : '';
        // Release is only allowed if item has a real recipient+planCard AND is not a special case
        const canRelease = isActive && !isSpecialCase && m.recipientId && m.planCardId && m.clientId;
        const safeMailId   = encodeURIComponent(m.mailId||'');
        const safeRecip    = encodeURIComponent(m.recipientName||'');
        const safePlanCard = encodeURIComponent(m.planCardId||'');
        const safeStatus   = encodeURIComponent(m.accessStatus||'');
        const sc = statusColor[m.status] || 'var(--ink-3)';
        const sl = statusLabel[m.status] || m.status;

        return `
          <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);${isReleased ? 'opacity:0.7;background:var(--bg)' : 'background:var(--white)'}">
            ${isForwardable
              ? `<input type="checkbox" class="fwd-checkbox" data-mailid="${m.mailId}" onchange="onForwardCheckChange()" style="width:16px;height:16px;cursor:pointer;flex-shrink:0;accent-color:var(--blue)">`
              : `<div style="width:16px;flex-shrink:0"></div>`}
            <div style="width:36px;flex-shrink:0;text-align:center">
              <div style="font-size:16px">${isParcel?'ğŸ“¦':'âœ‰ï¸'}</div>
              <div style="font-size:9px;font-weight:600;color:${isParcel?'var(--amber)':'var(--blue)'};text-transform:uppercase">${isParcel?'Parcel':'Mail'}</div>
            </div>
            <div style="flex:1;min-width:0">
              <div style="font-size:13px;font-weight:500;display:flex;align-items:center;gap:5px;flex-wrap:wrap">
                ${isSpecialCase ? '(Unassigned)' : (m.recipientName || 'â€”')}
                ${confBadge}${fwdBadge}${tempBadge}${scBadge}${daysBadge}
              </div>
              <div style="font-size:11px;color:var(--ink-4);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                ${m.senderName ? 'From: '+m.senderName+' Â· ' : ''}${new Date(m.loggedAt).toLocaleDateString('en-CA',{month:'short',day:'numeric'})}${m.physicalLocation ? ' Â· ğŸ“'+m.physicalLocation : ''}${m.trackingLink ? ' Â· <a href="'+m.trackingLink+'" target="_blank" style="color:var(--blue)">Track â†—</a>' : ''}
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
              <span style="font-size:11px;font-weight:600;color:${sc};background:rgba(0,0,0,0.04);padding:2px 8px;border-radius:10px;white-space:nowrap">${sl}</span>
              ${canRelease
                ? `<button class="btn btn-success btn-sm" onclick="openReleaseModal('${safeMailId}','${safeRecip}','${safePlanCard}','${safeStatus}')">Release</button>`
                : isActive
                  ? `<button class="btn btn-secondary btn-sm" disabled title="${isSpecialCase ? 'Assign recipient first' : 'Missing account info'}" style="opacity:0.5;cursor:not-allowed">Release</button>`
                  : `<button class="btn btn-secondary btn-sm" onclick="openMailDetail('${m.mailId}')">View</button>`}
              ${(m.status !== 'picked_up' && m.status !== 'deleted' && m.status !== 'forwarded' && m.status !== 'shredded' && m.status !== 'discarded')
                ? `<button class="btn btn-secondary btn-sm" title="Edit mail item" onclick="openEditMailModal('${safeMailId}')" style="display:inline-flex;align-items:center;gap:3px;padding:3px 8px">
                    <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M11.5 2.5a2.121 2.121 0 013 3L5 15H1v-4L11.5 2.5z"/>
                    </svg>
                    Edit
                   </button>
                   <button class="btn btn-secondary btn-sm" title="Delete mail item" style="color:var(--red);padding:3px 8px" onclick="confirmDeleteMail('${safeMailId}','${safeRecip}')">âœ• Delete</button>`
                : ''}
            </div>
          </div>`;
      }).join('')}
    </div>`;
}


function onForwardCheckChange() {
  const checked = document.querySelectorAll('.fwd-checkbox:checked');
  const btn = qs('fwd-btn'), cnt = qs('fwd-count');
  if (btn) btn.disabled = checked.length === 0;
  if (cnt) cnt.textContent = checked.length;
}
function selectAllForwardable() {
  document.querySelectorAll('.fwd-checkbox').forEach(cb => { cb.checked = true; });
  onForwardCheckChange();
}

function openForwardModal() {
  const checked = document.querySelectorAll('.fwd-checkbox:checked');
  const mailIds = Array.from(checked).map(cb => cb.dataset.mailid);
  if (!mailIds.length) return;
  const existing = qs('forward-modal'); if (existing) existing.remove();
  const modal = document.createElement('div');
  modal.id = 'forward-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);padding:24px;max-width:460px;width:100%;box-shadow:var(--shadow-md);max-height:90vh;overflow-y:auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif;font-size:18px">ğŸ“¬ Forward ${mailIds.length} Item${mailIds.length>1?'s':''}</div>
        <button onclick="qs('forward-modal').remove()" style="background:none;font-size:18px;color:var(--ink-3)">âœ•</button>
      </div>
      <div class="form-group">
        <label>Tracking URL <span style="color:var(--ink-4);text-transform:none;font-weight:400">(visible to client)</span></label>
        <input type="text" id="fwd-tracking" placeholder="https://www.canadapost-postescanada.ca/track-reperage/...">
      </div>
      <div class="form-group">
        <label>Forwarding Cost (CAD) <span style="color:var(--ink-4);text-transform:none;font-weight:400">(staff only)</span></label>
        <input type="text" id="fwd-cost" placeholder="e.g. 12.50">
      </div>
      <div class="form-group">
        <label>Notes <span style="color:var(--ink-4);text-transform:none;font-weight:400">(optional)</span></label>
        <textarea id="fwd-notes" style="width:100%;padding:8px 11px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px;resize:vertical;min-height:60px" placeholder="e.g. Shipped via Canada Post Xpresspost..."></textarea>
      </div>
      <div style="background:var(--amber-bg);border-radius:var(--radius-sm);padding:8px 12px;font-size:12px;color:var(--amber);margin-bottom:16px">
        âš ï¸ Forwarding cost is staff-only and not auto-billed. Invoice separately if needed.
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" style="flex:1" id="fwd-submit-btn" onclick="submitBulkForward(${JSON.stringify(mailIds)})">âœ“ Confirm Forward</button>
        <button class="btn btn-secondary" onclick="qs('forward-modal').remove()">Cancel</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target===modal) modal.remove(); });
}

async function submitBulkForward(mailIds) {
  const trackingLink   = qs('fwd-tracking') ? qs('fwd-tracking').value.trim() : '';
  const forwardingCost = qs('fwd-cost')     ? qs('fwd-cost').value.trim()     : '';
  const forwardNotes   = qs('fwd-notes')    ? qs('fwd-notes').value.trim()    : '';
  const btn = qs('fwd-submit-btn');
  if (btn) { btn.disabled=true; btn.innerHTML='<span class="btn-spinner"></span> Forwarding...'; }
  try {
    const result = await apiPost({ action:'bulkForwardMail', uuid:STATE.uuid, mailIds:JSON.stringify(mailIds), trackingLink, forwardingCost, forwardNotes });
    if (result.status==='ok') {
      qs('forward-modal').remove();
      const ok  = (result.results||[]).filter(r=>r.status==='ok').length;
      const err = (result.results||[]).filter(r=>r.status==='error').length;
      toast(`${ok} item${ok>1?'s':''} forwarded${err?', '+err+' failed':''}`, ok>0?'success':'error');
      await loadStaffMailLog();
    } else throw new Error(result.message||'Forward failed');
  } catch(err) {
    toast(err.message,'error');
    if (btn) { btn.disabled=false; btn.innerHTML='âœ“ Confirm Forward'; }
  }
}


// â”€â”€ Release Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openReleaseModal(mailId, recipientName, planCardId, accessStatus) {
  // Decode URI-encoded params (passed safely from onclick attributes)
  mailId        = decodeURIComponent(mailId        || '');
  recipientName = decodeURIComponent(recipientName || '');
  planCardId    = decodeURIComponent(planCardId    || '');
  accessStatus  = decodeURIComponent(accessStatus  || '');
  const existing = qs('release-modal');
  if (existing) existing.remove();

  // Block if payment issue
  if (accessStatus && !['ACTIVE','CANCELED_WITH_ACCESS'].includes(accessStatus)) {
    const modal = document.createElement('div');
    modal.id = 'release-modal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
    modal.innerHTML = `<div style="background:var(--white);border-radius:var(--radius);padding:24px;max-width:400px;width:100%;box-shadow:var(--shadow-md)">
      <div style="font-size:18px;font-family:'DM Serif Display',serif;margin-bottom:12px">â›” Release Blocked</div>
      <div style="font-size:13px;color:var(--ink-2);margin-bottom:16px">
        This mailbox has an outstanding payment issue (<strong>${accessStatus.replace(/_/g,' ')}</strong>).
        Mail cannot be released until payment is resolved.<br><br>A notification has been sent to the client.
      </div>
      <button class="btn btn-secondary btn-full" onclick="qs('release-modal').remove()">Close</button>
    </div>`;
    document.body.appendChild(modal);
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
    apiPost({ action:'notifyNonPayment', uuid:STATE.uuid, planCardId, mailId }).catch(()=>{});
    return;
  }

  // Fetch active agents for this plan card
  let agents = [];
  try {
    const data = await api(`uuid=${STATE.uuid}&action=getAgentsForPlanCard&planCardId=${planCardId}`);
    agents = data.agents || [];
  } catch(e) {}

  const agentOptions = agents.length === 0
    ? `<div style="padding:12px;background:var(--amber-bg);border-radius:var(--radius-sm);font-size:13px;color:var(--amber)">
        âš ï¸ No authorized pickup agents on file. Client needs to add agents from their dashboard before mail can be released.
      </div>`
    : `<div style="display:flex;flex-direction:column;gap:8px" id="agent-options">
        ${agents.map(a => `
          <label style="display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:background 0.1s"
            onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background=''">
            <input type="radio" name="release-agent" value="${a.agentId}" style="flex-shrink:0">
            <div>
              <div style="font-size:13px;font-weight:500">${a.name}</div>
              <div style="font-size:11px;color:var(--ink-4)">${a.idType?a.idType+(a.idLast4?' Â·Â·Â·'+a.idLast4:''):''} ${a.phone?'Â· '+a.phone:''}</div>
            </div>
          </label>`).join('')}
      </div>`;

  const modal = document.createElement('div');
  modal.id = 'release-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);padding:24px;max-width:440px;width:100%;box-shadow:var(--shadow-md);max-height:90vh;overflow-y:auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif;font-size:18px">Release Mail</div>
        <button onclick="qs('release-modal').remove()" style="background:none;font-size:18px;color:var(--ink-3);cursor:pointer">âœ•</button>
      </div>
      <div style="font-size:13px;color:var(--ink-3);margin-bottom:16px">
        Releasing mail for <strong>${recipientName}</strong>. Select the authorized agent collecting this item.
      </div>
      ${agentOptions}
      ${agents.length > 0 ? `
      <div style="margin-top:16px">
        <label style="font-size:11px;font-weight:500;color:var(--ink-3);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:5px">Release Notes <span style="color:var(--ink-4);text-transform:none">(optional)</span></label>
        <textarea id="release-notes" style="width:100%;padding:8px 11px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px;resize:vertical;min-height:60px" placeholder="e.g. ID verified, signed release form..."></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button class="btn btn-success" style="flex:1" onclick="submitRelease('${mailId}','${planCardId}')">âœ“ Confirm Release</button>
        <button class="btn btn-secondary" onclick="qs('release-modal').remove()">Cancel</button>
      </div>` : `
      <button class="btn btn-secondary btn-full" style="margin-top:16px" onclick="qs('release-modal').remove()">Close</button>`}
    </div>`;

  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

async function submitRelease(mailId, planCardId) {
  const selected = document.querySelector('input[name="release-agent"]:checked');
  if (!selected) { toast('Please select a pickup agent', 'error'); return; }

  const btn = document.querySelector('#release-modal .btn-success');
  if (btn) { btn.disabled = true; btn.innerHTML = '<span class="btn-spinner"></span> Releasing...'; }

  try {
    const result = await apiPost({
      action:       'releaseMail',
      uuid:         STATE.uuid,
      mailId:       mailId,
      agentId:      selected.value,
      releaseNotes: qs('release-notes') ? qs('release-notes').value : ''
    });

    if (result.status === 'ok') {
      qs('release-modal').remove();
      toast('Mail released successfully', 'success');
      // Refresh mail log
      await loadStaffMailLog();
      // Refresh tasks
      await loadTasks();
      if (STATE.view === 'split') renderTasksPane();
    } else {
      throw new Error(result.message || 'Release failed');
    }
  } catch(err) {
    toast(err.message, 'error');
    if (btn) { btn.disabled = false; btn.innerHTML = 'âœ“ Confirm Release'; }
  }
}

function openMailDetail(mailId) {
  mailId = decodeURIComponent(mailId || '');
  // Find in cached list
  const m = _allStaffMail.find(x => x.mailId === mailId);
  if (!m) { toast('Mail item not found'); return; }

  const existing = qs('mail-detail-modal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'mail-detail-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);max-width:460px;width:100%;box-shadow:var(--shadow-md);display:flex;flex-direction:column;max-height:85vh">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border);flex-shrink:0">
        <div style="font-family:'DM Serif Display',serif;font-size:17px">${m.type === 'parcel' ? 'ğŸ“¦' : 'âœ‰ï¸'} Mail Detail</div>
        <button onclick="qs('mail-detail-modal').remove()" style="background:none;font-size:18px;color:var(--ink-3)">âœ•</button>
      </div>
      <div style="overflow-y:auto;flex:1;padding:0 20px">
      <div style="display:flex;flex-direction:column;gap:0">
        ${[
        ['Mail ID',           m.mailId],
        ['Recipient',         m.recipientName || 'â€”'],
        ['Plan Card',         m.planCardId || 'â€”'],
        ['Client ID',         m.clientId || 'â€”'],
        ['Sender',            m.senderName || 'â€”'],
        ['Type',              m.type === 'parcel' ? 'ğŸ“¦ Parcel' : 'âœ‰ï¸ Mail / Letter'],
        ['Status',            m.status.replace(/_/g,' ')],
        ['Confidential',      m.confidential==='TRUE'||m.confidential===true ? 'ğŸ”’ Yes' : 'No'],
        ['Special Case',      m.specialCase==='TRUE'||m.specialCase===true ? 'âš ï¸ Yes' : 'No'],
        ['Special Case Reason',m.specialCaseReason || 'â€”'],
        ['Physical Location', m.physicalLocation || 'â€”'],
        ['Scanned File',       m.scanImageUrl ? '<a href="'+m.scanImageUrl+'" target="_blank" style="color:var(--blue)">View â†—</a>' : 'â€”'],
        ['Note to Client',    m.noteToClient || 'â€”'],
        ['Internal Note',     m.noteInternal || 'â€”'],
        ['Logged At',         m.loggedAt],
        ['Logged By',         m.loggedBy || 'â€”'],
        ['Storage Start',     m.storageStartDate || 'â€”'],
        ['Storage Due',       m.storageDueDate || 'â€”'],
        ['Piece Count',       m.pieceCount || 'â€”'],
        ['Released To',       m.releasedTo || 'â€”'],
        ['Released At',       m.releasedAt || 'â€”'],
        ['Released By',       m.releasedBy || 'â€”'],
        ['Forwarding Eligible',m.forwardingEligible==='TRUE'||m.forwardingEligible===true ? 'Yes' : 'No'],
        ['Edited At',         m.editedAt || 'â€”'],
        ['Edited By',         m.editedBy || 'â€”'],
      ].map(([k,v]) => `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px;gap:12px">
          <span style="color:var(--ink-3);flex-shrink:0;min-width:130px">${k}</span>
          <span style="font-weight:500;text-align:right;word-break:break-all">${v}</span>
        </div>`).join('')}
      </div>
      </div>
      <div style="padding:16px 20px;border-top:1px solid var(--border);flex-shrink:0">
        <button class="btn btn-secondary btn-full" onclick="qs('mail-detail-modal').remove()">Close</button>
      </div>
    </div>`;

  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

// â”€â”€ Special Case Release Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSpecialCaseReleaseModal(mailId) {
  const m = _allStaffMail.find(x => x.mailId === mailId);
  if (!m) return;

  const existing = qs('special-release-modal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'special-release-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);padding:24px;max-width:420px;width:100%;box-shadow:var(--shadow-md)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif;font-size:18px">ğŸ” Special Case Item</div>
        <button onclick="qs('special-release-modal').remove()" style="background:none;font-size:18px;color:var(--ink-3);cursor:pointer">âœ•</button>
      </div>
      <div style="font-size:13px;color:var(--ink-3);margin-bottom:14px">
        This item has no recipient assigned. You can:
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-secondary" onclick="qs('special-release-modal').remove();openAssignRecipientModal('${mailId}')">
          ğŸ“‹ Assign to Recipient (starts storage clock)
        </button>
        <button class="btn btn-secondary" onclick="discardSpecialCase('${mailId}')">
          ğŸ—‘ Mark as Discarded
        </button>
        <button class="btn btn-secondary" onclick="qs('special-release-modal').remove()">
          Cancel â€” keep in queue
        </button>
      </div>
      <div style="font-size:11px;color:var(--ink-4);margin-top:14px">
        Storage clock starts from the date of recipient assignment.
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

async function discardSpecialCase(mailId) {
  try {
    await apiPost({ action: 'updateMailStatus', uuid: STATE.uuid, mailId, status: 'discarded', note: 'Staff discarded unmatched special case item' });
    qs('special-release-modal') && qs('special-release-modal').remove();
    toast('Item marked as discarded', 'success');
    await loadStaffMailLog();
  } catch(e) { toast(e.message, 'error'); }
}

async function renderExceptionsView(container) {
  container.innerHTML = `
    <div style="max-width:900px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif;font-size:20px">âš  Exceptions</div>
        <div style="display:flex;align-items:center;gap:6px">
          <span id="exc-last-refreshed" style="font-size:11px;color:var(--ink-4)"></span>
          <button id="exc-refresh-btn" class="btn btn-secondary btn-sm" data-refresh-label="exc-last-refreshed" onclick="animRefresh('exc-refresh-btn', loadExceptions)">â†» Refresh</button>
        </div>
      </div>
      <div style="font-size:13px;color:var(--ink-3);margin-bottom:16px">
        Mail items with no matched recipient or flagged as special case. Assign to a recipient or discard.
      </div>
      <div id="exc-list"><div style="text-align:center;padding:40px;color:var(--ink-4)">Loading...</div></div>
    </div>`;
  await loadExceptions();
}

async function loadExceptions() {
  const el = qs('exc-list');
  if (!el) return;
  try {
    const data = await api(`uuid=${STATE.uuid}&action=getExceptions&limit=200`);
    renderExceptionsList(data.exceptions || []);
  } catch(e) {
    if (el) el.innerHTML = `<div style="color:var(--red);padding:20px">Error loading exceptions: ${e.message}</div>`;
  }
}


function renderExceptionsList(items) {
  const el = qs('exc-list');
  if (!el) return;
  if (!items.length) {
    el.innerHTML = `<div style="text-align:center;padding:48px;background:var(--white);border:1px solid var(--border);border-radius:var(--radius)"><div style="font-size:32px;margin-bottom:12px">âœ…</div><div style="font-size:14px;font-weight:500">No exceptions</div><div style="font-size:13px;color:var(--ink-4)">All mail items have been assigned.</div></div>`;
    return;
  }
  el.innerHTML = items.map(m => {
    const isParcel = m.type === 'parcel';
    const days = m.storageDueDate ? Math.ceil((new Date(m.storageDueDate)-new Date())/(1000*60*60*24)) : null;
    const daysHtml = days!==null ? `<span style="font-size:11px;color:${days<0?'var(--red)':days<=5?'var(--amber)':'var(--ink-4)'};font-weight:600">â° ${days<0?Math.abs(days)+'d overdue':days+'d left'}</span>` : '';
    // How long it's been sitting as special case
    const loggedDate = new Date(m.loggedAt);
    const daysStored = Math.floor((new Date() - loggedDate) / (1000*60*60*24));
    const storedColor = daysStored >= 20 ? 'var(--red)' : daysStored >= 10 ? 'var(--amber)' : 'var(--ink-3)';
    const storedLabel = daysStored === 0 ? 'logged today' : daysStored === 1 ? '1 day in exceptions' : `${daysStored} days in exceptions`;

    return `
      <div class="exc-item">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px">
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap">
              <span style="font-size:16px">${isParcel?'ğŸ“¦':'âœ‰ï¸'}</span>
              <span style="font-size:13px;font-weight:600">${m.mailId}</span>
              <span class="pill ${m.status}">${m.status.replace(/_/g,' ')}</span>
              <span style="font-size:11px;font-weight:600;color:${storedColor}">â± ${storedLabel}</span>
              ${daysHtml}
            </div>
            <div style="font-size:13px;color:var(--ink-2);margin-bottom:2px">
              ${m.senderName?'From: <strong>'+m.senderName+'</strong> Â· ':''}Logged ${loggedDate.toLocaleDateString('en-CA',{month:'short',day:'numeric',year:'numeric'})}
            </div>
            <div style="font-size:12px;color:var(--amber);margin-top:4px">âš  ${m.specialCaseReason||'No recipient matched'}</div>
            ${m.physicalLocation?`<div style="font-size:11px;color:var(--ink-4);margin-top:2px">ğŸ“ ${m.physicalLocation}</div>`:''}
          </div>
        </div>
        <div class="exc-actions">
          <button class="btn btn-primary btn-sm" onclick="openAssignModal('${m.mailId}')">Assign to Recipient â†’</button>
          <button class="btn btn-secondary btn-sm" onclick="openDiscardModal('${m.mailId}')">Discard</button>
          <button class="btn btn-secondary btn-sm" onclick="openMailDetail('${m.mailId}')">View Detail</button>
        </div>
      </div>`;
  }).join('');
}

function openAssignModal(mailId) {
  const existing = qs('assign-modal'); if (existing) existing.remove();
  const modal = document.createElement('div');
  modal.id = 'assign-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9000;padding:20px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);padding:24px;max-width:460px;width:100%;box-shadow:var(--shadow-md)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div style="font-family:'DM Serif Display',serif;font-size:18px">Assign Mail Item</div>
        <button onclick="qs('assign-modal').remove()" style="background:none;font-size:18px;color:var(--ink-3)">âœ•</button>
      </div>
      <div style="font-size:13px;color:var(--ink-3);margin-bottom:16px">Search for the recipient this mail belongs to.</div>
      <div class="form-group" style="position:relative">
        <label>Search Recipient</label>
        <input type="text" id="assign-search" placeholder="Type name or company..." autocomplete="off" oninput="searchForAssign(this.value)">
        <div id="assign-results" style="display:none;position:absolute;top:100%;left:0;right:0;background:var(--white);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:var(--shadow-md);z-index:10;max-height:200px;overflow-y:auto"></div>
      </div>
      <div id="assign-selected" style="display:none;background:var(--bg);border-radius:var(--radius-sm);padding:10px 12px;margin-bottom:14px;font-size:13px">
        <div style="font-weight:500" id="assign-sel-name"></div>
        <div style="font-size:11px;color:var(--ink-4)" id="assign-sel-sub"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn btn-primary" style="flex:1" id="assign-submit-btn" onclick="submitAssign('${mailId}')">Assign</button>
        <button class="btn btn-secondary" onclick="qs('assign-modal').remove()">Cancel</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target===modal) modal.remove(); });
}

let _assignTarget = null;

function searchForAssign(query) {
  const results = qs('assign-results');
  if (!results || !query) { if(results) results.style.display='none'; return; }
  const q = query.toLowerCase();
  const hits = (_recipientCache||[]).filter(r => [r.name,r.companyName,r.planCardId].join(' ').toLowerCase().includes(q)).slice(0,8);
  results.style.display = 'block';
  if (!hits.length) { results.innerHTML=`<div style="padding:10px 12px;color:var(--ink-4);font-size:13px">No matches</div>`; return; }
  results.innerHTML = hits.map(r => {
    const data = JSON.stringify({recipientId:r.recipientId,name:r.name,companyName:r.companyName||'',planCardId:r.planCardId,clientId:r.clientId,subscriptionId:r.subscriptionId||''}).replace(/"/g,'&quot;');
    return `<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--border);font-size:13px" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background=''" onclick="selectForAssign(${data})">
      <div style="font-weight:500">${r.name}${r.companyName?' Â· <span style="color:var(--ink-4)">'+r.companyName+'</span>':''}</div>
      <div style="font-size:11px;color:var(--ink-4)">${r.planName||r.planCardId}</div>
    </div>`;
  }).join('');
}

function selectForAssign(data) {
  _assignTarget = data;
  const results = qs('assign-results'); if (results) results.style.display='none';
  const search  = qs('assign-search');  if (search)  search.value = data.name;
  const sel = qs('assign-selected');
  if (sel) {
    sel.style.display = 'block';
    const n = qs('assign-sel-name'), sub = qs('assign-sel-sub');
    if (n) n.textContent = data.name + (data.companyName?' â€” '+data.companyName:'');
    if (sub) sub.textContent = data.planCardId;
  }
}

async function submitAssign(mailId) {
  if (!_assignTarget) { toast('Please select a recipient first','error'); return; }
  const btn = qs('assign-submit-btn');
  if (btn) { btn.disabled=true; btn.textContent='Assigning...'; }
  try {
    const result = await apiPost({ action:'assignMailRecipient', uuid:STATE.uuid, mailId,
      recipientId:_assignTarget.recipientId, recipientName:_assignTarget.name,
      planCardId:_assignTarget.planCardId, clientId:_assignTarget.clientId,
      subscriptionId:_assignTarget.subscriptionId });
    if (result.status==='ok') {
      qs('assign-modal').remove();
      _assignTarget = null;
      // If plan requires scan, prompt for scan URL before dismissing
      if (result.needsScan) {
        const scanUrl = await appPrompt({ title: 'ğŸ” Scan Plan', message: 'This recipient is on a scan plan. Please provide the scanned file URL:', placeholder: 'https://drive.google.com/...', required: true, confirmLabel: 'Save' });
        if (scanUrl && scanUrl.trim()) {
          await apiPost({ action:'editMailItem', uuid:STATE.uuid, mailId, scanImageUrl: scanUrl.trim() });
        }
      }
      toast('Mail assigned â€” now in main mail log', 'success');
      await loadExceptions();
      await loadStaffMailLog();
    } else throw new Error(result.message||'Failed');
  } catch(err) { toast(err.message,'error'); if (btn) { btn.disabled=false; btn.textContent='Assign'; } }
}

async function openDiscardModal(mailId) {
  const reason = await appPrompt({ title: 'Discard Item', message: 'Enter a reason for discarding this mail item:', placeholder: 'e.g. Junk mail, undeliverable...', confirmLabel: 'Discard', confirmClass: 'btn-danger' });
  if (reason === null) return;
  apiPost({ action:'updateMailStatus', uuid:STATE.uuid, mailId, status:'discarded', note:reason })
    .then(r => { if (r.status==='ok') { toast('Item discarded','success'); loadExceptions(); } else toast(r.message||'Failed','error'); })
    .catch(e => toast(e.message,'error'));
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLAN CARDS VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderPlanCardsView(container) {
  container.innerHTML = `
    <div style="max-width:900px;margin:0 auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
        <div style="font-family:'DM Serif Display',serif;font-size:20px">Plan Cards</div>
        <div style="display:flex;align-items:center;gap:6px">
          <span id="pc-last-refreshed" style="font-size:11px;color:var(--ink-4)"></span>
          <button id="pc-refresh-btn" class="btn btn-secondary btn-sm" data-refresh-label="pc-last-refreshed" onclick="animRefresh('pc-refresh-btn', loadPlanCardsView)">â†» Refresh</button>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap">
        <input type="text" id="pc-search" placeholder="Search client, plan, recipient..."
          style="flex:1;min-width:180px;padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;font-family:inherit"
          oninput="filterPlanCards(this.value)">
        <select id="pc-status-filter" onchange="filterPlanCards(qs('pc-search').value)"
          style="padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;font-family:inherit">
          <option value="">All Statuses</option>
          <option value="ACTIVE">Active</option>
          <option value="PAYMENT_REQUIRED">Payment Required</option>
          <option value="CANCELED_WITH_ACCESS">Pending Cancellation</option>
          <option value="CANCELED">Cancelled</option>
          <option value="SUSPENDED">Suspended</option>
        </select>
        <select id="pc-sort" onchange="filterPlanCards(qs('pc-search').value)"
          style="padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:12px;font-family:inherit">
          <option value="name-asc">Client Aâ†’Z</option>
          <option value="name-desc">Client Zâ†’A</option>
          <option value="plan-asc">Plan Name Aâ†’Z</option>
          <option value="recipients-desc">Most Recipients</option>
          <option value="recipients-asc">Fewest Recipients</option>
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
        </select>
      </div>
      <div id="pc-count" style="font-size:11px;color:var(--ink-4);margin-bottom:8px"></div>
      <div id="pc-list"><div style="text-align:center;padding:40px;color:var(--ink-4)">Loading...</div></div>
    </div>`;
  await loadPlanCardsView();
}

let _allPlanCards = [];

async function loadPlanCardsView() {
  const el = qs('pc-list'); if (!el) return;
  try {
    const data = await api(`uuid=${STATE.uuid}&action=getPlanCardsStaff`);
    _allPlanCards = data.planCards || [];
    filterPlanCards(qs('pc-search') ? qs('pc-search').value : '');
  } catch(e) { if(el) el.innerHTML=`<div style="color:var(--red);padding:20px">Error: ${e.message}</div>`; }
}

function filterPlanCards(query) {
  const q      = (query||'').toLowerCase();
  const status = qs('pc-status-filter') ? qs('pc-status-filter').value : '';
  const sort   = qs('pc-sort') ? qs('pc-sort').value : 'name-asc';
  let filtered = _allPlanCards;

  // Status filter
  if (status === 'SUSPENDED') {
    filtered = filtered.filter(pc => pc.accessOverride === 'suspended' || pc.clientAccessOverride === 'suspended');
  } else if (status) {
    filtered = filtered.filter(pc => (pc.accessStatus||'') === status && pc.accessOverride !== 'suspended' && pc.clientAccessOverride !== 'suspended');
  }

  // Text search
  if (q) filtered = filtered.filter(pc =>
    [pc.planCardId,pc.planName,pc.clientId,pc.clientName,pc.clientEmail||'',...(pc.recipients||[]).map(r=>r.name+' '+(r.companyName||'')+' '+(r.email||'')),pc.businessDescription||'',(pc.notes||''),(pc.referralSource||''),(pc.subscriptionId||'')].join(' ').toLowerCase().includes(q)
  );

  // Sort
  filtered = [...filtered].sort((a, b) => {
    switch (sort) {
      case 'name-asc':  return (a.clientName||'').localeCompare(b.clientName||'');
      case 'name-desc': return (b.clientName||'').localeCompare(a.clientName||'');
      case 'plan-asc':  return (a.planName||'').localeCompare(b.planName||'');
      case 'recipients-desc': return (b.recipients||[]).filter(r=>r.status==='active').length - (a.recipients||[]).filter(r=>r.status==='active').length;
      case 'recipients-asc':  return (a.recipients||[]).filter(r=>r.status==='active').length - (b.recipients||[]).filter(r=>r.status==='active').length;
      case 'newest': return (b.createdAt||'').localeCompare(a.createdAt||'');
      case 'oldest': return (a.createdAt||'').localeCompare(b.createdAt||'');
      default: return 0;
    }
  });

  // Count
  const countEl = qs('pc-count');
  if (countEl) {
    const suspended = _allPlanCards.filter(pc => pc.accessOverride === 'suspended' || pc.clientAccessOverride === 'suspended').length;
    const parts = [`${filtered.length} of ${_allPlanCards.length} plans`];
    if (suspended > 0) parts.push(`${suspended} suspended`);
    countEl.textContent = parts.join(' Â· ');
  }

  renderPlanCardsList(filtered);
}

function renderPlanCardsList(planCards) {
  const el = qs('pc-list'); if (!el) return;
  if (!planCards.length) {
    el.innerHTML = `<div style="text-align:center;padding:40px;color:var(--ink-4)">No plan cards found.</div>`;
    return;
  }

  const statusInfo = {
    'ACTIVE':               { cls:'scanned',    label:'Active',              icon:'âœ…' },
    'CANCELED_WITH_ACCESS': { cls:'warning',    label:'Canceling',           icon:'âš ï¸' },
    'PAYMENT_REQUIRED':     { cls:'payment_req',label:'Payment Required',    icon:'â›”' },
    'CANCELED':             { cls:'expired',    label:'Canceled',            icon:'âœ•' },
    'UNKNOWN':              { cls:'stored',     label:'Unknown',             icon:'â€”' }
  };

  // Nicely format ISO dates like "2026-02-22T05:00:00.000Z"
  function fmtPeriodDate(raw) {
    if (!raw) return 'â€”';
    try {
      return new Date(raw).toLocaleDateString('en-CA', { month: 'short', day: 'numeric', year: 'numeric' });
    } catch(e) { return raw; }
  }

  el.innerHTML = planCards.map((pc, i) => {
    const recs      = pc.recipients || [];
    const activeRec = recs.filter(r => r.status === 'active');
    const tempRec   = recs.filter(r => r.status === 'active' && r.notes && r.notes.startsWith('TEMP:'));
    const si        = statusInfo[pc.accessStatus] || statusInfo['UNKNOWN'];
    const planLocked    = pc.accessOverride === 'suspended';
    const accountLocked = pc.clientAccessOverride === 'suspended';
    const isActive  = !planLocked && !accountLocked && (pc.accessStatus === 'ACTIVE' || pc.accessStatus === 'CANCELED_WITH_ACCESS');
    const clientLabel = pc.clientName ? ` <span style="font-weight:400;color:var(--ink-3)">(${pc.clientName})</span>` : '';
    const lockPill = planLocked ? '<span class="pill expired" style="font-size:10px">ğŸ”’ Plan Suspended</span>'
      : accountLocked ? '<span class="pill expired" style="font-size:10px">ğŸ”’ Account Suspended</span>' : '';

    return `
      <div class="pc-card" style="border-left:3px solid ${isActive ? 'var(--green)' : planLocked || accountLocked ? '#9E9E9E' : 'var(--red)'}">
        <div class="pc-card-header" id="pc-hdr-${i}" onclick="togglePcCard(${i})" style="cursor:pointer" title="Click to expand">
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap">
              <span style="font-size:13px;font-weight:600">${pc.planName||pc.planCardId}${clientLabel}</span>
              ${lockPill || `<span class="pill ${si.cls}" style="font-size:10px">${si.icon} ${si.label}</span>`}
            </div>
            <div style="font-size:11px;color:var(--ink-4);display:flex;gap:12px;flex-wrap:wrap">
              <span>${pc.planCardId}</span>
              <span>${activeRec.length} recipient${activeRec.length!==1?'s':''}${tempRec.length ? ` (${tempRec.length} temp)` : ''}</span>
              ${pc.autoFeature === 'ship' ? '<span>ğŸ“¬ Forwarding</span>' : ''}
              ${pc.autoFeature === 'scan' ? '<span>ğŸ” Scan</span>' : ''}
            </div>
          </div>
          <span style="color:var(--ink-4);font-size:14px;flex-shrink:0" id="pc-chevron-${i}">â–¸</span>
        </div>

        <div id="pc-body-${i}" style="display:none" class="pc-card-body" data-pcid="${pc.planCardId}">

          <!-- Lock Controls -->
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px">
            <button class="btn btn-sm ${planLocked ? 'btn-primary' : 'btn-secondary'}"
              onclick="togglePlanLock('${pc.planCardId}',${planLocked})"
              style="${planLocked ? 'background:#D32F2F;border-color:#D32F2F;color:#fff' : ''}"
              title="${planLocked ? 'Unlock this plan' : 'Suspend this plan'}">
              ${planLocked ? 'ğŸ”“ Unlock Plan' : 'ğŸ”’ Suspend Plan'}
            </button>
            <button class="btn btn-sm ${accountLocked ? 'btn-primary' : 'btn-secondary'}"
              onclick="toggleAccountLock('${pc.clientId}','${pc.clientName||''}',${accountLocked})"
              style="${accountLocked ? 'background:#D32F2F;border-color:#D32F2F;color:#fff' : ''}"
              title="${accountLocked ? 'Unlock entire account' : 'Suspend entire account'}">
              ${accountLocked ? 'ğŸ”“ Unlock Account' : 'ğŸ”’ Suspend Account'}
            </button>
            ${planLocked && pc.overrideReason ? `<div style="font-size:11px;color:var(--ink-4);align-self:center">Reason: ${pc.overrideReason}</div>` : ''}
          </div>

          <!-- Client Info -->
          <div style="background:var(--bg);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:14px">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);margin-bottom:8px">Client Info</div>
            <div style="display:grid;grid-template-columns:auto 1fr;gap:4px 12px;font-size:12px">
              <span style="color:var(--ink-4)">Name</span>
              <span style="font-weight:500">${pc.clientName || 'â€”'}</span>
              <span style="color:var(--ink-4)">Email</span>
              <span>${pc.clientEmail ? `<a href="mailto:${pc.clientEmail}" style="color:var(--blue)">${pc.clientEmail}</a>` : 'â€”'}</span>
              <span style="color:var(--ink-4)">Phone</span>
              <span>${pc.clientPhone || 'â€”'}</span>
              <span style="color:var(--ink-4)">Client ID</span>
              <span style="font-family:monospace;font-size:10px;color:var(--ink-4)">${pc.clientId || 'â€”'}</span>
              <span style="color:var(--ink-4)">Plan Card ID</span>
              <span style="font-family:monospace;font-size:10px;color:var(--ink-4)">${pc.planCardId}</span>
              ${pc.businessDescription ? `<span style="color:var(--ink-4)">Business</span><span style="color:var(--ink-2)">${pc.businessDescription}</span>` : ''}
              ${pc.referralSource ? `<span style="color:var(--ink-4)">Source</span><span style="color:var(--ink-3)">${pc.referralSource}</span>` : ''}
            </div>
          </div>

          <!-- Billing & Usage -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;font-size:12px">
            <div style="background:var(--bg);border-radius:var(--radius-sm);padding:10px 12px">
              <div style="color:var(--ink-4);margin-bottom:3px">Billing Period</div>
              <div style="font-weight:500">${fmtPeriodDate(pc.currentPeriodStart)} â€“ ${fmtPeriodDate(pc.currentPeriodEnd)}</div>
            </div>
            <div style="background:var(--bg);border-radius:var(--radius-sm);padding:10px 12px">
              <div style="color:var(--ink-4);margin-bottom:3px">Usage</div>
              <div style="font-weight:500">Mail: ${pc.mailsUsed||0}/${pc.mailLimit||'â€”'} Â· Parcels: ${pc.parcelsUsed||0}/${pc.parcelLimit||'â€”'}</div>
            </div>
            ${pc.forwardingAddress ? `
            <div style="background:var(--bg);border-radius:var(--radius-sm);padding:10px 12px;grid-column:1/-1">
              <div style="color:var(--ink-4);margin-bottom:3px">Forward to</div>
              <div style="font-weight:500">${pc.forwardingAddress}, ${pc.forwardingCity||''} ${pc.forwardingProvince||''} ${pc.forwardingPostalCode||''}</div>
            </div>` : ''}
          </div>

          <!-- Recipients -->
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3)">
              Recipients (${recs.length})
            </div>
            <button class="btn btn-secondary btn-sm" onclick="openAddTempRecipient('${pc.planCardId}',${i})">
              + Add Temporary
            </button>
          </div>
          <div id="add-temp-${i}" style="display:none;background:var(--bg);border-radius:var(--radius-sm);padding:14px;margin-bottom:10px">
            <div style="font-size:12px;font-weight:600;color:var(--amber);margin-bottom:12px">âš¡ Temporary Recipient (staff only)</div>
            <!-- Row 1: First name / Last name / Type -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px">
              <div>
                <label id="tmp-fname-label-${i}" style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);display:block;margin-bottom:4px">First Name *</label>
                <input type="text" id="tmp-fname-${i}" placeholder="Jane"
                  oninput="tmpCheckName(${i})"
                  style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
              </div>
              <div id="tmp-lname-wrap-${i}">
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);display:block;margin-bottom:4px">Last Name *</label>
                <input type="text" id="tmp-lname-${i}" placeholder="Smith"
                  oninput="tmpCheckName(${i})"
                  style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
              </div>
              <div>
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);display:block;margin-bottom:4px">Type</label>
                <select id="tmp-type-${i}" onchange="tmpTypeChange(${i})"
                  style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
                  <option value="individual">Individual</option>
                  <option value="company">Company</option>
                </select>
              </div>
            </div>
            <!-- Row 2: Language / Notes -->
            <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;margin-bottom:10px">
              <div>
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);display:block;margin-bottom:4px">Language</label>
                <select id="tmp-lang-${i}" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
                  <option value="en">English</option>
                  <option value="fr">FranÃ§ais</option>
                </select>
              </div>
              <div>
                <label style="font-size:11px;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-3);display:block;margin-bottom:4px">Notes <span style="color:var(--ink-4);text-transform:none;letter-spacing:0">(optional)</span></label>
                <input type="text" id="tmp-notes-${i}" placeholder="e.g. Guest, courier, etc."
                  style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
              </div>
            </div>
            <!-- Name hint -->
            <div id="tmp-hint-${i}" style="display:none;font-size:11px;color:var(--red);margin-bottom:8px">Please enter both first and last name.</div>
            <!-- Actions -->
            <div style="display:flex;gap:6px">
              <button class="btn btn-primary btn-sm" onclick="submitAddTempRecipient('${pc.planCardId}',${i})">Add</button>
              <button class="btn btn-secondary btn-sm" onclick="qs('add-temp-${i}').style.display='none';tmpReset(${i})">Cancel</button>
            </div>
          </div>

          ${(() => {
            if (recs.length === 0) return '<div style="font-size:12px;color:var(--ink-4);padding:8px 0">No recipients on file.</div>';
            const regRecs  = recs.filter(r => !(r.notes && r.notes.startsWith('TEMP:')));
            const tempRecs = recs.filter(r =>   r.notes && r.notes.startsWith('TEMP:'));
            const renderRec = r => {
              const safeId   = encodeURIComponent(r.recipientId);
              const safeName = encodeURIComponent(r.name||'');
              const isTemp   = r.notes && r.notes.startsWith('TEMP:');
              const hasMailLogged = r.hasMailLogged === 'TRUE' || r.hasMailLogged === true;
              return `
              <div class="rec-row" id="rec-row-${r.recipientId}">
                <div style="width:30px;height:30px;border-radius:50%;background:${isTemp?'var(--amber-bg)':'var(--bg-2)'};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;flex-shrink:0;color:${isTemp?'var(--amber)':'inherit'}">${isTemp?'T':(r.name||'?')[0].toUpperCase()}</div>
                <div style="flex:1;min-width:0">
                  <div style="font-size:13px;font-weight:500;display:flex;align-items:center;gap:6px">
                    ${r.name}
                    ${isTemp ? `<span style="font-size:10px;background:var(--amber-bg);color:var(--amber);padding:1px 6px;border-radius:8px;font-weight:600">TEMP</span>` : ''}
                    ${hasMailLogged ? `<span style="font-size:10px;color:var(--ink-4)">Â· has mail</span>` : ''}
                  </div>
                  <div style="font-size:11px;color:var(--ink-4)">${r.type||'individual'}</div>
                </div>
                <div style="display:flex;align-items:center;gap:6px;flex-shrink:0">
                  <span class="pill ${r.status==='active'?'scanned':r.status==='inactive'?'void':'stored'}" style="font-size:10px;${r.status==='inactive'?'opacity:0.6':''}">${r.status==='inactive'?'âŠ˜ Inactive':r.status}</span>
                  <button class="btn btn-secondary btn-sm" 
                      style="color:${r.status==='inactive'?'var(--green)':'var(--red)'}"
                      onclick="${r.status==='inactive'?'reactivateRecipient':'deactivateRecipient'}('${safeId}','${safeName}')">
                      ${r.status==='inactive'?'Re-activate':'Deactivate'}
                    </button>
                </div>
              </div>`;
            };
            return [
              regRecs.length > 0 ? regRecs.map(renderRec).join('') : '',
              tempRecs.length > 0 ? `
                <div style="margin-top:12px;padding-top:10px;border-top:1px dashed var(--border)">
                  <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--amber);margin-bottom:6px">âš¡ Temporary Recipients</div>
                  ${tempRecs.map(renderRec).join('')}
                </div>` : ''
            ].join('');
          })()}
        </div>
      </div>`;
  }).join('');

  // Restore previously open card
  if (_openPcCardId) {
    for (let idx = 0; idx < planCards.length; idx++) {
      if (planCards[idx].planCardId === _openPcCardId) {
        togglePcCard(idx);
        break;
      }
    }
  }
}

function openAddTempRecipient(planCardId, i) {
  const wrap = qs('add-temp-' + i);
  if (wrap) wrap.style.display = wrap.style.display === 'none' ? 'block' : 'none';
}

async function submitAddTempRecipient(planCardId, i) {
  const fnameEl = document.getElementById('tmp-fname-' + i);
  const lnameEl = document.getElementById('tmp-lname-' + i);
  const typeEl  = document.getElementById('tmp-type-'  + i);
  const langEl  = document.getElementById('tmp-lang-'  + i);
  const notesEl = document.getElementById('tmp-notes-' + i);
  const hintEl  = document.getElementById('tmp-hint-'  + i);
  const type    = typeEl ? typeEl.value : 'individual';
  const fname   = fnameEl ? fnameEl.value.trim() : '';
  const lname   = lnameEl ? lnameEl.value.trim() : '';
  const name    = type === 'company' ? fname : [fname, lname].filter(Boolean).join(' ');

  if (!fname) { toast('First name is required.', 'error'); if (fnameEl) fnameEl.focus(); return; }
  if (type === 'individual' && !lname) {
    if (hintEl) hintEl.style.display = 'block';
    toast('Please enter both first and last name.', 'error');
    if (lnameEl) lnameEl.focus();
    return;
  }
  if (hintEl) hintEl.style.display = 'none';

  try {
    const result = await apiPost({
      action:     'addTempRecipient',
      uuid:       STATE.uuid,
      planCardId,
      name,
      type,
      language:   langEl ? langEl.value : 'en',
      notes:      notesEl ? notesEl.value.trim() : ''
    });
    if (result.status === 'ok') {
      toast('Temporary recipient added', 'success');
      qs('add-temp-' + i).style.display = 'none';
      tmpReset(i);
      await loadPlanCardsView();
    } else throw new Error(result.message || 'Failed');
  } catch(err) { toast(err.message, 'error'); }
}

function tmpTypeChange(i) {
  const typeEl  = document.getElementById('tmp-type-'  + i);
  const lWrap   = document.getElementById('tmp-lname-wrap-' + i);
  const lEl     = document.getElementById('tmp-lname-' + i);
  const fLabel  = document.getElementById('tmp-fname-label-' + i);
  const isComp  = typeEl && typeEl.value === 'company';
  if (lWrap) lWrap.style.display = isComp ? 'none' : '';
  // Update first name label and placeholder
  if (fLabel) fLabel.textContent = isComp ? 'Company Name / DBA *' : 'First Name *';
  const fEl = document.getElementById('tmp-fname-' + i);
  if (fEl) fEl.placeholder = isComp ? 'e.g. Acme Corp' : 'Jane';
  // Clear last name if switching to company
  if (isComp && lEl) lEl.value = '';
}

function tmpCheckName(i) {
  const typeEl  = document.getElementById('tmp-type-' + i);
  const fnEl    = document.getElementById('tmp-fname-' + i);
  const lnEl    = document.getElementById('tmp-lname-' + i);
  const hintEl  = document.getElementById('tmp-hint-'  + i);
  if (!hintEl) return;
  const isInd = !typeEl || typeEl.value === 'individual';
  const fn = fnEl ? fnEl.value.trim() : '';
  const ln = lnEl ? lnEl.value.trim() : '';
  hintEl.style.display = (isInd && fn.length > 0 && !ln) ? 'block' : 'none';
}

function tmpReset(i) {
  ['tmp-fname-','tmp-lname-','tmp-notes-'].forEach(p => {
    const el = document.getElementById(p + i);
    if (el) el.value = '';
  });
  const typeEl = document.getElementById('tmp-type-' + i);
  if (typeEl) typeEl.value = 'individual';
  const langEl = document.getElementById('tmp-lang-' + i);
  if (langEl) langEl.value = 'en';
  const hintEl = document.getElementById('tmp-hint-' + i);
  if (hintEl) hintEl.style.display = 'none';
  const lWrap = document.getElementById('tmp-lname-wrap-' + i);
  if (lWrap) lWrap.style.display = '';
  const fLabel = document.getElementById('tmp-fname-label-' + i);
  if (fLabel) fLabel.textContent = 'First Name *';
  const fEl = document.getElementById('tmp-fname-' + i);
  if (fEl) fEl.placeholder = 'Jane';
}


let _openPcCardId = null; // track which plan card is expanded

function togglePcCard(i) {
  const body=qs('pc-body-'+i), chevron=qs('pc-chevron-'+i), header=qs('pc-hdr-'+i);
  if (!body) return;
  const open = body.style.display==='none';
  body.style.display=open?'block':'none';
  if (chevron) chevron.textContent=open?'â–¾':'â–¸';
  if (header)  header.classList.toggle('open',open);
  // Track which card is open by planCardId
  const pcId = body.dataset.pcid || null;
  _openPcCardId = open ? pcId : null;
}

function openEditRecipient(recipientId, name, companyName) {
  const editDiv = qs('rec-edit-'+recipientId);
  if (!editDiv) return;
  const isOpen = editDiv.style.display!=='none';
  editDiv.style.display = isOpen?'none':'block';
  if (!isOpen) {
    const nameEl=qs('re-name-'+recipientId), akaEl=qs('re-aka-'+recipientId);
    if (nameEl) nameEl.value=decodeURIComponent(name||'');
    if (akaEl)  akaEl.value=decodeURIComponent(companyName||'');
  }
}

async function saveRecipientEdit(recipientId) {
  const nameEl=qs('re-name-'+recipientId), akaEl=qs('re-aka-'+recipientId), typeEl=qs('re-type-'+recipientId);
  if (!nameEl||!nameEl.value.trim()) { toast('Name is required','error'); return; }
  try {
    const result = await apiPost({ action:'updateRecipient', uuid:STATE.uuid, recipientId, name:nameEl.value.trim(), companyName:akaEl?akaEl.value.trim():'', type:typeEl?typeEl.value:'individual' });
    if (result.status==='ok') {
      toast('Recipient updated','success');
      const d=qs('rec-display-'+recipientId);
      if (d) d.innerHTML=`<div style="font-size:13px;font-weight:500">${nameEl.value.trim()}</div><div style="font-size:11px;color:var(--ink-4)">${akaEl?akaEl.value.trim():''} Â· ${typeEl?typeEl.value:'individual'}</div>`;
      qs('rec-edit-'+recipientId).style.display='none';
    } else throw new Error(result.message||'Failed');
  } catch(err) { toast(err.message,'error'); }
}

async function deactivateRecipient(recipientId, name) {
  const ok = await appConfirm({ title: 'Deactivate Recipient', message: `Deactivate <strong>${decodeURIComponent(name)}</strong>? They will be marked inactive and cannot be selected when logging mail.`, confirmLabel: 'Deactivate', confirmClass: 'btn-danger' });
  if (!ok) return;
  await _setRecipientStatus(recipientId, 'inactive');
}

async function reactivateRecipient(recipientId, name) {
  const ok = await appConfirm({ title: 'Re-activate Recipient', message: `Re-activate <strong>${decodeURIComponent(name)}</strong>?`, confirmLabel: 'Re-activate' });
  if (!ok) return;
  await _setRecipientStatus(recipientId, 'active');
}

async function _setRecipientStatus(recipientId, status) {
  try {
    const result = await apiPost({ action:'updateRecipientStatus', uuid:STATE.uuid, recipientId, status });
    if (result.status==='ok') {
      toast(status === 'active' ? 'Recipient re-activated' : 'Recipient deactivated', 'success');
      await loadPlanCardsView();
    } else throw new Error(result.message||'Failed');
  } catch(err) { toast(err.message,'error'); }
}

// â”€â”€ Plan / Account Lock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function togglePlanLock(planCardId, isCurrentlyLocked) {
  let reason = '';
  if (!isCurrentlyLocked) {
    reason = await appPrompt({ title: 'ğŸ”’ Suspend Plan', message: 'The client will lose access to this plan. Mail logging will continue normally.', placeholder: 'Reason (optional)', confirmLabel: 'Suspend Plan', confirmClass: 'btn-danger' });
    if (reason === null) return;
  } else {
    const ok = await appConfirm({ title: 'ğŸ”“ Unlock Plan', message: 'The client will regain access to this plan immediately.', confirmLabel: 'Unlock Plan' });
    if (!ok) return;
  }
  try {
    const result = await apiPost({ action: 'togglePlanLock', uuid: STATE.uuid, planCardId, reason });
    if (result.status === 'ok') {
      toast(result.locked ? 'ğŸ”’ Plan suspended' : 'ğŸ”“ Plan unlocked', 'success');
      await loadPlanCardsView();
    } else throw new Error(result.message || 'Failed');
  } catch(err) { toast(err.message, 'error'); }
}

async function toggleAccountLock(clientId, clientName, isCurrentlyLocked) {
  let reason = '';
  if (!isCurrentlyLocked) {
    reason = await appPrompt({ title: 'âš ï¸ Suspend Entire Account', message: `This will block <strong>ALL plans</strong> for <strong>${clientName || clientId}</strong>. The client cannot access their portal. Mail logging will continue normally.`, placeholder: 'Reason (optional)', confirmLabel: 'Suspend Account', confirmClass: 'btn-danger' });
    if (reason === null) return;
  } else {
    const ok = await appConfirm({ title: 'ğŸ”“ Unlock Account', message: `Unlock the entire account for <strong>${clientName || clientId}</strong>? All plans will be accessible again.`, confirmLabel: 'Unlock Account' });
    if (!ok) return;
  }
  try {
    const result = await apiPost({ action: 'toggleAccountLock', uuid: STATE.uuid, clientId, reason });
    if (result.status === 'ok') {
      toast(result.locked ? 'ğŸ”’ Account suspended' : 'ğŸ”“ Account unlocked', 'success');
      await loadPlanCardsView();
    } else throw new Error(result.message || 'Failed');
  } catch(err) { toast(err.message, 'error'); }
}

// â”€â”€ Edit Mail Item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _editTarget = null;

async function openEditMailModal(mailIdEnc) {
  const mailId = decodeURIComponent(mailIdEnc);
  // Find item in cache
  const item = (_allStaffMail || []).find(m => m.mailId === mailId);
  if (!item) { toast('Item not found in current view â€” refresh first', 'error'); return; }
  _editTarget = item;

  // Remove any existing modal
  const existing = document.getElementById('edit-mail-modal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'edit-mail-modal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px';
  modal.innerHTML = `
    <div style="background:var(--white);border-radius:var(--radius);width:100%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-md)">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:600;font-size:15px">Edit Mail Item â€” ${item.mailId}</div>
        <button onclick="document.getElementById('edit-mail-modal').remove()" style="background:none;font-size:18px;color:var(--ink-4)">âœ•</button>
      </div>
      <div style="padding:20px;display:flex;flex-direction:column;gap:14px">
        <div style="font-size:11px;color:var(--ink-4);background:var(--bg);padding:6px 10px;border-radius:var(--radius-sm)">
          ğŸ“… Logged: ${fmtDateTime(item.loggedAt)} by ${item.loggedBy || 'â€”'} &nbsp;Â·&nbsp; Editing does not change the log date.
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Sender Name</label>
            <input id="em-sender" type="text" value="${item.senderName||''}" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
          </div>
          <div>
            <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Type</label>
            <select id="em-type" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
              <option value="letter" ${item.type==='letter'?'selected':''}>âœ‰ï¸ Mail / Letter</option>
              <option value="parcel" ${item.type==='parcel'?'selected':''}>ğŸ“¦ Parcel / Package</option>
            </select>
          </div>
          <div>
            <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Physical Location</label>
            <input id="em-location" type="text" value="${item.physicalLocation||''}" placeholder="e.g. Shelf A3" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
          </div>
          <div>
            <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Scanned File URL</label>
            <input id="em-scan" type="text" value="${item.scanImageUrl||''}" placeholder="https://..." style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
          </div>
        </div>

        <!-- Confidential toggle in edit -->
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg);border-radius:var(--radius-sm);border:1px solid var(--border)">
          <div>
            <div style="font-size:13px;font-weight:500">Confidential</div>
            <div style="font-size:11px;color:var(--ink-4)">Blocks scan &amp; forwarding â€” pickup only</div>
          </div>
          <div class="toggle ${item.confidential==='TRUE'||item.confidential===true?'on':''}" id="em-confidential" onclick="this.classList.toggle('on')"></div>
        </div>

        <!-- Special Case toggle in edit -->
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg);border-radius:var(--radius-sm);border:1px solid var(--border)">
          <div>
            <div style="font-size:13px;font-weight:500">Special Case</div>
            <div style="font-size:11px;color:var(--ink-4)">Mark as unmatched â€” clears recipient assignment</div>
          </div>
          <div class="toggle ${item.specialCase==='TRUE'||item.specialCase===true?'on':''}" id="em-special-case" onclick="onEditSpecialCaseToggle()"></div>
        </div>
        <div id="em-spec-name-wrap" style="display:${item.specialCase==='TRUE'||item.specialCase===true?'block':'none'};margin-top:4px">
          <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Name on Envelope / Package</label>
          <input id="em-spec-name" type="text" value="${item.recipientName||''}" placeholder="Name as it appears on mail"
            style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px">
        </div>

        <div>
          <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Note to Client</label>
          <textarea id="em-note-client" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px;resize:vertical;min-height:60px">${item.noteToClient||''}</textarea>
        </div>
        <div>
          <label style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);display:block;margin-bottom:4px">Internal Note</label>
          <textarea id="em-note-internal" style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px;resize:vertical;min-height:60px">${item.noteInternal||''}</textarea>
        </div>

        <div style="padding-top:8px;border-top:1px solid var(--border)">
          <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--ink-3);margin-bottom:8px">Change Recipient</div>
          <div class="form-group recipient-search-wrap" style="margin:0">
            <input type="text" id="em-rec-search" placeholder="Search to change recipientâ€¦"
              style="width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:inherit;font-size:13px"
              oninput="searchEditRecipient(this.value)">
            <div id="em-rec-results" class="recipient-results" style="display:none"></div>
          </div>
          <div id="em-rec-current" style="font-size:12px;color:var(--ink-3);margin-top:6px">
            Current: <strong>${item.recipientName || '(none)'}</strong>
          </div>
        </div>

        <div style="display:flex;gap:8px;padding-top:4px">
          <button class="btn btn-primary" style="flex:1" onclick="saveEditMail()">Save Changes</button>
          <button class="btn btn-secondary" onclick="document.getElementById('edit-mail-modal').remove()">Cancel</button>
        </div>
      </div>
    </div>`;
  document.body.appendChild(modal);
}

function onEditSpecialCaseToggle() {
  const tog = document.getElementById('em-special-case');
  if (!tog) return;
  tog.classList.toggle('on');
  const isOn = tog.classList.contains('on');
  const nameWrap = document.getElementById('em-spec-name-wrap');
  if (nameWrap) nameWrap.style.display = isOn ? 'block' : 'none';
  if (isOn) {
    const cur = document.getElementById('em-rec-current');
    if (cur) cur.innerHTML = '<span style="color:var(--amber)">âš  Special case â€” recipient will be cleared on save</span>';
    _editRecipient = null;
  }
}

let _editRecipient = null;

function searchEditRecipient(query) {
  if (!query || query.length < 2) { qs('em-rec-results').style.display='none'; return; }
  const q = query.toLowerCase();
  const hits = (_recipientCache || []).filter(r =>
    [r.name, r.companyName, r.planCardId, r.planName].join(' ').toLowerCase().includes(q)
  ).slice(0, 6);
  const el = qs('em-rec-results');
  if (!hits.length) { el.style.display='block'; el.innerHTML='<div class="recipient-result-item" style="color:var(--ink-4)">No matches</div>'; return; }
  el.style.display = 'block';
  el.innerHTML = hits.map(r => {
    const payload = JSON.stringify(r).replace(/"/g,'&quot;');
    return `<div class="recipient-result-item" onclick="selectEditRecipient(${payload})">
      <div class="rri-name">${r.name}</div>
      <div class="rri-sub" style="font-size:10px">${r.planName||r.planCardId}</div>
    </div>`;
  }).join('');
}

function selectEditRecipient(data) {
  _editRecipient = data;
  const el = qs('em-rec-search');
  if (el) el.value = data.name;
  const cur = qs('em-rec-current');
  if (cur) cur.innerHTML = `Current: <strong>${(_editTarget||{}).recipientName||'(none)'}</strong> â†’ <strong style="color:var(--green)">${data.name}</strong>`;
  const res = qs('em-rec-results');
  if (res) res.style.display = 'none';
}

async function saveEditMail() {
  if (!_editTarget) return;
  const emConf = qs('em-confidential');
  const emSpec = qs('em-special-case');
  const isConf = emConf && emConf.classList.contains('on');
  const isSpec = emSpec && emSpec.classList.contains('on');
  const updates = {
    action:           'editMailItem',
    uuid:             STATE.uuid,
    mailId:           _editTarget.mailId,
    senderName:       qs('em-sender')?.value?.trim()        || _editTarget.senderName || '',
    type:             qs('em-type')?.value                  || _editTarget.type,
    physicalLocation: qs('em-location')?.value?.trim()      || '',
    scanImageUrl:     qs('em-scan')?.value?.trim()          || '',
    noteToClient:     qs('em-note-client')?.value?.trim()   || '',
    noteInternal:     qs('em-note-internal')?.value?.trim() || '',
    confidential:     isConf ? 'TRUE' : 'FALSE',
    specialCase:      isSpec ? 'TRUE' : 'FALSE'
  };
  // If special case toggled ON, clear recipient
  if (isSpec) {
    updates.recipientId    = '';
    updates.recipientName  = qs('em-spec-name')?.value?.trim() || 'SPECIAL CASE';
    updates.planCardId     = '';
    updates.clientId       = '';
    updates.subscriptionId = '';
  }
  if (_editRecipient) {
    updates.recipientId    = _editRecipient.recipientId;
    updates.recipientName  = _editRecipient.name;
    updates.planCardId     = _editRecipient.planCardId;
    updates.clientId       = _editRecipient.clientId;
    updates.subscriptionId = _editRecipient.subscriptionId;
  }
  try {
    const result = await apiPost(updates);
    if (result.status === 'ok') {
      toast('Mail item updated', 'success');
      document.getElementById('edit-mail-modal')?.remove();
      _editTarget = null; _editRecipient = null;
      await loadStaffMailLog();
    } else throw new Error(result.message || 'Failed');
  } catch(e) { toast(e.message, 'error'); }
}

// â”€â”€ Delete Mail Item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function confirmDeleteMail(mailIdEnc, recipNameEnc) {
  const mailId    = decodeURIComponent(mailIdEnc);
  const recipName = decodeURIComponent(recipNameEnc);
  const pin = await appPrompt({ title: 'âš ï¸ Delete Mail Item', message: `Permanently delete mail item for <strong>${recipName}</strong>? This cannot be undone.`, placeholder: 'Enter staff PIN to confirm', required: true, confirmLabel: 'Delete', confirmClass: 'btn-danger' });
  if (pin === null) return;
  if (pin !== '1234') { toast('Incorrect PIN â€” deletion cancelled', 'error'); return; }
  try {
    const result = await apiPost({ action: 'deleteMailItem', uuid: STATE.uuid, mailId, pin });
    if (result.status === 'ok') {
      toast('Mail item deleted', 'success');
      await loadStaffMailLog();
    } else throw new Error(result.message || 'Failed');
  } catch(e) { toast(e.message, 'error'); }
}

// â”€â”€ Refresh Plan Cards (staff) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshPlanCardsView() {
  toast('Refreshingâ€¦', 'success');
  await loadPlanCardsView();
}



// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
boot();
</script>
</body>
</html>
